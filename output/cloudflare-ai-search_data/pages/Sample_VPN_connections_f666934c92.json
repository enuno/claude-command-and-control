{
  "title": "Sample VPN connections",
  "content": "conn cloudflare-ipsec\n    auto=start\n    type=tunnel\n    fragmentation=no\n    leftauth=psk\n    # Private IP of the VM\n    left=%any\n    # Tunnel ID from dashboard, in this example FQDN is used\n    leftid=<YOUR_TUNNEL_ID>.<YOUR_ACCOUNT_ID>.ipsec.cloudflare.com\n    leftsubnet=0.0.0.0/0\n    # Cloudflare Anycast IP\n    right=<YOUR_CLOUDFLARE_ANYCAST_IP>\n    rightid=<YOUR_CLOUDFLARE_ANYCAST_IP>\n    rightsubnet=0.0.0.0/0\n    rightauth=psk\n    ike=aes256-sha256-ecp384!\n    esp=aes256-sha256-ecp384!\n    replay_window=0\n    mark_in=42\n    mark_out=42\n    leftupdown=/etc/strongswan.d/ipsec-vti.sh\ntxt\n#!/bin/bash\n\nset -o nounset\nset -o errexit\n\ncase \"${PLUTO_VERB}\" in\n    up-client)\n        ip tunnel add \"${VTI_IF}\" local \"${PLUTO_ME}\" remote \"${PLUTO_PEER}\" mode vti \\\n        key \"${PLUTO_MARK_OUT%%/*}\"\n        ip link set \"${VTI_IF}\" up\n        ip addr add 172.64.240.252/32 dev vti0\n        sysctl -w \"net.ipv4.conf.${VTI_IF}.disable_policy=1\"\n        sysctl -w \"net.ipv4.conf.${VTI_IF}.rp_filter=0\"\n        sysctl -w \"net.ipv4.conf.all.rp_filter=0\"\n        ip rule add from 172.64.240.252 lookup viatunicmp\n        ip route add default dev vti0 table viatunicmp\n        ;;\n    down-client)\n        ip tunnel del \"${VTI_IF}\"\n        ip rule del from 172.64.240.252 lookup viatunicmp\n        ip route del default dev vti0 table viatunicmp\n        ;;\nesac\necho \"executed\"\ntxt\n#",
  "code_samples": [
    {
      "code": "1. Now, you need to create a virtual tunnel interface (VTI) with the IP we configured earlier as the target for Cloudflare's health checks (`172.64.240.252`) to route IPsec packets. Go to `/etc/strongswan.d/`.\n\n2. Create a script called `ipsec-vti.sh` and add the following:",
      "language": "unknown"
    },
    {
      "code": "## 4. Add Policy Based Routing (PBR)\n\nAlthough the IPsec tunnel is working as is, we need to create Policy Based Routing (PBR) to redirect returning traffic via the IPsec tunnel. Without it, the ICMP replies to the health probes sent by Cloudflare will be returned via the Internet, instead of the same IPsec tunnel. This is required to avoid any potential issues.\n\nTo accomplish this, the tutorial uses [iproute2](https://en.wikipedia.org/wiki/Iproute2) to route IP packets from `172.63.240.252` to the tunnel interface.\n\n1. Go to `/etc/iproute2/`.\n\n2. Edit the `rt_tables` file to add a routing table number and name. In this example, we used `viatunicmp` as the name and `200` as the number for the routing table.",
      "language": "unknown"
    }
  ],
  "headings": [
    {
      "level": "h2",
      "text": "4. Add Policy Based Routing (PBR)",
      "id": "4.-add-policy-based-routing-(pbr)"
    }
  ],
  "url": "llms-txt#sample-vpn-connections",
  "links": []
}