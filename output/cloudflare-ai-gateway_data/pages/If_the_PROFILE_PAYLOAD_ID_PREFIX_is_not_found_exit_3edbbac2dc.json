{
  "title": "If the PROFILE_PAYLOAD_ID_PREFIX is not found, exit 0 to wait for the next agent run.",
  "content": "if [[ ${#profiles[@]} -eq 0 ]]; then\n    echo \"no profiles with ID $PROFILE_PAYLOAD_ID_PREFIX were found ...\"\n    echo \"Waiting until the profile is installed before proceeding ...\"\n    echo \"Will check again at the next Kandji agent check-in ...\"\n    exit 0\n\nelse\n    echo \"Profile prefix $PROFILE_PAYLOAD_ID_PREFIX present ...\"\n\n# Uses the find binary to look for the app inside of the Applications directory and\n    # any subdirectories up to 3 levels deep.\n    find_app=\"$(/usr/bin/find /Applications -maxdepth 3 -name $APP_NAME)\"\n    ret=\"$?\"\n\n# Check to see if the app is installed.\n    if [[ \"$ret\" -eq 0 ]] && [[ -d \"$find_app\" ]] &&\n        [[ \"$APP_NAME\" == \"$(/usr/bin/basename $find_app)\" ]]; then\n        # If the previous command returns true and the returned object is a directory\n        # and the app name that we are looking for is exactly equal to the app name\n        # found by the find command.\n        echo \"$find_app was found ...\"\n\n# Check to see if an ENFORCED_VERSION is set. If not, exit 0.\n        if [[ \"$ENFORCED_VERSION\" == \"\" ]]; then\n            echo \"A minimum enforced version is not set ...\"\n            exit 0\n        fi\n\n# Get the currently install version\n        # Pass the APP_NAME variable from above to the return_installed_app_version function\n        # Removing the periods from the version number so that we can make a comparison.\n        installed_version=\"$(return_installed_app_version $APP_NAME | /usr/bin/sed 's/\\.//g')\"\n\n# Removing the periods from the version number so that we can make a comparison.\n        enforced_version=\"$(echo $ENFORCED_VERSION | /usr/bin/sed 's/\\.//g')\"\n\n# Check to see if the installed_version is less than the enforced_version. If it is then\n        # exit 1 to initiate the installation process.\n        if [[ \"$installed_version\" -lt \"$enforced_version\" ]]; then\n            echo \"Installed app version $installed_version less than enforced version $ENFORCED_VERSION\"\n            echo \"Starting the app install process ...\"\n            exit 1\n\nelse\n            echo \"Enforced vers: $enforced_version\"\n            echo \"Installed app version: $installed_version\"\n            echo \"Minimum app version enforcement met ...\"\n            echo \"No need to run the installer ...\"\n            exit 0\n        fi\n\nelse\n        echo \"$APP_NAME was not found in the Applications folder ...\"\n        echo \"Need to install $APP_NAME ...\"\n        exit 1\n\nexit 0\nmermaid\n\t\tflowchart LR\n\t\taccTitle: In this example, the applications go directly to the Internet, skipping Cloudflare's security. filtering\n\t\ta(Magic WAN Connector) --> b(Cloudflare) -->|Filtered traffic|c(Internet)\n\na-- Breakout traffic ---d(Application1) & e(Application2) --> c\n\nclassDef orange fill:#f48120,color: black\n\t\tclass a,b orange\n\t\t\nbash\ncurl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/apps\" \\\n  --request POST \\\n  --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n  --json '{\n    \"managed_app_id\": \"<APP_ID>\",\n    \"name\": \"<APP_NAME>\",\n    \"type\": \"<APP_TYPE>\"\n  }'\njson\n{\n  \"result\": {\n    \"account_app_id\": \"eb09v665c0784618a3e4ba9809258fd4\",\n    \"name\": \"<APP_NAME>\",\n    \"type\": \"<APP_TYPE>\",\n  },\n  \"success\": true,\n  \"errors\": [],\n  \"messages\": []\n}\nbash\n     curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/apps\" \\\n       --request GET \\\n       --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\"\n     json\n       {\n         \"result\": [\n           {\n             \"managed_app_id\": \"<APP_ID>\",\n             \"name\": \"<APP_NAME>\",\n             \"type\": \"File Sharing\",\n             \"hostnames\": [\n               \"<app_name.com>\",\n               \"<app-name.info>\"\n             ]\n           }\n         ]\n       }\n     bash\n     curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/app_configs\" \\\n       --request POST \\\n       --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n       --json '{\n         \"managed_app_id\": \"<MANAGED_APP_ID>\",\n         \"breakout\": true\n       }'\n     json\n     {\n       \"result\": {\n         \"account_app_id\": \"<APP_ID>\",\n         \"name\": \"<APP_NAME>\",\n         \"type\": \"<BREAKOUT_OR_PRIORITY>\"\n       },\n       \"success\": true,\n       \"errors\": [],\n       \"messages\": []\n     }\n     bash\n     curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/app_configs\" \\\n       --request GET \\\n       --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\"\n     json\n       {\n         \"result\": [\n           {\n             \"id\": \"<APP_ID>\",\n             \"site_id\": \"<SITE_ID>\",\n             \"managed_app_id\": \"<APP_NAME>\",\n             \"breakout\": true\n           }\n         ]\n       }\n     bash\n     curl \"https://api.cloudflare.com/client/v4/accounts/%7Baccount_id%7D/magic/sites/%7Bsite_id%7D/app_configs/%7Bid%7D\" \\\n       --request DELETE\n     json\n     {\n         \"result\": {\n             \"id\": \"<APP_ID>\",\n             \"site_id\": \"<SITE_ID>\",\n             \"managed_app_id\": \"<APP_NAME>\",\n             \"breakout\": true\n         },\n         \"success\": true,\n         \"errors\": [],\n         \"messages\": []\n     }\n     bash\ncurl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/netflow_config\" \\\n  --request PUT \\\n  --json '{\n    \"collector_ip\": \"162.159.65.1\"\n  }'\nbash\ncurl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/netflow_config\" \\\n  --request PUT \\\n  --json '{\n    \"collector_ip\": \"162.159.65.1\",\n    \"collector_port\": 2055,\n    \"sampling_rate\": 100,\n    \"active_timeout\": 60,\n    \"inactive_timeout\": 30\n  }'\nbash\ncurl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/apps\" \\\n  --request POST \\\n  --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n  --json '{\n    \"managed_app_id\": \"<APP_ID>\",\n    \"name\": \"<APP_NAME>\",\n    \"type\": \"<APP_TYPE>\"\n  }'\njson\n{\n  \"result\": {\n    \"account_app_id\": \"eb09v665c0784618a3e4ba9809258fd4\",\n    \"name\": \"<APP_NAME>\",\n    \"type\": \"<APP_TYPE>\",\n  },\n  \"success\": true,\n  \"errors\": [],\n  \"messages\": []\n}\nbash\n     curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/apps\" \\\n       --request GET \\\n       --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\"\n     json\n       {\n         \"result\": [\n           {\n             \"managed_app_id\": \"<APP_ID>\",\n             \"name\": \"<APP_NAME>\",\n             \"type\": \"File Sharing\",\n             \"hostnames\": [\n               \"<app_name.com>\",\n               \"<app-name.info>\"\n             ]\n           }\n         ]\n       }\n     bash\n     curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/app_configs\" \\\n       --request POST \\\n       --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n       --json '{\n         \"managed_app_id\": \"<MANAGED_APP_ID>\",\n         \"breakout\": true\n       }'\n     json\n     {\n       \"result\": {\n         \"account_app_id\": \"<APP_ID>\",\n         \"name\": \"<APP_NAME>\",\n         \"type\": \"<BREAKOUT_OR_PRIORITY>\"\n       },\n       \"success\": true,\n       \"errors\": [],\n       \"messages\": []\n     }\n     bash\n     curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/app_configs\" \\\n       --request GET \\\n       --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\"\n     json\n       {\n         \"result\": [\n           {\n             \"id\": \"<APP_ID>\",\n             \"site_id\": \"<SITE_ID>\",\n             \"managed_app_id\": \"<APP_NAME>\",\n             \"breakout\": true\n           }\n         ]\n       }\n     bash\n     curl \"https://api.cloudflare.com/client/v4/accounts/%7Baccount_id%7D/magic/sites/%7Bsite_id%7D/app_configs/%7Bid%7D\" \\\n       --request DELETE\n     json\n     {\n         \"result\": {\n             \"id\": \"<APP_ID>\",\n             \"site_id\": \"<SITE_ID>\",\n             \"managed_app_id\": \"<APP_NAME>\",\n             \"breakout\": true\n         },\n         \"success\": true,\n         \"errors\": [],\n         \"messages\": []\n     }\n     mermaid\n\tflowchart LR\n\taccTitle: An example of Connector in DHCP Relay mode\n\t\t\ta(Magic WAN Connector) <--> b(Cloudflare/Magic WAN) <--> c(DHCP server)\n\nsubgraph Site A\n\t\t\td[LAN 1] <--> a\n\t\t\te[LAN 2] <--> a\n\t\t\tend\n\nsubgraph Site B\n\t\t\tc\n\t\t\tend\n\t\t\tclassDef orange fill:#f48120,color: black\n\t\t\tclass a,b,c orange\nbash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/lans/$LAN_ID\" \\\n    --request PUT \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"lan\": {\n          \"static_addressing\": {\n              \"dhcp_relay\": {\n                  \"server_addresses\": [\n                      \"192.0.2.1\"\n                  ]\n              }\n          }\n      }\n    }'\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/lans/$LAN_ID\" \\\n    --request PUT \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"lan\": {\n          \"static_addressing\": {\n              \"dhcp_server\": {\n                  \"reservations\": {\n                      \"<HARDWARE_MAC_ADDRESS>\": \"<IP_ADDRESS>\",\n                      \"<HARDWARE_MAC_ADDRESS_2>\": \"<IP_ADDRESS>\"\n                  }\n              }\n          }\n      }\n    }'\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/lans/$LAN_ID\" \\\n    --request PUT \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"lan\": {\n          \"static_addressing\": {\n              \"dhcp_server\": {\n                  \"dhcp_pool_end\": \"<IP_ADDRESS>\",\n                  \"dhcp_pool_start\": \"<IP_ADDRESS>\",\n                  \"dns_server\": \"<IP_ADDRESS>\"\n              }\n          }\n      }\n    }'\n  sh\ncurl https://ipinfo.io\njson\n{\n  \"ip\": \"104.xxx.xxx.225\",\n  \"city\": \"Reston\",\n  \"region\": \"Virginia\",\n  \"country\": \"US\",\n  \"loc\": \"xx.xxxx,-xx.xxxx\",\n  \"org\": \"AS13335 Cloudflare, Inc.\",\n  \"postal\": \"20190\",\n  \"timezone\": \"America/New_York\",\n  \"readme\": \"https://ipinfo.io/missingauth\"\n}\npowershell\nGet-AzAccessToken\ntxt\nToken: eyJ0e<REDACTED>AH-PdSPg\nExpiresOn : 04/08/2024 23:32:47 +00:00\nType      : Bearer\nTenantId  : xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\nUserId    : user@domain.com\nbash\ncurl --location 'https://management.azure.com/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/virtualNetworkGateways/{{virtualNetworkGatewayName}}?api-version=2022-05-01' \\\n--header 'Authorization: Bearer eyJ0e<REDACTED>AH-PdSPg'\njson\n{\n    \"name\": \"{{virtualNetworkGatewayName}}\",\n    \"id\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/virtualNetworkGateways/{{virtualNetworkGatewayName}}\",\n    \"etag\": \"W/\\\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\\\"\",\n    \"type\": \"Microsoft.Network/virtualNetworkGateways\",\n    \"location\": \"eastus\"\n    },\n    \"properties\": {\n        \"provisioningState\": \"Succeeded\",\n        \"resourceGuid\": \"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\",\n        \"packetCaptureDiagnosticState\": \"None\",\n        \"enablePrivateIpAddress\": false,\n        \"isMigrateToCSES\": false,\n        \"ipConfigurations\": [\n            {\n                \"name\": \"default\",\n                \"id\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/virtualNetworkGateways/{{virtualNetworkGatewayName}}/ipConfigurations/default\",\n                \"etag\": \"W/\\\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\\\"\",\n                \"type\": \"Microsoft.Network/virtualNetworkGateways/ipConfigurations\",\n                \"properties\": {\n                    \"provisioningState\": \"Succeeded\",\n                    \"privateIPAllocationMethod\": \"Dynamic\",\n                    \"publicIPAddress\": {\n                        \"id\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/publicIPAddresses/{{virtualNetworkGatewayPublicIpAddress}}\"\n                    },\n                    \"subnet\": {\n                        \"id\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/virtualNetworks/{{virtualNetworkGatewayName}}/subnets/GatewaySubnet\"\n                    }\n                }\n            }\n        ],\n        \"natRules\": [],\n        \"virtualNetworkGatewayPolicyGroups\": [],\n        \"enableBgpRouteTranslationForNat\": false,\n        \"disableIPSecReplayProtection\": false,\n        \"sku\": {\n            \"name\": \"VpnGw2AZ\",\n            \"tier\": \"VpnGw2AZ\",\n            \"capacity\": 2\n        },\n        \"gatewayType\": \"Vpn\",\n        \"vpnType\": \"RouteBased\",\n        \"enableBgp\": false,\n        \"activeActive\": false,\n        \"bgpSettings\": {\n            \"asn\": 65515,\n            \"bgpPeeringAddress\": \"172.25.40.30\",\n            \"peerWeight\": 0,\n            \"bgpPeeringAddresses\": [\n                {\n                    \"ipconfigurationId\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/virtualNetworkGateways/{{virtualNetworkGatewayName}}/ipConfigurations/default\",\n                    \"defaultBgpIpAddresses\": [\n                        \"172.25.40.30\"\n                    ],\n                    \"customBgpIpAddresses\": [],\n                    \"tunnelIpAddresses\": [\n                        \"{{CF ANYCAST IP}}\"\n                    ]\n                }\n            ]\n        },\n        \"gatewayDefaultSite\": {\n            \"id\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/localNetworkGateways/{{localNetworkGatewayName}}\"\n        },\n        \"vpnGatewayGeneration\": \"Generation2\",\n        \"allowRemoteVnetTraffic\": false,\n        \"allowVirtualWanTraffic\": false\n    }\n}\ntxt\n\"disableIPSecReplayProtection\": true\nbash\ncurl --location --request PUT \\\n'https://management.azure.com/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/virtualNetworkGateways/{{virtualNetworkGatewayName}}?api-version=2022-05-01' \\\n--header \"Authorization: Bearer eyJ0e<REDACTED>AH-PdSPg\" \\\n--header \"Content-Type: application/json\" \\\n--data '{\n    \"name\": \"{{virtualNetworkGatewayName}}\",\n    \"id\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/virtualNetworkGateways/{{virtualNetworkGatewayName}}\",\n    \"etag\": \"W/\\\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\\\"\",\n    \"type\": \"Microsoft.Network/virtualNetworkGateways\",\n    \"location\": \"eastus\"\n    },\n    \"properties\": {\n        \"provisioningState\": \"Succeeded\",\n        \"resourceGuid\": \"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\",\n        \"packetCaptureDiagnosticState\": \"None\",\n        \"enablePrivateIpAddress\": false,\n        \"isMigrateToCSES\": false,\n        \"ipConfigurations\": [\n            {\n                \"name\": \"default\",\n                \"id\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/virtualNetworkGateways/{{virtualNetworkGatewayName}}/ipConfigurations/default\",\n                \"etag\": \"W/\\\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\\\"\",\n                \"type\": \"Microsoft.Network/virtualNetworkGateways/ipConfigurations\",\n                \"properties\": {\n                    \"provisioningState\": \"Succeeded\",\n                    \"privateIPAllocationMethod\": \"Dynamic\",\n                    \"publicIPAddress\": {\n                        \"id\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/publicIPAddresses/{{virtualNetworkGatewayPublicIpAddress}}\"\n                    },\n                    \"subnet\": {\n                        \"id\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/virtualNetworks/{{virtualNetworkGatewayName}}/subnets/GatewaySubnet\"\n                    }\n                }\n            }\n        ],\n        \"natRules\": [],\n        \"virtualNetworkGatewayPolicyGroups\": [],\n        \"enableBgpRouteTranslationForNat\": false,\n        \"disableIPSecReplayProtection\": true,\n        \"sku\": {\n            \"name\": \"VpnGw2AZ\",\n            \"tier\": \"VpnGw2AZ\",\n            \"capacity\": 2\n        },\n        \"gatewayType\": \"Vpn\",\n        \"vpnType\": \"RouteBased\",\n        \"enableBgp\": false,\n        \"activeActive\": false,\n        \"bgpSettings\": {\n            \"asn\": 65515,\n            \"bgpPeeringAddress\": \"172.25.40.30\",\n            \"peerWeight\": 0,\n            \"bgpPeeringAddresses\": [\n                {\n                    \"ipconfigurationId\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/virtualNetworkGateways/{{virtualNetworkGatewayName}}/ipConfigurations/default\",\n                    \"defaultBgpIpAddresses\": [\n                        \"172.25.40.30\"\n                    ],\n                    \"customBgpIpAddresses\": [],\n                    \"tunnelIpAddresses\": [\n                        \"{{CF ANYCAST IP}}\"\n                    ]\n                }\n            ]\n        },\n        \"gatewayDefaultSite\": {\n            \"id\": \"/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.Network/localNetworkGateways/{{localNetworkGatewayName}}\"\n        },\n        \"vpnGatewayGeneration\": \"Generation2\",\n        \"allowRemoteVnetTraffic\": false,\n        \"allowVirtualWanTraffic\": false\n    }\n}'\n```\n\n1. Leave the replay protection setting checked in the Cloudflare dashboard, and wait several minutes before validating connectivity again.\n\n<page>\n---\ntitle: Microsoft Azure Virtual WAN · Cloudflare One docs\ndescription: This tutorial provides information on how to connect Magic WAN to a\n  Microsoft Azure Virtual WAN hub.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/azure/azure-virtual-wan/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/azure/azure-virtual-wan/index.md\n---\n\nThis tutorial provides information on how to connect Magic WAN to a Microsoft Azure Virtual WAN hub.\n\nYou will need to have an existing Resource group, Virtual Network, and Virtual Machine created in your Azure account. Refer to [Microsoft's documentation](https://learn.microsoft.com/en-us/azure/virtual-network/) to learn more on how to create these.\n\n## Start Azure configuration\n\n### 1. Create a Virtual WAN\n\nTo connect one or more VNets to Magic WAN via a Virtual WAN hub, you first need to create a Virtual WAN (vWAN) resource representing your Azure network. If you already have a vWAN that you wish to connect to Magic WAN, continue to the next step. Refer to [Microsoft's documentation](https://learn.microsoft.com/en-us/azure/virtual-wan/virtual-wan-site-to-site-portal#openvwan) to learn more.\n\n1. In the Azure portal, go to your **Virtual WANs** page.\n2. Select the option to create a **Virtual WAN**.\n3. Create a Virtual WAN with the **Type** set to **Standard**.\n\n### 2. Create a Virtual WAN Hub\n\nUsing traditional hub and spoke terminology, a Virtual WAN Hub deployed within a vWAN is the hub to which your VNet(s) and Magic WAN attach as spokes. The vWAN hub deployed in this step will contain a VPN Gateway for connecting to Magic WAN.\n\n1. Create a **Virtual WAN Hub**.\n\n1. Select your resource group as well as your desired region, capacity, and hub routing preference. Microsoft recommends using the default hub routing preference of **ExpressRoute** unless you have a specific need to change this setting. Refer to [Microsoft's documentation](https://learn.microsoft.com/en-us/azure/virtual-wan/about-virtual-hub-routing-preference) to learn more about Azure hub routing preferences.\n   2. Configure the **Hub Private Address Space**. Choose an [address space with a subnet mask of `/24` or greater](https://learn.microsoft.com/en-us/azure/virtual-wan/virtual-wan-site-to-site-portal#hub) that does not overlap with the address spaces of any VNets you wish to attach to the vWAN Hub, nor with any of your Magic WAN sites.\n\n3. In **Site to Site**:\n\n1. In **Do you want to create a Site to site (VPN gateway)?** select **Yes**.\n   2. Select your desired **Gateway scale units** and **Routing Preference**. Refer to [Microsoft's documentation](https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/routing-preference-overview#routing-via-microsoft-global-network) to learn more about Azure routing preferences.\n\n4. Select **Create**. Note that the deployment time for the vWAN Hub and VPN Gateway may take 30 minutes or more.\n\n5. After the VPN Gateway has finished provisioning, go to **Virtual WAN** > **Hubs** > **Your vHub** > **Connectivity** > **VPN (Site to site)**.\n\n6. In the **Essentials** dropdown select the VPN Gateway listed.\n\n7. Select the JSON View for the VPN Gateway and take note of the JSON attributes at the paths `properties.ipConfigurations[0].publicIpAddress` and `properties.ipConfigurations[1].publicIpAddress`. These will be the customer endpoints needed when configuring IPsec tunnels for Magic WAN.\n\n### 3. Create a VPN site\n\nA VPN site represents the remote site your Azure vWAN can reach through a VPN connection. This is typically an on-premises location. In this case, the VPN site represents Magic WAN.\n\n1. Go to **Virtual WAN** > **VPN sites** > **Create site**.\n\n1. Configure your desired region and name.\n   2. Configure the **Device vendor** as Cloudflare.\n   3. In **Private address space**, specify the address range(s) you wish to access from your vWAN through Magic WAN. This could include other private networks connected to your Magic WAN, or a default route (`0.0.0.0/0`) if you want Internet egress traffic to traverse Magic WAN (that is, to be scanned by Cloudflare Gateway). The address space can be modified after VPN site creation.\n\n3. In **Links**:\n   1. Configure a single link. Provide a name, speed (in Mbps), and provider name (here, enter `Cloudflare`) for your link. For the **Link IP address**, enter your Cloudflare anycast address. The **BGP address** and **ASN** fields should be left empty. BGP is not supported at the time of writing this tutorial.\n\n4. Select **Create**.\n\n### 4. Configure VPN site for Magic IPsec tunnel health checks\n\nMagic WAN uses [Tunnel Health Checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/) to monitor whether a tunnel is available.\n\nTunnel health checks make use of ICMP probes sent from the Cloudflare side of the Magic IPsec tunnel to the remote endpoint (Azure). Probes are sent from the tunnel's interface address, which you specify in two places:\n\n* **Cloudflare Dashboard:** In your Magic IPsec tunnel configuration as the address of the virtual tunnel interface (VTI) (so that Cloudflare knows what address to send probes from). Cloudflare requires this address in CIDR notation with a `/31` netmask.\n* **Azure Portal:** In your VPN site's address space (so that Azure routes probe responses back over the tunnel). Azure requires this address in CIDR notation with a `/32` netmask.\n\nCloudflare recommends that you select a unique `/31` subnet ([RFC 1918 — Address Allocation for Private Internets](https://datatracker.ietf.org/doc/html/rfc1918)) for each IPsec tunnel which is treated as a Point-to-Point Link and provides the ideal addressing scheme to satisfy both requirements.\n\n* Select `169.254.251.137/31` as your unique Point-to-Point Link subnet.\n* In the Cloudflare dashboard, set `169.254.251.137/31` as your tunnel's **IPv4 Interface address**. (Refer to [Configure Magic WAN](#configure-magic-wan) below.)\n* In the Azure portal, add `169.254.251.137/32` to your VPN site's **Private address space**.\n\nIt is important to ensure the subnet selected for the Interface Address does not overlap with any other subnet.\n\nYou should also refer to RFC 3021 for more information on using 31-bit prefixes on [IPv4 Point-to-Point Links](https://datatracker.ietf.org/doc/html/rfc3021).\n\nTo configure the Address Space for the Local Network Gateway to support Tunnel Health Checks:\n\n1. Go to **Virtual WAN** > **VPN sites** > **Your VPN Site** > **Edit site** to edit the VPN site configured in the previous section.\n2. Update the **Private address space** to include two `/32` subnets in CIDR notation as described above. When using Azure VPN Gateways with vWAN Hubs, a single VPN Gateway Connection maps to two Magic WAN IPsec Tunnels. For this reason, we need to select two unique `/31` subnets, one for each Cloudflare IPsec Tunnel. The upper address of each `/31` is then added to the VPN Site's Private address space as a `/32`subnet.\n3. Select **Confirm**.\n\n### 5. Create a Virtual Network Connection\n\nTo connect your existing VNet to your newly created vHub:\n\n1. Go to **Virtual WAN** > **Virtual network connections** and select **Add connection**.\n\n2. Configure the connection to connect the desired VNet to the vHub created above.\n\n3. Ensure that within the connection's **Routing configuration**:\n\n1. **Propagate to none** is set to **No.**\n   2. **Bypass Next Hop IP for workloads within this VNet** is set to **No**\n   3. And **Propagate static route** is set to **Yes**.\n\n4. Select **Create**.\n\n## Configure Magic WAN\n\nWhen connecting your Azure vHub VPN Gateway to Magic WAN, you need to create two Magic WAN IPsec tunnels to map to the single Azure VPN Gateway Connection created above. This is because Azure VPN Gateways are deployed with two public IP addresses.\n\n1. Create an [IPsec tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) in the Cloudflare dashboard.\n\n2. Make sure you have the following settings:\n\n1. **Interface address**: Add the upper IP address within the first `/31` subnet selected in step 4 of the Start Azure Configuration section. Refer to [Tunnel endpoints](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/) for more details.\n   2. **Customer endpoint**: The first public IP associated with your Azure VPN Gateway. For example, `40.xxx.xxx.xxx`.\n   3. **Cloudflare endpoint**: Use the Cloudflare anycast address you have received from your account team. This will also be the IP address corresponding to the VPN Site in Azure. For example, `162.xxx.xxx.xxx`.\n   4. **Health check rate**: Medium (default).\n   5. **Health check type**: Reply (default).\n   6. **Health check direction**: Bidirectional (default).\n   7. **Health check target**: Custom; enter the customer endpoint.\n   8. **Add pre-shared key later**: Select this option to create a PSK that will be used later in Azure.\n   9. **Replay protection**: **Enable**.\n\n3. Edit the tunnel. Generate a new pre-shared key and copy the key to a safe location.\n\n4. Create static routes for your Azure Virtual Network subnets, specifying the newly created tunnel as the next hop.\n\n5. Create the second IPsec tunnel in the Cloudflare dashboard. Copy the configuration of the first tunnel with the following exceptions:\n\n1. **Interface address**: Add the upper IP address within the **second** `/31` subnet selected in step 4 of the Start Azure Configuration section.\n   2. **Customer endpoint**: The **second** Public IP associated with your Azure VPN Gateway.\n   3. **Health check target**: Enter the new customer endpoint as a custom target.\n   4. **Use my own pre-shared key**: Select this option and enter the key generated for the first tunnel.\n\n6. Create static routes for your Azure Virtual Network subnets, specifying the newly created tunnel as the next hop. To use one tunnel as primary and the other as backup, give the primary tunnel's route a lower priority. To ECMP load balance across both tunnels, assign both routes the same priority.\n\n## Finish Azure Configuration\n\n### 1. Create an IPsec VPN Gateway Connection\n\nTo create a **VPN Gateway Connection**:\n\n1. Go to **Virtual WAN** > **Hubs** > **Your vHub** > **Connectivity** > **VPN (Site to site)** and remove the default filter **Hub association: Connected** to display the **VPN Site** created above.\n2. Check the box next to your VPN Site and select **Connect VPN sites**.\n\nChoose the following settings. These settings have been tested by Cloudflare. However, when setting up your VPN connection note that there are other configuration parameters are also technically feasible, as documented in the [Azure documentation](https://learn.microsoft.com/en-us/azure/virtual-wan/virtual-wan-ipsec) and in the [Cloudflare documentation](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/gre-ipsec-tunnels/#supported-configuration-parameters).\n\n1. **PSK**: Provide the PSK generated by Cloudflare for your Magic WAN Tunnels.\n\n2. **Protocol**: *IKEv2*\n\n3. **IPsec**: *Custom*\n\n1. **IPsec SA lifetime in seconds**: 28800\n\n1. **Encryption**: *AES256*\n      2. **Integrity/PRF**: *SHA256*\n      3. **DH Group**: *ECP384*\n\n3. **IKE Phase 2(IPsec)**\n\n1. **IPsec Encryption**: *AES256*\n      2. **IPsec Integrity**: *SHA256*\n      3. **PFS Group**: *ECP384*\n\n4. **Propagate Default Route:** **Disable**\n\n5. **Use policy based traffic selector**: **Disable**\n\n6. **Connection mode**: **Initiator Only**\n\n7. **Configure traffic selector?**: **Disabled**\n\n4. Select **Connect**.",
  "code_samples": [
    {
      "code": "## TLS decryption\n\nThe Kandji macOS agent uses certificate pinning, which is incompatible with [Gateway TLS decryption](https://developers.cloudflare.com/cloudflare-one/traffic-policies/http-policies/tls-decryption/). If Gateway TLS decryption is [turned on](https://developers.cloudflare.com/cloudflare-one/traffic-policies/http-policies/tls-decryption/#turn-on-tls-decryption), you must create a [Do Not Inspect policy](https://developers.cloudflare.com/cloudflare-one/traffic-policies/http-policies/common-policies/#skip-inspection-for-groups-of-applications) to exempt Kandji from SSL/TLS inspection. For more information, refer to the [Kandji documentation](https://support.kandji.io/kb/using-kandji-on-enterprise-networks#SSL/TLS-Inspection).\n\n</page>\n\n<page>\n---\ntitle: Breakout traffic · Cloudflare One docs\ndescription: Breakout traffic allows you to define which applications should\n  bypass Cloudflare's security filtering.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/breakout-traffic/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/breakout-traffic/index.md\n---\n\nBreakout traffic allows you to define which applications should bypass Cloudflare's security filtering, and go directly to the Internet. It works via DNS requests inspection. This means that if your network is caching DNS requests, Breakout traffic will only take effect after you cache entries expire and your client issues a new DNS request that Magic WAN Connector can detect. This can take several minutes.\n\nWarning\n\nBreakout traffic will not work for applications that use DNS-over-HTTPS.",
      "language": "unknown"
    },
    {
      "code": "*In the graph above, Applications 1 and 2 are configured to bypass Cloudflare's security filtering, and go straight to the Internet*\n\nA note on security\n\nWe recommend [routing](https://www.cloudflare.com/learning/network-layer/what-is-routing/) all traffic through our global network for comprehensive security filtering and access controls. However, there may be specific cases where you want a subset of traffic to bypass Cloudflare's security filtering and route it directly to the Internet. You can scope this breakout traffic to specific applications from the Cloudflare dashboard.\n\nRefer to [Traffic steering](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/) to learn how Cloudflare routes traffic.\n\n## Add an application to your account\n\nBefore you can add or remove Breakout traffic applications to your Magic WAN Connector, you need to create an account-level list with the applications that you want to configure. Currently, adding to or modifying this list is only possible via API, through the [`managed_app_id`](https://developers.cloudflare.com/api/resources/magic_transit/subresources/apps/methods/create/) endpoint.\n\nTo add applications to your account:\n\nSend a `POST` request to add new apps to your account.\n\nRequired API token permissions\n\nAt least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n* `Magic WAN Write`\n* `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "You can now add this new app to the Breakout traffic list in your Magic WAN Connector.\n\n### Add an application to Magic WAN Connector\n\nYou need to configure Breakout traffic applications for each of your existing sites, as this is a per-site configuration.\n\n* Dashboard\n\n  1. Log in to the [Cloudflare One dashboard](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select the Magic WAN Connector you want to configure > **Edit**.\n  2) Select **Traffic Steering**.\n  3) In **Breakout traffic**, select **Create**.\n  4) Select one or more applications that should bypass Cloudflare filtering from the list. You can also use the search box.\n\n  1. (Optional) You can also pin an application to a WAN port. In **Preferred breakout port**, select the WAN you want to assign your applications to. Refer to [Designate WAN ports for breakout apps](#designate-wan-ports-for-breakout-apps) for more information.\n\n  1) Select **Save**.\n\n  The traffic for the application you chose will now go directly to the Internet and bypass Cloudflare's filtering.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  1. Send a `GET` [request](https://developers.cloudflare.com/api/resources/magic_transit/subresources/apps/methods/list/) to list the applications associated with an account.\n\n     Required API token permissions\n\n     At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n     * `Magic WAN Write`\n     * `Magic WAN Read`\n     * `Magic Transit Read`\n     * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Take note of the `\"managed_app_id\"` value for any application you want to add.\n\n  2. Send a `POST` request to add new apps to the Breakout traffic policy.\n\n     Required API token permissions\n\n     At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n     * `Magic WAN Write`\n     * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### Delete an application from Magic WAN Connector\n\n* Dashboard\n\n  1. Log in to the [Cloudflare One dashboard](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select the Connector you want to configure > **Edit**.\n  2) Select **Traffic Steering**.\n  3) In **Breakout traffic**, find the application you want to delete > select the **three dots** next to it > **Remove application traffic**.\n  4) (Optional) If you have several pages of applications, you can use the search box to quickly find the application you are looking for.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  You need to delete Breakout traffic applications for each of your existing sites, as this is a per-site configuration.\n\n  1. Send a [`GET` request](https://developers.cloudflare.com/api/resources/magic_transit/subresources/apps/methods/list/) to list the applications associated with a site.\n\n     Required API token permissions\n\n     At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n     * `Magic WAN Write`\n     * `Magic WAN Read`\n     * `Magic Transit Read`\n     * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Take note of the `\"id\"` value for the application that want to delete.\n\n  2. Send a `DELETE` request to delete an application from the Breakout traffic policy.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## Designate WAN ports for breakout apps\n\nYou can pin applications to a specific WAN port in Magic WAN Connector when you need control over which WAN port your applications egress from the device. In case your preferred WAN port goes down, Magic WAN Connector automatically fails over to a standard configured WAN port priority.\n\nWith this preferred breakout port, customers have direct control over their local Internet breakout traffic. You can designate a specific WAN uplink as the primary path for your critical applications configured to bypass the Cloudflare network. This provides the predictability and control needed for performance-sensitive applications, ensuring your critical traffic always takes the path you choose.\n\nTo pin applications to a WAN port:\n\n1. Log in to the [Cloudflare One dashboard](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Profiles**.\n3. Select the Magic WAN Connector you want to configure> **Edit**.\n\n1) In **Traffic steering** > **Breakout Traffic** find the application you want to pin to a WAN port.\n2) Select the three dots next to it > **Edit application traffic**.\n3) From the **Preferred breakout port** dropdown, select the WAN port you want to assign to the applications.\n4) Select **Save**.\n\n## NetFlow exports from Magic WAN Connector to Magic Network Monitoring\n\nYou can configure your Magic WAN Connector to export Netflow statistics for local breakout traffic to [Magic Network Monitoring](https://developers.cloudflare.com/magic-network-monitoring). This provides visibility into traffic that leaves your site directly, bypassing the Cloudflare network.\n\nThe Magic WAN Connector appliance uses NetFlow v9 to export flow data for breakout traffic only. You can enable and configure this export by setting the Netflow configuration for the associated site via the Cloudflare API.\n\n### Enable NetFlow exports\n\nNote\n\nTo export NetFlow statistics, you will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/), as well as the `site_id` associated with your Magic WAN Connector.\n\n1. Send a `PUT` request to the Netflow configuration endpoint for your site.\n2. In the JSON body request, you must include the `collector_ip` parameter. To export traffic statistics to Magic Network Monitoring, use the IP address `162.159.65.1`. This is the only field required to enable the feature.\n\nMinimal configuration example:",
      "language": "unknown"
    },
    {
      "code": "1. You can customize the configuration by adding optional fields to the JSON payload. These fields include:\n\n* `collector_port`: The UDP port for the collector. The default is `2055`.\n* `sampling_rate`: The rate at which packets are sampled.\n* `active_timeout`: The timeout for active flows in seconds.\n* `inactive_timeout`: The timeout for inactive flows in seconds.\n\nFull configuration example:",
      "language": "unknown"
    },
    {
      "code": "Your Magic WAN Connector will now begin exporting Netflow data for its breakout traffic, which will be ingested and visualized within your Magic Network Monitoring dashboard. You can retrieve the current settings by sending a `GET` request, or disable the export by sending a `DELETE` request to the same endpoint.\n\n## WARP traffic\n\nIf you have Magic WAN Connector and WARP clients deployed in your premises, Magic WAN Connector automatically routes WARP traffic to the Internet rather than Magic WAN IPsec tunnels. This prevents traffic from being encapsulated twice.\n\nYou may need to configure your firewall to allow this new traffic. Make sure to allow the following IPs and ports:\n\n* **Destination IPs**: `162.159.193.0/24`, `162.159.197.0/24`\n* **Destination ports**: `443`, `500`, `1701`, `2408`, `4443`, `4500`, `8095`, `844`\n\nRefer to [WARP with firewall](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/firewall/) for more information on this topic.\n\n</page>\n\n<page>\n---\ntitle: Prioritized traffic · Cloudflare One docs\ndescription: Prioritized traffic allows you to define which applications are\n  processed first by Connector.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/prioritized-traffic/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/prioritized-traffic/index.md\n---\n\nPrioritized traffic allows you to define which applications Magic WAN Connector should process first. Applications not in the list will be queued behind prioritized traffic.\n\nSimilarly to breakout traffic, prioritized traffic also works via DNS requests inspection.\n\nWarning\n\nPrioritized traffic will not work for applications that use DNS-over-HTTPS.\n\n## Add an application to your account\n\nBefore you can add or remove Prioritized traffic applications to your Magic WAN Connector, you need to create an account-level list with the applications that you want to configure. Currently, adding to or modifying this list is only possible via API, through the [`managed_app_id`](https://developers.cloudflare.com/api/resources/magic_transit/subresources/apps/methods/create/) endpoint.\n\nTo add applications to your account:\n\nSend a `POST` request to add new apps to your account.\n\nRequired API token permissions\n\nAt least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n* `Magic WAN Write`\n* `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "You can now add this new app to the Prioritized traffic list in your Magic WAN Connector.\n\n### Add an application to Magic WAN Connector\n\nYou need to configure Prioritized traffic applications for each of your existing sites, as this is a per-site configuration.\n\n* Dashboard\n\n  1. Log in to the [Cloudflare One dashboard](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select the Magic WAN Connector you want to configure > **Edit**.\n  2) Select **Traffic Steering**.\n  3) In **Prioritized traffic**, select **Create**.\n  4) Select one or more applications that should bypass Cloudflare filtering from the list. You can also use the search box.\n\n  1. Select **Save**.\n\n  The traffic for the application you chose is now processed first by Connector.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  1. Send a `GET` [request](https://developers.cloudflare.com/api/resources/magic_transit/subresources/apps/methods/list/) to list the applications associated with an account.\n\n     Required API token permissions\n\n     At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n     * `Magic WAN Write`\n     * `Magic WAN Read`\n     * `Magic Transit Read`\n     * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Take note of the `\"managed_app_id\"` value for any application you want to add.\n\n  2. Send a `POST` request to add new apps to the Prioritized traffic policy.\n\n     Required API token permissions\n\n     At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n     * `Magic WAN Write`\n     * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### Delete an application from Magic WAN Connector\n\n* Dashboard\n\n  1. Log in to the [Cloudflare One dashboard](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select the Connector you want to configure > **Edit**.\n  2) Select **Traffic Steering**.\n  3) In **Prioritized traffic**, find the application you want to delete > select the **three dots** next to it > **Remove application traffic**.\n  4) (Optional) If you have several pages of applications, you can use the search box to quickly find the application you are looking for.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  You need to delete Prioritized traffic applications for each of your existing sites, as this is a per-site configuration.\n\n  1. Send a [`GET` request](https://developers.cloudflare.com/api/resources/magic_transit/subresources/apps/methods/list/) to list the applications associated with a site.\n\n     Required API token permissions\n\n     At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n     * `Magic WAN Write`\n     * `Magic WAN Read`\n     * `Magic Transit Read`\n     * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Take note of the `\"id\"` value for the application that want to delete.\n\n  2. Send a `DELETE` request to delete an application from the Prioritized traffic policy.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: DHCP relay · Cloudflare One docs\ndescription: DHCP Relay provides a way for DHCP clients to communicate with DHCP\n  servers that are not available on the same local subnet/broadcast domain. When\n  you enable DHCP Relay, Magic WAN Connector forwards DHCP discover messages to\n  a predefined DHCP server, and routes the responses back to the original device\n  that sent the discover message.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-relay/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-relay/index.md\n---\n\nDHCP Relay provides a way for DHCP clients to communicate with DHCP servers that are not available on the same local subnet/broadcast domain. When you enable DHCP Relay, Magic WAN Connector forwards DHCP discover messages to a predefined DHCP server, and routes the responses back to the original device that sent the discover message.",
      "language": "unknown"
    },
    {
      "code": "*The above graph shows Magic WAN Connector sending DHCP discover messages to a DHCP server offsite.*\n\nWarning\n\nDHCP relay will not work if your DHCP server is behind a [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/). To enable DHCP relay functionality, use either a WAN Tunnels tunnel or a CNI connection.\n\nTo configure DHCP relay:\n\n* Dashboard\n\n  1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select your Magic WAN Connector > **Edit**.\n  2) Select **Network Configuration**.\n  3) In **LAN configuration**, select the LAN where you need to configure DHCP relay.\n  4) Select **Edit**.\n  5) Select **This is a DHCP Relay**.\n  6) In **Upstream DHCP server addresses**, enter the IP address of your DHCP server.\n  7) (Optional) If you need to add more DHCP server addresses, select **Add upstream DHCP server address** as many times as needed, and enter the new values.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a [`PUT` request](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/lans/methods/update/) to update the LAN where you want to enable DHCP relay:\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: DHCP static address reservation · Cloudflare One docs\ndescription: \"If you configure your Magic WAN Connector to be a DHCP server, you\n  can also assign IP addresses to specific devices on your network. To reserve\n  IP addresses:\"\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-static-address-reservation/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-static-address-reservation/index.md\n---\n\nIf you configure your Magic WAN Connector to be a DHCP server, you can also assign IP addresses to specific devices on your network. To reserve IP addresses:\n\n* Dashboard\n\n  1. Configure your Magic WAN Connector to be a [DHCP server](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-server/).\n  2. Select **Add DHCP Reservation**.\n  3. In **Hardware Address** enter the [MAC address](https://en.wikipedia.org/wiki/MAC_address) for the device you want a specific IP address for.\n  4. In **IP Address**, enter the IP address for that device.\n  5. (Optional) If you need to reserve more IP addresses, select **Add DHCP Reservation** as many times as needed, and enter the new values.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a [`PUT` request](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/lans/methods/update/) to update the LAN where you want to reserve addresses:\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: DHCP server · Cloudflare One docs\ndescription: \"When you use a static IP address, Magic WAN Connector can also act\n  as a DHCP server in your network. To enable this feature:\"\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-server/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-server/index.md\n---\n\nWhen you use a static IP address, Magic WAN Connector can also act as a DHCP server in your network. To enable this feature:\n\n* Dashboard\n\n  1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select your Magic WAN Connector you want to configure > **Edit**.\n\n  2) Select **Network Configuration**, and scroll down to **LAN configuration**.\n\n  3) In **LAN configuration**, select the LAN where you want to enable DHCP server.\n\n  4) Select **Edit**.\n\n  5) Under **Static addressing**, select **This is a DHCP Server**. You also have to specify:\n\n     * The DNS server address. You can have more than one IP address. Select **Add DNS Server** for each server you want to add.\n     * The DHCP pool start\n     * The DHCP pool end\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a [`PUT` request](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/lans/methods/update/) to update the LAN where you want to enable DHCP server:\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Microsoft Azure VPN Gateway · Cloudflare One docs\ndescription: This tutorial provides information on how to connect Cloudflare\n  Magic WAN to your Azure Virtual Network, using the Azure Virtual Network\n  Gateway.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/azure/azure-vpn-gateway/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/azure/azure-vpn-gateway/index.md\n---\n\nThis tutorial provides information on how to connect Cloudflare Magic WAN to your Azure Virtual Network, using the Azure Virtual Network Gateway.\n\n## Prerequisites\n\nYou will need to have an existing Resource group, Virtual Network, and Virtual Machine created in your Azure account. Refer to [Microsoft's documentation](https://learn.microsoft.com/en-us/azure/virtual-network/) to learn more on how to create these.\n\n## Configure Azure Virtual Network Gateway\n\n### 1. Create a Gateway subnet\n\nYou should already have a Virtual Network (VNET) created with a subnet assigned to it. The next step is to create a gateway subnet that Azure will use for addressing services related to Azure's Virtual Network Gateway. If you already have a gateway subnet, Azure will prevent you from creating a second one. If that is your case, update your gateway subnet settings.\n\n1. Go to your **Virtual Network** > **Subnets**.\n2. Select the option to add a **Gateway subnet**.\n3. Configure the subnet address range. The gateway subnet must be contained by the address space of the virtual network, and have a subnet mask of `/27` or greater.\n4. Make sure all other settings are set to **None**.\n\n### 2. Create a Virtual Network Gateway\n\nThe Virtual Network Gateway is used to form the tunnel to the devices on your premises.\n\nNote\n\nThis configuration guide applies to Azure Virtual Network Gateway which includes the functionality found in the Azure VPN Gateway.\n\nActive/Active and Active/Standby configurations are both supported. Two Azure public IP addresses and two Magic WAN IPsec tunnels are required for the Active/Active configuration.\n\n#### Active/Active configuration\n\n1. Create a Virtual Network Gateway.\n2. Create two new public IP addresses or use existing IPs. Take note of the public IP addresses assigned to the Virtual Network Gateway as these will be the **Customer endpoint** for Magic WAN's IPsec tunnels configuration.\n3. Navigate to the Virtual Network Gateway created earlier.\n4. In **Configuration**, enable **Active-active mode** and disable **Gateway Private IPs**.\n5. Select **Create**.\n\n#### Active/Standby configuration\n\n1. Create a Virtual Network Gateway.\n2. Create a new public IP address or use an existing IP. Take note of the public IP address assigned to the Virtual Network Gateway as this will be the **Customer endpoint** for Magic WAN's IPsec tunnels configuration.\n3. Select the resource group and VNET you have already created.\n4. In **Configuration**, disable **Active-active mode** and **Gateway Private IPs**.\n5. Select **Create**.\n\nNote\n\nThe time it takes for Azure to fully provision the Virtual Network Gateway depends on the deployment region.\n\n## Configure Magic WAN\n\n1. Create an [IPsec tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) in the Cloudflare dashboard.\n\n2. Make sure you have the following settings:\n\n   1. **Interface address**: As the Azure Local Network Gateway will only permit specifying the lower IP address in a `/31` subnet, add the upper IP address within the `/31` subnet selected in [step 2 of the Configure Azure section](#2-configure-local-network-gateway-for-magic-ipsec-tunnel-health-checks). Refer to [Tunnel endpoints](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/) for more details.\n   2. **Customer endpoint**: The Public IP associated with your Azure Virtual Network Gateway. For example, `40.xxx.xxx.xxx`.\n   3. **Cloudflare endpoint**: Use the Cloudflare anycast address you have received from your account team. This will also be the IP address corresponding to the Local Network Gateway in Azure. For example, `162.xxx.xxx.xxx`.\n   4. **Health check rate**: Leave the default option (Medium) selected.\n   5. **Health check type**: Leave the default option (Reply) selected.\n   6. **Health check direction**: Leave default option (Bidirectional) selected.\n   7. **Health check target**: Select **Custom**.\n   8. **Target address**: Enter the same address that is used in the **Customer endpoint** field.\n   9. **Add pre-shared key later**: Select this option to create a PSK that will be used later in Azure.\n   10. **Replay protection**: **Enable**.\n\n3. If you are using the Active/Active configuration, select **Add IPsec tunnel** and repeat step 2 to create the second Magic WAN IPsec tunnel. Use the same **Cloudflare endpoint** as for the first tunnel.\n\n4. Select **Add Tunnels** when you are finished.\n\n5. The Cloudflare dashboard will show you a list of your tunnels. Edit the tunnel(s) you have created > select **Generate a new pre-shared key** > copy the generated key. If using the Active/Active configuration, select **Change to a new custom pre-shared key** on the second tunnel and use the PSK generated for the first tunnel.\n\n6. Create [static routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) for your Azure Virtual Network subnets, specifying the newly created tunnel as the next hop.\n\nNote\n\nBoth tunnels in an Active/Active configuration must use the same **Cloudflare endpoint**, because an Active/Active Azure VPN connection creates two tunnels to the same remote address.\n\n## Complete the Azure Configuration\n\n### 1. Create a Local Network Gateway\n\nThe Local Network Gateway typically refers to your on-premises location. In this case, the Local Network Gateway represents the Cloudflare side of the connection.\n\nWe recommend creating a Local Network Gateway for your Cloudflare IPsec tunnel.\n\n1. Create a new local network gateway.\n2. In **Instance details** > **Endpoint**, select **IP address** and enter the Cloudflare anycast address in the IP address field.\n3. In **Address space(s)**, specify the address range of any subnets you wish to access remotely through the Magic WAN connection. For example, if you want to reach a network with an IP range of `192.168.1.0/24`, and this network is connected to your Magic WAN tenant, you would add `192.168.1.0/24` to the local network gateway address space.\n4. Go to the **Advanced** tab > **BGP settings**, and make sure you select **No**.\n\nNote\n\nA single Cloudflare anycast address must be used in both Active/Active and Active/Standby configurations.\n\n### 2. Configure Local Network Gateway for Magic IPsec tunnel health checks\n\nMagic WAN uses [Tunnel Health Checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/) to monitor whether a tunnel is available.\n\nTunnel health checks make use of ICMP probes sent from the Cloudflare side of the Magic IPsec tunnel to the remote endpoint (Azure). Probes are sent from the tunnel's interface address, which you specify in two places:\n\n1. **Cloudflare Dashboard:** In your Magic IPsec tunnel configuration as the address of the virtual tunnel interface (VTI) (so that Cloudflare knows what address to send probes from). Cloudflare requires this address in CIDR notation with a `/31` netmask.\n2. **Azure Portal:** In your VPN site's address space (so that Azure routes probe responses back over the tunnel). Azure requires this address in CIDR notation with a `/32` netmask.\n\nCloudflare recommends customers select a unique `/31` subnet ([RFC 1918 - Address Allocation for Private Internets](https://datatracker.ietf.org/doc/html/rfc1918)) for each IPsec tunnel which is treated as a Point-to-Point Link and provides the ideal addressing scheme to satisfy both requirements.\n\nExample:\n\n* Select 10.252.3.55/31 as your unique point-to-point link subnet.\n* In the Cloudflare dashboard, set `10.252.3.55/31` as your tunnel's **IPv4 Interface address** (refer to [Configure Magic WAN](#configure-magic-wan)).\n* In the Azure portal, add `10.252.3.55/32` to your Local Network Gateway's **Address space**.\n\nNote\n\nIt is important to ensure the subnet selected for the Interface Address does not overlap with any other subnet.\n\nNote\n\nRefer to RFC 3021 for more information on using 31-bit prefixes on [IPv4 Point-to-Point Links](https://datatracker.ietf.org/doc/html/rfc3021).\n\nTo configure the Address Space for the Local Network Gateway to support Tunnel Health Checks:\n\n1. Edit the Local Network Gateway configured in the previous section.\n2. Select **Connections**.\n3. Under **Address Space(s)** add the Interface Address of the Magic IPsec Tunnel from the Cloudflare dashboard in CIDR notation (for example, `10.252.3.55/32`).\n4. If using an Active/Active configuration, also add the Interface Address of the second Magic IPsec Tunnel from the Cloudflare Dashboard in CIDR notation (for example, `10.252.3.56/32`) under **Address Space(s)**. Both tunnel interface addresses must be configured in the Local Network Gateway Address Space to ensure both tunnels remain healthy.\n5. Select **Save**.\n\nNote\n\nThe Magic IPsec Tunnel Interface Address should be entered as a `/31` in the Cloudflare Dashboard, but as a `/32` when configuring the Local Network Gateway Address Space(s) in the Azure portal.\n\n### 3. Create an IPsec VPN Connection\n\nChoose the following settings when creating your VPN Connection:\n\n1. **Virtual network gateway**: Select the Virtual Network Gateway you have created in step 2.\n\n2. **Local network gateway**: Select the Local Network Gateway created in step 3.\n\n3. **Use Azure Private IP Address**: **Disabled**\n\n4. **BGP**: **Disabled**\n\n5. **IPsec / IKE policy**: **Custom**\n\n   1. **IKE Phase 1**\n\n      1. **Encryption**: *GCMAES256*\n      2. **Integrity/PRF**: *SHA384*\n      3. **DH Group**: *ECP384*\n\n   2. **IKE Phase 2(IPsec)**\n\n      1. **IPsec Encryption**: *GCMAES256*\n      2. **IPsec Integrity**: *GCMAES256*\n      3. **PFS Group**: *ECP384*\n\n   3. **IPsec SA lifetime in KiloBytes**: `0`\n\n   4. **IPsec SA lifetime in seconds**: `28800`\n\n   5. **Use policy based traffic selector**: **Disable**\n\n   6. **DPD timeout in seconds**: `45`\n\n   7. **Connection mode**: **InitiatorOnly**\n\n   8. **Use custom traffic selectors**: **Disabled**\n\n6. After the connection is created, select **Settings** > **Authentication**, and input your PSK (this will need to match the PSK used by the Magic WAN configuration).\n\nRepeat this process to define the settings for the Connection to the Local Network Gateway that corresponds to the redundant Cloudflare anycast IP address.\n\n### 4. Route all Internet traffic through Magic WAN and Cloudflare Gateway\n\nCloudflare Zero Trust customers can route Internet-bound traffic through Magic WAN to the Internet through Cloudflare Gateway.\n\nMicrosoft does not permit specifying a default route (`0.0.0.0/0`) under Address Space in the Local Network Gateway. However, it is possible to work around this limitation through the use of route summarization.\n\n1. Go to **Local network gateways** and select the desired object.\n2. Go to **Configuration** > **Address Space(s)** and specify the following two subnets: `0.0.0.0/1` & `128.0.0.0/1`.\n3. Do not remove the subnet configured to support the Tunnel Health Checks.\n4. Select **Save**.\n\n## Install Cloudflare Zero Trust CA Certificate\n\nIf you opt to route all Internet bound traffic through Magic WAN and want to take advantage of [HTTPS TLS decryption](https://developers.cloudflare.com/cloudflare-one/traffic-policies/http-policies/tls-decryption/), it will be necessary to install and trust the Cloudflare Zero Trust root CA certificate on your user's devices. You can either install the certificate provided by Cloudflare (default option), or generate your own custom certificate and upload it to Cloudflare.\n\nMore details on how to install the root CA certificate can be found in [User-side certificates](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/user-side-certificates/) in the Cloudflare Zero Trust documentation.\n\nOnce the root CA certificate is installed, open a web browser or use curl to validate Internet connectivity:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Note\n\nICMP (ping/traceroute) will work to remote Magic WAN sites, but is not forwarded to the Internet. Please ensure you validate connectivity via HTTP.\n\n## Validate connectivity and disable Azure Virtual Network Gateway anti-replay protection\n\nOnce you have determined that connectivity has been established, Cloudflare recommends you disable anti-replay protection for the Azure Virtual Network Gateway site-to-site VPN connection. This can be accomplished through Microsoft Azure API.\n\n1. Determine the API token via PowerShell:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "1. Issue the API call to display the details of the site-to-site VPN Connection associated with the Azure Virtual Network Gateway (`GET` request):",
      "language": "unknown"
    },
    {
      "code": "1. Copy/paste the entire response into a text editor:",
      "language": "unknown"
    },
    {
      "code": "1. Locate the line that controls disabling IPsec anti-replay protection, and change it from `false` to `true`:",
      "language": "unknown"
    },
    {
      "code": "1. Upload the entire response in a subsequent API call (`PUT` request):",
      "language": "unknown"
    }
  ],
  "headings": [
    {
      "level": "h2",
      "text": "TLS decryption",
      "id": "tls-decryption"
    },
    {
      "level": "h2",
      "text": "Add an application to your account",
      "id": "add-an-application-to-your-account"
    },
    {
      "level": "h3",
      "text": "Add an application to Magic WAN Connector",
      "id": "add-an-application-to-magic-wan-connector"
    },
    {
      "level": "h3",
      "text": "Delete an application from Magic WAN Connector",
      "id": "delete-an-application-from-magic-wan-connector"
    },
    {
      "level": "h2",
      "text": "Designate WAN ports for breakout apps",
      "id": "designate-wan-ports-for-breakout-apps"
    },
    {
      "level": "h2",
      "text": "NetFlow exports from Magic WAN Connector to Magic Network Monitoring",
      "id": "netflow-exports-from-magic-wan-connector-to-magic-network-monitoring"
    },
    {
      "level": "h3",
      "text": "Enable NetFlow exports",
      "id": "enable-netflow-exports"
    },
    {
      "level": "h2",
      "text": "WARP traffic",
      "id": "warp-traffic"
    },
    {
      "level": "h2",
      "text": "Add an application to your account",
      "id": "add-an-application-to-your-account"
    },
    {
      "level": "h3",
      "text": "Add an application to Magic WAN Connector",
      "id": "add-an-application-to-magic-wan-connector"
    },
    {
      "level": "h3",
      "text": "Delete an application from Magic WAN Connector",
      "id": "delete-an-application-from-magic-wan-connector"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Configure Azure Virtual Network Gateway",
      "id": "configure-azure-virtual-network-gateway"
    },
    {
      "level": "h3",
      "text": "1. Create a Gateway subnet",
      "id": "1.-create-a-gateway-subnet"
    },
    {
      "level": "h3",
      "text": "2. Create a Virtual Network Gateway",
      "id": "2.-create-a-virtual-network-gateway"
    },
    {
      "level": "h2",
      "text": "Configure Magic WAN",
      "id": "configure-magic-wan"
    },
    {
      "level": "h2",
      "text": "Complete the Azure Configuration",
      "id": "complete-the-azure-configuration"
    },
    {
      "level": "h3",
      "text": "1. Create a Local Network Gateway",
      "id": "1.-create-a-local-network-gateway"
    },
    {
      "level": "h3",
      "text": "2. Configure Local Network Gateway for Magic IPsec tunnel health checks",
      "id": "2.-configure-local-network-gateway-for-magic-ipsec-tunnel-health-checks"
    },
    {
      "level": "h3",
      "text": "3. Create an IPsec VPN Connection",
      "id": "3.-create-an-ipsec-vpn-connection"
    },
    {
      "level": "h3",
      "text": "4. Route all Internet traffic through Magic WAN and Cloudflare Gateway",
      "id": "4.-route-all-internet-traffic-through-magic-wan-and-cloudflare-gateway"
    },
    {
      "level": "h2",
      "text": "Install Cloudflare Zero Trust CA Certificate",
      "id": "install-cloudflare-zero-trust-ca-certificate"
    },
    {
      "level": "h2",
      "text": "Validate connectivity and disable Azure Virtual Network Gateway anti-replay protection",
      "id": "validate-connectivity-and-disable-azure-virtual-network-gateway-anti-replay-protection"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Start Azure configuration",
      "id": "start-azure-configuration"
    },
    {
      "level": "h3",
      "text": "1. Create a Virtual WAN",
      "id": "1.-create-a-virtual-wan"
    },
    {
      "level": "h3",
      "text": "2. Create a Virtual WAN Hub",
      "id": "2.-create-a-virtual-wan-hub"
    },
    {
      "level": "h3",
      "text": "3. Create a VPN site",
      "id": "3.-create-a-vpn-site"
    },
    {
      "level": "h3",
      "text": "4. Configure VPN site for Magic IPsec tunnel health checks",
      "id": "4.-configure-vpn-site-for-magic-ipsec-tunnel-health-checks"
    },
    {
      "level": "h3",
      "text": "5. Create a Virtual Network Connection",
      "id": "5.-create-a-virtual-network-connection"
    },
    {
      "level": "h2",
      "text": "Configure Magic WAN",
      "id": "configure-magic-wan"
    },
    {
      "level": "h2",
      "text": "Finish Azure Configuration",
      "id": "finish-azure-configuration"
    },
    {
      "level": "h3",
      "text": "1. Create an IPsec VPN Gateway Connection",
      "id": "1.-create-an-ipsec-vpn-gateway-connection"
    }
  ],
  "url": "llms-txt#if-the-profile_payload_id_prefix-is-not-found,-exit-0-to-wait-for-the-next-agent-run.",
  "links": []
}