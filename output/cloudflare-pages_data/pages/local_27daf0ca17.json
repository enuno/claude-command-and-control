{
  "title": "local",
  "content": "#\n#1  inr.ruhep\nsh\nip rule add from 172.64.240.252 lookup viatunicmp\nsh\nip route add default dev vti0 table viatunicmp\nbash\nipsec start\nbash\nSecurity Associations (1 up, 0 connecting):\ncloudflare-ipsec[1]: ESTABLISHED 96 minutes ago, <IPSEC_TUNNEL_IDENTIFIER>.ipsec.cloudflare.com]...162.159.67.88[162.159.67.88]\ncloudflare-ipsec{4}:  INSTALLED, TUNNEL, reqid 1, ESP SPIs: c4e20a95_i c5373d00_o\ncloudflare-ipsec{4}:   0.0.0.0/0 === 0.0.0.0/0\nsh\nsudo tcpdump -i <OUTGOING_INTERFACE> esp and host <TUNNEL_CLOUDFLARE_ENDPOINT_IP>\nsh\nsudo tcpdump -i vti0 host 172.64.240.252\nbash\n   set vpn ipsec-performance anti-replay window-size 0\n   bash\n   system gre tunnel add name <NAME_OF_YOUR_GRE_TUNNEL> local-gw <WAN_PORT> remote-gw <REMOTE_GATEWAY_IP_ADDRESS> local-ip <LOCAL_IP_ADDRESS> remote-ip <REMOTE_IP_ADDRESS>\n   bash\nsystem gre route add net <IP_ADDRESS> tunnelname <TUNNEL_NAME>\nbash\ncurl --request PUT \\\nhttps://api.cloudflare.com/client/v4/accounts/{account_id}/magic/ipsec_tunnels/{tunnel_id} \\\n--header \"X-Auth-Email: <EMAIL>\" \\\n--header \"X-Auth-Key: <API_KEY>\" \\\n--header \"Content-Type: application/json\" \\\n--data '{\n  \"health_check\": {\n    \"enabled\": true,\n    \"target\": \"172.64.240.252\",\n    \"type\": \"request\",\n    \"rate\": \"mid\"\n  }\n}'\nsh\ntcpdump -nn proto 1\nsh\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on any, link-type LINUX_SLL (Linux cooked v1), capture size 262144 bytes\n\n13:09:55.500453 xfrm1, IN: IP 172.70.51.31 > 172.64.240.252: ICMP echo request, id 33504, seq 0, length 64\n13:09:55.500480 xfrm1, OUT: IP 172.64.240.252 > 172.70.51.31: ICMP echo reply, id 33504, seq 0, length 64\n\n13:09:55.504669 xfrm1, IN: IP 172.71.29.66 > 172.64.240.252: ICMP echo request, id 60828, seq 0, length 64\n13:09:55.504695 xfrm1, OUT: IP 172.64.240.252 > 172.71.29.66: ICMP echo reply, id 60828, seq 0, length 64\nbash\nset interfaces vti <name of the vti interface> address\n'<PRIVATE_IP_ADDRESS_OF_IPSEC_TUNNEL_INTERFACE>'\nset vpn ipsec esp-group <NAME_OF_ESP_GROUP> compression 'disable'\nset vpn ipsec esp-group <NAME_OF_ESP_GROUP> lifetime '86400'\nset vpn ipsec esp-group <NAME_OF_ESP_GROUP> mode 'tunnel'\nset vpn ipsec esp-group <NAME_OF_ESP_GROUP> pfs 'enable'\nset vpn ipsec esp-group <NAME_OF_ESP_GROUP> proposal 1 encryption 'aes256gcm128'\nset vpn ipsec esp-group <NAME_OF_ESP_GROUP> proposal 1 hash 'sha512'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> close-action 'none'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> dead-peer-detection action 'restart'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> dead-peer-detection interval '30'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> dead-peer-detection timeout '120'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> ikev2-reauth 'no'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> key-exchange 'ikev2'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> lifetime '28800'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> mobike 'disable'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> proposal 1 dh-group '20'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> proposal 1 encryption 'aes256gcm128'\nset vpn ipsec ike-group <NAME_OF_IKE_GROUP> proposal 1 hash 'sha512'\nset vpn ipsec ipsec-interfaces interface '<UPLINK_INTF_TO_INTERNET/WAN>'\nset vpn ipsec logging log-level '2'\nset vpn ipsec options disable-route-autoinstall\nset vpn ipsec site-to-site peer <CF_ANYCAST_IP> authentication id '<IPSEC_ID_STRING_IN_RESULT_OF_PSK_KEY-GEN_VIA_CF_API>'\nset vpn ipsec site-to-site peer <CF_ANYCAST_IP> authentication pre-shared-secret '<PSK_KEY_STRING_GENERATED_VIA_CF_API>'\nset vpn ipsec site-to-site peer <CF_ANYCAST_IP> authentication remote-id '<CF_ANYCAST_IP>'\nset vpn ipsec site-to-site peer <CF_ANYCAST_IP> connection-type 'initiate'\nset vpn ipsec site-to-site peer <CF_ANYCAST_IP> ike-group '<NAME_OF_IKE_GROUP>'\nset vpn ipsec site-to-site peer <CF_ANYCAST_IP> ikev2-reauth 'no'\nset vpn ipsec site-to-site peer <CF_ANYCAST_IP> local-address '<IP_ADDR_OF_UPLINK_INTF_TO_INTERNET/WAN>'\nset vpn ipsec site-to-site peer <CF_ANYCAST_IP> vti bind '<NAME_OF_VTI_INTERFACE>'\nset vpn ipsec site-to-site peer <CF_ANYCAST_IP> vti esp-group '<NAME_OF_ESP_GROUP>'\nmermaid\n\tflowchart LR\n\taccTitle: In this example, there are LANs where traffic flows between each other, instead of going to Cloudflare first.\n\t\t\ta(Magic WAN Connector) <---> b(Internet) <---> c(Cloudflare)\n\nsubgraph Customer site\n\t\t\td[LAN 1] <---> a\n\t\t\te[LAN 2] <---> a\n\t\t\tg[LAN 3] <---> a\n\t\t\th[LAN 4] <---> a\n\t\t\tend\n\t\t\tclassDef orange fill:#f48120,color: black\n\t\t\tclass a,c orange\n\nlinkStyle 0,1,2,3 stroke:#f48120,stroke-width:3px\n\t\t\tlinkStyle 4,5 stroke:red,stroke-width:3px\nbash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/acls\" \\\n    --request POST \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"description\": \"<POLICY_DESCRIPTION>\",\n      \"forward_locally\": true,\n      \"lan_1\": {\n          \"lan_id\": \"<LAN_ID>\",\n          \"lan_name\": \"<LAN_NAME>\",\n          \"ports\": [\n              1\n          ],\n          \"subnets\": [\n              \"192.0.2.1\"\n          ]\n      },\n      \"lan_2\": {\n          \"lan_id\": \"<LAN_ID>\",\n          \"lan_name\": \"<LAN_NAME\",\n          \"ports\": [\n              1\n          ],\n          \"subnets\": [\n              \"192.0.2.1\"\n          ]\n      },\n      \"name\": \"<POLICY_NAME>\",\n      \"protocols\": [\n          \"tcp\"\n      ]\n    }'\n  json\n  {\n    \"errors\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"messages\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"result\": {\n      \"id\": \"023e105f4ecef8ad9ca31a8372d0c353\",\n      \"description\": \"Allows local traffic between PIN pads and cash register.\",\n      \"forward_locally\": true,\n      \"lan_1\": {\n        \"lan_id\": \"lan_id\",\n        \"lan_name\": \"lan_name\",\n        \"port_ranges\": [\n          \"8080-9000\"\n        ],\n        \"ports\": [\n          1\n        ],\n        \"subnets\": [\n          \"192.0.2.1\"\n        ]\n      },\n      \"lan_2\": {\n        \"lan_id\": \"lan_id\",\n        \"lan_name\": \"lan_name\",\n        \"port_ranges\": [\n          \"8080-9000\"\n        ],\n        \"ports\": [\n          1\n        ],\n        \"subnets\": [\n          \"192.0.2.1\"\n        ]\n      },\n      \"name\": \"PIN Pad - Cash Register\",\n      \"protocols\": [\n        \"tcp\"\n      ],\n      \"unidirectional\": true\n    },\n    \"success\": true\n  }\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/acls/$ACL_ID\" \\\n    --request PUT \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"description\": \"<POLICY_DESCRIPTION>\",\n      \"forward_locally\": true,\n      \"lan_1\": {\n          \"lan_id\": \"<LAN_ID>\",\n          \"lan_name\": \"<LAN_NAME>\",\n          \"ports\": [\n              1\n          ],\n          \"subnets\": [\n              \"192.0.2.1\"\n          ]\n      },\n      \"lan_2\": {\n          \"lan_id\": \"<LAN_ID>\",\n          \"lan_name\": \"<LAN_NAME>\",\n          \"ports\": [\n              1\n          ],\n          \"subnets\": [\n              \"192.0.2.1\"\n          ]\n      },\n      \"name\": \"<POLICY_NAME>\",\n      \"protocols\": [\n          \"tcp\"\n      ]\n    }'\n  json\n  {\n    \"errors\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"messages\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"result\": {\n      \"id\": \"023e105f4ecef8ad9ca31a8372d0c353\",\n      \"connector_id\": \"ac60d3d0435248289d446cedd870bcf4\",\n      \"description\": \"description\",\n      \"ha_mode\": true,\n      \"location\": {\n        \"lat\": \"37.6192\",\n        \"lon\": \"122.3816\"\n      },\n      \"name\": \"site_1\",\n      \"secondary_connector_id\": \"8d67040d3835dbcf46ce29da440dc482\"\n    },\n    \"success\": true\n  }\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/acls/$ACL_ID\" \\\n    --request DELETE \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\"\n  mermaid\n\tflowchart TB\n\taccTitle: Routed subnets\n\taccDescr: Some LANs are complex, and might have additional subnets behind L3 routers.\n\nsubgraph b [Magic WAN Connector]\n\tdirection TB\n\tc(LAN 1)\n\td(LAN n)\n\tend\n\nc --- e(subnet x):::blue\n\td --- f(subnet 192.168.100.0/24):::blue\n\nf---|192.168.100.10|g(Layer 3 router)\n\ng --- h(routed subnet y):::red\n\tg --- i(192.168.200.0/24):::red\n\tg --- j(layer 3 router)\n\tj --- k(routed subnet z):::red\n\nclassDef blue fill:#add8e6,color: black\n\tclassDef red fill:#ff6900,color: black\nbash\n$logFile = \"${env:TEMP}/fleet-install-software.log\"\n\n$installProcess = Start-Process msiexec.exe `\n  -ArgumentList \"/quiet /norestart ORGANIZATION=your-team-name SUPPORT_URL=https://example.com /lv ${logFile} /i `\"${env:INSTALLER_PATH}`\"\" `\n  -PassThru -Verb RunAs -Wait\n\nGet-Content $logFile -Tail 500\n\nExit $installProcess.ExitCode\n\n} catch {\n  Write-Host \"Error: $_\"\n  Exit 1\n}\nsh\n#!/bin/sh",
  "code_samples": [
    {
      "code": "1. Open the console and add a rule to match the routing table just created. This rule instructs the system to use routing table `viatunicmp` if the packet's source address is `172.64.240.252`:",
      "language": "unknown"
    },
    {
      "code": "1. Add a route to the newly created routing table `viatunicmp`. This is the default route via the interface `vti0` in the `viatunicmp` table.",
      "language": "unknown"
    },
    {
      "code": "1. Now, you can `start` IPsec. You can also `stop`, `restart` and show the `status` for the IPsec connection:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## 5. Check connection status\n\nAfter you finish configuring StrongSwan with Magic WAN, you can use tcpdump to investigate the status of health checks originated from Cloudflare.",
      "language": "unknown"
    },
    {
      "code": "In this example, the outgoing Internet interface shows that the IPsec encrypted packets (ESP) from Cloudflare's health check probes (both the request and response) are going through the IPsec tunnel we configured.\n\n![tcpdump shows the IPsec encrypted packets from Cloudflare's health probbes](https://developers.cloudflare.com/_astro/ipsec.CuiOceRh_1V6PpQ.webp)\n\nYou can also run tcpdump on `vti0` to check the decrypted packets.",
      "language": "unknown"
    },
    {
      "code": "![If you run tcpdump on vti0 you can check for decrypted packets](https://developers.cloudflare.com/_astro/tcpdump.CaDJay4I_22Gq1n.webp)\n\n</page>\n\n<page>\n---\ntitle: Ubiquiti · Cloudflare One docs\ndescription: Connect a Ubiquiti UniFi Gateway to Cloudflare's network using\n  Magic WAN. These steps use the Cloud Gateway Max (UCG-Max) but work with other\n  UniFi gateways supporting route-based IPsec VPNs, like the Dream Machine\n  series.\nlastUpdated: 2025-11-19T12:29:18.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/ubiquiti/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/ubiquiti/index.md\n---\n\nConnect a Ubiquiti UniFi Gateway to Cloudflare's network using Magic WAN. These steps use the Cloud Gateway Max (UCG-Max) but work with other UniFi gateways supporting route-based IPsec VPNs, like the Dream Machine series.\n\n## Prerequisites\n\n* Cloudflare account with Magic WAN enabled (contact your account team)\n\n* UniFi Cloud Gateway or Dream Machine with IPsec support\n\n* UniFi Network Application (self-hosted or cloud)\n\n* Static public IP from your ISP\n\n* Admin access to both Cloudflare and UniFi\n\n* Gather a **Magic Anycast IPv4** address from the **Leased IPs** section in the dashboard\n\n  * [Go to **Leased IPs**](https://dash.cloudflare.com/?to=/:account/ip-addresses/leased-ips)\n  * Contact your account team if you do not see any IPs listed.\n\n## 1. Configure Magic WAN\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **WAN Tunnels**, and select **Create**.\n\n1) Select **IPsec tunnel** > **Next**, and fill in the following settings:\n\n   * **Name**: `unifi-gw-primary`\n\n   * **IPv4 Interface Address**: `10.252.2.28/31` or refer to the [Tunnel endpoints documentation](https://developers.cloudflare.com/magic-wan/configuration/manually/how-to/configure-tunnel-endpoints/)\n\n   * **Customer Endpoint**: This should be your UniFi Gateway's WAN IP (for example, `203.0.113.10`)\n\n   * **Cloudflare Endpoint**: This should be one of the IPv4 addresses gathered from Leased IPs.\n\n   * Under **Tunnel Health checks**, select:\n\n     * **Health check rate**: Set to desired level\n     * **Health check type**: *Request*\n     * **Health check direction**: *Bidirectional*\n     * **Health check target**: *Default*\n\n   * Under **Pre-shared key**:\n     * Select **Add pre-shared key later**. This key will be given during the UniFi site-to-site VPN configuration.\n\n## 2. Configure site-to-site VPN on UniFi\n\n1. In UniFi Network, go to **Settings** > **VPN** > **Site-to-Site VPN**.\n\n2. Select **Create New**.\n\n3. Configure the following settings:\n\n   * **VPN Type:** `IPsec`.\n   * **Name:** `Cloudflare-Magic-WAN`.\n   * **Pre-shared key:** Copy this key. You need it for the Magic WAN tunnel.\n   * **Local IP:** Select the WAN interface (for example, `WAN1`).\n   * **Remote IP:** Enter the Cloudflare endpoint IP from [Step 1](#1-configure-magic-wan).\n   * **VPN Method:** Route Based.\n   * **Tunnel IP:** `10.252.2.29/31` or refer to the [Tunnel endpoints documentation](https://developers.cloudflare.com/magic-wan/configuration/manually/how-to/configure-tunnel-endpoints/).\n   * **Remote Networks:** Inside Cloudflare tunnel address (for example, `10.252.2.28/31`) and other remote subnets to access through Magic WAN.\n\n4. Set Advanced settings:\n\n   * **Key Exchange Version**: IKEv2.\n   * **IKE Encryption**: AES-256.\n   * **IKE Hash**: SHA256.\n   * **IKE DH Group**: 14.\n   * **IKE Lifetime**: 28800.\n   * **ESP Encryption**: AES-256.\n   * **ESP Hash**: SHA256.\n   * **ESP DH Group**: 14.\n   * **ESP Lifetime**: 28800.\n   * **PFS**: Enabled.\n   * **Local Authentication ID**: Auto.\n   * **Remote Authentication ID**: Uncheck **Auto**, and enter the Cloudflare Endpoint IP from [Step 1](#1-configure-magic-wan).\n   * **MTU**: 1436.\n\n5. Select **Apply**\n\n## 3. Add pre-shared key to Cloudflare\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. In **WAN tunnels**, find the IPsec tunnel you have just created.\n\n1) Select your tunnel and then **Edit**.\n2) Paste the preshared key from [Step 2](#2-configure-site-to-site-vpn-on-unifi).\n3) Select **Save**.\n\n## 4. Configure Routes\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Routes** > **WAN routes** > **Create**.\n\n1) Enter the following settings:\n\n   * **Prefix**: Your local network (for example, `192.168.1.0/24`).\n   * **Tunnel/Next hop**: Select your tunnel.\n   * **Priority**: `100`.\n\n2) Select **Add routes** to add your static route.\n\n## Verify connections\n\nTo check your connections are working correctly, wait a few minutes, and then access both Cloudflare and UniFi to verify the tunnel's status:\n\nCloudflare\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Insights**.\n2. Go to **Network visibility** > **WAN connector health**.\n3. Find the tunnel you have just created and make sure its status shows **Up**. Refer to [Check tunnel health in the dashboard](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/check-tunnel-health-dashboard/) for more information.\n\nUniFi\n\nGo to **Settings** > **VPN**, and make sure the status is **Connected**.\n\n## Troubleshooting\n\n**Tunnel down:**\n\n* Verify Peer IP, pre-shared key, and IPsec settings match on both sides\n* Check that the ISP is not blocking UDP ports `500`/`4500`\n\n**Traffic not routing:**\n\n* Verify Remote Subnets setting in UniFi VPN configuration\n* Check firewall rules are not blocking VPN traffic\n\n**Health check fails:**\n\n* Allow ICMP from Cloudflare to the customer-side tunnel IP\n* Target should be the `/31` interface IP, not your LAN gateway\n\n## Policy-based routing\n\nTo route only specific devices through Cloudflare (UniFi Network Application):\n\n1. Remove necessary routes from Remote Subnets in your VPN configuration.\n\n2. Go to **Settings** > **Policy Table**.\n\n3. Under **Policy Engine** select **Create New Policy** with the following settings:\n\n   * Select `Route`.\n   * **Name**: Provide a name for the policy.\n   * **Type**: *Policy-Based*.\n   * **Interface/VPN Tunnel**: Select the VPN Tunnel (for example, `Cloudflare-Magic-WAN`).\n   * **Kill Switch**: *Enabled* (recommended).\n   * **Source**: Select `Device/Network` and then choose the Device(s) or Network(s).\n   * **Destination**: *Any*.\n   * **Interface**: Your VPN tunnel.\n\n## Next Steps\n\n* Use [Magic Firewall](https://developers.cloudflare.com/magic-firewall/) for network policies.\n* Configure a second tunnel for redundancy.\n* Monitor traffic in the Magic WAN dashboard.\n\n***\n\nYou are now routing traffic through Cloudflare's network using Magic WAN.\n\n</page>\n\n<page>\n---\ntitle: Sophos Firewall · Cloudflare One docs\ndescription: \"This tutorial shows you how to use Magic WAN with the following\n  versions of the Sophos Firewall:\"\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/sophos-firewall/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/sophos-firewall/index.md\n---\n\nThis tutorial shows you how to use Magic WAN with the following versions of the Sophos Firewall:\n\n* **Sophos form factor tested:**\n\n  * Sophos Firewall XGS and XG series hardware\n  * Sophos Firewall virtual appliance on VMware\n\n* **Sophos software versions tested:**\n\n  * SFOS Version 19.0 MR2-Build 472\n  * SFOS Version 19.5.1 MR1-Build 278\n\nYou can connect through[ Generic Routing Encapsulation (GRE) or IPsec tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/) to Magic WAN.\n\n## IPsec connection\n\nThe following instructions show how to setup an IPsec connection on your Sophos Firewall device. Settings not explicitly mentioned can be left with their default values.\n\n### 1. Add an IPsec profile\n\n1. Go to **System** > **Profiles**.\n\n2. In **IPsec profiles**, select **Add**.\n\n3. In the **General settings** group, make sure you have the following settings:\n\n   * **Name**: Give your profile a descriptive name.\n   * **Key exchange**: **IKEv2**\n   * **Authentication mode**: **Main mode**\n\n4. In the **Phase 1** group, make sure you have the following settings:\n\n   * **DH group (key group)**: *20*\n   * **Encryption**: *AES256*\n   * **Authentication**: *SHA2 256*\n\n5. In the **Phase 2** group, select the following:\n\n   * **PFS group (DH group)**: *Same as phase-1*\n   * **Key life**: *28800*\n   * **Encryption**: *AES256*\n   * **Authentication**: *SHA2 256*\n\n6. Enable **Dead Peer Detection**.\n\n7. In **When peer unreachable**, select *Re-initiate*.\n\n8. Select **Save**.\n\n### 2. Create IPsec connection tunnel\n\nThe next step involves configuring a site-to-site IPsec VPN connection on your Sophos Firewall device.\n\n1. Go to **Configure** > **Site-to-site VPN**.\n\n2. In **IPsec**, select **Add**.\n\n3. In the **General settings** group, make sure you have the following settings:\n\n   * **Name**: Give your site-to-site VPN a descriptive name.\n   * **Connection type**: *Tunnel interface*\n   * **Gateway type**: *Initiate the connection*\n\n4. In the **Encryption** group, make sure you have the following settings:\n   * **Authentication type**: **Preshared key**\n\n5. In **Gateway settings**, make sure you have the following settings:\n\n   * **Gateway address**: Enter your Cloudflare anycast IP address provided by Cloudflare.\n   * **Local ID type**: Add the [IKE ID](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/gre-ipsec-tunnels/#supported-ike-id-formats) provided by Cloudflare.\n\n![Configure an IPsec tunnel.](https://developers.cloudflare.com/_astro/2-ipsec-tunnel.EuRwmMGh_wIMKi.webp)\n\nAfter setting up your IPsec tunnel, it will show up on the IPsec connections list with an **Active** status.\n\n![The IPsec tunnel should show up on the IPsec connections list.](https://developers.cloudflare.com/_astro/2b-ipsec-tunnel.DcLZdCzX_2gDzJX.webp)\n\n### 3. Assign the XFRM interface address\n\nYou must use an interface address from the `/31` subnet required to [configure tunnel endpoints](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/) on Magic WAN.\n\n1. Go to **Configure** > **Network**.\n2. In **Interfaces**, select the corresponding interface to the IPsec tunnel you created in [step 2](#2-create-ipsec-connection-tunnel).\n3. Edit the interface to assign an address from the `/31` subnet required to [configure tunnel endpoints](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/). When you are finished, it should look similar to the following:\n\n![Configure a XFRM interface.](https://developers.cloudflare.com/_astro/3-xfrm-interface.Dks8X1E8_ZPYrQT.webp)\n\n### 4. Add a firewall rule\n\n1. Go to **Protect** > **Rules and policies**.\n2. In **Firewall rules**, create a firewall rule with the criteria and security policies from your company that allows traffic to flow between Sophos and Magic WAN.\n\n![Create a firewall rule with the criteria and security policies from your company](https://developers.cloudflare.com/_astro/4-firewall-rule.CfVt6IDY_Z1zkMRq.webp)\n\n### 5. Disable IPsec anti-replay\n\nYou will have to disable IPsec Anti-Replay on your Sophos Firewall. Changing the anti-replay settings restarts the IPsec service, which causes tunnel-flap for all IPsec tunnels. This will also disable IPsec anti-replay protection for all VPN connections globally. Plan these changes accordingly.\n\nBelow are instruction on how to achieve this on SFOS version 19 and SFOS version 19.5:\n\n#### SFOS 19.0 MR2-Build 472 or 19.5 MR1-Build278 or later versions:\n\n1. Sign in to the CLI.\n\n2. Enter **4** to choose **Device console**, and enter the following command:",
      "language": "unknown"
    },
    {
      "code": "![Access the CLI to disable anti-replay](https://developers.cloudflare.com/_astro/5-sfos-19.CmXNwDG8_Z2sQ13W.webp)\n\n#### Older SFOS versions\n\nContact Sophos support.\n\n## GRE connection\n\n### 1. Configure a GRE tunnel between SFOS and Cloudflare\n\nStart by configuring a GRE tunnel between SFOS and the Cloudflare anycast IP address.\n\n1. Sign in to the CLI.\n\n2. Enter **4** to choose **Device console**, and enter the following command:",
      "language": "unknown"
    },
    {
      "code": "![Access the CLI to configure a GRE tunnel](https://developers.cloudflare.com/_astro/1-gre-connection.BwxtP6sM_Z12PvdG.webp)\n\n   For more details, refer to the [Sophos Firewall knowledge base](https://support.sophos.com/support/s/article/KB-000035813?language=en_US).\n\n### 2. Add a GRE or SD-WAN route to redirect traffic through the GRE tunnel\n\nThe detailed information on how to add a GRE or SD-WAN route to redirect traffic through the GRE tunnel, is in the next section ([Traffic redirection mechanism on Sophos Firewall](#traffic-redirection-mechanism-on-sophos-firewall)).\n\n### 3. Add a firewall rule for LAN/DMZ to VPN\n\nCreate a firewall rule with the criteria and security policies from your company that allows traffic to flow between Sophos and Magic WAN. This firewall rule should include the required networks and services.\n\n1. Go to **Protect** > **Rules and policies**.\n2. In **Firewall rules**, select **IPv4** > **Add firewall rule**.\n\n![Create a firewall rule with the criteria and security policies from your company](https://developers.cloudflare.com/_astro/4-firewall-rule.CfVt6IDY_Z1zkMRq.webp)\n\n## Traffic redirection mechanism on Sophos Firewall\n\nTo redirect traffic, you can add a static or an SD-WAN route.\n\n### IPsec\n\n#### Static route\n\nGo to **Configure** > **Routing** > **Static routes** to add an XFRM interface-based route. The interface will be automatically created when you set up a tunnel interface based on IPsec (such as the Cloudflare\\_MWAN example from above).\n\n![Go to static routes to add an XFRM interface-based route](https://developers.cloudflare.com/_astro/static-route.Cv8cjbPi_blRdV.webp)\n\n#### SD-WAN route\n\n1. Go to **Configure** > **Routing** > **Gateways** to create a custom gateway on the XFRM interface. The interface will be automatically created when you set up a tunnel interface based on IPsec (such as the Cloudflare\\_MWAN example from above).\n\n![Go to Gateways to add an XFRM interface-based route](https://developers.cloudflare.com/_astro/1-sd-wan-gateway.B-zYNWQF_Z2x4Oc6.webp)\n\n1. In **Configure** > **Routing** > **SD-WAN routes**, select **Add** to add the desired networks and services in the route to redirect traffic to Cloudflare. Enter a descriptive name for your connection, and the IP addresses you set up for your IPsec tunnels in **Incoming interface** and **Source networks**. Do not forget to choose the correct **Primary gateway** option.\n\n![Go to SD-WAN to add the desired networks and services in the route.](https://developers.cloudflare.com/_astro/2-sd-wan-routes.ZK7MHrV6_ZEhQ4a.webp)\n\n### GRE\n\nAdd a GRE or SD-WAN route or both.\n\n#### GRE route\n\nAdd the route on the CLI.\n\n1. Sign in to the CLI.\n2. Enter **4** to choose **Device console**, and enter the following command to create the tunnel:",
      "language": "unknown"
    },
    {
      "code": "![Add the route on the CLI.](https://developers.cloudflare.com/_astro/gre-route-cli.eRcqLJze_1WI8vl.webp)\n\n#### SD-WAN route\n\n1. Add a custom gateway on GRE with the peer IP address (from the `/31` subnet you chose earlier) as the Gateway IP address, and disable **Health check**.\n\n![Add a custom gateway on GRE.](https://developers.cloudflare.com/_astro/sd-wan-1-gre.CApTTOXu_Z2uMYKP.webp)\n\n1. Add an SD-WAN route with the desired networks and services in the route to redirect traffic to Cloudflare.\n\n![Add an SD-WAN route.](https://developers.cloudflare.com/_astro/2-sd-wan-routes.ZK7MHrV6_ZEhQ4a.webp)\n\n## Verify tunnel status on Cloudflare dashboard\n\nThe Cloudflare dashboard monitors the health of all anycast tunnels on your account that route traffic from Cloudflare to your origin network. Refer to [Check tunnel health in the dashboard](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/check-tunnel-health-dashboard/) for more information.\n\n### Make Cloudflare health checks work\n\n1. The ICMP probe packet from Cloudflare must be the type ICMP request, with anycast source IP. In the following example, we have used `172.64.240.252` as a target example:",
      "language": "unknown"
    },
    {
      "code": "1. Go to **Configure** > **Network** > **Interfaces** > **Add alias**. Add the IP address provided by Cloudflare for the ICMP probe traffic. This is needed to prevent Sophos firewall from dropping them as spoof packets. This is not the same IP used to create VPN. This is the special IP address for probe traffic only.\n\n![Add the IP address provided by Cloudflare to prevent the probe from being dropped by the firewall.](https://developers.cloudflare.com/_astro/2-icmp-probe-firewall.BD1XaeDb_ZpN0sB.webp)\n\n1. ICMP reply from SFOS should go back via the same tunnel on which the probe packets are received. You will need to create an additional SD-WAN policy route.\n\n![Configure an SD-WAN route so the ICMP reply goes back to Cloudflare via the same tunnel.](https://developers.cloudflare.com/_astro/3-icmp-probe-reply.CX60fYHN_Z9vF1H.webp)\n\nPacket flow will look like the following:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## Verify tunnel status on Sophos Firewall dashboard\n\n### IPsec\n\nWhen the tunnel is working, its **Status** will be green.\n\n![If the tunnel is working, it will show up with a green status.](https://developers.cloudflare.com/_astro/2b-ipsec-tunnel.DcLZdCzX_2gDzJX.webp)\n\nThe corresponding XFRM interface will also show a **Connected** status.\n\n![The XFRM interface will also show a connected status.](https://developers.cloudflare.com/_astro/1-sd-wan-gateway.B-zYNWQF_Z2x4Oc6.webp)\n\n### GRE\n\nAccess the CLI and type `system gre tunnel show` to check the status of a GRE tunnel. When the tunnel is working, its Status will show up as **Enabled**.\n\n![The GRE tunnel will show a status of Enabled when working.](https://developers.cloudflare.com/_astro/gre-status-enabled.CkTEu5BC_ZlXB2y.webp) ![The GRE tunnel will show a status of Enabled when working.](https://developers.cloudflare.com/_astro/gre-status-enabled-b.D8-vH0Du_vfstx.webp)\n\n## Troubleshooting\n\nIf a tunnel shows a connected status at both ends, but is not established:\n\n* Check if the IPsec profile configuration is correct.\n* Make sure the corresponding tunnel interfaces are up.\n* Make sure routing configuration and route precedence are correctly set on SFOS.\n* Make sure a static back route is added on Cloudflare.\n* Firewall rules for specific zones and host or service must be added in SFOS. GRE and IPsec belong to the VPN zone.\n* Perform `tcpdump` to check if packets are going through the VPN or GRE tunnel as expected.\n* Perform a packet capture on Cloudflare to see if traffic is reaching the Cloudflare platform.\n\n</page>\n\n<page>\n---\ntitle: Cisco SD-WAN · Cloudflare One docs\ndescription: Cloudflare partners with Cisco's SD-WAN solution to provide users\n  with an integrated SASE solution. The Cisco SD-WAN appliances (physical and\n  virtual) manage subnets associated with branch offices and cloud instances.\n  Anycast Tunnels are set up between these SD-WAN edge devices and Cloudflare to\n  securely route Internet-bound traffic. This tutorial describes how to\n  configure the Cisco Catalyst 8000 Edge Platforms (physical or virtual) in the\n  SD-WAN mode for north-south (Internet-bound) use cases.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/viptela/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/viptela/index.md\n---\n\nCloudflare partners with Cisco's SD-WAN solution to provide users with an integrated SASE solution. The Cisco SD-WAN appliances (physical and virtual) manage subnets associated with branch offices and cloud instances. Anycast Tunnels are set up between these SD-WAN edge devices and Cloudflare to securely route Internet-bound traffic. This tutorial describes how to configure the Cisco Catalyst 8000 Edge Platforms (physical or virtual) in the SD-WAN mode for north-south (Internet-bound) use cases.\n\n## Prerequisites\n\nBefore setting up a connection between Cisco SD-WAN and Cloudflare, you must have:\n\n* Purchased Magic WAN and Secure Web Gateway.\n* Cloudflare provision Magic WAN and Secure Web Gateway.\n* Received two Cloudflare tunnel endpoints (anycast IP address) assigned to Magic WAN.\n* Cisco SD-WAN appliances (physical or virtual). This ensures specific Internet-bound traffic from the sites' private networks is routed over the anycast GRE tunnels to Secure Web Gateway to enforce a user's specific web access policies.\n* A static IP pair to use with the tunnel endpoints. The static IPs should be `/31` addresses separate from the IPs used in the subnet deployment.\n* Release 20.6 Controllers and vEdge Device Builds. You should also pair them with devices that are on at least version Cisco IOS XE SD-WAN 17.6. Refer to [Cisco documentation](https://www.cisco.com/c/en/us/support/docs/routers/sd-wan/215676-cisco-tac-and-bu-recommended-sd-wan-soft.html) to learn more Cisco softweare versions.\n\nNote\n\nThe SASE integration between Cisco SD-WAN and Cloudflare SSE was validated with Cisco SD-WAN 20.6.2 version with Catalyst 8kv router. For connectivity, we used GRE tunnels.\n\n## 1. Create a SIG template on Cisco vManage\n\nCisco vManage is Cisco's SD-WAN management tool that is used to manage all the SD-WAN appliances in branch offices.\n\nFor this example scenario, a generic template for `SIG-Branch` was created.\n\n![Traffic flow diagram for GRE](https://developers.cloudflare.com/_astro/viptela-flow-diagram-gre.BGa0DR7d_1E1VCz.webp)\n\nTo create a Secure Internet Gateway (SIG) using vManage:\n\n1. From **Cisco vManage** under **Configuration**, select **Generic** and **Add Tunnel**.\n2. Refer to the table below for the setting fields and their options.\n\n| Setting | Type/Detail |\n| - | - |\n| **Global Template** | Factory\\_Default\\_Global\\_CISCO\\_Template |\n| **Cisco Banner** | Factory\\_Default\\_Retail\\_Banner |\n| **Policy** | Branch-Local-Policy |\n\n**Transport & Management VPN settings**\n\n| Setting | Type/Detail |\n| - | - |\n| **Cisco VPN 0** | GCP-Branch-VPN0 |\n| **Cisco Secure Internet Gateway** | Branch-SIG-GRE-Template |\n| **Cisco VPN Interface Ethernet** | GCP-Branch-Public-Internet-TLOC |\n| **Cisco VPN Interface Ethernet** | GCP-VPN0-Interface |\n| **Cisco VPN 512** | Default\\_AWS\\_TGW\\_CSR\\_VPN512\\_V01 |\n\n**Basic Information settings**\n\n| Setting | Type/Detail |\n| - | - |\n| **Cisco System** | Default\\_BootStrap\\_Cisco\\_System\\_Template |\n| **Cisco Logging** | Default\\_Logging\\_Cisco\\_V01 |\n| **Cisco AAA** | AWS-Branch-AAA-Template |\n| **Cisco BFD** | Default\\_BFD\\_Cisco-V01 |\n| **Cisco OMP** | Default\\_AWS\\_TGW\\_CSR\\_OMP\\_IPv46\\_... |\n| **Cisco Security** | Default\\_Security\\_Cisco\\_V01 |\n\nWhen creating the Feature Template, you can choose values that apply globally or that are device specific. For example, the **Tunnel Source IP Address**, **Interface Name** and fields from **Update Tunnel** are device specific and should be chosen accordingly.\n\n## 2. Create tunnels in vManage\n\nFrom vManage, select **Configuration** > **Templates**. You should see the newly created template where you will update the device values.\n\nBecause the template was created to add GRE tunnels, you only need to update the device values. Note that **VPN0** is the default, and the WAN interface used to build the tunnel must be part of **VPN0**.\n\n![Update template fields for GRE tunnel](https://developers.cloudflare.com/_astro/viptela-update-device-template-gre.BQZzlgJi_1KlKnW.webp)\n\n## 3. Create tunnels in Cloudflare\n\nRefer to [Configure tunnel endpoints](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/) for more information on creating a GRE tunnel.\n\n![Established GRE tunne in Cloudflash dashboard](https://developers.cloudflare.com/_astro/viptela-gre-tunnel.BI5bFdGE_Z2oknv3.webp)\n\n## 4. Define static routes\n\nRefer to [Configure static routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) for more information on configuring your static routes.\n\n![Established GRE static routes in Cloudflare dashboard](https://developers.cloudflare.com/_astro/viptela-gre-static-routes.xe2lnYh6_ZdqsAT.webp)\n\n## 5. Validate traffic flow\n\nIn the example below, a request for `neverssl.com` was issued, which has a Cloudflare policy blocking traffic to `neverssl`.com.\n\nOn the client VM (192.168.30.3), a blocked response is visible.\n\n![cURL example for a request to neverssl.com](https://developers.cloudflare.com/_astro/viptela-curl-traffic-flow.DiSsMVxM_ZCu0Ac.webp)\n\nA matching blocked log line is visible from the Cloudflare logs.\n\n![A blocked log from Gateway Activity Log in the Cloudflare dashboard](https://developers.cloudflare.com/_astro/viptela-gre-swg-traffic.DD7CHYgi_Z2hBM1W.webp)\n\n## Add new tunnels using IPsec\n\nIPsec tunnels to Cloudflare can only be created on Cisco 8000v in the router mode today. Refer to the [Cisco IOS XE](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/cisco-ios-xe/) for more information.\n\n</page>\n\n<page>\n---\ntitle: VyOS · Cloudflare One docs\ndescription: This tutorial contains configuration information and a sample\n  template for using a VyOS device with an IPsec configuration.\nlastUpdated: 2025-10-27T11:06:15.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/vyos/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/vyos/index.md\n---\n\nThis tutorial contains configuration information and a sample template for using a VyOS device with an IPsec configuration.\n\n## Notes\n\n* `vti <NAME_OF_VTI_INTERFACE` - Specifies the virtual tunnel interface of the IPsec tunnel.\n* `esp-group <NAME_OF_ESP_GROUP>` - Defines the ESP group for encrypted traffic defined by the tunnel or defines a particular ESP policy or profile.\n* `ike-group <NAME_OF_IKE_GROUP>` - Defines IKE group to use for key exchanges or defines a particular IKE policy or profile.\n* The IP addresses of the IPsec tunnel interfaces on both ends of the tunnel should be a pair of private IP addresses (RFC 1918) on the same `/31` or `/30` subnet, essentially specifying a point-to-point link.\n* The IPsec tunnel endpoint on this VyOS router is the `<IP_ADDR_OF_UPLINK_INTF_TO_INTERNET/WAN>`.\n* The IP address of the IPsec tunnel endpoint on the Cloudflare side is the anycast IP address provided by Cloudflare.\n* This router is configured to initiate the IPsec tunnel connection.\n\n## Configuration parameters\n\n### Phase 1\n\n* **Encryption**\n\n  * AES-GCM with 128-bit or 256-bit key length\n\n* **Integrity**\n\n  * SHA512\n\n### Phase 2\n\n* **Encryption**\n\n  * AES-GCM with 128-bit or 256-bit key length\n\n* **Integrity**\n\n  * SHA512\n\n* **PFS group**\n\n  * DH group 20 (348-bit random ECP group)\n\n## Configuration template",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Activate Connector · Cloudflare One docs\ndescription: \"Before you can activate your Magic WAN Connector, you need to\n  follow Cloudflare's instructions regarding DHCP. For full instructions on\n  this, refer to:\"\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/activate-connector/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/activate-connector/index.md\n---\n\nBefore you can activate your Magic WAN Connector, you need to follow Cloudflare's instructions regarding DHCP. For full instructions on this, refer to:\n\n* The [hardware version of Magic WAN Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#activate-appliance)\n* The [virtual version of Magic WAN Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/#activate-appliance)\n\n</page>\n\n<page>\n---\ntitle: Add or remove connectors · Cloudflare One docs\ndescription: To add a new Magic WAN Connector you first need to remove the one\n  associated with the on-ramps. You can only have more than one Magic WAN\n  Connector if you initially enabled high availability on your on-ramp.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/add-remove-connectors/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/add-remove-connectors/index.md\n---\n\nTo add a new Magic WAN Connector you first need to remove the one associated with the on-ramps. You can only have more than one Magic WAN Connector if you initially enabled high availability on your on-ramp.\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n1) Find the Magic WAN Connector that you want to edit > select the three dots next to it > **Edit**.\n2) In **Appliances**, remove the Magic WAN Connector associated with the on-ramp.\n3) Select **Add appliance** to add a different Magic WAN Connector to your on-ramp.\n4) Select **Save**.\n\n</page>\n\n<page>\n---\ntitle: Deactivate Connector · Cloudflare One docs\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/deactivate-connector/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/deactivate-connector/index.md\n---\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Appliances**.\n3. Find the Magic WAN Connector you want to deactivate, select the three dots next to it > **Edit**.\n\n1) In **Status**, select *Deactivated* from the dropdown.\n2) Select **Update**.\n\n</page>\n\n<page>\n---\ntitle: Default password · Cloudflare One docs\ndescription: Learn how to edit Magic WAN Connector's default password.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/default-password/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/default-password/index.md\n---\n\nMagic WAN Connector ships to you with a default password that enables you to access the hardware box or the virtual machine. Cloudflare recommends that you change this password after the first boot.\n\n## Default password to access hardware Magic WAN Connector\n\nThe default password for Magic WAN Connector is the serial number (also known as a Service Tag for Dell devices), all uppercase followed by an `!` (exclamation mark). For example, `A1B2C3D!`\n\n## Default password to access Virtual Connector\n\nThe default password for Virtual Connector is the last seven characters of your license key, all uppercase, plus an `!` (exclamation mark).\n\nFor example, if your license key is `mconn-abcdefghijklmnopqrstuvwxyz`, your default password will be `TUVWXYZ!`.\n\n</page>\n\n<page>\n---\ntitle: Edit basic information · Cloudflare One docs\ndescription: In Basic information, you can change the name and description of\n  your Magic WAN Connector.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-basic-info/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-basic-info/index.md\n---\n\nIn **Basic information**, you can change the name and description of your Magic WAN Connector.\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Appliances**.\n\n1) Find the Magic WAN Connector that you want to edit > select the three dots next to it > **Edit**.\n2) In **Basic information** make the necessary changes.\n3) Select **Save**.\n\n</page>\n\n<page>\n---\ntitle: Edit network settings · Cloudflare One docs\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-network-settings/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-network-settings/index.md\n---\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n1) Find the Connector that you want to edit > select the three dots next to it > **Edit**.\n2) Go to **Network configuration** > **WAN configuration** or **LAN configuration**.\n3) Find the WAN/LAN you want to edit > select the three dots next to it > **Edit**.\n4) Make the necessary changes.\n5) Select **Save**.\n\n</page>\n\n<page>\n---\ntitle: Edit sites · Cloudflare One docs\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-sites/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-sites/index.md\n---\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/) > **Insights**.\n2. Go to **Network visibility** > **Traffic overview**, and find the site you want to make changes on.\n3. Select the three dots next to it > **Edit**.\n4. In **Basic information**, make changes to the site's name, description, and geographic coordinates.\n5. In **On-ramps**, add new on-ramps to your site. You can also remove existing ones.\n\n</page>\n\n<page>\n---\ntitle: Interrupt window · Cloudflare One docs\ndescription: Learn how to set up when Connector can update its systems.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/interrupt-service-window/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/interrupt-service-window/index.md\n---\n\nThe Interrupt window defines when Magic WAN Connector can update its systems. When Magic WAN Connector is updating, this may result in an interruption to existing connections. Set up a time window that minimizes disruption to your sites.\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks** > **Connectors**.\n2. In **Appliances** > **Appliances**, select the Magic WAN Connector for which you want to set up the update window > **Edit**.\n\n1) In **Interrupt window**, select the most appropriate time for the Magic WAN Connector to update its systems:\n\n   * **Timezone**: Select the time zone for the Magic WAN Connector to update.\n   * **Start time**: Choose an hour for the Magic WAN Connector to start updating. Cloudflare recommends you choose an hour when there is minimal activity in your network, to avoid potential disruptions.\n   * **Duration**: Duration indicates the time window during which the Magic WAN Connector is scheduled to update. For example, if you configure your Magic WAN Connector to update at `22:00` and specify a **Duration** of `4 hours`, the Magic WAN Connector will attempt to update within the four-hour period following `22:00`.\n\n</page>\n\n<page>\n---\ntitle: Edit traffic steering settings · Cloudflare One docs\ndescription: \"You can only add or remove applications to Breakout traffic and\n  Prioritized traffic. To add or remove applications:\"\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-traffic-steering-settings/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-traffic-steering-settings/index.md\n---\n\nYou can only add or remove applications to Breakout traffic and Prioritized traffic. To add or remove applications:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n1) Find the Connector that you want to edit > select the three dots next to it > **Edit**.\n2) Go to **Traffic steering** > **Breakout traffic** or **Prioritized traffic**.\n3) Select **Add** to add a new application.\n4) To delete an application, find the one you want to delete from **Breakout traffic** or **Prioritized traffic** > select the three dots next to it > **Remove**.\n\n</page>\n\n<page>\n---\ntitle: Heartbeat · Cloudflare One docs\ndescription: Magic WAN Connector communicates periodically with Cloudflare via\n  HTTPS. This is also known as a heartbeat, and lets Cloudflare know that the\n  Magic WAN Connector in question is connected to the Internet and reachable.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/heartbeat/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/heartbeat/index.md\n---\n\nMagic WAN Connector communicates periodically with Cloudflare via HTTPS. This is also known as a heartbeat, and lets Cloudflare know that the Magic WAN Connector in question is connected to the Internet and reachable.\n\nThe heartbeat calls are made to `api.cloudflare.com`. Each Magic WAN Connector has a heartbeat frequency of 10 seconds, independently of the number of WAN interfaces you have running on your device.\n\nThere are three symbols for the heartbeat signal that allow you to quickly check the status of Magic WAN Connector:\n\n* **Blue `i`**: Magic WAN Connector is contacting Cloudflare as expected.\n* **Yellow triangle**: Magic WAN Connector has not yet connected to Cloudflare.\n* **Red triangle**: There is a potential problem with Magic WAN Connector.\n\n### Access Magic WAN Connector's heartbeat\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Appliances**.\n3. Find your Magic WAN Connector, and place your cursor over the icon on the **Status** column to check the timestamp. The timestamp shows you the last time Magic WAN Connector successfully contacted Cloudflare.\n\n</page>\n\n<page>\n---\ntitle: Register a hardware Connector · Cloudflare One docs\ndescription: To set up and use the hardware version of Magic WAN Connector, you\n  first need to register it with your account. This is not applicable to Virtual\n  Magic WAN Connector.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/register-appliance/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/register-appliance/index.md\n---\n\nTo set up and use the hardware version of Magic WAN Connector, you first need to register it with your account. This is not applicable to Virtual Magic WAN Connector.\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances**, and select **Register an appliance**.\n\n1) In **Appliance details** > **Serial number**, insert the serial number for your device. You can optionally add notes about the Magic WAN Connector you are adding to the dashboard.\n2) (Optional) Select **Add** below **Serial number** to add multiple Magic WAN Connectors at once to your account.\n3) Select **Register appliance**.\n\nYour device is now registered with your account.\n\n</page>\n\n<page>\n---\ntitle: Application-aware policies · Cloudflare One docs\ndescription: In addition to traffic policies based on network-layer attributes\n  like IP and port ranges, Magic WAN Connector supports the ability to classify\n  traffic based on well-known applications. Application-aware policies provide\n  easier management and more granularity over traffic flows.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/index.md\n---\n\nIn addition to traffic policies based on network-layer attributes like IP and port ranges, Magic WAN Connector supports the ability to classify traffic based on well-known applications. Application-aware policies provide easier management and more granularity over traffic flows.\n\nCloudflare's implementation of application awareness leverages the intelligence of our global network, using the same categorization/classification already shared across security tools like our [Secure Web Gateway](https://developers.cloudflare.com/cloudflare-one/policies/gateway/), so IT and security teams can expect consistent behavior across routing and inspection decisions.\n\nFor more information, refer to [Applications and app types](https://developers.cloudflare.com/cloudflare-one/policies/gateway/application-app-types/).\n\nMagic WAN Connector's ability to classify traffic allows you to define which applications should bypass Cloudflare's security filtering, and go directly to the Internet. You can also give some applications a higher priority, and Connector will process them first. This is useful when your network is at capacity, for example.\n\nRefer to the following pages for more information.\n\n* [Breakout traffic](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/breakout-traffic/)\n* [Prioritized traffic](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/prioritized-traffic/)\n\n</page>\n\n<page>\n---\ntitle: DHCP options · Cloudflare One docs\nlastUpdated: 2025-10-27T11:06:15.000Z\nchatbotDeprioritize: true\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/index.md\n---\n\n* [DHCP relay](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-relay/)\n* [DHCP server](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-server/)\n* [DHCP static address reservation](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-static-address-reservation/)\n\n</page>\n\n<page>\n---\ntitle: Enable NAT for a subnet · Cloudflare One docs\ndescription: Enable static NAT for subnets in Connector to  re-use address spaces locally.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/nat-subnet/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/nat-subnet/index.md\n---\n\n## Overview\n\nEach subnet (directly attached or routed) must use a unique address space within the Magic WAN overlay. Many networks already reuse private RFC 1918 space at different sites. To avoid renumbering and still satisfy the Magic WAN uniqueness requirements, you can enable static network address translation (NAT) for a subnet on a Magic WAN Connector.\n\nWith subnet NAT, the Connector performs a static, 1:1 translation between:\n\n* The **local prefix** used inside the site.\n* A **NAT prefix** that is advertised into the Magic WAN overlay.\n\nBecause the mapping is static, the Connector supports both outbound connections from the site and inbound connections from Magic WAN to the site. Connections do not have to be initiated by hosts behind the Magic WAN Connector.\n\n## How subnet NAT works in Magic WAN\n\nNAT is static and 1:1 between equal-sized prefixes. When you enable NAT for a subnet on a Connector:\n\n* The **local prefix** is the subnet on the LAN side of the Connector.\n\n* The **NAT prefix** is a WAN-facing prefix of the same size.\n\n* The Connector translates addresses 1:1 between the two prefixes:\n\n  * For traffic leaving the site towards Magic WAN, it replaces local addresses with the corresponding NAT addresses.\n  * For traffic arriving at the site from Magic WAN, it replaces NAT addresses with the corresponding local addresses.\n\n## Addressing rules\n\nTo avoid overlapping addresses in the overlay, Magic WAN enforces the following rules:\n\n* **Uniqueness within a LAN**\n\n  * The local prefix for each subnet must be unique within that LAN on the Connector.\n  * You can reuse the same local prefix on a different LAN or on a different site.\n\n* **Uniqueness in the Magic WAN overlay**\n\n  * Every **overlay-facing prefix** must be unique across all sites in your Magic WAN deployment.\n  * For a subnet **with NAT enabled**, the overlay-facing prefix is the **NAT prefix**.\n  * For a subnet **without NAT**, the overlay-facing prefix is the **local prefix**.\n\nThese rules allow you to reuse local space at multiple sites, as long as each subnet in the Magic WAN overlay has a unique overlay-facing prefix.\n\n## Example\n\nConsider a subnet that uses the following prefixes:\n\n* **Local prefix**: `192.168.100.0/24`\n* **NAT prefix**: `10.10.100.0/24`\n\nIn this case:\n\n* When a host inside the site with address `192.168.100.13` sends traffic into the Magic WAN overlay, the Connector translates the address to `10.10.100.13`.\n* When traffic from another site, or from the Internet via Magic WAN, targets `10.10.100.13`, the Connector translates the address back to `192.168.100.13`.\n\n## Configure NAT for subnets\n\nYou configure subnet NAT when you create or edit a LAN on a Magic WAN Connector. In the Connector configuration:\n\n* You define the **local prefix** for the subnet on the LAN side.\n* You optionally define a **static NAT prefix** of the same size. When present, this prefix becomes the overlay-facing prefix for that subnet.\n\nFor step-by-step instructions to configure a LAN and supply a static NAT prefix, refer to:\n\n* [Configure hardware Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#create-a-lan)\n* [Configure Virtual Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/#create-a-lan)\n\n</page>\n\n<page>\n---\ntitle: Network segmentation · Cloudflare One docs\ndescription: Define policies to define if traffic should flow between your LANs\n  without leaving your local premises, or if traffic should be forwarded to\n  Cloudflare for additional security configurations.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/network-segmentation/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/network-segmentation/index.md\n---\n\nYou can define policies in your Magic WAN Connector to either allow traffic to flow between your LANs without it leaving your local premises or to forward it via the Cloudflare network where you can add additional security features. The default behavior is to drop all LAN-to-LAN traffic. These policies can be created for specific subnets, and link two LANs.",
      "language": "unknown"
    },
    {
      "code": "*In the above example, the red path shows traffic that stays in the customer's premises (allowing direct communication between LAN 3 and LAN 4), and the orange path shows traffic that goes to Cloudflare before returning to the customer's premises (processing traffic between LAN 1 and LAN 2 in Cloudflare).*\n\n\n\nAs a best practice for security, we recommend sending all traffic through Cloudflare's network for Zero Trust security filtering. Use these policies with care and only for scenarios where you have a hard requirement for LAN-to-LAN traffic flows.\n\nIf you enable LAN to LAN traffic flows, communications can only be initiated from origin to destination — for example, LAN 1 to LAN 2 — and not the other way around. This is by design and prevents potential exfiltration of information. This does not mean bidirectional communication on TCP is not possible. It only means that the origin is the only one authorized to initiate communications.\n\nUnidirectional communication can be enabled for UDP and ICMP, but it is not available for TCP, as it would break that protocol.\n\nThe following guide assumes you have already created a site and configured your Magic WAN Connector. To learn how to create a site and configure your Magic WAN Connector, refer to [Configure hardware Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/) or [Configure Virtual Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/), depending on the type of Magic WAN Connector you have on your premises.\n\n## Create a policy\n\n* Dashboard\n\n  Follow the steps below to create a new LAN policy to segment your network. Only the fields marked **required** are mandatory.\n\n  1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select the Magic WAN Connector you want to configure > **Edit**.\n\n  1. Select **LAN policies** > **Create**.\n\n  2. In **Policy name**, enter a descriptive name for the policy you are creating.\n\n  3. From the drop-down menu **Origin (required)**, select your origin LAN.\n\n  4. Specify a subnet for your first LAN in **Subnets**.\n\n  5. In **Ports** specify the TCP/UDP ports you want to use. Valid ports range from `1` to `65535`. Zero (`0`) is not a valid port number. Add a comma to separate each of the ports or add a port range. For example, `2,5,6,9-14`.\n\n  6. In **Destination (required)**, select the destination LAN and repeat the above process to configure it.\n\n  7. In **Protocols**, select the type of traffic you want to allow. You can choose **TCP**, **UDP**, and **ICMP**. You can also select **Any** to choose all types of traffic.\n\n  8. In **Traffic direction** you can choose between bidirectional traffic (the default) and unidirectional traffic. What you can choose depends on the protocol that you chose for the policy:\n\n     * **Any**: If **Any** is selected and you choose **Unidirectional**, the system will alert you that this will break TCP traffic.\n     * **TCP**: You can only select **Bidirectional**.\n     * **UDP**: The system defaults to **Bidirectional** but you can choose **Unidirectional**.\n     * **ICMP**: The system defaults to **Bidirectional** but you can choose **Unidirectional**.\n\n  9. In **Traffic path**, select **Forwarded via Cloudflare** if you want traffic to be forwarded to Cloudflare to be processed. If you do not select this option, traffic will flow locally, in your premises without passing through Cloudflare.\n\n  10. Select **Save**.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a `POST` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/acls/methods/create/) to create a network policy.\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Take note of the `id` parameter, as you will need it to edit or delete network policies.\n\nThe new policy will ensure that traffic between the specified LANs flows locally, bypassing Cloudflare.\n\n## Edit a policy\n\n* Dashboard\n\n  1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select the Magic WAN Connector you want to configure > **Edit**.\n\n  1. Select **LAN policies**.\n  2. Select the policy you need to edit > **Edit**.\n  3. Make your changes, and select **Update policy**.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a `PUT` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/acls/methods/update/) to edit a network policy.\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## Delete a policy\n\n* Dashboard\n\n  1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select the Magic WAN Connector you want to configure > **Edit**.\n\n  1. Select **LAN policies**.\n  2. Select the policy you need to edit > **Edit**.\n  3. Select **Delete**.\n  4. Select **I understand that deleting a policy is permanent** in the dialog box > **Delete**.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a `DELETE` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/acls/methods/delete/) to delete a network policy.\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Routed subnets · Cloudflare One docs\ndescription: Learn how to configure routed subnets on a Connector, including\n  setting static routes and next-hop addresses for complex LAN setups.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/routed-subnets/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/routed-subnets/index.md\n---\n\nEach LAN interface (physical port + VLAN tag) on Magic WAN Connector is part of a *directly-attached subnet*. When you specify a static address for the LAN interface, you indicate both the interface's address as well as the subnet it attaches to. For example, `192.168.100.13/24` means the LAN interface has the IP address `192.168.100.13`, and is part of the subnet `192.168.100.0/24`.\n\nSome LANs are more complex. In addition to the directly-attached subnet, they might have additional subnets sitting behind L3 routers south of the Magic WAN Connector. We call these *routed subnets*.\n\nRefer to the diagram below for an example of how this might work:\n\nNote\n\nBlue represents directly-attached subnets, and red represents routed subnets.",
      "language": "unknown"
    },
    {
      "code": "To add a routed subnet to your LAN, you need:\n\n* **A prefix**: The subnet's CIDR prefix; Cloudflare will automatically install static routes to this prefix in our global network (to forward [packets](https://www.cloudflare.com/learning/network-layer/what-is-a-packet/) for this subnet to the right Magic WAN Connector), and in your Magic WAN Connector (to forward packets for this subnet to the right LAN interface). In the figure above, the routed subnet in the center has the prefix `192.168.200.0/24`.\n* **A next-hop address**: The address of the L3 router to which the Magic WAN Connector should forward packets for this subnet. In the figure, the routed subnet in the center has the next-hop address `192.168.100.10`.\n\nOptionally, you can also [enable NAT for a subnet](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/nat-subnet/) by providing a static overlay prefix.\n\n## Create routed subnets\n\nFor more information on how to create routed subnets, refer to **Create a LAN**, either in either in [Configure hardware Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#create-a-lan) or in [Configure Virtual Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/#create-a-lan).\n\n</page>\n\n<page>\n---\ntitle: Fleet · Cloudflare One docs\ndescription: This guide covers how to deploy the Cloudflare WARP client using\n  Fleet device management software.\nlastUpdated: 2025-10-21T14:33:19.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/fleet/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/fleet/index.md\n---\n\nThis guide covers how to deploy the Cloudflare WARP client using [Fleet](https://fleetdm.com/) device management software.\n\n## macOS\n\n### 1. Create a custom MDM file\n\n1. [Download](https://developers.cloudflare.com/cloudflare-one/static/mdm/CloudflareWARP.mobileconfig) an example `.mobileconfig` file.\n2. Modify the file with your desired [deployment parameters](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/parameters/).\n\n### 2. Upload MDM file to Fleet\n\n1. In the Fleet admin console, go to **Controls**.\n\n2. From the **Teams** dropdown, select the team (group of hosts) that requires Cloudflare WARP.\n\n3. Select **OS settings** > **Custom settings**.\n\n4. Select **Add profile** and upload the custom `.mobileconfig`.\n\n5. Select the hosts which require Cloudflare WARP:\n\n   * **All hosts**: Deploys WARP to all hosts in the team.\n   * **Custom**: Deploys WARP to a subset of the hosts in the team. Use [labels](https://fleetdm.com/guides/managing-labels-in-fleet#basic-article) to define the hosts that should be included or excluded.\n\n6. Select **Add profile**.\n\nThe defined hosts will immediately receive the deployment profile, but WARP is not yet installed.\n\n### 3. Download WARP package for macOS\n\nVisit the [Download page](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/download-warp/#macos) to review system requirements and download the installer for your operating system.\n\n### 4. Upload WARP package to Fleet\n\nTo add the WARP client installer package for distribution to your hosts enrolled in Fleet:\n\n1. In the Fleet admin console, go to **Software**.\n2. From the **Teams** dropdown, select the team (group of hosts) that requires Cloudflare WARP.\n3. Select **Add Software** and upload the `.pkg` file that was previously downloaded.\n\n### 5. Install WARP with Fleet\n\nTo deploy the uploaded `.pkg` file to your hosts:\n\n1. In the Fleet admin console, go to **Hosts**.\n2. Select the host that requires the WARP client.\n3. Go to **Software** and search for `Cloudflare`.\n4. Select **Actions** > **Install**.\n\nInstallation will happen automatically when the host comes online. To deploy with REST API or GitOps, refer to the [Fleet documentation](https://fleetdm.com/guides/deploy-software-packages).\n\nAfter deploying the WARP client, you can check its connection progress using the [Connectivity status](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/connectivity-status/) messages displayed in the WARP GUI.\n\n### 6. Uninstall WARP with Fleet\n\nTo uninstall the Fleet-deployed WARP client:\n\n1. In the Fleet admin console, go to **Hosts**.\n2. Select the host that requires the WARP client to be uninstalled.\n3. Go to **Software** and search for `Cloudflare`.\n4. Select **Actions** > **Uninstall**.\n\n## Windows\n\n### 1. Download WARP package for Windows\n\nVisit the [Download page](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/download-warp/#windows) to review system requirements and download the installer for your operating system.\n\n### 2. Upload WARP package to Fleet\n\nTo add the WARP client installer package for distribution to your hosts enrolled in Fleet:\n\n1. In the Fleet admin console, go to **Software**.\n2. From the **Teams** dropdown, select the team (group of hosts) that requires Cloudflare WARP.\n3. Select **Add Software** and upload the `.msi` file that was previously downloaded.\n4. (Optional) To allow users to install WARP from Fleet Desktop, select **Self-service**.\n5. Select **Advanced options**.\n6. In **Install script**, replace the default script with the following:",
      "language": "unknown"
    },
    {
      "code": "Refer to [deployment parameters](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/parameters/) for a description of each argument.\n\n### 3. Install WARP with Fleet\n\nTo deploy the uploaded `.pkg` file to your hosts:\n\n1. In the Fleet admin console, go to **Hosts**.\n2. Select the host that requires the WARP client.\n3. Go to **Software** and search for `Cloudflare`.\n4. Select **Actions** > **Install**.\n\nInstallation will happen automatically when the host comes online. To deploy with REST API or GitOps, refer to the [Fleet documentation](https://fleetdm.com/guides/deploy-software-packages).\n\nAfter deploying the WARP client, you can check its connection progress using the [Connectivity status](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/connectivity-status/) messages displayed in the WARP GUI.\n\n### 4. Uninstall WARP with Fleet\n\nTo uninstall the Fleet-deployed WARP client:\n\n1. In the Fleet admin console, go to **Hosts**.\n2. Select the host that requires the WARP client to be uninstalled.\n3. Go to **Software** and search for `Cloudflare`.\n4. Select **Actions** > **Uninstall**.\n\n## Linux\n\nFleet allows you to [execute custom scripts](https://fleetdm.com/guides/scripts) on Linux hosts. The following example script creates an [MDM file](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/#linux) and installs WARP on an Ubuntu 22.04 host:",
      "language": "unknown"
    }
  ],
  "headings": [
    {
      "level": "h2",
      "text": "5. Check connection status",
      "id": "5.-check-connection-status"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "1. Configure Magic WAN",
      "id": "1.-configure-magic-wan"
    },
    {
      "level": "h2",
      "text": "2. Configure site-to-site VPN on UniFi",
      "id": "2.-configure-site-to-site-vpn-on-unifi"
    },
    {
      "level": "h2",
      "text": "3. Add pre-shared key to Cloudflare",
      "id": "3.-add-pre-shared-key-to-cloudflare"
    },
    {
      "level": "h2",
      "text": "4. Configure Routes",
      "id": "4.-configure-routes"
    },
    {
      "level": "h2",
      "text": "Verify connections",
      "id": "verify-connections"
    },
    {
      "level": "h2",
      "text": "Troubleshooting",
      "id": "troubleshooting"
    },
    {
      "level": "h2",
      "text": "Policy-based routing",
      "id": "policy-based-routing"
    },
    {
      "level": "h2",
      "text": "Next Steps",
      "id": "next-steps"
    },
    {
      "level": "h2",
      "text": "IPsec connection",
      "id": "ipsec-connection"
    },
    {
      "level": "h3",
      "text": "1. Add an IPsec profile",
      "id": "1.-add-an-ipsec-profile"
    },
    {
      "level": "h3",
      "text": "2. Create IPsec connection tunnel",
      "id": "2.-create-ipsec-connection-tunnel"
    },
    {
      "level": "h3",
      "text": "3. Assign the XFRM interface address",
      "id": "3.-assign-the-xfrm-interface-address"
    },
    {
      "level": "h3",
      "text": "4. Add a firewall rule",
      "id": "4.-add-a-firewall-rule"
    },
    {
      "level": "h3",
      "text": "5. Disable IPsec anti-replay",
      "id": "5.-disable-ipsec-anti-replay"
    },
    {
      "level": "h2",
      "text": "GRE connection",
      "id": "gre-connection"
    },
    {
      "level": "h3",
      "text": "1. Configure a GRE tunnel between SFOS and Cloudflare",
      "id": "1.-configure-a-gre-tunnel-between-sfos-and-cloudflare"
    },
    {
      "level": "h3",
      "text": "2. Add a GRE or SD-WAN route to redirect traffic through the GRE tunnel",
      "id": "2.-add-a-gre-or-sd-wan-route-to-redirect-traffic-through-the-gre-tunnel"
    },
    {
      "level": "h3",
      "text": "3. Add a firewall rule for LAN/DMZ to VPN",
      "id": "3.-add-a-firewall-rule-for-lan/dmz-to-vpn"
    },
    {
      "level": "h2",
      "text": "Traffic redirection mechanism on Sophos Firewall",
      "id": "traffic-redirection-mechanism-on-sophos-firewall"
    },
    {
      "level": "h3",
      "text": "IPsec",
      "id": "ipsec"
    },
    {
      "level": "h3",
      "text": "GRE",
      "id": "gre"
    },
    {
      "level": "h2",
      "text": "Verify tunnel status on Cloudflare dashboard",
      "id": "verify-tunnel-status-on-cloudflare-dashboard"
    },
    {
      "level": "h3",
      "text": "Make Cloudflare health checks work",
      "id": "make-cloudflare-health-checks-work"
    },
    {
      "level": "h2",
      "text": "Verify tunnel status on Sophos Firewall dashboard",
      "id": "verify-tunnel-status-on-sophos-firewall-dashboard"
    },
    {
      "level": "h3",
      "text": "IPsec",
      "id": "ipsec"
    },
    {
      "level": "h3",
      "text": "GRE",
      "id": "gre"
    },
    {
      "level": "h2",
      "text": "Troubleshooting",
      "id": "troubleshooting"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "1. Create a SIG template on Cisco vManage",
      "id": "1.-create-a-sig-template-on-cisco-vmanage"
    },
    {
      "level": "h2",
      "text": "2. Create tunnels in vManage",
      "id": "2.-create-tunnels-in-vmanage"
    },
    {
      "level": "h2",
      "text": "3. Create tunnels in Cloudflare",
      "id": "3.-create-tunnels-in-cloudflare"
    },
    {
      "level": "h2",
      "text": "4. Define static routes",
      "id": "4.-define-static-routes"
    },
    {
      "level": "h2",
      "text": "5. Validate traffic flow",
      "id": "5.-validate-traffic-flow"
    },
    {
      "level": "h2",
      "text": "Add new tunnels using IPsec",
      "id": "add-new-tunnels-using-ipsec"
    },
    {
      "level": "h2",
      "text": "Notes",
      "id": "notes"
    },
    {
      "level": "h2",
      "text": "Configuration parameters",
      "id": "configuration-parameters"
    },
    {
      "level": "h3",
      "text": "Phase 1",
      "id": "phase-1"
    },
    {
      "level": "h3",
      "text": "Phase 2",
      "id": "phase-2"
    },
    {
      "level": "h2",
      "text": "Configuration template",
      "id": "configuration-template"
    },
    {
      "level": "h2",
      "text": "Default password to access hardware Magic WAN Connector",
      "id": "default-password-to-access-hardware-magic-wan-connector"
    },
    {
      "level": "h2",
      "text": "Default password to access Virtual Connector",
      "id": "default-password-to-access-virtual-connector"
    },
    {
      "level": "h3",
      "text": "Access Magic WAN Connector's heartbeat",
      "id": "access-magic-wan-connector's-heartbeat"
    },
    {
      "level": "h2",
      "text": "Overview",
      "id": "overview"
    },
    {
      "level": "h2",
      "text": "How subnet NAT works in Magic WAN",
      "id": "how-subnet-nat-works-in-magic-wan"
    },
    {
      "level": "h2",
      "text": "Addressing rules",
      "id": "addressing-rules"
    },
    {
      "level": "h2",
      "text": "Example",
      "id": "example"
    },
    {
      "level": "h2",
      "text": "Configure NAT for subnets",
      "id": "configure-nat-for-subnets"
    },
    {
      "level": "h2",
      "text": "Create a policy",
      "id": "create-a-policy"
    },
    {
      "level": "h2",
      "text": "Edit a policy",
      "id": "edit-a-policy"
    },
    {
      "level": "h2",
      "text": "Delete a policy",
      "id": "delete-a-policy"
    },
    {
      "level": "h2",
      "text": "Create routed subnets",
      "id": "create-routed-subnets"
    },
    {
      "level": "h2",
      "text": "macOS",
      "id": "macos"
    },
    {
      "level": "h3",
      "text": "1. Create a custom MDM file",
      "id": "1.-create-a-custom-mdm-file"
    },
    {
      "level": "h3",
      "text": "2. Upload MDM file to Fleet",
      "id": "2.-upload-mdm-file-to-fleet"
    },
    {
      "level": "h3",
      "text": "3. Download WARP package for macOS",
      "id": "3.-download-warp-package-for-macos"
    },
    {
      "level": "h3",
      "text": "4. Upload WARP package to Fleet",
      "id": "4.-upload-warp-package-to-fleet"
    },
    {
      "level": "h3",
      "text": "5. Install WARP with Fleet",
      "id": "5.-install-warp-with-fleet"
    },
    {
      "level": "h3",
      "text": "6. Uninstall WARP with Fleet",
      "id": "6.-uninstall-warp-with-fleet"
    },
    {
      "level": "h2",
      "text": "Windows",
      "id": "windows"
    },
    {
      "level": "h3",
      "text": "1. Download WARP package for Windows",
      "id": "1.-download-warp-package-for-windows"
    },
    {
      "level": "h3",
      "text": "2. Upload WARP package to Fleet",
      "id": "2.-upload-warp-package-to-fleet"
    },
    {
      "level": "h3",
      "text": "3. Install WARP with Fleet",
      "id": "3.-install-warp-with-fleet"
    },
    {
      "level": "h3",
      "text": "4. Uninstall WARP with Fleet",
      "id": "4.-uninstall-warp-with-fleet"
    },
    {
      "level": "h2",
      "text": "Linux",
      "id": "linux"
    }
  ],
  "url": "llms-txt#local",
  "links": []
}