{
  "title": "ForceCommand cvs server",
  "content": "sh\n   mv /etc/ssh/sshd_config /etc/ssh/sshd_config.bak\n   sh\n   vi /etc/ssh/sshd_config\n   sh\n     sudo systemctl reload ssh\n     sh\n     sudo systemctl reload sshd\n     sh\n   ssh-keygen -t rsa -f ~/.ssh/gcp_ssh -C <username in GCP>\n   sh\n   cat ~/.ssh/gcp_ssh.pub\n   sh\nssh -i ~/.ssh/gcp_ssh <username>@<server IP>\nbash\n  curl https://api.cloudflare.com/client/v4/accounts/{account_id}/magic/sites/{site_id}/wans \\\n  --header \"X-Auth-Email: <EMAIL>\" \\\n  --header \"X-Auth-Key: <API_KEY>\" \\\n  --header \"Content-Type: application/json\" \\\n  --data '{\n    \"name\": \"<YOUR_WAN_NAME>\",\n    \"physport\": 1,\n    \"priority\": 0,\n    \"vlan_tag\": 0\n  }'\n  bash\n  curl https://api.cloudflare.com/client/v4/accounts/{account_id}/magic/sites/{site_id}/lans \\\n  --header \"X-Auth-Email: <EMAIL>\" \\\n  --header \"X-Auth-Key: <API_KEY>\" \\\n  --header \"Content-Type: application/json\" \\\n  --data '{\n    \"name\": \"<YOUR_LAN_NAME>\",\n    \"physport\": 2,\n    \"static_addressing\": {\n      \"address\": \"172.16.14.0/24\"\n    },\n    \"vlan_tag\": 0\n  }'\n  mermaid\nflowchart LR\n\taccTitle: Magic WAN Connector set up as a DHCP server, and connecting to the Internet.\n  a(Magic WAN Connector)--> b(Internet) --> c(Cloudflare)\n\nsubgraph Customer site\n  d[LAN 1] --> a\n  e[LAN 2] --> a\n  end\n\nclassDef orange fill:#f48120,color: black\n  class a,c orange\nmermaid\nflowchart LR\n\taccTitle: Magic WAN Connector connects to the router in the site, and only some of the LANs connect to Connector.\n  a(Magic WAN Connector)--> b((Site's router)) --> c(Internet) --> i(Cloudflare)\n\nsubgraph Customer site\n  d[LAN 1] --> a\n  e[LAN 2] --> a\n  g(LAN 3) --> b\n  h(LAN 4) --> b\n  end\n\nclassDef orange fill:#f48120,color: black\n  class a,i orange\nsh\n  tar -xvf mconn-2024-1-3.ova\n  bash\n  curl https://api.cloudflare.com/client/v4/accounts/{account_id}/magic/sites/{site_id}/wans \\\n  --header \"X-Auth-Email: <EMAIL>\" \\\n  --header \"X-Auth-Key: <API_KEY>\" \\\n  --header \"Content-Type: application/json\" \\\n  --data '{\n    \"name\": \"<YOUR_WAN_NAME>\",\n    \"physport\": 1,\n    \"priority\": 0,\n    \"vlan_tag\": 0\n  }'\n  bash\n  curl https://api.cloudflare.com/client/v4/accounts/{account_id}/magic/sites/{site_id}/lans \\\n  --header \"X-Auth-Email: <EMAIL>\" \\\n  --header \"X-Auth-Key: <API_KEY>\" \\\n  --header \"Content-Type: application/json\" \\\n  --data '{\n    \"name\": \"<YOUR_LAN_NAME>\",\n    \"physport\": 2,\n    \"static_addressing\": {\n      \"address\": \"172.16.14.0/24\"\n    },\n    \"vlan_tag\": 0\n  }'\n  graphql\nquery telemetry(\n  $accountTag: string\n  $snapshotsFilter: AccountMconnTelemetrySnapshotsAdaptiveGroupsFilter_InputObject!\n  $snapshotMountsFilter: AccountMconnTelemetrySnapshotMountsAdaptiveGroupsFilter_InputObject!\n  $snapshotThermalsFilter: AccountMconnTelemetrySnapshotThermalsAdaptiveGroupsFilter_InputObject!\n  $limit: int64!\n) {\n  viewer {\n    accounts(filter: { accountTag: $accountTag }) {\n      snapshots: mconnTelemetrySnapshots(\n        filter: $snapshotsFilter\n        limit: $limit\n        orderBy: [datetimeFiveMinutes_DESC]\n      ) {\n        max {\n          cpuCount\n          loadAverage1m\n          memoryFreeBytes\n          memoryTotalBytes\n        }\n        dimensions {\n          connectorId\n          datetimeFiveMinutes\n        }\n      }\n      snapshotMounts: mconnTelemetrySnapshotMounts(\n        filter: $snapshotMountsFilter\n        limit: $limit\n        orderBy: [datetimeFiveMinutes_DESC]\n      ) {\n        max {\n          availableBytes\n          totalBytes\n        }\n        dimensions {\n          connectorId\n          datetimeFiveMinutes\n        }\n      }\n      snapshotThermals: mconnTelemetrySnapshotThermals(\n        filter: $snapshotThermalsFilter\n        limit: $limit\n        orderBy: [datetimeFiveMinutes_DESC, connectorId_DESC]\n      ) {\n        max {\n          currentCelcius\n        }\n        dimensions {\n          connectorId\n          datetimeFiveMinutes\n        }\n      }\n    }\n  }\n}\nbash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/alerting/v3/policies\" \\\n    --request POST \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"alert_type\": \"magic_wan_tunnel_health\",\n      \"description\": \"<DESCRIBE_POLICY>\",\n      \"enabled\": true,\n      \"filters\": {\n          \"slo\": [\n              \"99.9\"\n          ]\n      },\n      \"mechanisms\": {\n          \"email\": [\n              {\n                  \"id\": \"EMAIL_ADDRESS\"\n              }\n          ]\n      },\n      \"name\": \"<DESCRIBE_ALERT>\"\n    }'\n  json\n    {\n      \"result\": [\n        {\n          \"id\": \"f174e90a-fafe-4643-bbbc-4a0ed4fc8415\",\n          \"name\": \"<POLICY_NAME>\",\n          \"description\": \"<POLICY_DESCRIPTION>\",\n          \"enabled\": true,\n          \"alert_type\": \"magic_wan_tunnel_health\",\n          \"mechanisms\": {\n            \"email\": [\n              {\n                \"id\": \"<YOUR_EMAIL>\"\n              }\n            ]\n          },\n          \"created\": \"2024-09-11T14:13:29.585658Z\",\n          \"modified\": \"2024-09-11T14:13:29.585658Z\",\n          \"conditions\": {\n            \"and\": [\n              {\n                \"or\": [\n                  {\n                    \"<=\": [\n                      {\n                        \"var\": \"slo\"\n                      },\n                      \"99.9\"\n                    ]\n                  }\n                ]\n              }\n            ]\n          },\n          \"filters\": {\n            \"slo\": [\"99.9\"]\n          }\n        }\n      ],\n      \"success\": true,\n      \"errors\": [],\n      \"messages\": []\n    }\n  bash\ncurl \"https://api.cloudflare.com/client/v4/accounts/ACCOUNT_ID/ipsec_tunnels/TUNNEL_ID\" \\\n  --request PATCH \\\n  --json '{\n    \"custom_remote_identities\": {\n        \"fqdn_id\": \"<your_custom_label>.<account_id>.custom.ipsec.cloudflare.com\"\n    }\n  }'\nbash\n  curl \"https://api.cloudflare.com/client/v4/accounts/%7Baccount_id%7D/magic/ipsec_tunnels/%7Bipsec_tunnel_id%7D\" \\\n    --request PUT \\\n    --json '{\n      \"health_check\": {\n          \"rate\": \"low\"\n      }\n    }'\n  tf\n     locals {\n       default_local_domains = [\n         # Default Local Domain Fallback entries recommended by Cloudflare\n         {\n       suffix = \"corp\"\n     },\n     {\n       suffix = \"domain\"\n     },\n     {\n       suffix = \"home\"\n     },\n     {\n       suffix = \"home.arpa\"\n     },\n     {\n       suffix = \"host\"\n     },\n     {\n       suffix = \"internal\"\n     },\n     {\n       suffix = \"intranet\"\n     },\n     {\n       suffix = \"invalid\"\n     },\n     {\n       suffix = \"lan\"\n     },\n     {\n       suffix = \"local\"\n     },\n     {\n       suffix = \"localdomain\"\n     },\n     {\n       suffix = \"localhost\"\n     },\n     {\n       suffix = \"private\"\n     },\n     {\n       suffix = \"test\"\n     }\n       ]\n     }\n     tf\n     resource \"cloudflare_zero_trust_device_custom_profile_local_domain_fallback\" \"example\" {\n       account_id = var.cloudflare_account_id\n       policy_id  = cloudflare_zero_trust_device_custom_profile.example.id\n       domains = concat(\n         # Global entries\n         local.default_local_domains,\n\n# Profile-specific entries\n         [\n           {\n           suffix = \"example.com\"\n           description = \"Domain for local development\"\n           dns_server = [\"1.1.1.1\", \"192.168.0.1\"]\n           }\n         ]\n       )\n     }\n     mermaid\nflowchart LR\nsubgraph Device\nW[WARP client] -.-> D\nD[DNS proxy]\nW -.-> V[Virtual interface]\nend\nsubgraph Cloudflare\nA[Zero Trust account]\nsubgraph Gateway\nN[L3/L4 firewall]\nG[DNS resolver]\nend\nend\nW<--\"Device\norchestration\"-->A\nsubgraph tunnel[\"WARP tunnel\"]\n ip@{ shape: text, label: \"Network traffic\" }\n  dns@{ shape: text, label: \"DNS traffic\" }\nend\nV --- ip-->N\nD --- dns-->G\nN --> O[(Application)]\nmermaid\nflowchart LR\nD{{DNS request}}-->L[\"Local DNS proxy <br> (127.0.2.2 and 127.0.2.3)\"]-->R{In local domain fallback?}\nR -- Yes --> F[Private DNS resolver]\nR -- No --> G[Cloudflare Gateway]\nsh\n  scutil --dns\n  sh\n  DNS configuration (for scoped queries)\n  resolver #1\n    search domain[0] : <DNS-SEARCH-DOMAIN>\n    nameserver[0] : 127.0.2.2\n    nameserver[1] : 127.0.2.3\n    if_index : 15 (en0)\n    flags    : Scoped, Request A records\n    reach    : 0x00030002 (Reachable,Local Address,Directly Reachable Address)\n  resolver #2\n    nameserver[0] : 127.0.2.2\n    nameserver[1] : 127.0.2.3\n    nameserver[2] : fd01:db8:1111::2\n    nameserver[3] : fd01:db8:1111::3\n    if_index : 23 (utun3)\n    flags    : Scoped, Request A records, Request AAAA records\n    reach    : 0x00030002 (Reachable,Local Address,Directly Reachable Address)\n  powershell\n  ipconfig\n  txt\n  Windows IP Configuration\n\nUnknown adapter CloudflareWARP:\n\nConnection-specific DNS Suffix  . :\n     Description . . . . . . . . . . . : Cloudflare WARP Interface Tunnel\n     Physical Address. . . . . . . . . :\n     DHCP Enabled. . . . . . . . . . . : No\n     Autoconfiguration Enabled . . . . : Yes\n     IPv6 Address. . . . . . . . . . . : 2606:4700:110:8f79:145:f180:fc4:8106(Preferred)\n     Link-local IPv6 Address . . . . . : fe80::83b:d647:4bed:d388%49(Preferred)\n     IPv4 Address. . . . . . . . . . . : 172.16.0.2(Preferred)\n     Subnet Mask . . . . . . . . . . . : 255.255.255.255\n     Default Gateway . . . . . . . . . :\n     DNS Servers . . . . . . . . . . . : 127.0.2.2\n                                         127.0.2.3\n     NetBIOS over Tcpip. . . . . . . . : Enabled\n  sh\n  cat /etc/resolv.conf\n  sh\n  # This file was generated by cloudflare-warp.\n  nameserver 127.0.2.2\n  nameserver 127.0.2.3\n  nameserver fd01:db8:1111::2\n  nameserver fd01:db8:1111::3\n  search <DNS-SEARCH-DOMAIN>\n  options edns0\n  options trust-ad\n  mermaid\nflowchart LR\nP{{IP packet}}-->R[\"OS routing table\"]-->F[\"OS firewall\"] --> S{Excluded from Split Tunnels?}\nS -- Yes --> A[(Application)]\nS -- No --> U[\"Virtual interface<br> (172.16.0.2)\"] --> G[Cloudflare Gateway]\nsh\n  ifconfig\n  sh\n  <redacted>\n  utun3: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 1280\n    inet 172.16.0.2 --> 172.16.0.2 netmask 0xffffffff\n    inet6 fe80::f6d4:88ff:fe82:6d9e%utun3 prefixlen 64 scopeid 0x17\n    inet6 2606:4700:110:8c7d:7369:7526:a59b:5636 prefixlen 128\n    nd6 options=201<PERFORMNUD,DAD>\n  powershell\n  ipconfig\n  txt\n  Windows IP Configuration\n\nUnknown adapter CloudflareWARP:\n\nConnection-specific DNS Suffix  . :\n     Description . . . . . . . . . . . : Cloudflare WARP Interface Tunnel\n     Physical Address. . . . . . . . . :\n     DHCP Enabled. . . . . . . . . . . : No\n     Autoconfiguration Enabled . . . . : Yes\n     IPv6 Address. . . . . . . . . . . : 2606:4700:110:8f79:145:f180:fc4:8106(Preferred)\n     Link-local IPv6 Address . . . . . : fe80::83b:d647:4bed:d388%49(Preferred)\n     IPv4 Address. . . . . . . . . . . : 172.16.0.2(Preferred)\n     Subnet Mask . . . . . . . . . . . : 255.255.255.255\n     Default Gateway . . . . . . . . . :\n     DNS Servers . . . . . . . . . . . : 127.0.2.2\n                                         127.0.2.3\n     NetBIOS over Tcpip. . . . . . . . : Enabled\n  sh\n  ip addr\n  sh\n  <redacted>\n  3: CloudflareWARP: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1280 qdisc mq state UNKNOWN group default qlen 500\n      link/none\n      inet 172.16.0.2/32 scope global CloudflareWARP\n         valid_lft forever preferred_lft forever\n      inet6 2606:4700:110:8a2e:a5f7:a8de:a1f9:919/128 scope global\n         valid_lft forever preferred_lft forever\n      inet6 fe80::117e:276b:8a79:c498/64 scope link stable-privacy\n         valid_lft forever preferred_lft forever\n  sh\n  route get google.com\n  sh\n     route to: lga25s81-in-f14.1e100.net\n  destination: 136.0.0.0\n         mask: 248.0.0.0\n    interface: utun3\n        flags: <UP,DONE,PRCLONING>\n   recvpipe  sendpipe  ssthresh  rtt,msec    rttvar  hopcount      mtu     expire\n         0         0         0         0         0         0      1280         0\n  sh\n  route get 169.254.0.0\n  sh\n     route to: 169.254.0.0\n  destination: 169.254.0.0\n         mask: 255.255.0.0\n    interface: en0\n        flags: <UP,DONE,CLONING,STATIC>\n   recvpipe  sendpipe  ssthresh  rtt,msec    rttvar  hopcount      mtu     expire\n         0         0         0         0         0         0      1500   -210842\n  powershell\n  Find-NetRoute -RemoteIPAddress \"1.1.1.1\" | Select-Object InterfaceAlias -Last 1\n  txt\n  InterfaceAlias\n  --------------\n  CloudflareWARP\n  powershell\n  Find-NetRoute -RemoteIPAddress \"169.254.0.0\" | Select-Object InterfaceAlias -Last 1\n  txt\n  InterfaceAlias\n  --------------\n  Wi-Fi\n  sh\n  ip route get 1.1.1.1\n  sh\n  1.1.1.1 dev CloudflareWARP table 65743 src 172.16.0.2 uid 1000\n      cache\n  sh\n  ip route get 169.254.0.0\n  sh\n  169.254.0.0 dev ens18 src 172.24.8.6 uid 1000\n      cache\n  tf\n     resource \"cloudflare_zero_trust_device_custom_profile\" \"exclude_example\" {\n       account_id            = var.cloudflare_account_id\n       name                  = \"Custom profile in Split Tunnels Exclude mode\"\n       enabled               = true\n       precedence            = 101\n       service_mode_v2       = {mode = \"warp\"}\n       match                 =  \"identity.email == \\\"test@cloudflare.com\\\"\"\n\nexclude = [{\n           address = \"10.0.0.0/8\"\n           description = \"Example route to exclude from WARP tunnel\"\n       }]\n     }\n     tf\n     resource \"cloudflare_zero_trust_device_custom_profile\" \"include_example\" {\n       account_id            = var.cloudflare_account_id\n       name                  = \"Custom profile in Split Tunnels Include mode\"\n       enabled               = true\n       precedence            = 101\n       service_mode_v2       = {mode = \"warp\"}\n       match                 =  \"identity.email == \\\"test@cloudflare.com\\\"\"\n\ninclude = [{\n           address = \"10.0.0.0/8\"\n           description = \"Example route to include in WARP tunnel\"\n       }]\n     }\n     tf\n     locals {\n       global_exclude_list = [\n         # Default Split Tunnel entries recommended by Cloudflare\n         {\n           address     = \"ff05::/16\"\n         },\n         {\n           address     = \"ff04::/16\"\n         },\n         {\n           address     = \"ff03::/16\"\n         },\n         {\n           address     = \"ff02::/16\"\n         },\n         {\n           address     = \"ff01::/16\"\n         },\n         {\n           address     = \"fe80::/10\"\n           description = \"IPv6 Link Local\"\n         },\n         {\n           address     = \"fd00::/8\"\n         },\n         {\n           address     = \"255.255.255.255/32\"\n           description = \"DHCP Broadcast\"\n         },\n         {\n           address     = \"240.0.0.0/4\"\n         },\n         {\n           address     = \"224.0.0.0/24\"\n         },\n         {\n           address     = \"192.168.0.0/16\"\n         },\n         {\n           address     = \"192.0.0.0/24\"\n         },\n         {\n           address     = \"172.16.0.0/12\"\n         },\n         {\n           address     = \"169.254.0.0/16\"\n           description = \"DHCP Unspecified\"\n         },\n         {\n           address     = \"100.64.0.0/10\"\n         },\n         {\n           address     = \"10.0.0.0/8\"\n         }\n       ]\n     }\n     tf\n     resource \"cloudflare_zero_trust_device_custom_profile\" \"example\" {\n       account_id            = var.cloudflare_account_id\n       name                  = \"Example custom profile with split tunnels\"\n       enabled               = true\n       precedence            = 101\n       service_mode_v2       = {mode = \"warp\"}\n       match                 =  \"identity.email == \\\"test@cloudflare.com\\\"\"\n\nexclude = concat(\n         # Global entries\n         local.global_exclude_list,\n\n# Profile-specific entries\n         [\n           {\n             address = \"192.0.2.0/24\"\n             description = \"Example IP to exclude from WARP\"\n           },\n           {\n             host = \"example.com\"\n             description = \"Example domain to exclude from WARP\"\n           }\n         ]\n       )\n     }\n     bash\ncurl \"https://api.cloudflare.com/client/v4/zones/$ZONE_ID/devices/policy/certificates\" \\\n  --request PATCH \\\n  --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n  --json '{\n    \"enabled\": true\n  }'\nsh\n     $ certutil -L -d sql:/etc/pki/nssdb\n     xml\n<key>auth_client_id</key>\n<string>88bf3b6d86161464f6509f7219099e57.access</string>\n<key>auth_client_secret</key>\n<string>bdd31cbc4dec990953e39163fbbb194c93313ca9f0a6e420346af9d326b1d2a5</string>\nxml\n  <key>service_mode</key>\n  <string>proxy</string>\n  <key>proxy_port</key>\n  <integer>44444</integer>\n  xml\n<dict>\n  <key>organization</key>\n  <string>your-team-name</string>\n  <key>warp_tunnel_protocol</key>\n  <string>masque</string>\n  <key>enable_pmtud</key>\n  <true/>\n</dict>\ntxt\n   ====================================================================\n   H3 Quic Connect\n   ====================================================================\n\nTesting H3 QUIC connectivity to 'https://cloudflare-quic.com/cdn-cgi/l4-stats' result: Successful\n   IPv4:\n   \"\n   Headers:\n     server address=104.18.26.14:443\n     ...\n\nBody:\n     transport=TCP\n     ...\n\nPMTU:\n     1500 bytes\n   \"\n   xml\n<dict>\n  <key>organization</key>\n  <string>your-team-name</string>\n  <key>onboarding</key>\n  <false/>\n</dict>\nxml\n     <key>AutoLaunchProtocolsFromOrigins</key>\n     <array>\n       <dict>\n         <key>allowed_origins</key>\n         <array>\n           <string>https://<your-team-name>.cloudflareaccess.com</string>\n         </array>\n         <key>protocol</key>\n         <string>com.cloudflare.warp</string>\n       </dict>\n     </array>\n     xml\n     <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n     <!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n     <plist version=\"1.0\">\n     <dict>\n         <key>PayloadIdentifier</key>\n         <string>com.google.chrome</string>\n         <key>PayloadRemovalDisallowed</key>\n         <true/>\n         <key>PayloadScope</key>\n         <string>System</string>\n         <key>PayloadType</key>\n         <string>Configuration</string>\n         <key>PayloadUUID</key>\n         <string>8FCBDCA7-87B3-4610-A01A-B0FE4C5B57C8</string>\n         <key>PayloadOrganization</key>\n         <string></string>\n         <key>PayloadVersion</key>\n         <integer>1</integer>\n         <key>PayloadDisplayName</key>\n         <string>Google Chrome Policy</string>\n         <key>PayloadContent</key>\n         <array>\n             <dict>\n                 <key>PayloadType</key>\n                 <string>com.apple.ManagedClient.preferences</string>\n                 <key>PayloadVersion</key>\n                 <integer>1</integer>\n                 <key>PayloadIdentifier</key>\n                 <string>com.normandale</string>\n                 <key>PayloadUUID</key>\n                 <string>8FCBDCA7-87B3-4610-A01A-B0FE4C5B57C8</string>\n                 <key>PayloadEnabled</key>\n                 <true/>\n                 <key>PayloadDisplayName</key>\n                 <string>Custom: (com.google.Chrome)</string>\n                 <key>PayloadContent</key>\n                 <dict>\n                     <key>com.google.Chrome</key>\n                     <dict>\n                         <key>Forced</key>\n                         <array>\n                             <dict>\n                                 <key>mcx_preference_settings</key>\n                                 <dict>\n                                     <key>AutoLaunchProtocolsFromOrigins</key>\n                                     <array>\n                                     <dict>\n                                     <key>allowed_origins</key>\n                                     <array>\n                                     <string>https://<your-team-name>.cloudflareaccess.com</string>\n                                     </array>\n                                     <key>protocol</key>\n                                     <string>com.cloudflare.warp</string>\n                                     </dict>\n                                     </array>\n                                 </dict>\n                             </dict>\n                         </array>\n                     </dict>\n                 </dict>\n             </dict>\n         </array>\n     </dict>\n     </plist>\n     xml\n<dict>\n  <key>configs</key>\n  <array>\n    <dict>\n      <key>organization</key>\n      <string>mycompany</string>\n      <key>display_name</key>\n      <string>Production environment</string>\n    </dict>\n    <dict>\n      <key>organization</key>\n      <string>mycompany</string>\n      <key>override_api_endpoint</key>\n      <string>203.0.113.0</string>\n      <key>override_doh_endpoint</key>\n      <string>203.0.113.0</string>\n      <key>override_warp_endpoint</key>\n      <string>203.0.113.0:0</string>\n      <key>display_name</key>\n      <string>China employees</string>\n    </dict>\n    <dict>\n      <key>organization</key>\n      <string>test-org</string>\n      <key>display_name</key>\n      <string>Test environment</string>\n    </dict>\n  </array>\n</dict>\nxml\n<dict>\n  <key>multi_user</key>\n  <true/>\n  <key>configs</key>\n  <array>\n    <dict>\n      <key>organization</key>\n      <string>your-team-name</string>\n      <key>display_name</key>\n      <string>Default</string>\n    </dict>\n  </array>\n</dict>\nxml\n<dict>\n  <key>multi_user</key>\n  <true/>\n  <key>pre_login</key>\n  <dict>\n    <key>organization</key>\n    <string>mycompany</string>\n    <key>auth_client_id</key>\n    <string>88bf3b6d86161464f6509f7219099e57.access</string>\n    <key>auth_client_secret</key>\n    <string>bdd31cbc4dec990953e39163fbbb194c93313ca9f0a6e420346af9d326b1d2a5</string>\n  </dict>\n  <key>configs</key>\n  <array>\n    <dict>\n      <key>organization</key>\n      <string>mycompany</string>\n      <key>display_name</key>\n      <string>Production environment</string>\n    </dict>\n    <dict>\n      <key>organization</key>\n      <string>test-org</string>\n      <key>display_name</key>\n      <string>Test environment</string>\n    </dict>\n  </array>\n</dict>\nmermaid\nflowchart TB\n    start([\"Enable multi-user mode\"])-->reg[\"Active Windows user is prompted to register WARP\"]\n\t\treg--\"Log out of Windows\"-->prelogin\n\t\treg--\"Switch user\"-->regexists\n\nsubgraph preloginbehavior[\"Windows login screen\"]\n\t\tprelogin{{\"Is there a pre-login <br />registration?\"}}\n    preloginyes[\"Use pre-login settings\"]\n\t\tprelogin--\"Yes\"-->preloginyes\n\t\tprelogin-. \"No\" .->preloginno\n\t\tpreloginno[\"Stay registered as <br />previous Windows user\"]\n\t\tend\n\npreloginbehavior--\"Log in to Windows\"---->regexists{{\"Has the user already registered with WARP?\"}}\n\t\tregexists--\"Yes\"-->user[\"Switch to that user's registration\"]\n\t\tregexists-. \"No\" .->reg\nbash\n     curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/access/service_tokens\" \\\n       --request POST \\\n       --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n       --json '{\n         \"name\": \"CI/CD token\",\n         \"duration\": \"8760h\"\n       }'\n     json\n     \"result\": {\n       \"client_id\": \"88bf3b6d86161464f6509f7219099e57.access\",\n       \"client_secret\": \"bdd31cbc4dec990953e39163fbbb194c93313ca9f0a6e420346af9d326b1d2a5\",\n       \"created_at\": \"2025-09-25T22:26:26Z\",\n       \"expires_at\": \"2026-09-25T22:26:26Z\",\n       \"id\": \"3537a672-e4d8-4d89-aab9-26cb622918a1\",\n       \"name\": \"CI/CD token\",\n       \"updated_at\": \"2025-09-25T22:26:26Z\",\n       \"duration\": \"8760h\",\n       \"client_secret_version\": 1\n     }\n     tf\n     resource \"cloudflare_zero_trust_access_service_token\" \"example_service_token\" {\n       account_id = var.cloudflare_account_id\n       name       = \"Example service token\"\n       duration  = \"8760h\"\n\nlifecycle {\n         create_before_destroy = true\n       }\n     }\n     tf\n        output \"example_service_token_client_id\" {\n          value     = cloudflare_zero_trust_access_service_token.example_service_token.client_id\n        }\n\noutput \"example_service_token_client_secret\" {\n          value     = cloudflare_zero_trust_access_service_token.example_service_token.client_secret\n          sensitive = true\n        }\n        sh\n        terraform apply\n        sh\n        terraform output -raw example_service_token_client_id\n        sh\n        terraform output -raw example_service_token_client_secret\n        tf\n       resource \"vault_generic_secret\" \"example_service_token\" {\n         path         = \"kv/cloudflare/example_service_token\"\n\ndata_json = jsonencode({\n           \"CLIENT_ID\"     = cloudflare_access_service_token.example_service_token.client_id\n           \"CLIENT_SECRET\" = cloudflare_access_service_token.example_service_token.client_secret\n         })\n       }\n     xml\n<dict>\n  <key>pre_login</key>\n  <dict>\n    <key>organization</key>\n    <string>mycompany</string>\n    <key>auth_client_id</key>\n    <string>TOKEN-ID</string>\n    <key>auth_client_secret</key>\n    <string>TOKEN-SECRET</string>\n  </dict>\n  <key>configs</key>\n  <array>\n    <dict>\n      <key>organization</key>\n      <string>mycompany</string>\n      <key>display_name</key>\n      <string>Default</string>\n    </dict>\n  </array>\n</dict>\ntxt\n   <account tag>@CF-emailsecurity.com\n   sh\n   cloudflared service install\n   sh\n   systemctl start cloudflared\n   sh\n   systemctl status cloudflared\n   sh\nsystemctl restart cloudflared\nsh\ncloudflared service install\nsh\nsudo cloudflared service install\nsh\nsudo launchctl start com.cloudflare.cloudflared\nsh\nsudo launchctl stop com.cloudflare.cloudflared\nsudo launchctl start com.cloudflare.cloudflared\nbash\n   C:\\Cloudflared\\bin\n   bash\n   cloudflared.exe service install\n   bash\n   mkdir C:\\Windows\\System32\\config\\systemprofile\\.cloudflared\n   bash\n   cloudflared.exe login\n   bash\n   copy C:\\Users\\%USERNAME%\\.cloudflared\\cert.pem C:\\Windows\\System32\\config\\systemprofile\\.cloudflared\\cert.pem\n   bash\n   cloudflared.exe tunnel create <Tunnel Name>\n   txt\n    tunnel: <Tunnel ID>\n    credentials-file: C:\\Windows\\System32\\config\\systemprofile\\.cloudflared\\<Tunnel-ID>.json\n    # Uncomment the following two lines if you are using self-signed certificates in your origin server\n    # originRequest:\n    #   noTLSVerify: true\n\ningress:\n      - hostname: app.mydomain.com\n        service: https://internal.mydomain.com\n      - service: http_status:404\n    logfile:  C:\\Cloudflared\\cloudflared.log\n    bash\n    copy C:\\Users\\%USERNAME%\\.cloudflared\\<Tunnel-ID>.json C:\\Windows\\System32\\config\\systemprofile\\.cloudflared\\<Tunnel-ID>.json\n    bash\n    cloudflared.exe tunnel ingress validate\n    bash\n    C:\\Cloudflared\\bin\\cloudflared.exe --config=C:\\Windows\\System32\\config\\systemprofile\\.cloudflared\\config.yml tunnel run\n    bash\n    sc start cloudflared\n    txt\n    SERVICE_NAME: cloudflared\n            TYPE               : 10  WIN32_OWN_PROCESS\n            STATE              : 2  START_PENDING\n                                    (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)\n            WIN32_EXIT_CODE    : 0  (0x0)\n            SERVICE_EXIT_CODE  : 0  (0x0)\n            CHECKPOINT         : 0x0\n            WAIT_HINT          : 0x7d0\n            PID                : 3548\n            FLAGS              :\n    bash\nsc stop cloudflared\nsc start cloudflared\nmermaid\n\tflowchart TB\n\taccTitle: Routed subnets\n\taccDescr: Some LANs are complex, and might have additional subnets behind L3 routers.\n\nsubgraph b [Magic WAN Connector]\n\tdirection TB\n\tc(LAN 1)\n\td(LAN n)\n\tend\n\nc --- e(subnet x):::blue\n\td --- f(subnet 192.168.100.0/24):::blue\n\nf---|192.168.100.10|g(Layer 3 router)\n\ng --- h(routed subnet y):::red\n\tg --- i(192.168.200.0/24):::red\n\tg --- j(layer 3 router)\n\tj --- k(routed subnet z):::red\n\nclassDef blue fill:#add8e6,color: black\n\tclassDef red fill:#ff6900,color: black\nmermaid\n\tflowchart LR\n\taccTitle: In this example, there are LANs where traffic flows between each other, instead of going to Cloudflare first.\n\t\t\ta(Magic WAN Connector) <---> b(Internet) <---> c(Cloudflare)\n\nsubgraph Customer site\n\t\t\td[LAN 1] <---> a\n\t\t\te[LAN 2] <---> a\n\t\t\tg[LAN 3] <---> a\n\t\t\th[LAN 4] <---> a\n\t\t\tend\n\t\t\tclassDef orange fill:#f48120,color: black\n\t\t\tclass a,c orange\n\nlinkStyle 0,1,2,3 stroke:#f48120,stroke-width:3px\n\t\t\tlinkStyle 4,5 stroke:red,stroke-width:3px\nbash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/acls\" \\\n    --request POST \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"description\": \"<POLICY_DESCRIPTION>\",\n      \"forward_locally\": true,\n      \"lan_1\": {\n          \"lan_id\": \"<LAN_ID>\",\n          \"lan_name\": \"<LAN_NAME>\",\n          \"ports\": [\n              1\n          ],\n          \"subnets\": [\n              \"192.0.2.1\"\n          ]\n      },\n      \"lan_2\": {\n          \"lan_id\": \"<LAN_ID>\",\n          \"lan_name\": \"<LAN_NAME\",\n          \"ports\": [\n              1\n          ],\n          \"subnets\": [\n              \"192.0.2.1\"\n          ]\n      },\n      \"name\": \"<POLICY_NAME>\",\n      \"protocols\": [\n          \"tcp\"\n      ]\n    }'\n  json\n  {\n    \"errors\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"messages\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"result\": {\n      \"id\": \"023e105f4ecef8ad9ca31a8372d0c353\",\n      \"description\": \"Allows local traffic between PIN pads and cash register.\",\n      \"forward_locally\": true,\n      \"lan_1\": {\n        \"lan_id\": \"lan_id\",\n        \"lan_name\": \"lan_name\",\n        \"port_ranges\": [\n          \"8080-9000\"\n        ],\n        \"ports\": [\n          1\n        ],\n        \"subnets\": [\n          \"192.0.2.1\"\n        ]\n      },\n      \"lan_2\": {\n        \"lan_id\": \"lan_id\",\n        \"lan_name\": \"lan_name\",\n        \"port_ranges\": [\n          \"8080-9000\"\n        ],\n        \"ports\": [\n          1\n        ],\n        \"subnets\": [\n          \"192.0.2.1\"\n        ]\n      },\n      \"name\": \"PIN Pad - Cash Register\",\n      \"protocols\": [\n        \"tcp\"\n      ],\n      \"unidirectional\": true\n    },\n    \"success\": true\n  }\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/acls/$ACL_ID\" \\\n    --request PUT \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"description\": \"<POLICY_DESCRIPTION>\",\n      \"forward_locally\": true,\n      \"lan_1\": {\n          \"lan_id\": \"<LAN_ID>\",\n          \"lan_name\": \"<LAN_NAME>\",\n          \"ports\": [\n              1\n          ],\n          \"subnets\": [\n              \"192.0.2.1\"\n          ]\n      },\n      \"lan_2\": {\n          \"lan_id\": \"<LAN_ID>\",\n          \"lan_name\": \"<LAN_NAME>\",\n          \"ports\": [\n              1\n          ],\n          \"subnets\": [\n              \"192.0.2.1\"\n          ]\n      },\n      \"name\": \"<POLICY_NAME>\",\n      \"protocols\": [\n          \"tcp\"\n      ]\n    }'\n  json\n  {\n    \"errors\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"messages\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"result\": {\n      \"id\": \"023e105f4ecef8ad9ca31a8372d0c353\",\n      \"connector_id\": \"ac60d3d0435248289d446cedd870bcf4\",\n      \"description\": \"description\",\n      \"ha_mode\": true,\n      \"location\": {\n        \"lat\": \"37.6192\",\n        \"lon\": \"122.3816\"\n      },\n      \"name\": \"site_1\",\n      \"secondary_connector_id\": \"8d67040d3835dbcf46ce29da440dc482\"\n    },\n    \"success\": true\n  }\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/sites/$SITE_ID/acls/$ACL_ID\" \\\n    --request DELETE \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\"\n  bash\ncurl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/zerotrust/subnets/cloudflare_source/$ADDRESS_FAMILY\" \\\n  --request PATCH \\\n  --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n  --json '{\n    \"comment\": \"example_comment\",\n    \"name\": \"IPv4 Cloudflare Source IPs\",\n    \"network\": \"100.64.0.0/12\"\n  }'\nbash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/gre_tunnels\" \\\n    --request POST \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"name\": \"<TUNNEL_NAME>\",\n      \"description\": \"<TUNNEL_DESCRIPTION>\",\n      \"interface_address\": \"<INTERFACE_ADDRESS>\",\n      \"cloudflare_gre_endpoint\": \"<CLOUDFLARE_ENDPOINT>\",\n      \"customer_gre_endpoint\": \"<CUSTOMER_ENDPOINT>\"\n    }'\n  json\n  {\n    \"errors\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"messages\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"result\": {\n      \"gre_tunnels\": [\n        {\n          \"cloudflare_gre_endpoint\": \"<IP_ADDRESS>\",\n          \"customer_gre_endpoint\": \"<IP_ADDRESS>\",\n          \"interface_address\": \"<INTERFACE_CIDR>\",\n          \"name\": \"<TUNNEL_NAME>\",\n          \"description\": \"<TUNNEL_DESCRIPTION>\",\n          \"health_check\": {\n            \"direction\": \"unidirectional\",\n            \"enabled\": true,\n            \"rate\": \"low\",\n            \"type\": \"reply\"\n          },\n          \"mtu\": 0,\n          \"ttl\": 0\n        }\n      ]\n    },\n    \"success\": true\n  }\n  bash\n     curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/ipsec_tunnels\" \\\n       --request POST \\\n       --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n       --json '{\n         \"name\": \"<TUNNEL_NAME>\",\n         \"description\": \"<TUNNEL_DESCRIPTION>\",\n         \"interface_address\": \"<INTERFACE_ADDRESS>\",\n         \"cloudflare_endpoint\": \"<CLOUDFLARE_ENDPOINT>\",\n         \"customer_endpoint\": \"<CUSTOMER_ENDPOINT>\"\n       }'\n     json\n     {\n       \"errors\": [\n         {\n           \"code\": 1000,\n           \"message\": \"message\"\n         }\n       ],\n       \"messages\": [\n         {\n           \"code\": 1000,\n           \"message\": \"message\"\n         }\n       ],\n       \"result\": {\n         \"ipsec_tunnels\": [\n           {\n             \"id\": \"<IPSEC_TUNNEL_ID>\",\n             \"interface_address\": \"<INTERFACE_CIDR>\",\n             \"name\": \"<TUNNEL_NAME>\",\n             \"cloudflare_endpoint\": \"<IP_ADDRESS>\",\n             \"customer_endpoint\": \"<IP_ADDRESS>\",\n             \"description\": \"<TUNNEL_DESCRIPTION>\",\n             \"health_check\": {\n               \"direction\": \"unidirectional\",\n               \"enabled\": true,\n               \"rate\": \"low\",\n               \"type\": \"reply\"\n             },\n             \"psk_metadata\": {},\n             \"replay_protection\": false\n           }\n         ]\n       },\n       \"success\": true\n     }\n     bash\n     curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/ipsec_tunnels/$IPSEC_TUNNEL_ID/psk_generate\" \\\n       --request POST \\\n       --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\"\n     json\n     {\n       \"result\": {\n         \"ipsec_id\": \"<IPSEC_ID>\",\n         \"ipsec_tunnel_id\": \"<IPSEC_TUNNEL_ID>\",\n         \"psk\": \"<PSK_CODE>\",\n         \"psk_metadata\": {\n           \"last_generated_on\": \"2025-03-13T14:28:47.054317925Z\"\n         }\n       },\n       \"success\": true,\n       \"errors\": [],\n       \"messages\": []\n     }\n     bash\n     curl \"https://api.cloudflare.com/client/v4/accounts/%7Baccount_id%7D/magic/ipsec_tunnels/%7Bipsec_tunnel_id%7D\" \\\n       --request PUT \\\n       --json '{\n         \"psk\": \"<PSK_VALUE>\"\n       }'\n     json\n  {\n    \"result\": {\n      \"modified\": true,\n      \"modified_ipsec_tunnel\": {\n        \"id\": \"<IPSEC_ID>\",\n        \"interface_address\": \"<IPSEC_CIDR>\",\n        \"created_on\": \"2025-03-13T14:28:21.139535Z\",\n        \"modified_on\": \"2025-03-13T14:33:26.09683Z\",\n        \"name\": \"<TUNNEL_NAME>\",\n        \"cloudflare_endpoint\": \"<IP_ADDRESS>\",\n        \"customer_endpoint\": \"<IP_ADDRESS>\",\n        \"remote_identities\": {\n          \"hex_id\": \"\",\n          \"fqdn_id\": \"\",\n          \"user_id\": \"\"\n        },\n        \"psk_metadata\": {\n          \"last_generated_on\": \"2025-03-13T14:28:47.054318Z\"\n        },\n        \"description\": \"<TUNNEL_DESCRIPTION>\",\n        \"health_check\": {\n          \"enabled\": true,\n          \"target\": \"\",\n          \"type\": \"reply\",\n          \"rate\": \"mid\",\n          \"direction\": \"unidirectional\"\n        }\n      }\n    },\n    \"success\": true,\n    \"errors\": [],\n    \"messages\": []\n  }\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/%7Baccount_id%7D/magic/ipsec_tunnels/%7Bipsec_tunnel_id%7D\" \\\n    --request PUT \\\n    --json '{\n      \"health_check\": {\n          \"direction\": \"bidirectional\"\n      }\n    }'\n  json\n  {\n    \"result\": {\n      \"modified\": true,\n      \"modified_ipsec_tunnel\": {\n        \"id\": \"<IPSEC_ID>\",\n        \"interface_address\": \"<IPSEC_CIDR>\",\n        \"created_on\": \"2025-03-13T14:28:21.139535Z\",\n        \"modified_on\": \"2025-03-13T14:33:26.09683Z\",\n        \"name\": \"<TUNNEL_NAME>\",\n        \"cloudflare_endpoint\": \"<IP_ADDRESS>\",\n        \"customer_endpoint\": \"<IP_ADDRESS>\",\n        \"remote_identities\": {\n          \"hex_id\": \"\",\n          \"fqdn_id\": \"\",\n          \"user_id\": \"\"\n        },\n        \"psk_metadata\": {\n          \"last_generated_on\": \"2025-03-13T14:28:47.054318Z\"\n        },\n        \"description\": \"<TUNNEL_DESCRIPTION>\",\n        \"health_check\": {\n          \"enabled\": true,\n          \"target\": \"\",\n          \"type\": \"reply\",\n          \"rate\": \"mid\",\n          \"direction\": \"bidirectional\"\n        }\n      }\n    },\n    \"success\": true,\n    \"errors\": [],\n    \"messages\": []\n  }\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/routes\" \\\n    --request POST \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"nexthop\": \"<IP_NEXT_HOP>\",\n      \"prefix\": \"<YOUR_IP_PREFIX>\",\n      \"priority\": 0,\n      \"id\": \"023e105f4ecef8ad9ca31a8372d0c353\",\n      \"description\": \"<ROUTE_DESCRIPTION>\",\n      \"scope\": {\n          \"colo_names\": [\n              \"den01\"\n          ],\n          \"colo_regions\": [\n              \"APAC\"\n          ]\n      },\n      \"weight\": 0\n    }'\n  json\n  {\n    \"errors\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"messages\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"result\": {\n      \"routes\": [\n        {\n          \"nexthop\": \"203.0.113.1\",\n          \"prefix\": \"192.0.2.0/24\",\n          \"priority\": 0,\n          \"id\": \"023e105f4ecef8ad9ca31a8372d0c353\",\n          \"description\": \"New route for new prefix 203.0.113.1\",\n          \"scope\": {\n            \"colo_names\": [\n              \"den01\"\n            ],\n            \"colo_regions\": [\n              \"APAC\"\n            ]\n          },\n          \"weight\": 0\n        }\n      ]\n    },\n    \"success\": true\n  }\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/routes/$ROUTE_ID\" \\\n    --request PUT \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"nexthop\": \"<IP_NEXT_HOP>\",\n      \"prefix\": \"<YOUR_IP_PREFIX>\",\n      \"priority\": 0,\n      \"id\": \"023e105f4ecef8ad9ca31a8372d0c353\",\n      \"description\": \"<ROUTE_DESCRIPTION>\",\n      \"scope\": {\n          \"colo_names\": [\n              \"den01\"\n          ],\n          \"colo_regions\": [\n              \"APAC\"\n          ]\n      },\n      \"weight\": 0\n    }'\n  json\n  {\n    \"errors\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"messages\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"result\": {\n      \"modified\": true,\n      \"modified_route\": {\n        \"nexthop\": \"203.0.113.1\",\n        \"prefix\": \"192.0.2.0/24\",\n        \"priority\": 0,\n        \"id\": \"023e105f4ecef8ad9ca31a8372d0c353\",\n        \"description\": \"New route for new prefix 203.0.113.1\",\n        \"scope\": {\n          \"colo_names\": [\n            \"den01\"\n          ],\n          \"colo_regions\": [\n            \"APAC\"\n          ]\n        },\n        \"weight\": 0\n      }\n    },\n    \"success\": true\n  }\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/routes/$ROUTE_ID\" \\\n    --request DELETE \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\"\n  json\n  {\n    \"errors\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"messages\": [\n      {\n        \"code\": 1000,\n        \"message\": \"message\"\n      }\n    ],\n    \"result\": {\n      \"deleted\": true,\n      \"deleted_route\": {\n        \"nexthop\": \"203.0.113.1\",\n        \"prefix\": \"192.0.2.0/24\",\n        \"priority\": 0,\n        \"id\": \"023e105f4ecef8ad9ca31a8372d0c353\",\n        \"description\": \"New route for new prefix 203.0.113.1\",\n        \"scope\": {\n          \"colo_names\": [\n            \"den01\"\n          ],\n          \"colo_regions\": [\n            \"APAC\"\n          ]\n        },\n        \"weight\": 0\n      }\n    },\n    \"success\": true\n  }\n  bash\n  curl \"https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/magic/ipsec_tunnels\" \\\n    --request POST \\\n    --header \"Authorization: Bearer $CLOUDFLARE_API_TOKEN\" \\\n    --json '{\n      \"cloudflare_endpoint\": \"<CLOUDFLARE_ENDPOINT>\",\n      \"interface_address\": \"<INTERFACE_ADDRESS>\",\n      \"name\": \"IPsec_1\",\n      \"customer_endpoint\": \"<CUSTOMER_ENDPOINT>\",\n      \"description\": \"Tunnel for ISP X\",\n      \"psk\": \"<PSK>\",\n      \"automatic_return_routing\": \"true\"\n    }'\n  sh\nsudo traceroute -s 10.1.0.100 -I 10.3.0.100\nsh\ntraceroute to 10.3.0.100 (10.3.0.100), 30 hops max, 60 byte packets\n 1  * * *\n 2  * * *\n 3  * * *\n 4  * * *\n 5  * * *\n 6  * * *\n 7  * * *\n 8  * * *\n 9  * * *\n10  10.3.0.100 (10.3.0.100)  420.505 ms  420.779 ms  420.776 ms\nsh\nsudo ip link set cf_gre type gre ttl 64\nsudo traceroute -s 10.1.0.100 -I 10.3.0.100\nsh\ntraceroute to 10.3.0.100 (10.3.0.100), 30 hops max, 60 byte packets\n 1  10.0.0.11 (10.0.0.11)  58.947 ms  58.933 ms  58.930 ms\n 2  173.245.60.175 (173.245.60.175)  61.138 ms  61.316 ms  61.313 ms\n 3  172.68.145.21 (172.68.145.21)  367.448 ms  367.532 ms  367.530 ms\n 4  mplat-e2e-vm3.c.magic-transit.internal (10.152.0.20)  370.362 ms  370.440 ms  370.522 ms\n 5  10.3.0.100 (10.3.0.100)  370.519 ms  370.541 ms  518.152 ms\nsh\nsudo sysctl -w net.ipv4.conf.CloudflareWARP.rp_filter=2\nsh\nnet.ipv4.conf.CloudflareWARP.rp_filter = 2\nsh\nsudo traceroute -s 172.16.0.2 -I 10.3.0.100\nsh\ntraceroute to 10.3.0.100 (10.3.0.100), 30 hops max, 60 byte packets\n 1  169.254.21.171 (169.254.21.171)  48.887 ms  48.894 ms  48.620 ms\n 2  173.245.60.175 (173.245.60.175)  49.403 ms  49.519 ms  49.603 ms\n 3  172.68.65.7 (172.68.65.7)  357.499 ms  357.519 ms  357.520 ms\n 4  mplat-e2e-vm3.c.magic-transit.internal (10.152.0.20)  360.024 ms  360.086 ms  360.078 ms\n 5  10.3.0.100 (10.3.0.100)  360.283 ms  360.297 ms  360.489 ms\nbash\ncurl \"https://api.cloudflare.com/client/v4/accounts/{account_id}/magic/ipsec_tunnels?validate_only=true\" \\\n--header \"X-Auth-Email: <EMAIL>\" \\\n--header \"X-Auth-Key: <API_KEY>\" \\\n--header \"Content-Type: application/json\" \\\n--data '{\n  \"ipsec_tunnels\": [\n    {\n      \"name\": \"EdgeConnect_IPSEC_1\",\n      \"customer_endpoint\": \"35.188.72.56\",\n      \"cloudflare_endpoint\": \"172.64.241.205\",\n      \"interface_address\": \"192.168.10.11/31\",\n      \"description\": \"Tunnel for EdgeConnect - GCP Central\"\n    }\n  ]\n}'\nbash\ncurl https://api.cloudflare.com/client/v4/accounts/{account_id}/magic/ipsec_tunnels \\\n--header \"X-Auth-Email: <EMAIL>\" \\\n--header \"X-Auth-Key: <API_KEY>\" \\\n--header \"Content-Type: application/json\" \\\n--data '{\n  \"ipsec_tunnels\": [\n    {\n      \"name\": \"EdgeConnect_IPSEC_1\",\n      \"customer_endpoint\": \"35.188.72.56\",\n      \"cloudflare_endpoint\": \"172.64.241.205\",\n      \"interface_address\": \"192.168.10.11/31\",\n      \"description\": \"Tunnel for EdgeConnect - GCP Central\"\n    }\n  ]\n}'\njson\n{\n  \"result\": {\n    \"ipsec_tunnels\": [\n      {\n        \"id\": \"tunnel_id\",\n        \"interface_address\": \"192.168.10.11/31\",\n        \"created_on\": \"2022-04-14T19:57:43.938376Z\",\n        \"modified_on\": \"2022-04-14T19:57:43.938376Z\",\n        \"name\": \"EdgeConnect_IPSEC_1\",\n        \"cloudflare_endpoint\": \"172.64.241.205\",\n        \"customer_endpoint\": \"35.188.72.56\",\n        \"description\": \"Tunnel for EdgeConnect - GCP Central\",\n        \"health_check\": {\n          \"enabled\": true,\n          \"target\": \"35.188.72.56\",\n          \"type\": \"reply\"\n        }\n      }\n    ]\n  },\n  \"success\": true,\n  \"errors\": [],\n  \"messages\": []\n}\nbash\ncurl --request POST \\\n\"https://api.cloudflare.com/client/v4/accounts/{account_id}/magic/ipsec_tunnels/{tunnel_id}/psk_generate?validate_only=true\" \\\n--header \"X-Auth-Email: <EMAIL>\" \\\n--header \"X-Auth-Key: <API_KEY>\"\njson\n{\n  \"result\": {\n  \"ipsec_id\": \"<ipsec_id>\",\n  \"ipsec_tunnel_id\": \"<tunnel_id>\",\n  \"psk\": \"XXXXXXXXXXXXXXXXX\",\n  \"psk_metadata\": {\n  \"last_generated_on\": \"2022-04-14T20:05:29.756514071Z\"\n  }\n  },\n  \"success\": true,\n  \"errors\": [],\n  \"messages\": []\n}\ntxt\ncrypto ikev2 proposal CF_MAGIC_WAN_IKEV2_PROPOSAL\n encryption aes-cbc-256\n integrity sha512 sha384 sha256\n group 20\n!\ncrypto ikev2 policy CF_MAGIC_WAN_IKEV2_POLICY\n match fvrf any\n proposal CF_MAGIC_WAN_IKEV2_PROPOSAL\n!\ncrypto ikev2 keyring CF_MAGIC_WAN_KEYRING\n peer GCP_CSR_IPSEC01\n  address 162.159.###.###\n  pre-shared-key hbGnJzFMqwltb###############BapXCOwsGZz2NMg\n !\n peer GCP_CSR_IPSEC02\n  address 172.64.###.###\n  pre-shared-key 1VscPp0LPFAcZ###############HOdN-1cUgKVduL4\n !\n!\n!\ncrypto ikev2 profile CF_MAGIC_WAN_01\n match identity remote address 162.159.###.### 255.255.255.255\n identity local fqdn ad329f56###############bbe898c0a0.33145236.ipsec.cloudflare.com\n authentication remote pre-share\n authentication local pre-share\n keyring local CF_MAGIC_WAN_KEYRING\n no config-exchange request\n!\ncrypto ikev2 profile CF_MAGIC_WAN_02\n match identity remote address 172.64.###.### 255.255.255.255\n identity local fqdn 83f9c418###############29b3f97049.33145236.ipsec.cloudflare.com\n authentication remote pre-share\n authentication local pre-share\n keyring local CF_MAGIC_WAN_KEYRING\n no config-exchange request\n!\n!\n!\n!\ncrypto ipsec profile CF_MAGIC_WAN_01\n set security-association lifetime kilobytes disable\n set security-association replay disable\n set pfs group20\n set ikev2-profile CF_MAGIC_WAN_01\n!\ncrypto ipsec profile CF_MAGIC_WAN_02\n set security-association lifetime kilobytes disable\n set security-association replay disable\n set pfs group14\n set ikev2-profile CF_MAGIC_WAN_02\n!\n!\n!\n!\ninterface Tunnel101\n ip address 10.252.2.35 255.255.255.254\n ip mtu 1450\n ip tcp adjust-mss 1350\n tunnel source 10.141.0.9\n tunnel mode ipsec ipv4\n tunnel destination 162.159.###.###\n tunnel path-mtu-discovery\n tunnel protection ipsec profile CF_MAGIC_WAN_01\n!\ninterface Tunnel102\n ip address 10.252.2.37 255.255.255.254\n ip mtu 1450\n ip tcp adjust-mss 1350\n tunnel source 10.141.0.9\n tunnel mode ipsec ipv4\n tunnel destination 172.64.###.###\n tunnel path-mtu-discovery\n tunnel protection ipsec profile CF_MAGIC_WAN_02\n!\ninterface GigabitEthernet1\n ip address dhcp\n ip nat outside\n negotiation auto\n no mop enabled\n no mop sysid\n!\ninterface GigabitEthernet2\n ip address 10.10.0.35 255.255.255.0\n negotiation auto\n no mop enabled\n no mop sysid\ntxt\ncrypto ikev2 profile CF_MAGIC_WAN_01\n match identity remote address 162.159.###.### 255.255.255.255\n identity local fqdn ad329f56###############bbe898c0a0.33145236.ipsec.cloudflare.com\n authentication remote pre-share\n authentication local pre-share\n keyring local CF_MAGIC_WAN_KEYRING\n nat force-encap\n no config-exchange request\ntxt\ncisco-csr1000v#show crypto session detail\nCrypto session current status\n\nCode: C - IKE Configuration mode, D - Dead Peer Detection\nK - Keepalives, N - NAT-traversal, T - cTCP encapsulation\nX - IKE Extended Authentication, F - IKE Fragmentation\nR - IKE Auto Reconnect, U - IKE Dynamic Route Update\nS - SIP VPN\n\nInterface: Tunnel101\nProfile: CF_MAGIC_WAN_01\nUptime: 00:15:16\nSession status: UP-ACTIVE\nPeer: 162.159.###.### port 500 fvrf: (none) ivrf: (none)\n      Phase1_id: 162.159.###.###\n      Desc: (none)\n  Session ID: 6\n  IKEv2 SA: local 10.141.0.9/500 remote 162.159.###.###/500 Active\n          Capabilities:(none) connid:1 lifetime:23:44:44\n  IPSEC FLOW: permit ip 0.0.0.0/0.0.0.0 0.0.0.0/0.0.0.0\n        Active SAs: 2, origin: crypto map\n        Inbound:  #pkts dec'ed 28110 drop 0 life (KB/Sec) KB Vol Rekey Disabled/2684\n        Outbound: #pkts enc'ed 0 drop 0 life (KB/Sec) KB Vol Rekey Disabled/2684\n\nInterface: Tunnel102\nProfile: CF_MAGIC_WAN_02\nUptime: 00:14:59\nSession status: UP-ACTIVE\nPeer: 172.64.###.### port 500 fvrf: (none) ivrf: (none)\n      Phase1_id: 172.64.###.###\n      Desc: (none)\n  Session ID: 7\n  IKEv2 SA: local 10.141.0.9/500 remote 172.64.###.###/500 Active\n          Capabilities:(none) connid:2 lifetime:23:45:01\n  IPSEC FLOW: permit ip 0.0.0.0/0.0.0.0 0.0.0.0/0.0.0.0\n        Active SAs: 2, origin: crypto map\n        Inbound:  #pkts dec'ed 27586 drop 0 life (KB/Sec) KB Vol Rekey Disabled/2701\n        Outbound: #pkts enc'ed 0 drop 0 life (KB/Sec) KB Vol Rekey Disabled/2701\ntxt\ncisco-csr1000v#show crypto session remote 162.159.###.### detail\nCrypto session current status\n\nCode: C - IKE Configuration mode, D - Dead Peer Detection\nK - Keepalives, N - NAT-traversal, T - cTCP encapsulation\nX - IKE Extended Authentication, F - IKE Fragmentation\nR - IKE Auto Reconnect, U - IKE Dynamic Route Update\nS - SIP VPN\n\nInterface: Tunnel101\nProfile: CF_MAGIC_WAN_01\nUptime: 00:15:45\nSession status: UP-ACTIVE\nPeer: 162.159.###.### port 500 fvrf: (none) ivrf: (none)\n      Phase1_id: 162.159.###.###\n      Desc: (none)\n  Session ID: 6\n  IKEv2 SA: local 10.141.0.9/500 remote 162.159.###.###/500 Active\n          Capabilities:(none) connid:1 lifetime:23:44:15\n  IPSEC FLOW: permit ip 0.0.0.0/0.0.0.0 0.0.0.0/0.0.0.0\n        Active SAs: 2, origin: crypto map\n        Inbound:  #pkts dec'ed 29000 drop 0 life (KB/Sec) KB Vol Rekey Disabled/2655\n        Outbound: #pkts enc'ed 0 drop 0 life (KB/Sec) KB Vol Rekey Disabled/2655\ntxt\ncisco-csr1000v#show crypto session remote 172.64.###.### detail\nCrypto session current status\n\nCode: C - IKE Configuration mode, D - Dead Peer Detection\nK - Keepalives, N - NAT-traversal, T - cTCP encapsulation\nX - IKE Extended Authentication, F - IKE Fragmentation\nR - IKE Auto Reconnect, U - IKE Dynamic Route Update\nS - SIP VPN\n\nInterface: Tunnel102\nProfile: CF_MAGIC_WAN_02\nUptime: 00:17:10\nSession status: UP-ACTIVE\nPeer: 172.64.###.### port 500 fvrf: (none) ivrf: (none)\n      Phase1_id: 172.64.###.###\n      Desc: (none)\n  Session ID: 7\n  IKEv2 SA: local 10.141.0.9/500 remote 172.64.###.###/500 Active\n          Capabilities:(none) connid:2 lifetime:23:42:50\n  IPSEC FLOW: permit ip 0.0.0.0/0.0.0.0 0.0.0.0/0.0.0.0\n        Active SAs: 2, origin: crypto map\n        Inbound:  #pkts dec'ed 31639 drop 0 life (KB/Sec) KB Vol Rekey Disabled/2569\n        Outbound: #pkts enc'ed 0 drop 0 life (KB/Sec) KB Vol Rekey Disabled/2569\ntxt\nconf t\ncrypto isakmp invalid-spi-recovery\nexit\ntxt\ninterface Tunnel 1\n ip address 10.0.0.0 255.255.255.254\n tunnel mode ipsec map MAP1\n link-state sync-sa\nexit\n!\n\ncrypto ipsec policy IPsec_POLICY\n set security-association always-up\n set security-association lifetime seconds 28800\n set security-association transform-keysize aes 256 256 256\n set security-association transform esp-aes esp-sha256-hmac\n set mtu 1460\n set mss 1350\n set ip df-bit 0\n set ip fragment post\n ! if there is a NAT router between Cloudflare and FITELnet,\n ! add the two udp-encapsulation options below\n set udp-encapsulation nat-t keepalive interval 30 always-send\n set udp-encapsulation-force\nexit\n!\ncrypto ipsec selector SELECTOR\n src 1 ipv4 any\n dst 1 ipv4 any\nexit\n!\ncrypto isakmp keepalive\ncrypto isakmp log sa\ncrypto isakmp log session\ncrypto isakmp log negotiation-fail\ncrypto isakmp negotiation always-up-params interval 100 max-initiate 10 max-pending 10 delay 1\ncrypto ipsec replay-check disable\n!\ncrypto isakmp policy ISAKMP_POLICY\n authentication pre-share\n encryption aes\n encryption-keysize aes 256 256 256\n group 20\n lifetime 86400\n hash sha sha-256\n initiate-mode aggressive\nexit\n!\ncrypto isakmp profile PROF1\n ! set the value of FQDN ID for self-identify\n self-identity fqdn <FQDN-ID-TUNNEL01>\n set isakmp-policy ISAKMP_POLICY\n set ipsec-policy IPsec_POLICY\n set peer <CLOUDFLARE-ANYCAST-ADDRESS>\n ike-version 2\n local-key <PRE-SHARED-KEY-TUNNEL01>\nexit\n!\ncrypto map MAP1 ipsec-isakmp\n match address SELECTOR\n set isakmp-profile PROF1\nexit\n!\ntxt\ninterface Tunnel 2\n ip address 10.0.0.2 255.255.255.254\n tunnel mode ipsec map MAP1\n link-state sync-sa\nexit\n!\n\ncrypto ipsec policy IPsec_POLICY\n set security-association always-up\n set security-association lifetime seconds 28800\n set security-association transform-keysize aes 256 256 256\n set security-association transform esp-aes esp-sha256-hmac\n set mtu 1460\n set mss 1350\n set ip df-bit 0\n set ip fragment post\n ! if there is a NAT router between Cloudflare and FITELnet,\n ! add the two udp-encapsulation options below\n set udp-encapsulation nat-t keepalive interval 30 always-send\n set udp-encapsulation-force\nexit\n!\ncrypto ipsec selector SELECTOR\n src 1 ipv4 any\n dst 1 ipv4 any\nexit\n!\ncrypto isakmp keepalive\ncrypto isakmp log sa\ncrypto isakmp log session\ncrypto isakmp log negotiation-fail\ncrypto isakmp negotiation always-up-params interval 100 max-initiate 10 max-pending 10 delay 1\ncrypto ipsec replay-check disable\n!\ncrypto isakmp policy ISAKMP_POLICY\n authentication pre-share\n encryption aes\n encryption-keysize aes 256 256 256\n group 20\n lifetime 86400\n hash sha sha-256\n initiate-mode aggressive\nexit\n!\ncrypto isakmp profile PROF1\n ! set the value of FQDN ID for self-identify\n self-identity fqdn <FQDN-ID-TUNNEL02>\n set isakmp-policy ISAKMP_POLICY\n set ipsec-policy IPsec_POLICY\n set peer <CLOUDFLARE-ANYCAST-ADDRESS>\n ike-version 2\n local-key <PRE-SHARED-KEY-TUNNEL02>\nexit\n!\ncrypto map MAP1 ipsec-isakmp\n match address SELECTOR\n set isakmp-profile PROF1\nexit\n!\ntxt\nip route 192.168.0.0 255.255.255.0 tunnel 1\ntxt\nip route 192.168.1.0 255.255.255.0 tunnel 2\ntxt\nshow crypto sa\n\nIKE_SA\n    Mode: <I>\n    Local IP : <LOCAL_IP>/500\n    Local ID : <LOCAL_ID> (ipv4)\n    Remote IP : anycast-address/500\n    Remote ID : anycast-address (ipv4)\n    Local Authentication method : Pre-shared key\n    Remote Authentication method : Pre-shared key\n    Encryption algorithm : aes256-cbc\n    Hash algorithm : hmac-sha256-128\n    Diffie-Hellman group : 20\n    Initiator Cookie : aaaaaaaa bbbbbbbb\n    Responder Cookie : cccccccc dddddddd\n    Life time : 6852/14400 sec\n    DPD : on\n\nCHILD_SA <I>\n    Selector :\n      0.0.0.0/0 ALL ALL <---> 0.0.0.0/0 ALL ALL\n    Interface : tunnel 1\n    Peer IP : anycast-address/500\n    Local IP : xxx.xxx.xxx.xxx/500\n    Encryption algorithm : AES-CBC/256\n    Authentication algorithm : HMAC-SHA2-256\n    Life time : 22868/28800 sec\n    PFS : off ESN : off\n    IN\n      SPI : eeeeeeee\n      Packets       : 0\n      Octets        : 0\n      Replay error  : 0\n      Auth error    : 0\n      Padding error : 0\n      Rule error    : 0\n    OUT\n      SPI : ffffffff\n      Packets       : 0\n      Octets        : 0\n      Seq lapped    : 0\n\nTotal number of ISAKMP SA 1\n  Total number of IPSEC SA 1\ntxt\nshow ip route\n\nCodes: K - kernel route, C - connected, S - static, R - RIP, O - OSPF,\n       B - BGP, T - Tunnel, i - IS-IS, V - VRRP track,\n       Iu - ISAKMP SA up, It - ISAKMP tunnel route, Ip - ISAKMP l2tpv2-ppp\n       Dc - DHCP-client, L - Local Breakout\n       > - selected route, * - FIB route, p - stale info\n\n<snip>\nS > * 192.168.1.0/24 [100/0] is directly connected, Tunnel1\n<snip>\n#\ntxt\nconfig system settings\n    set asymroute-icmp enable\nend\ntxt\nconfig system settings\n    set ike-port 4500\nend\ntxt\nfortigate # config vpn ipsec phase1-interface\n    edit \"<NAME_OF_YOUR_TUNNEL>\"\n        set nattraversal enable\ntxt\nconfig system global\n    set anti-replay disable\nend\ntxt\nfortigate # config vpn ipsec phase1-interface\n    edit \"MWAN_IPsec_Tun1\"\n        set interface \"wan1\"\n        set ike-version 2\n        set keylife 86400\n        set peertype any\n        set net-device enable\n        set proposal aes256gcm-prfsha512 aes256gcm-prfsha384 aes256gcm-prfsha256\n        set localid \"f1473dXXXXXXX72e33.49561179.ipsec.cloudflare.com\"\n        set dhgrp 20\n        set nattraversal disable\n        set remote-gw 162.159.67.210\n        set add-gw-route enable\n        set psksecret <YOUR_PRE-SHARED_KEY>\n    next\n    edit \"MWAN_IPsec_Tun2\"\n        set interface \"wan1\"\n        set ike-version 2\n        set keylife 86400\n        set peertype any\n        set net-device enable\n        set proposal aes256gcm-prfsha512 aes256gcm-prfsha384 aes256gcm-prfsha256\n        set localid \"de91565XXXXXXXfbbd6632.49561179.ipsec.cloudflare.com\"\n        set dhgrp 20\n        set nattraversal disable\n        set remote-gw 172.XX.XX.210\n        set add-gw-route enable\n        set psksecret ENC <YOUR_PRE-SHARED_KEY>\n    next\nend\ntxt\nfortigate # config vpn ipsec phase2-interface\n    edit \"MWAN_IPsec_Tun1\"\n        set phase1name \"MWAN_IPsec_Tun1\"\n        set proposal aes256gcm aes128gcm\n        set dhgrp 20\n        set replay disable\n        set keylifeseconds 28800\n        set auto-negotiate enable\n        set keepalive enable\n    next\n    edit \"MWAN_IPsec_Tun2\"\n        set phase1name \"MWAN_IPsec_Tun2\"\n        set proposal aes256gcm aes128gcm\n        set dhgrp 20\n        set replay disable\n        set keylifeseconds 28800\n        set auto-negotiate enable\n        set keepalive enable\n    next\nend\ntxt\nfortigate # config system interface\n    edit \"MWAN_IPsec_Tun1\"\n        set vdom \"root\"\n        set ip 10.252.2.91 255.255.255.255\n        set allowaccess ping\n        set type tunnel\n        set remote-ip 10.252.2.90 255.255.255.254\n        set alias \"MWAN_IPsec_Tun1\"\n        set snmp-index 17\n        set interface \"wan1\"\n    next\n    edit \"MWAN_IPsec_Tun2\"\n        set vdom \"root\"\n        set ip 10.252.2.93 255.255.255.255\n        set allowaccess ping\n        set type tunnel\n        set remote-ip 10.252.2.92 255.255.255.254\n        set alias \"MWAN_IPsec_Tun2\"\n        set snmp-index 18\n        set interface \"wan1\"\n    next\nend\ntxt\nfortigate # execute ping 10.252.2.90\nPING 10.252.2.90 (10.252.2.90): 56 data bytes\n64 bytes from 10.252.2.90: icmp_seq=0 ttl=64 time=5.8 ms\n64 bytes from 10.252.2.90: icmp_seq=1 ttl=64 time=5.8 ms\n64 bytes from 10.252.2.90: icmp_seq=2 ttl=64 time=5.8 ms\n64 bytes from 10.252.2.90: icmp_seq=3 ttl=64 time=5.8 ms\n64 bytes from 10.252.2.90: icmp_seq=4 ttl=64 time=5.7 ms\n\n--- 10.252.2.90 ping statistics ---\n5 packets transmitted, 5 packets received, 0% packet loss\nround-trip min/avg/max = 5.7/5.7/5.8 ms\ntxt\nfortigate # execute ping 10.252.2.92\nPING 10.252.2.92 (10.252.2.92): 56 data bytes\n64 bytes from 10.252.2.92: icmp_seq=0 ttl=64 time=6.1 ms\n64 bytes from 10.252.2.92: icmp_seq=1 ttl=64 time=6.1 ms\n64 bytes from 10.252.2.92: icmp_seq=2 ttl=64 time=6.1 ms\n64 bytes from 10.252.2.92: icmp_seq=3 ttl=64 time=6.1 ms\n64 bytes from 10.252.2.92: icmp_seq=4 ttl=64 time=6.0 ms\n\n--- 10.252.2.92 ping statistics ---\n5 packets transmitted, 5 packets received, 0% packet loss\nround-trip min/avg/max = 6.0/6.0/6.1 ms\ntxt\nfortigate # config system zone\n    edit \"Cloudflare_Zone\"\n        set intrazone allow\n        set interface \"MWAN_IPsec_Tun1\" \"MWAN_IPsec_Tun2\"\n    next\n    edit \"Trust_Zone\"\n        set intrazone allow\n        set interface \"internal\"\n    next\n    edit \"Untrust_Zone\"\n        set intrazone allow\n        set interface \"wan1\"\n    next\nend\ntxt\nconfig firewall address\n    edit \"Cloudflare_IPv4_01\"\n        set color 9\n        set subnet 173.245.48.0 255.255.240.0\n    next\n    edit \"Cloudflare_IPv4_02\"\n        set color 9\n        set subnet 103.21.244.0 255.255.252.0\n    next\n    edit \"Cloudflare_IPv4_03\"\n        set color 9\n        set subnet 103.22.200.0 255.255.252.0\n    next\n    edit \"Cloudflare_IPv4_04\"\n        set color 9\n        set subnet 103.31.4.0 255.255.252.0\n    next\n    edit \"Cloudflare_IPv4_05\"\n        set color 9\n        set subnet 141.101.64.0 255.255.192.0\n    next\n    edit \"Cloudflare_IPv4_06\"\n        set color 9\n        set subnet 108.162.192.0 255.255.192.0\n    next\n    edit \"Cloudflare_IPv4_07\"\n        set color 9\n        set subnet 190.93.240.0 255.255.240.0\n    next\n    edit \"Cloudflare_IPv4_08\"\n        set color 9\n        set subnet 188.114.96.0 255.255.240.0\n    next\n    edit \"Cloudflare_IPv4_09\"\n        set color 9\n        set subnet 197.234.240.0 255.255.252.0\n    next\n    edit \"Cloudflare_IPv4_10\"\n        set color 9\n        set subnet 198.41.128.0 255.255.128.0\n    next\n    edit \"Cloudflare_IPv4_11\"\n        set color 9\n        set subnet 162.158.0.0 255.254.0.0\n    next\n    edit \"Cloudflare_IPv4_12\"\n        set color 9\n        set subnet 104.16.0.0 255.248.0.0\n    next\n    edit \"Cloudflare_IPv4_13\"\n        set color 9\n        set subnet 104.24.0.0 255.252.0.0\n    next\n    edit \"Cloudflare_IPv4_14\"\n        set color 9\n        set subnet 172.64.0.0 255.248.0.0\n    next\n    edit \"Cloudflare_IPv4_15\"\n        set color 9\n        set subnet 131.0.72.0 255.255.252.0\n    next\n    edit \"Bidirect_HC_Endpoint_01\"\n        set comment \"Bidirectional health check endpoint address\"\n        set color 9\n        set subnet 172.64.240.253 255.255.255.255\n    next\n    edit \"Bidirect_HC_Endpoint_02\"\n        set comment \"Bidirectional health check endpoint address\"\n        set color 9\n        set subnet 172.64.240.254 255.255.255.255\n    next\nend\ntxt\nconfig firewall addrgrp\n    edit \"Cloudflare_IPv4_Nets\"\n        set member \"Cloudflare_IPv4_01\" \"Cloudflare_IPv4_02\" \"Cloudflare_IPv4_03\" \"Cloudflare_IPv4_04\" \"Cloudflare_IPv4_05\" \"Cloudflare_IPv4_06\" \"Cloudflare_IPv4_07\" \"Cloudflare_IPv4_08\" \"Cloudflare_IPv4_09\" \"Cloudflare_IPv4_10\" \"Cloudflare_IPv4_11\" \"Cloudflare_IPv4_12\" \"Cloudflare_IPv4_13\" \"Cloudflare_IPv4_14\" \"Cloudflare_IPv4_15\"\n        set color 9\n    next\nend\ntxt\nfortigate (policy) # show\nconfig firewall policy\n    edit 2\n        set name \"CF_Magic_Health_Checks\"\n        set uuid 80eb76ce-3033-51ee-c5e5-d5a670dff3b3\n        set srcintf \"Cloudflare_Zone\"\n        set action accept\n        set srcaddr \"Cloudflare_IPv4_Nets\"\n        set dstaddr \"Bidirect_HC_Endpoint_01\" \"Bidirect_HC_Endpoint_02\"\n        set schedule \"always\"\n        set service \"ALL_ICMP\"\n        set logtraffic all\n    next\nend\ntxt\nfortigate # config router policy\n    edit 1\n        set input-device \"MWAN_IPsec_Tun1\"\n        set srcaddr \"all\"\n        set dstaddr \"all\"\n        set gateway 10.252.2.90\n        set output-device \"MWAN_IPsec_Tun1\"\n    next\n    edit 2\n        set input-device \"MWAN_IPsec_Tun2\"\n        set srcaddr \"all\"\n        set dstaddr \"all\"\n        set gateway 10.252.2.92\n        set output-device \"MWAN_IPsec_Tun2\"\n    next\nend\ntxt\nfortigate # diagnose sniffer packet any 'host 172.64.240.253' 4\ninterfaces=[any]\nfilters=[host 172.64.240.253]\n0.601569 MWAN_IPsec_Tun1 in 172.64.240.253 -> 162.158.176.118: icmp: echo reply\n0.601585 MWAN_IPsec_Tun1 out 172.64.240.253 -> 162.158.176.118: icmp: echo reply\n0.611164 MWAN_IPsec_Tun1 in 172.64.240.253 -> 172.71.87.94: icmp: echo reply\n0.611178 MWAN_IPsec_Tun1 out 172.64.240.253 -> 172.71.87.94: icmp: echo reply\n0.617562 MWAN_IPsec_Tun1 in 172.64.240.253 -> 172.71.129.214: icmp: echo reply\n0.617574 MWAN_IPsec_Tun1 out 172.64.240.253 -> 172.71.129.214: icmp: echo reply\n0.622042 MWAN_IPsec_Tun1 in 172.64.240.253 -> 172.69.61.43: icmp: echo reply\n0.622056 MWAN_IPsec_Tun1 out 172.64.240.253 -> 172.69.61.43: icmp: echo reply\n0.624092 MWAN_IPsec_Tun1 in 172.64.240.253 -> 172.68.9.214: icmp: echo reply\ntxt\nfortigate # diagnose sniffer packet any 'host 172.64.240.254' 4\ninterfaces=[any]\nfilters=[host 172.64.240.254]\n0.912041 MWAN_IPsec_Tun2 in 172.64.240.254 -> 172.70.177.56: icmp: echo reply\n0.912057 MWAN_IPsec_Tun2 out 172.64.240.254 -> 172.70.177.56: icmp: echo reply\n0.913579 MWAN_IPsec_Tun2 in 172.64.240.254 -> 172.70.221.154: icmp: echo reply\n0.913592 MWAN_IPsec_Tun2 out 172.64.240.254 -> 172.70.221.154: icmp: echo reply\n0.914247 MWAN_IPsec_Tun2 in 172.64.240.254 -> 162.158.1.85: icmp: echo reply\n0.914260 MWAN_IPsec_Tun2 out 172.64.240.254 -> 162.158.1.85: icmp: echo reply\n0.918533 MWAN_IPsec_Tun2 in 172.64.240.254 -> 172.71.125.75: icmp: echo reply\n0.918550 MWAN_IPsec_Tun2 out 172.64.240.254 -> 172.71.125.75: icmp: echo reply\n0.924465 MWAN_IPsec_Tun2 in 172.64.240.254 -> 172.69.21.134: icmp: echo reply\ntxt\nfortigate # diagnose debug disable\nfortigate # diagnose debug flow filter clear\nfortigate # diagnose debug reset\nfortigate # diagnose debug flow filter addr 172.64.240.253\nfortigate # diagnose debug show flow show function-name enable\nfortigate # diagnose debug config-error-log timestamps enable\nfortigate # diagnose debug flow trace start 999\nfortigate # diagnose debug enable\nfortigate # 2023-08-01 09:27:26 id=20085 trace_id=2871 func=print_pkt_detail line=5844 msg=\"vd-root:0 received a packet(proto=1, 172.64.240.253:56968->172.70.121.28:0) tun_id=162.159.67.210 from MWAN_IPsec_Tun1. type=0, code=0, id=56968, seq=0.\"\n2023-08-01 09:27:26 id=20085 trace_id=2871 func=rpdb_srv_match_input line=1036 msg=\"Match policy routing id=1: to 10.252.2.90 via ifindex-34\"\n2023-08-01 09:27:26 id=20085 trace_id=2871 func=vf_ip_route_input_common line=2605 msg=\"find a route: flag=00000000 gw-162.159.67.210 via MWAN_IPsec_Tun1\"\n2023-08-01 09:27:26 id=20085 trace_id=2871 func=ipsecdev_hard_start_xmit line=669 msg=\"enter IPSec interface MWAN_IPsec_Tun1, tun_id=0.0.0.0\"\n2023-08-01 09:27:26 id=20085 trace_id=2871 func=_do_ipsecdev_hard_start_xmit line=229 msg=\"output to IPSec tunnel MWAN_IPsec_Tun1\"\n2023-08-01 09:27:26 id=20085 trace_id=2871 func=esp_output4 line=844 msg=\"IPsec encrypt/auth\"\n2023-08-01 09:27:26 id=20085 trace_id=2871 func=ipsec_output_finish line=544 msg=\"send to 172.71.91.34 via intf-wan1\"\n2023-08-01 09:27:26 id=20085 trace_id=2872 func=print_pkt_detail line=5844 msg=\"vd-root:0 received a packet(proto=1, 172.64.240.253:18685->162.158.209.64:0) tun_id=162.159.67.210 from MWAN_IPsec_Tun1. type=0, code=0, id=18685, seq=0.\"\n2023-08-01 09:27:26 id=20085 trace_id=2872 func=rpdb_srv_match_input line=1036 msg=\"Match policy routing id=1: to 10.252.2.90 via ifindex-34\"\n2023-08-01 09:27:26 id=20085 trace_id=2872 func=vf_ip_route_input_common line=2605 msg=\"find a route: flag=00000000 gw-162.159.67.210 via MWAN_IPsec_Tun1\"\n2023-08-01 09:27:26 id=20085 trace_id=2872 func=ipsecdev_hard_start_xmit line=669 msg=\"enter IPSec interface MWAN_IPsec_Tun1, tun_id=0.0.0.0\"\n2023-08-01 09:27:26 id=20085 trace_id=2872 func=_do_ipsecdev_hard_start_xmit line=229 msg=\"output to IPSec tunnel MWAN_IPsec_Tun1\"\n2023-08-01 09:27:26 id=20085 trace_id=2872 func=esp_output4 line=844 msg=\"IPsec encrypt/auth\"\n2023-08-01 09:27:26 id=20085 trace_id=2872 func=ipsec_output_finish line=544 msg=\"send to 172.71.91.34 via intf-wan1\"\ntxt\nfortigate # diagnose debug disable\ntxt\nset interfaces st0 unit 0 family inet address 10.252.2.21/31\nset interfaces st0 unit 1 family inet address 10.252.2.23/31\ntxt\nadmin@srx300> show configuration interfaces st0\ntxt\nunit 0 {\n    family inet {\n        address 10.252.2.21/31;\n    }\n}\nunit 1 {\n    family inet {\n        address 10.252.2.23/31;\n    }\n}\ntxt\nset security zones security-zone cloudflare interfaces st0.0 host-inbound-traffic system-services all\nset security zones security-zone cloudflare interfaces st0.0 host-inbound-traffic\nset security zones security-zone cloudflare interfaces st0.1 host-inbound-traffic system-services all\nset security zones security-zone cloudflare interfaces st0.1 host-inbound-traffic\ntxt\nadmin@srx220> show configuration security zones security-zone cloudflare\ntxt\ninterfaces {\n  st0.0 {\n    host-inbound-traffic {\n      system-services {\n        all;\n      }\n      protocols {\n        all;\n      }\n    }\n  }\n  st0.1 {\n    host-inbound-traffic {\n      system-services {\n        all;\n      }\n      protocols {\n        all;\n      }\n    }\n  }\n}\ntxt\nset security zones security-zone untrust interfaces ge-0/0/0.0 host-inbound-traffic system-services ike\ntxt\nadmin@srx300> show configuration security zones security-zone untrust\ntxt\nscreen untrust-screen;\ninterfaces {\n    ge-0/0/0.0 {\n        host-inbound-traffic {\n            system-services {\n                ike;\n            }\n        }\n    }\n}\ntxt\nset security ike proposal cf_magic_wan_ike_prop authentication-method pre-shared-keys\nset security ike proposal cf_magic_wan_ike_prop dh-group group20\nset security ike proposal cf_magic_wan_ike_prop authentication-algorithm sha-256\nset security ike proposal cf_magic_wan_ike_prop encryption-algorithm aes-256-cbc\nset security ike proposal cf_magic_wan_ike_prop lifetime-seconds 86400\ntxt\nadmin@srx300> show configuration security ike proposal cf_magic_wan_ike_prop\ntxt\nauthentication-method pre-shared-keys;\ndh-group group20;\nauthentication-algorithm sha-256;\nencryption-algorithm aes-256-cbc;\nlifetime-seconds 86400;\ntxt\nset security ike policy cf_magic_wan_tun_01_pol mode main\nset security ike policy cf_magic_wan_tun_01_pol proposals cf_magic_wan_ike_prop\nset security ike policy cf_magic_wan_tun_01_pol pre-shared-key ascii-text \"$9$GRjPTF<REDACTED>WZUjHPT\"\ntxt\nadmin@srx300> show configuration security ike policy cf_magic_wan_tun_01_pol\ntxt\nmode main;\nproposals cf_magic_wan_ike_prop;\npre-shared-key ascii-text \"$9$GRjPTF<REDACTED>WZUjHPT\"; ## SECRET-DATA\ntxt\nset security ike policy cf_magic_wan_tun_02_pol mode main\nset security ike policy cf_magic_wan_tun_02_pol proposals cf_magic_wan_ike_prop\nset security ike policy cf_magic_wan_tun_02_pol pre-shared-key ascii-text \"$9$f536tp<REDACTED>SrH.fT/9Lx7-bY\"\ntxt\nadmin@srx300> show configuration security ike policy cf_magic_wan_tun_02_pol\ntxt\nmode main;\nproposals cf_magic_wan_ike_prop;\npre-shared-key ascii-text \"$9$f536tp<REDACTED>SrH.fT/9Lx7-bY\"; ## SECRET-DATA\ntxt\nset security ike gateway cf_magic_wan_gw_tun_01 ike-policy cf_magic_wan_tun_01_pol\nset security ike gateway cf_magic_wan_gw_tun_01 address 162.159.68.68\nset security ike gateway cf_magic_wan_gw_tun_01 local-identity hostname 1663e5e70<REDACTED>6555.ipsec.cloudflare.com\nset security ike gateway cf_magic_wan_gw_tun_01 external-interface ge-0/0/0.0\nset security ike gateway cf_magic_wan_gw_tun_01 version v2-only\ntxt\nadmin@srx300> show configuration security ike gateway cf_magic_wan_gw_tun_01\ntxt\nike-policy cf_magic_wan_tun_01_pol;\naddress 162.159.68.68;\nlocal-identity hostname 1663e5e70<REDACTED>6555.ipsec.cloudflare.com;\nexternal-interface ge-0/0/0.0;\nversion v2-only;\ntxt\nset security ike gateway cf_magic_wan_gw_tun_02 ike-policy cf_magic_wan_tun_02_pol\nset security ike gateway cf_magic_wan_gw_tun_02 address 172.64.244.68\nset security ike gateway cf_magic_wan_gw_tun_02 local-identity hostname b5ee5303<REDACTED>6555.ipsec.cloudflare.com\nset security ike gateway cf_magic_wan_gw_tun_02 external-interface ge-0/0/0.0\nset security ike gateway cf_magic_wan_gw_tun_02 version v2-only\ntxt\nadmin@srx300> show configuration security ike gateway cf_magic_wan_gw_tun_02\ntxt\nike-policy cf_magic_wan_tun_02_pol;\naddress 172.64.244.68;\nlocal-identity hostname b5ee5303<REDACTED>6555.ipsec.cloudflare.com;\nexternal-interface ge-0/0/0.0;\nversion v2-only;\ntxt\nset security ipsec proposal cf_magic_wan_ipsec_prop protocol esp\nset security ipsec proposal cf_magic_wan_ipsec_prop authentication-algorithm hmac-sha-256-128\nset security ipsec proposal cf_magic_wan_ipsec_prop encryption-algorithm aes-256-cbc\nset security ipsec proposal cf_magic_wan_ipsec_prop lifetime-seconds 28800\ntxt\nadmin@srx300> show configuration security ipsec proposal cf_magic_wan_ipsec_prop\ntxt\nprotocol esp;\nauthentication-algorithm hmac-sha-256-128;\nencryption-algorithm aes-256-cbc;\nlifetime-seconds 28800;\ntxt\nset security ipsec policy cf_magic_wan_ipsec_pol proposals cf_magic_wan_ipsec_prop\ntxt\nadmin@srx300> show configuration security ipsec policy cf_magic_wan_ipsec_pol\ntxt\nproposals cf_magic_wan_ipsec_prop;\ntxt\nset security ipsec vpn cf_magic_wan_ipsec_tun_01 bind-interface st0.0\nset security ipsec vpn cf_magic_wan_ipsec_tun_01 ike gateway cf_magic_wan_gw_tun_01\nset security ipsec vpn cf_magic_wan_ipsec_tun_01 ike no-anti-replay\nset security ipsec vpn cf_magic_wan_ipsec_tun_01 ike ipsec-policy cf_magic_wan_ipsec_pol\nset security ipsec vpn cf_magic_wan_ipsec_tun_01 establish-tunnels immediately\ntxt\nadmin@srx300> show configuration security ipsec vpn cf_magic_wan_ipsec_tun_01\ntxt\nbind-interface st0.0;\nike {\n    gateway cf_magic_wan_gw_tun_01;\n    no-anti-replay;\n    ipsec-policy cf_magic_wan_ipsec_pol;\n}\nestablish-tunnels immediately;\ntxt\nset security ipsec vpn cf_magic_wan_ipsec_tun_02 bind-interface st0.1\nset security ipsec vpn cf_magic_wan_ipsec_tun_02 ike gateway cf_magic_wan_gw_tun_02\nset security ipsec vpn cf_magic_wan_ipsec_tun_02 ike no-anti-replay\nset security ipsec vpn cf_magic_wan_ipsec_tun_02 ike ipsec-policy cf_magic_wan_ipsec_pol\nset security ipsec vpn cf_magic_wan_ipsec_tun_02 establish-tunnels immediately\ntxt\nadmin@srx300> show configuration security ipsec vpn cf_magic_wan_ipsec_tun_02\ntxt\nbind-interface st0.1;\nike {\n    gateway cf_magic_wan_gw_tun_02;\n    no-anti-replay;\n    ipsec-policy cf_magic_wan_ipsec_pol;\n}\nestablish-tunnels immediately;\ntxt\nset routing-instances MAGIC_WAN_RI instance-type forwarding\nset routing-instances MAGIC_WAN_RI routing-options static route 0.0.0.0/0 next-hop 10.252.2.20\nset routing-instances MAGIC_WAN_RI routing-options static route 0.0.0.0/0 next-hop 10.252.2.22\ntxt\nadmin@srx300> show configuration routing-instances\ntxt\nMAGIC_WAN_RI {\n    instance-type forwarding;\n    routing-options {\n        static {\n            route 0.0.0.0/0 next-hop [ 10.252.2.20 10.252.2.22 ];\n        }\n    }\n}\ntxt\nset firewall family inet filter MAGIC_WAN_FBF term MAGIC_WAN_NETS from source-address 10.1.20.0/24\nset firewall family inet filter MAGIC_WAN_FBF term MAGIC_WAN_NETS from destination-address 10.1.100.0/24\nset firewall family inet filter MAGIC_WAN_FBF term MAGIC_WAN_NETS then count MAGIC_WAN_GATEWAY_FBF_count\nset firewall family inet filter MAGIC_WAN_FBF term MAGIC_WAN_NETS then routing-instance MAGIC_WAN_RI\nset firewall family inet filter MAGIC_WAN_FBF term ALLOW_EVERYTHING_ELSE then accept\ntxt\nadmin@srx300> show configuration firewall\ntxt\nfamily inet {\n    filter MAGIC_WAN_FBF {\n        term MAGIC_WAN_NETS {\n            from {\n                source-address {\n                    10.1.20.0/24;\n                }\n                destination-address {\n                    10.1.100.0/24;\n                }\n            }\n            then {\n                count MAGIC_WAN_FBF_count;\n                routing-instance MAGIC_WAN_RI;\n            }\n        }\n        term ALLOW_EVERYTHING_ELSE {\n            then accept;\n        }\n    }\n}\ntxt\nadmin@srx300> show firewall filter MAGIC_WAN_FBF counter MAGIC_WAN_FBF_count\ntxt\nFilter: MAGIC_WAN_FBF\n\nName                                      Bytes       Packets\nMAGIC_WAN_FBF_count                       760174478   1940954\ntxt\nset interfaces ge-0/0/7 unit 0 family inet filter input MAGIC_WAN_FBF\nset interfaces ge-0/0/7 unit 0 family inet address 10.1.20.1/24\ntxt\nadmin@srx300> show configuration interfaces ge-0/0/7 unit 0\ntxt\nfamily inet {\n    filter {\n        input MAGIC_WAN_FBF;\n    }\n    address 10.1.20.1/24;\n}\ntxt\nset routing-options static route 0.0.0.0/0 next-hop <DEFAULT GATEWAY VIA ISP>\nset routing-options rib-groups MAGIC_WAN_RG import-rib [ inet.0 MAGIC_WAN_RI.inet.0 ]\nset routing-options interface-routes rib-group inet MAGIC_WAN_RG\nset routing-options interface-routes rib-group inet MAGIC_WAN_RG\ntxt\nadmin@srx300> show configuration routing-options\ntxt\ninterface-routes {\n    rib-group inet MAGIC_WAN_GW_RG;\n}\nstatic {\n    route 0.0.0.0/0 next-hop <DEFAULT GATEWAY VIA ISP>;\n}\nrib-groups {\n    MAGIC_WAN_GW_RG {\n        import-rib [ inet.0 MAGIC_WAN_RI.inet.0 ];\n    }\n}\ntxt\nset security policies from-zone cloudflare to-zone trust policy cloudflare_to_trust match source-address any\nset security policies from-zone cloudflare to-zone trust policy cloudflare_to_trust match destination-address any\nset security policies from-zone cloudflare to-zone trust policy cloudflare_to_trust match application any\nset security policies from-zone cloudflare to-zone trust policy cloudflare_to_trust then permit\nset security policies from-zone cloudflare to-zone trust policy cloudflare_to_trust then log session-close\ntxt\nadmin@srx300> show configuration security policies from-zone cloudflare to-zone trust\ntxt\npolicy cloudflare_to_trust_permit {\n    match {\n        source-address any;\n        destination-address any;\n        application any;\n    }\n    then {\n        permit;\n        log {\n            session-close;\n        }\n    }\n}\ntxt\nset security policies from-zone trust to-zone cloudflare policy trust_to_cloudflare_permit match source-address any\nset security policies from-zone trust to-zone cloudflare policy trust_to_cloudflare_permit match destination-address any\nset security policies from-zone trust to-zone cloudflare policy trust_to_cloudflare_permit match application any\nset security policies from-zone trust to-zone cloudflare policy trust_to_cloudflare_permit then permit\nset security policies from-zone trust to-zone cloudflare policy trust_to_cloudflare_permit then log session-close\ntxt\nadmin@srx300> show configuration security policies from-zone trust to-zone cloudflare\ntxt\npolicy trust_to_cloudflare_permit {\n    match {\n        source-address any;\n        destination-address any;\n        application any;\n    }\n    then {\n        permit;\n        log {\n            session-close;\n        }\n    }\n}\ntxt\nadmin@srx300> ping source 10.252.2.21 10.252.2.20\ntxt\nPING 10.252.2.20 (10.252.2.20): 56 data bytes\n64 bytes from 10.252.2.20: icmp_seq=0 ttl=64 time=8.429 ms\n64 bytes from 10.252.2.20: icmp_seq=1 ttl=64 time=4.134 ms\n64 bytes from 10.252.2.20: icmp_seq=2 ttl=64 time=4.028 ms\n64 bytes from 10.252.2.20: icmp_seq=3 ttl=64 time=3.855 ms\n64 bytes from 10.252.2.20: icmp_seq=4 ttl=64 time=3.811 ms\ntxt\nadmin@srx300> ping source 10.252.2.23 10.252.2.22\ntxt\nPING 10.252.2.22 (10.252.2.22): 56 data bytes\n\n64 bytes from 10.252.2.22: icmp_seq=0 ttl=64 time=7.405 ms\n64 bytes from 10.252.2.22: icmp_seq=1 ttl=64 time=3.685 ms\n64 bytes from 10.252.2.22: icmp_seq=2 ttl=64 time=3.666 ms\n64 bytes from 10.252.2.22: icmp_seq=3 ttl=64 time=3.888 ms\n64 bytes from 10.252.2.22: icmp_seq=4 ttl=64 time=3.814 ms\ntxt\nadmin@srx300> show security ike active-peer\ntxt\nRemote Address            Port     Peer IKE-ID     XAUTH username    Assigned IP\n162.XXX.XX.164            500      162.XX.XXX.164  not available     0.0.0.0\n172.XX.XXX.164            500      172.XX.XXX.164  not available     0.0.0.0\ntxt\nadmin@srx300> show security ike security-associations\ntxt\nIndex  State Initiator cookie Responder cookie Mode      Remote Address\n3628774 UP   51078ae37b319d23 1475e3b48ca89a9a IKEv2     162.XXX.XX.164\n3628775 UP   b2d9a698b6224fc9 7fb1a9f81db0611c IKEv2     172.XX.XXX.164\ntxt\nadmin@srx300> show security ipsec security-associations\ntxt\nTotal active tunnels: 2\nID    Algorithm       SPI      Life:sec/kb  Mon lsys Port  Gateway\n<131073 ESP:aes-cbc-256/sha256 d28e709e 28565/unlim - root 500 162.XXX.66.164\n>131073 ESP:aes-cbc-256/sha256 25aed8ae 28565/unlim - root 500 162.XXX.XX.164\n<131074 ESP:aes-cbc-256/sha256 3f13176d 28566/unlim - root 500 172.XX.XXX.164\n>131074 ESP:aes-cbc-256/sha256 965169e9 28566/unlim - root 500 172.XX.XXX.164\ntxt\nset security ike traceoptions file ike-debug.log\nset security ike traceoptions file size 1m\nset security ike traceoptions file files 3\nset security ike traceoptions file world-readable\nset security ike traceoptions flag all\ntxt\n   tail -f /var/log/ike-debug.log\n   txt\ndeactivate security ike traceoptions\ntxt\nadmin@srx300> show configuration security ike traceoptions\ntxt\n##\n## inactive: security ike traceoptions\n##\nfile ike-debug.log size 1m files 3 world-readable;\nflag all;\ntxt\nset security ipsec traceoptions file ipsec-debug.log\nset security ipsec traceoptions file size 1m\nset security ipsec traceoptions file files 3\nset security ipsec traceoptions file world-readable\nset security ipsec traceoptions flag all\ntxt\ndelete security ipsec traceoptions\ntxt\ndeactivate security ipsec traceoptions\ntxt\nadmin@srx300> show configuration security ipsec traceoptions\ntxt\n##\n## inactive: security ipsec traceoptions\n##\nfile ipsec-debug.log size 1m files 3 world-readable;\nflag all;\njs\n    const a = new Uint8Array(48);\n    crypto.getRandomValues(a);\n    let base64String = btoa(String.fromCharCode.apply(null, a));\n\nbase64String = base64String.replace(/\\+/g, '')\n                   .replace(/\\//g, '')\n                   .replace(/=/g, '');\n\nconsole.log(base64String.substring(0, 32));\nbash\nset tag Trust_L3_Zone color color2\nset tag Untrust_L3_Zone color color1\nset tag Cloudflare_L3_Zone color color6\nbash\nset address CF_Health_Check_Anycast_01 ip-netmask 172.64.240.253\nset address CF_Health_Check_Anycast_01 tag Cloudflare_L3_Zone\nset address CF_Health_Check_Anycast_02 ip-netmask 172.64.240.254\nset address CF_Health_Check_Anycast_02 tag Cloudflare_L3_Zone\nset address CF_Magic_WAN_Anycast_01 ip-netmask 162.159.66.164\nset address CF_Magic_WAN_Anycast_01 tag Cloudflare_L3_Zone\nset address CF_Magic_WAN_Anycast_02 ip-netmask 172.64.242.164\nset address CF_Magic_WAN_Anycast_02 tag Cloudflare_L3_Zone\nset address CF_MWAN_IPsec_VTI_01_Local ip-netmask 10.252.2.27/31\nset address CF_MWAN_IPsec_VTI_01_Local tag Cloudflare_L3_Zone\nset address CF_MWAN_IPsec_VTI_02_Local ip-netmask 10.252.2.29/31\nset address CF_MWAN_IPsec_VTI_02_Local tag Cloudflare_L3_Zone\nset address CF_MWAN_IPsec_VTI_01_Remote ip-netmask 10.252.2.26\nset address CF_MWAN_IPsec_VTI_01_Remote tag Cloudflare_L3_Zone\nset address CF_MWAN_IPsec_VTI_02_Remote ip-netmask 10.252.2.28\nset address CF_MWAN_IPsec_VTI_02_Remote tag Cloudflare_L3_Zone\nset address CF_WARP_Client_Prefix ip-netmask 100.96.0.0/12\nset address CF_WARP_Client_Prefix tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_01 ip-netmask 173.245.48.0/20\nset address Cloudflare_IPv4_01 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_02 ip-netmask 103.21.244.0/22\nset address Cloudflare_IPv4_02 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_03 ip-netmask 103.22.200.0/22\nset address Cloudflare_IPv4_03 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_04 ip-netmask 103.31.4.0/22\nset address Cloudflare_IPv4_04 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_05 ip-netmask 141.101.64.0/18\nset address Cloudflare_IPv4_05 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_06 ip-netmask 108.162.192.0/18\nset address Cloudflare_IPv4_06 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_07 ip-netmask 190.93.240.0/20\nset address Cloudflare_IPv4_07 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_08 ip-netmask 188.114.96.0/20\nset address Cloudflare_IPv4_08 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_09 ip-netmask 197.234.240.0/22\nset address Cloudflare_IPv4_09 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_10 ip-netmask 198.41.128.0/17\nset address Cloudflare_IPv4_10 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_11 ip-netmask 162.158.0.0/15\nset address Cloudflare_IPv4_11 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_12 ip-netmask 104.16.0.0/13\nset address Cloudflare_IPv4_12 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_13 ip-netmask 104.24.0.0/14\nset address Cloudflare_IPv4_13 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_14 ip-netmask 172.64.0.0/13\nset address Cloudflare_IPv4_14 tag Cloudflare_L3_Zone\nset address Cloudflare_IPv4_15 ip-netmask 131.0.72.0/22\nset address Cloudflare_IPv4_15 tag Cloudflare_L3_Zone\nset address Internet_L3_203-0-113-254--24 ip-netmask 203.0.113.254/24\nset address Internet_L3_203-0-113-254--24 tag Untrust_L3_Zone\nset address VLAN0010_10-1-10-0--24 ip-netmask 10.1.10.0/24\nset address VLAN0010_10-1-10-0--24 tag Trust_L3_Zone\nset address VLAN0020_10-1-20-0--24 ip-netmask 10.1.20.0/24\nset address VLAN0020_10-1-20-0--24 tag Trust_L3_Zone\nset address VLAN0100_10-1-100-0--24 ip-netmask 10.1.100.0/24\nset address VLAN0100_10-1-100-0--24 tag Trust_L3_Zone\nset address VLAN0100_L3_10-1-100-254--24 ip-netmask 10.1.100.254/24\nset address VLAN0100_L3_10-1-100-254--24 tag Trust_L3_Zone\nbash\nset address-group Cloudflare_IPv4_Static_Grp static [ Cloudflare_IPv4_01 Cloudflare_IPv4_02 Cloudflare_IPv4_03 Cloudflare_IPv4_04 Cloudflare_IPv4_05 Cloudflare_IPv4_06 Cloudflare_IPv4_07 Cloudflare_IPv4_08 Cloudflare_IPv4_09 Cloudflare_IPv4_10 Cloudflare_IPv4_11 Cloudflare_IPv4_12 Cloudflare_IPv4_13 Cloudflare_IPv4_14 Cloudflare_IPv4_15 ]\nset address-group Cloudflare_IPv4_Static_Grp tag Cloudflare_L3_Zone\nbash\nset network profiles interface-management-profile Allow_Ping userid-service no\nset network profiles interface-management-profile Allow_Ping ping yes\nbash\nset network interface ethernet ethernet1/1 layer3 ndp-proxy enabled no\nset network interface ethernet ethernet1/1 layer3 lldp enable no\nset network interface ethernet ethernet1/1 layer3 ip VLAN0100_L3_10-1-100-254--24\nset network interface ethernet ethernet1/1 layer3 interface-management-profile Mgmt_Services\nset network interface ethernet ethernet1/2 layer3 ndp-proxy enabled no\nset network interface ethernet ethernet1/2 layer3 lldp enable no\nset network interface ethernet ethernet1/2 layer3 ip Internet_L3_203-0-113-254--24\nset network interface ethernet ethernet1/2 layer3 interface-management-profile Allow_Ping\nset network interface ethernet ethernet1/2 layer3 adjust-tcp-mss enable yes\nset network interface ethernet ethernet1/2 layer3 adjust-tcp-mss ipv4-mss-adjustment 64\nbash\nset network interface tunnel units tunnel.1 ip CF_MWAN_IPsec_VTI_01_Local\nset network interface tunnel units tunnel.1 mtu 1450\nset network interface tunnel units tunnel.1 interface-management-profile Allow_Ping\nset network interface tunnel units tunnel.2 ip CF_MWAN_IPsec_VTI_02_Local\nset network interface tunnel units tunnel.2 mtu 1450\nset network interface tunnel units tunnel.2 interface-management-profile Allow_Ping\nbash\nset zone Trust_L3_Zone network layer3 ethernet1/1\nset zone Untrust_L3_Zone network layer3 ethernet1/2\nset zone Cloudflare_L3_Zone network layer3 [ tunnel.1 tunnel.2 ]\nbash\nset network ike crypto-profiles ike-crypto-profiles CF_IKE_Crypto_CBC hash [ sha512 sha384 sha256 ]\nset network ike crypto-profiles ike-crypto-profiles CF_IKE_Crypto_CBC dh-group [ group20 ]\nset network ike crypto-profiles ike-crypto-profiles CF_IKE_Crypto_CBC encryption aes-256-cbc\nset network ike crypto-profiles ike-crypto-profiles CF_IKE_Crypto_CBC lifetime hours 24\nset network ike crypto-profiles ike-crypto-profiles CF_IKE_Crypto_CBC authentication-multiple 0\nbash\nset network ike crypto-profiles ipsec-crypto-profiles CF_IPsec_Crypto_CBC esp authentication [ sha256 sha1 ]\nset network ike crypto-profiles ipsec-crypto-profiles CF_IPsec_Crypto_CBC esp encryption aes-256-cbc\nset network ike crypto-profiles ipsec-crypto-profiles CF_IPsec_Crypto_CBC lifetime hours 8\nset network ike crypto-profiles ipsec-crypto-profiles CF_IPsec_Crypto_CBC dh-group group20\nbash\nset network ike gateway CF_Magic_WAN_IKE_01 protocol ikev1 dpd enable yes\nset network ike gateway CF_Magic_WAN_IKE_01 protocol ikev2 dpd enable yes\nset network ike gateway CF_Magic_WAN_IKE_01 protocol ikev2 ike-crypto-profile CF_IKE_Crypto_CBC\nset network ike gateway CF_Magic_WAN_IKE_01 protocol version ikev2\nset network ike gateway CF_Magic_WAN_IKE_01 local-address ip Internet_L3_203-0-113-254--24\nset network ike gateway CF_Magic_WAN_IKE_01 local-address interface ethernet1/2\nset network ike gateway CF_Magic_WAN_IKE_01 protocol-common nat-traversal enable no\nset network ike gateway CF_Magic_WAN_IKE_01 protocol-common fragmentation enable no\nset network ike gateway CF_Magic_WAN_IKE_01 peer-address ip CF_Magic_WAN_Anycast_01\nset network ike gateway CF_Magic_WAN_IKE_01 authentication pre-shared-key key -AQ==Xdcd9ir5o5xhjuIH---------------------HsRoVf+M0TTG4ja3EzulN37zMOwGs\nset network ike gateway CF_Magic_WAN_IKE_01 local-id id 28de99ee57424ee0a1591384193982fa.33145236.ipsec.cloudflare.com\nset network ike gateway CF_Magic_WAN_IKE_01 local-id type fqdn\nset network ike gateway CF_Magic_WAN_IKE_01 disabled no\nbash\nset network ike gateway CF_Magic_WAN_IKE_02 protocol ikev1 dpd enable yes\nset network ike gateway CF_Magic_WAN_IKE_02 protocol ikev2 dpd enable yes\nset network ike gateway CF_Magic_WAN_IKE_02 protocol ikev2 ike-crypto-profile CF_IKE_Crypto_CBC\nset network ike gateway CF_Magic_WAN_IKE_02 protocol version ikev2\nset network ike gateway CF_Magic_WAN_IKE_02 local-address ip Internet_L3_203-0-113-254--24\nset network ike gateway CF_Magic_WAN_IKE_02 local-address interface ethernet1/2\nset network ike gateway CF_Magic_WAN_IKE_02 protocol-common nat-traversal enable no\nset network ike gateway CF_Magic_WAN_IKE_02 protocol-common fragmentation enable no\nset network ike gateway CF_Magic_WAN_IKE_02 peer-address ip CF_Magic_WAN_Anycast_02\nset network ike gateway CF_Magic_WAN_IKE_02 authentication pre-shared-key key -AQ==rvwEulxx7wLBl---------------------swSeJPXxxM2cfPbt7q4HZZGZZ8\nset network ike gateway CF_Magic_WAN_IKE_02 local-id id b87322b0915b47158667bf1653990e66.33145236.ipsec.cloudflare.com\nset network ike gateway CF_Magic_WAN_IKE_02 local-id type fqdn\nset network ike gateway CF_Magic_WAN_IKE_02 disabled no\nbash\nset network tunnel ipsec CF_Magic_WAN_IPsec_01 auto-key ike-gateway CF_Magic_WAN_IKE_01\nset network tunnel ipsec CF_Magic_WAN_IPsec_01 auto-key ipsec-crypto-profile CF_IPsec_Crypto_CBC\nset network tunnel ipsec CF_Magic_WAN_IPsec_01 tunnel-monitor destination-ip 10.252.2.26\nset network tunnel ipsec CF_Magic_WAN_IPsec_01 tunnel-monitor tunnel-monitor-profile default\nset network tunnel ipsec CF_Magic_WAN_IPsec_01 tunnel-interface tunnel.1\nset network tunnel ipsec CF_Magic_WAN_IPsec_01 anti-replay no\nset network tunnel ipsec CF_Magic_WAN_IPsec_01 disabled no\nbash\nset network tunnel ipsec CF_Magic_WAN_IPsec_02 auto-key ike-gateway CF_Magic_WAN_IKE_02\nset network tunnel ipsec CF_Magic_WAN_IPsec_02 auto-key ipsec-crypto-profile CF_IPsec_Crypto_CBC\nset network tunnel ipsec CF_Magic_WAN_IPsec_02 tunnel-monitor destination-ip 10.252.2.28\nset network tunnel ipsec CF_Magic_WAN_IPsec_02 tunnel-monitor tunnel-monitor-profile default\nset network tunnel ipsec CF_Magic_WAN_IPsec_02 tunnel-interface tunnel.2\nset network tunnel ipsec CF_Magic_WAN_IPsec_02 anti-replay no\nset network tunnel ipsec CF_Magic_WAN_IPsec_02 disabled no\nbash\nshow vpn ike-sa gateway [value]\nbash\nadmin@panvm03> show vpn ike-sa gateway CF_Magic_WAN_IKE_01\n\nThere is no IKEv1 phase-1 SA found.\n\nThere is no IKEv1 phase-2 SA found.\n\nIKEv2 SAs\nGateway ID      Peer-Address           Gateway Name           Role SN       Algorithm             Established     Expiration      Xt Child  ST\n\n----------      ------------           ------------           ---- --       ---------             -----------     ----------      -- -----  --\n\n2               162.159.66.164         CF_Magic_WAN_IKE_01    Init 67       PSK/DH20/A256/SHA256  Jun.04 21:09:13 Jun.05 05:09:13 0  1      Established\n\nIKEv2 IPsec Child SAs\nGateway Name           TnID     Tunnel                    ID       Parent   Role SPI(in)  SPI(out) MsgID    ST\n\n------------           ----     ------                    --       ------   ---- -------  -------- -----    --\n\nCF_Magic_WAN_IKE_01    2        CF_Magic_WAN_IPsec_01     322550   67       Init FCAEE176 1EF41BA9 000007B4 Mature\n\nShow IKEv2 SA: Total 2 gateways found. 1 ike sa found.\nbash\nadmin@panvm03> show vpn ike-sa gateway CF_Magic_WAN_IKE_02\n\nThere is no IKEv1 phase-1 SA found.\n\nThere is no IKEv1 phase-2 SA found.\n\nIKEv2 SAs\nGateway ID      Peer-Address           Gateway Name           Role SN       Algorithm             Established     Expiration      Xt Child  ST\n\n----------      ------------           ------------           ---- --       ---------             -----------     ----------      -- -----  --\n\n3               172.64.242.164         CF_Magic_WAN_IKE_02    Init 66       PSK/DH20/A256/SHA256  Jun.04 20:37:42 Jun.05 04:37:42 0  2      Established\n\nIKEv2 IPsec Child SAs\nGateway Name           TnID     Tunnel                    ID       Parent   Role SPI(in)  SPI(out) MsgID    ST\n\n------------           ----     ------                    --       ------   ---- -------  -------- -----    --\n\nCF_Magic_WAN_IKE_02    3        CF_Magic_WAN_IPsec_02     323145   66       Init B6EDA356 43F71BC5 00000A52 Mature\n\nShow IKEv2 SA: Total 2 gateways found. 1 ike sa found.\nbash\ntest vpn ike-sa gateway [value]\nbash\nadmin@panvm03> test vpn ike-sa gateway CF_Magic_WAN_IKE_01\n\nStart time: Jun.05 00:30:29\nInitiate 1 IKE SA.\nbash\nadmin@panvm03> test vpn ike-sa gateway CF_Magic_WAN_IKE_02\n\nStart time: Jun.05 00:30:33\nInitiate 1 IKE SA.\nbash\nshow vpn ipsec-sa tunnel [value]\nbash\nadmin@panvm03> show vpn ipsec-sa tunnel CF_Magic_WAN_IPsec_01\n\nGwID/client IP  TnID   Peer-Address           Tunnel(Gateway)                                Algorithm          SPI(in)  SPI(out) life(Sec/KB)             remain-time(Sec)\n\n--------------  ----   ------------           ---------------                                ---------          -------  -------- ------------             ----------------\n\n2               2      162.159.66.164         CF_Magic_WAN_IPsec_01(CF_Magic_WAN_IKE_01)     ESP/A256/SHA256    B5D09AB8 9FA69407 3600/Unlimited           3445\n\nShow IPsec SA: Total 1 tunnels found. 1 ipsec sa found.\nbash\nadmin@panvm03> show vpn ipsec-sa tunnel CF_Magic_WAN_IPsec_02\n\nGwID/client IP  TnID   Peer-Address           Tunnel(Gateway)                                Algorithm          SPI(in)  SPI(out) life(Sec/KB)             remain-time(Sec)\n\n--------------  ----   ------------           ---------------                                ---------          -------  -------- ------------             ----------------\n\n3               3      172.64.242.164         CF_Magic_WAN_IPsec_02(CF_Magic_WAN_IKE_02)     ESP/A256/SHA256    CAEA6F09 EC6ACC7A 3600/Unlimited           3361\n\nShow IPsec SA: Total 1 tunnels found. 1 ipsec sa found.\nbash\ntest vpn ipsec-sa tunnel [value]\nbash\nadmin@panvm03> test vpn ipsec-sa tunnel CF_Magic_WAN_IPsec_01\n\nStart time: Jun.05 00:37:50\nInitiate 1 IPsec SA for tunnel CF_Magic_WAN_IPsec_01.\nbash\nadmin@panvm03> test vpn ipsec-sa tunnel CF_Magic_WAN_IPsec_02\n\nStart time: Jun.05 00:38:52\nInitiate 1 IPsec SA for tunnel CF_Magic_WAN_IPsec_02.\nbash\nping source [value src IP] host [value dst IP]\nbash\nadmin@panvm03> ping source 10.252.2.27 host 10.252.2.26\nPING 10.252.2.26 (10.252.2.26) from 10.252.2.27 : 56(84) bytes of data.\n64 bytes from 10.252.2.26: icmp_seq=1 ttl=64 time=2.71 ms\n64 bytes from 10.252.2.26: icmp_seq=2 ttl=64 time=2.03 ms\n64 bytes from 10.252.2.26: icmp_seq=3 ttl=64 time=1.98 ms\n64 bytes from 10.252.2.26: icmp_seq=4 ttl=64 time=1.98 ms\n^C\n--- 10.252.2.26 ping statistics ---\n4 packets transmitted, 4 received, 0% packet loss, time 3002ms\nrtt min/avg/max/mdev = 1.980/2.180/2.719/0.312 ms\nbash\nadmin@panvm03> ping source 10.252.2.29 host 10.252.2.28\nPING 10.252.2.28 (10.252.2.28) from 10.252.2.29 : 56(84) bytes of data.\n64 bytes from 10.252.2.28: icmp_seq=1 ttl=64 time=2.90 ms\n64 bytes from 10.252.2.28: icmp_seq=2 ttl=64 time=1.92 ms\n64 bytes from 10.252.2.28: icmp_seq=3 ttl=64 time=1.76 ms\n64 bytes from 10.252.2.28: icmp_seq=4 ttl=64 time=1.97 ms\n^C\n--- 10.252.2.28 ping statistics ---\n4 packets transmitted, 4 received, 0% packet loss, time 3003ms\nrtt min/avg/max/mdev = 1.765/2.141/2.900/0.446 ms\nbash\nset network virtual-router default ecmp algorithm weighted-round-robin interface tunnel.1 weight 100\nset network virtual-router default ecmp algorithm weighted-round-robin interface tunnel.2 weight 100\nset network virtual-router default ecmp enable yes\nset network virtual-router default ecmp symmetric-return yes\nset network virtual-router default ecmp strict-source-path yes\nbash\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun01 nexthop ip-address CF_MWAN_IPsec_VTI_01_Remote\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun01 bfd profile None\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun01 interface tunnel.1\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun01 metric 10\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun01 destination VLAN0010_10-1-10-0--24\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun01 route-table unicast\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun02 nexthop ip-address CF_MWAN_IPsec_VTI_02_Remote\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun02 bfd profile None\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun02 interface tunnel.2\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun02 metric 11\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun02 destination VLAN0010_10-1-10-0--24\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0010_Tun02 route-table unicast\nbash\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun01 nexthop ip-address CF_MWAN_IPsec_VTI_01_Remote\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun01 bfd profile None\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun01 interface tunnel.1\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun01 metric 10\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun01 destination VLAN0020_10-1-20-0--24\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun01 route-table unicast\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun02 nexthop ip-address CF_MWAN_IPsec_VTI_02_Remote\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun02 bfd profile None\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun02 interface tunnel.2\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun02 metric 11\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun02 destination VLAN0020_10-1-20-0--24\nset network virtual-router default routing-table ip static-route Magic_WAN_VLAN0020_Tun02 route-table unicast\nbash\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC to Cloudflare_L3_Zone\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC from Cloudflare_L3_Zone\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC source [ CF_Health_Check_Anycast_01 CF_Health_Check_Anycast_02 ]\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC destination Cloudflare_IPv4_Static_Grp\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC source-user any\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC category any\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC application [ icmp ping ]\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC service application-default\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC hip-profiles any\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC action allow\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC rule-type universal\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC description \"Permit bidirectional HCs\"\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC disabled no\nset rulebase security rules Cloudflare_Tunnel_Bidirect_HC log-end yes\nbash\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_01 action forward nexthop ip-address CF_MWAN_IPsec_VTI_01_Remote\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_01 action forward egress-interface tunnel.1\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_01 from zone Cloudflare_L3_Zone\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_01 enforce-symmetric-return enabled no\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_01 source CF_Health_Check_Anycast_01\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_01 destination Cloudflare_IPv4_Static_Grp\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_01 source-user any\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_01 application any\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_01 service any\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_01 tag Cloudflare_L3_Zone\nbash\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_02 action forward nexthop ip-address CF_MWAN_IPsec_VTI_02_Remote\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_02 action forward egress-interface tunnel.2\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_02 from zone Cloudflare_L3_Zone\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_02 enforce-symmetric-return enabled no\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_02 source CF_Health_Check_Anycast_02\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_02 destination Cloudflare_IPv4_Static_Grp\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_02 source-user any\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_02 application any\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_02 service any\nset rulebase pbf rules PBF_Cloudflare_Healthcheck_02 tag Cloudflare_L3_Zone\nbash\nrule eq Cloudflare_Tunnel_Bidirect_HC\nbash\n( addr.src in 172.64.240.253 ) or ( addr.src in 172.64.240.254 )\nbash\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow to Cloudflare_L3_Zone\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow from Trust_L3_Zone\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow source VLAN0100_10-1-100-0--24\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow destination [ VLAN0010_10-1-10-0--24 VLAN0020_10-1-20-0--24 ]\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow source-user any\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow category any\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow application any\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow service application-default\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow hip-profiles any\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow action allow\nset rulebase security rules Trust_to_Cloudflare_Magic_WAN_Allow rule-type universal\nbash\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow to Trust_L3_Zone\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow from Cloudflare_L3_Zone\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow source [ VLAN0010_10-1-10-0--24 VLAN0020_10-1-20-0--24 ]\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow destination VLAN0100_10-1-100-0--24\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow source-user any\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow category any\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow application any\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow service application-default\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow hip-profiles any\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow action allow\nset rulebase security rules Cloudflare_Magic_WAN_to_Trust_Allow rule-type universal\nbash\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 action forward nexthop ip-address CF_MWAN_IPsec_VTI_01_Remote\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 action forward egress-interface tunnel.1\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 from zone Trust_L3_Zone\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 enforce-symmetric-return enabled no\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 source VLAN0100_10-1-100-0--24\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 destination [ VLAN0010_10-1-10-0--24 VLAN0020_10-1-20-0--24 ]\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 source-user any\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 application any\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 service any\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 disabled no\nset rulebase pbf rules PBF_Magic_WAN_Sites_01 negate-destination no\nbash\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 action forward nexthop ip-address CF_MWAN_IPsec_VTI_02_Remote\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 action forward egress-interface tunnel.2\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 from zone Trust_L3_Zone\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 enforce-symmetric-return enabled no\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 source VLAN0100_10-1-100-0--24\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 destination [ VLAN0010_10-1-10-0--24 VLAN0020_10-1-20-0--24 ]\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 source-user any\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 application any\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 service any\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 disabled no\nset rulebase pbf rules PBF_Magic_WAN_Sites_02 negate-destination no\nbash\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow to Cloudflare_L3_Zone\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow from Trust_L3_Zone\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow source any\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow destination [ VLAN0010_10-1-10-0--24 VLAN0020_10-1-20-0--24 ]\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow source-user any\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow category any\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow application any\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow service application-default\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow hip-profiles any\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow action allow\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow rule-type universal\nset rulebase security rules Trust_to_MWAN_Gateway_Egress_Allow negate-destination yes\nbash\nset rulebase pbf rules PBF_MWAN_Egress_01 action forward nexthop ip-address CF_MWAN_IPsec_VTI_01_Remote\nset rulebase pbf rules PBF_MWAN_Egress_01 action forward egress-interface tunnel.1\nset rulebase pbf rules PBF_MWAN_Egress_01 from zone Trust_L3_Zone\nset rulebase pbf rules PBF_MWAN_Egress_01 enforce-symmetric-return enabled no\nset rulebase pbf rules PBF_MWAN_Egress_01 source VLAN0100_10-1-100-0--24\nset rulebase pbf rules PBF_MWAN_Egress_01 destination [ VLAN0010_10-1-10-0--24 VLAN0020_10-1-20-0--24 ]\nset rulebase pbf rules PBF_MWAN_Egress_01 source-user any\nset rulebase pbf rules PBF_MWAN_Egress_01 application any\nset rulebase pbf rules PBF_MWAN_Egress_01 service any\nset rulebase pbf rules PBF_MWAN_Egress_01 disabled no\nset rulebase pbf rules PBF_MWAN_Egress_01 negate-destination yes\nbash\nset rulebase pbf rules PBF_MWAN_Egress_02 action forward nexthop ip-address CF_MWAN_IPsec_VTI_02_Remote\nset rulebase pbf rules PBF_MWAN_Egress_02 action forward egress-interface tunnel.2\nset rulebase pbf rules PBF_MWAN_Egress_02 from zone Trust_L3_Zone\nset rulebase pbf rules PBF_MWAN_Egress_02 enforce-symmetric-return enabled no\nset rulebase pbf rules PBF_MWAN_Egress_02 source VLAN0100_10-1-100-0--24\nset rulebase pbf rules PBF_MWAN_Egress_02 destination [ VLAN0010_10-1-10-0--24 VLAN0020_10-1-20-0--24 ]\nset rulebase pbf rules PBF_MWAN_Egress_02 source-user any\nset rulebase pbf rules PBF_MWAN_Egress_02 application any\nset rulebase pbf rules PBF_MWAN_Egress_02 service any\nset rulebase pbf rules PBF_MWAN_Egress_02 disabled no\nset rulebase pbf rules PBF_MWAN_Egress_02 negate-destination yes\nbash\ncurl --request PUT \\\nhttps://api.cloudflare.com/client/v4/accounts/{account_id}/magic/ipsec_tunnels/{tunnel_id} \\\n--header \"X-Auth-Email: <EMAIL>\" \\\n--header \"X-Auth-Key: <API_KEY>\" \\\n--header \"Content-Type: application/json\" \\\n--data '{\n  \"health_check\": {\n    \"direction\": \"bidirectional\",\n    \"enabled\": true,\n    \"type\": \"request\",\n    \"rate\": \"low\"\n  }\n}'\nbash\n   set vpn ipsec-performance anti-replay window-size 0\n   bash\n   system gre tunnel add name <NAME_OF_YOUR_GRE_TUNNEL> local-gw <WAN_PORT> remote-gw <REMOTE_GATEWAY_IP_ADDRESS> local-ip <LOCAL_IP_ADDRESS> remote-ip <REMOTE_IP_ADDRESS>\n   bash\nsystem gre route add net <IP_ADDRESS> tunnelname <TUNNEL_NAME>\nbash\ncurl --request PUT \\\nhttps://api.cloudflare.com/client/v4/accounts/{account_id}/magic/ipsec_tunnels/{tunnel_id} \\\n--header \"X-Auth-Email: <EMAIL>\" \\\n--header \"X-Auth-Key: <API_KEY>\" \\\n--header \"Content-Type: application/json\" \\\n--data '{\n  \"health_check\": {\n    \"enabled\": true,\n    \"target\": \"172.64.240.252\",\n    \"type\": \"request\",\n    \"rate\": \"mid\"\n  }\n}'\nsh\ntcpdump -nn proto 1\nsh\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on any, link-type LINUX_SLL (Linux cooked v1), capture size 262144 bytes\n\n13:09:55.500453 xfrm1, IN: IP 172.70.51.31 > 172.64.240.252: ICMP echo request, id 33504, seq 0, length 64\n13:09:55.500480 xfrm1, OUT: IP 172.64.240.252 > 172.70.51.31: ICMP echo reply, id 33504, seq 0, length 64\n\n13:09:55.504669 xfrm1, IN: IP 172.71.29.66 > 172.64.240.252: ICMP echo request, id 60828, seq 0, length 64\n13:09:55.504695 xfrm1, OUT: IP 172.64.240.252 > 172.71.29.66: ICMP echo reply, id 60828, seq 0, length 64\nbash\ncurl --request PUT \\\nhttps://api.cloudflare.com/client/v4/accounts/{account_id}/magic/ipsec_tunnels/{tunnel_id} \\\n--header \"X-Auth-Email: <EMAIL>\" \\\n--header \"X-Auth-Key: <API_KEY>\" \\\n--header \"Content-Type: application/json\" \\\n--data '{\n  \"health_check\": {\n    \"enabled\": true,\n    \"target\": \"172.64.240.252\",\n    \"type\": \"request\",\n    \"rate\": \"mid\"\n  }\n}'\nsh\nsudo apt-get install strongswan -y\ntxt\ncharon {\n    load_modular = yes\n    install_routes = no\n    install_virtual_ip = no\n\nplugins {\n        include strongswan.d/charon/*.conf\n    }\n}\n\ninclude strongswan.d/*.conf\ntxt",
  "code_samples": [
    {
      "code": "#### Replace and test with example configuration\n\nThe next steps will walk you through a troubleshooting regimen. You will temporarily replace your existing `sshd_config` file with the provided example to rule out configuration issues. Before proceeding, carefully [review and compare both files](#review-your-sshd_config-file-for-misconfigurations) to identify any conflicting directives.\n\nYou may lose access to your server\n\nThese troubleshooting steps could result in you being locked out of your SSH server because your current SSH session may rely on existing configuration that is not in the [example file](#review-your-sshd_config-file-for-misconfigurations). Proceed with utmost caution.\n\n1. Back up the existing `sshd_config` file.",
      "language": "unknown"
    },
    {
      "code": "2. Create a new `sshd_config` file.",
      "language": "unknown"
    },
    {
      "code": "3. Enter insert mode by pressing the `i` key on your keyboard.\n\n4. Paste in the [example file](#review-your-sshd_config-file-for-misconfigurations).\n\n5. Exit insert mode by pressing the escape (`esc`) key.\n\n6. Enter `:x` to save and exit.\n\n7. [Reload](#reload-your-ssh-server) your SSH server.\n\n   Do not restart\n\n   Restarting your `sshd` service will result in the termination of your current SSH connection. Make sure to reload instead of restarting to avoid terminating all currently open SSH sessions.\n\n   Once you have modified your `sshd` configuration, reload the SSH service on the remote machine for the changes to take effect.\n\n   * Debian/Ubuntu\n\n     For Debian/Ubuntu:",
      "language": "unknown"
    },
    {
      "code": "* CentOS/RHEL\n\n     For CentOS/RHEL 7 and newer:",
      "language": "unknown"
    },
    {
      "code": "By completing all four troubleshooting steps, you should have resolved any connection issues caused by misconfiguration of the SSH server. If issues persist, [recheck `sshd` logs](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/use-cases/ssh/ssh-infrastructure-access/#review-your-sshd-logs). The example [`sshd_config` shared above](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/use-cases/ssh/ssh-infrastructure-access/#review-your-sshd_config-file-for-misconfigurations) enables debug logging and may expose more specific issues.\n\n### 5. Get help\n\nFor the fastest possible troubleshooting, ensure your support ticket includes comprehensive details. The more context you provide, the faster your issue can be identified and resolved.\n\nTo ensure efficient resolution when [contacting support](https://developers.cloudflare.com/support/contacting-cloudflare-support/), include as much relevant detail as possible in your ticket:\n\n*\n*\n*\n*\n*\n*\n*\n\nWrite a detailed ticket to resolve your issue faster\n\nAvoid vague descriptions and include scenario, timestamps, and steps taken to troubleshoot the issue. Refer to the following example:\n\nOn October 30, 2025, at approximately 3:45 PM UTC, Alice attempted to SSH into 10.116.0.3 (target hostname: prod-db-01) using Access for Infrastructure. The SSH client returned `Permission denied (none)` despite her email being included in the Access policy.\n\nThe `sshd` logs (captured with LogLevel DEBUG3) are attached and show the connection reaching the server but failing at the certificate validation step. The user exists on the server (`id alice` verified).\n\nThe `sshd_config` file and `ssh -vvv alice@10.116.0.3` output are attached. The tunnel status is Healthy in the Cloudflare dashboard, and Access authentication logs show a successful `Access granted` decision.\n\n</page>\n\n<page>\n---\ntitle: Connect with self-managed SSH keys  Cloudflare One docs\ndescription: If you want to manage your own SSH keys, you can use Cloudflare\n  Tunnel to create a secure, outbound-only connection from your server to\n  Cloudflare's global network. This requires running the cloudflared daemon on\n  the server (or any other host machine within the private network). Users with\n  SSH keys that are trusted by the SSH server can access the server by\n  installing the Cloudflare WARP client on their device and enrolling in your\n  Zero Trust organization. Remote devices will be able to connect as if they\n  were on your private network. By default, all devices enrolled in your\n  organization can SSH to the server unless you build policies to allow or block\n  specific users.\nlastUpdated: 2025-10-21T14:33:19.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/use-cases/ssh/ssh-warp-to-tunnel/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/use-cases/ssh/ssh-warp-to-tunnel/index.md\n---\n\nIf you want to manage your own SSH keys, you can use Cloudflare Tunnel to create a secure, outbound-only connection from your server to Cloudflare's global network. This requires running the `cloudflared` daemon on the server (or any other host machine within the private network). Users with SSH keys that are trusted by the SSH server can access the server by installing the [Cloudflare WARP client](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/) on their device and enrolling in your Zero Trust organization. Remote devices will be able to connect as if they were on your private network. By default, all devices enrolled in your organization can SSH to the server unless you build policies to allow or block specific users.\n\nNote\n\nIf you want to create more granular access policies, allow Cloudflare to manage SSH keys for you, or to obtain command logs, consider using [Access for Infrastructure](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/use-cases/ssh/ssh-infrastructure-access/) instead.\n\nThis example walks through how to set up an SSH server on a Google Cloud Platform (GCP) virtual machine (VM), but you can use any machine that supports SSH connections.\n\n## 1. Create an SSH key pair\n\nBefore creating your VM instance you will need to create an SSH key pair.\n\n1. Open a terminal and type the following command:",
      "language": "unknown"
    },
    {
      "code": "2. Enter your passphrase when prompted. It will need to be entered twice.\n\n   Two files will be generated: `gcp_ssh` which contains the private key, and `gcp_ssh.pub` which contains the public key.\n\n3. In the command line, enter:",
      "language": "unknown"
    },
    {
      "code": "4. Copy the output. This will be used when creating the VM instance in GCP.\n\n## 2. Create a VM instance in GCP\n\nNow that the SSH key pair has been created, you can create a VM instance.\n\n1. In your [Google Cloud Console](https://console.cloud.google.com/), [create a new project](https://developers.google.com/workspace/guides/create-project).\n2. Go to **Compute Engine** > **VM instances**.\n3. Select **Create instance**.\n4. Name your VM instance, for example `ssh-server`.\n5. Scroll down to **Advanced options** > **Security** > **Manage Access**.\n6. Under **Add manually generated SSH keys**, select **Add item** and paste the public key that you have created.\n7. Select **Create**.\n8. Once your VM instance is running, open the dropdown next to **SSH** and select *Open in browser window*.\n\nNote\n\nIn order to be able to establish an SSH connection, do not enable [OS Login](https://cloud.google.com/compute/docs/oslogin) on the VM instance.\n\n## 3. Connect the server to Cloudflare\n\n1. In [Cloudflare One](https://one.dash.cloudflare.com), go to **Networks** > **Connectors** > **Cloudflare Tunnels**.\n\n2. [Create a new tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/get-started/create-remote-tunnel/) or edit an existing `cloudflared` tunnel.\n\n1) In the **CIDR** tab for the tunnel, enter the private IP or CIDR address of your server. In GCP, the server IP is the **Internal IP** of the VM instance.\n\n2) (Optional) [Set up Zero Trust policies](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/private-net/cloudflared/#4-recommended-filter-network-traffic-with-gateway) to fine-tune access to your server.\n\n## 4. Set up the client\n\nTo connect your devices to Cloudflare:\n\n1. [Deploy the WARP client](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/) on your devices in Gateway with WARP mode or [generate a proxy endpoint](https://developers.cloudflare.com/cloudflare-one/networks/resolvers-and-proxies/proxy-endpoints/) and deploy a PAC file.\n2. [Create device enrollment rules](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/device-enrollment/) to determine which devices can enroll to your Zero Trust organization.\n\n## 5. Route private network IPs through WARP\n\nBy default, WARP excludes traffic bound for [RFC 1918 space](https://datatracker.ietf.org/doc/html/rfc1918), which are IP addresses typically used in private networks and not reachable from the Internet. In order for WARP to send traffic to your private network, you must configure [Split Tunnels](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/) so that the IP/CIDR of your private network routes through WARP.\n\n1. First, check whether your [Split Tunnels mode](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#change-split-tunnels-mode) is set to **Exclude** or **Include** mode.\n\n2. Edit your Split Tunnel routes depending on the mode:\n\n   * Exclude IPs and domains\n\n     If you are using **Exclude** mode:\n\n     a. [Delete the route](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#remove-a-route) containing your private network's IP/CIDR range. For example, if your network uses the default AWS range of `172.31.0.0/16`, delete `172.16.0.0/12`.\n\n     b. [Re-add IP/CIDR ranges](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#add-a-route) that are not explicitly used by your private network. For the AWS example above, you would add new entries for `172.16.0.0/13`, `172.24.0.0/14`, `172.28.0.0/15`, and `172.30.0.0/16`. This ensures that only traffic to `172.31.0.0/16` routes through WARP.\n\n     You can use the following calculator to determine which IP addresses to re-add:\n\n     Calculator instructions\n\n     1. In **Base CIDR**, enter the RFC 1918 range that you deleted from Split Tunnels.\n     2. In **Excluded CIDRs**, enter the IP/CIDR range used by your private network.\n     3. Re-add the calculator results to your Split Tunnel Exclude mode list.\n\n     By tightening the private IP range included in WARP, you reduce the risk of breaking a user's [access to local resources](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#allow-users-to-enable-local-network-exclusion).\n\n   * Include IPs and domains\n\n     If you are using **Include** mode:\n\n     1. Add the required [Zero Trust domains](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#cloudflare-zero-trust-domains) or [IP addresses](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#cloudflare-zero-trust-ip-addresses) to your Split Tunnel include list.\n     2. [Add a route](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#add-a-route) to include your private network's IP/CIDR range.\n\n## 6. Connect as a user\n\nOnce you have set up the application and the user device, the user can now SSH into the machine using its private IP address. If your SSH server requires an SSH key, the key should be included in the command.",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Configure hardware Connector  Cloudflare One docs\ndescription: In this page you will find instructions on how to configure Magic\n  WAN Connector. This guide provides a step-by-step guide for Magic WAN\n  Connector initial setup. You can either return here after setting up your\n  Magic WAN Connector, or refer to the Maintenance section where you will find\n  instructions on how to update your settings.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/index.md\n---\n\nIn this page you will find instructions on how to configure Magic WAN Connector. This guide provides a step-by-step guide for Magic WAN Connector initial setup. You can either return here after setting up your Magic WAN Connector, or refer to the [Maintenance](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/) section where you will find instructions on how to update your settings.\n\n## Prerequisites\n\nYou need to purchase [Magic WAN](https://www.cloudflare.com/magic-wan) before you can purchase and use Magic WAN Connector. Magic WAN Connector can function as your primary edge device for your network, or be deployed in-line with existing network gear.\n\nYou also need to purchase Magic WAN Connector before you can start configuring your settings in the Cloudflare dashboard. Contact your account representative to learn more about purchasing options for Magic WAN Connector.\n\n***\n\n## Before you begin\n\nThere are a couple of decisions you need to make when installing your Magic WAN Connector. Refer to the topics below for more information.\n\n### Determine the need for a high availability configuration\n\nYou can install up to two instances of Magic WAN Connector for redundancy at each of your sites. If one of your devices fails, traffic will fail over to the other, ensuring that you never lose connectivity to that site.\n\nIn this type of high availability (HA) configuration, you will choose a reliable LAN interface as the HA link which will be used to monitor the health of the peer connector. HA links can be dedicated links or can be shared with other LAN traffic.\n\nYou must decide the type of configuration you want for your site from the beginning: no redundancy or with redundancy. You cannot add redundancy after finishing the configuration of your dashboard settings. If, at a later stage, you decide to enable redundancy, you will need to delete your Magic WAN Connector device in the Cloudflare dashboard, and start again.\n\nDo you need a high availability configuration?\n\n* If you need a high availability configuration for your premises, refer to [About high availability configurations](#about-high-availability-configurations) for more information and learn how to configure your Magic WAN Connector device in this mode.\n\n* If you do not need a high availability configuration for you premises, check if you need a [DHCP or a static IP setup](#decide-on-dhcp-vs-static-ip-connections) before proceeding to [Set up Cloudflare dashboard](#set-up-cloudflare-dashboard).\n\nWarning\n\nYou cannot enable high availability for an existing Magic WAN Connector on-ramp. To add high availability to an existing Magic WAN Connector on-ramp in the Cloudflare dashboard, you need to delete the on-ramp and start again. Plan accordingly to create a high availability configuration from the start if needed.\n\n### Decide on DHCP vs static IP connections\n\nYou can use Magic WAN Connector in both DHCP networks and networks that require a static IP configuration. At first boot, however, Magic WAN Connector needs to reach out to Cloudflare to download your settings and go through the activation process. If any of the networks plugged into your Magic WAN Connector device are DHCP enabled, do not use a VLAN, and have an Internet connection, that process is handled automatically. However, if all of the networks require more information to utilize, (such as a network with static IPs, or tagged VLAN networks) your Magic WAN Connector might need some more information to proceed.\n\nThere are couple of ways to provide this information. Choose the one that fits your workflow:\n\n#### Option one - Activate on a DHCP Network\n\n1. Connect Magic WAN Connector to a DHCP port with access to the Internet.\n2. Go through the [setup flow](#set-up-cloudflare-dashboard) below and activate your Magic WAN Connector device.\n3. Refer to [WAN with a static IP address](#wan-with-a-static-ip-address).\n\n#### Option two - Bootstrap via Serial Console\n\nRefer to the [Bootstrap workflow](#bootstrap-via-serial-console).\n\n***\n\n## Port speeds\n\nThe hardware version of the Magic WAN Connector includes two [SFP+ ports](https://en.wikipedia.org/wiki/Small_Form-factor_Pluggable) that support 10G throughput, as well as six RJ45 ports that support 1G throughput.\n\nRefer to [](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/sfp-port-information)SFP+ port information for details on this topic.\n\n***\n\n## Set up Cloudflare dashboard\n\n### Register your Connector\n\nTo set up and use the hardware version of Magic WAN Connector, you first need to register it with your account. This is not applicable to Virtual Magic WAN Connector.\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances**, and select **Register an appliance**.\n\n1) In **Appliance details** > **Serial number**, insert the serial number for your device. You can optionally add notes about the Magic WAN Connector you are adding to the dashboard.\n2) (Optional) Select **Add** below **Serial number** to add multiple Magic WAN Connectors at once to your account.\n3) Select **Register appliance**.\n\nYour device is now registered with your account.\n\n### Create a new profile\n\nYou need to create a profile for your appliance before connecting it to the Internet.\n\nTo create a profile:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances**.\n3. Select **Create a profile**.\n\n1) In **Name**, enter a descriptive name for your Magic WAN Connector. Optionally, you can also add a description for it.\n2) You need to decide if you want to turn on high availability for the Magic WAN Connector. Refer to [About high availability configurations](#about-high-availability-configurations) for more information.\n3) Select **Create and continue**.\n4) Select **Add appliance**. This will show you a list of devices associated with your account. You need to have bought a Connector already for it to show up here. Refer to [Prerequisites](#prerequisites) if no Connector shows up in this list.\n5) If you have more than one Magic WAN Connector, choose the one that corresponds to the on-ramp you are creating. Magic WAN Connector devices are identified by a serial number, also known as a service tag. Use this information to choose the right Magic WAN Connector.\\\n   Select **Add Connector** when you are ready to proceed.\n6) Magic WAN Connector will be added to your account with an **Interrupt window** defined. The interrupt window is the time period when the Magic WAN Connector software can update, which may result in interruption to existing connections. You can change this later. Refer to [Interrupt window](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/interrupt-service-window/) for more details on how to define when the Magic WAN Connector can update its systems.\n7) Select **Continue** to proceed to creating your WAN and LAN networks.\n\n### Create a WAN\n\n* Dashboard\n\n  When you have more than one anycast IP configured in your account (set up during your Magic WAN onboarding), Magic WAN Connector will automatically create at most two tunnels per WAN port. This improves reliability and performance, and requires no additional configuration on your part.\n\n  1. In **WAN configuration**, select **Create**. You can create one or more [wide area networks (WANs)](https://www.cloudflare.com/learning/network-layer/what-is-a-wan/). Configuring multiple WANs will create multiple IPsec tunnels (one IPsec tunnel per WAN port). This allows Magic WAN Connector to load balance traffic over WANs of equal priority. It also allows Magic WAN Connector to failover between circuits according to their [health](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/). Refer to [WAN settings](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/#wan-settings) for more details.\n\n     Note\n\n     This is not the same as a high availability (HA) configuration. HA configurations need two Magic WAN Connector devices to work. Refer to [About high availability configurations](#about-high-availability-configurations) for more information.\n\n  2. In **Interface name**, enter a descriptive name for your WAN.\n\n  3. **Interface number** refers to the physical Connector Ethernet port that you are using for your WAN. The ports are labeled `GE1`, `GE2`, `GE3`, `GE4`, `GE5`, and `GE6`. Choose the number corresponding to the port that you are using in Connector.\\\n     If you need a throughput higher than 1 Gbps, you can use one of the SFP+ ports. Refer to [SFP+ port information](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/sfp-port-information/) for more information on the hardware supported.\n\n  4. In **VLAN ID**, enter a number between `0` and `4094` to specify a [VLAN ID](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/#vlan-id).\n\n  5. In **Priority**, choose the priority for your WAN. Lower numbers have higher priority. Refer to [Traffic steering](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/) to learn more about how Cloudflare calculates priorities.\n\n  6. In **Health check rate** configure the health check frequency for your site. Options are `low`, `mid`, and `high`. Refer to [Update tunnel health checks frequency](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/update-tunnel-health-checks-frequency/) for more information.\n\n  7. **Addressing**: Select **DHCP**. This is needed the first time you set up your Magic WAN Connector to successfully download all settings to the machine and activate it. If you need a static IP address in your network environment:\n\n     1. Continue the set up flow below to activate your Magic WAN Connector.\n     2. Refer to [WAN with a static IP address](#wan-with-a-static-ip-address). If you choose a static IP, you also need to specify the static IP and gateway addresses.\n\n  8. Select **Save** when you are finished.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Make a `POST` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/wans/methods/create/) to create a WAN.\n\n  The `static_addressing` object is optional. Omit it if you are using DHCP. If you are using static addressing, add the `secondary_address` parameter when your site is in high availability (HA) mode.\n\n  Example:",
      "language": "unknown"
    },
    {
      "code": "### Create a LAN\n\n* Dashboard\n\n  1. In **LAN configuration**, select **Create**.\n\n  2. Enter a descriptive name for your LAN in **Interface name**.\n\n  3. **Interface number** refers to the physical Connector Ethernet port that you are using for your WAN. The ports are labeled `GE1`, `GE2`, `GE3`, `GE4`, `GE5`, and `GE6`. Choose a number corresponding to the port that you are using in Connector.\\\n     If you need a throughput higher than 1 Gbps, you can use one of the SFP+ ports. Refer to [SFP+ port information](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/sfp-port-information/) for more information on the hardware supported.\n\n  4. In **VLAN ID**, specify a [VLAN ID](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/#vlan-id) to create virtual LANs.\n\n  5. In **Static addressing** > **Static address** give your Magic WAN Connector's LAN interface its IP address. You can also enable the following options if they suit your use case:\n\n     * **This is a DHCP server**: If your Magic WAN Connector is a [DHCP server](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-server/).\n     * **This is a DHCP relay**: If your Magic WAN Connector is a [DHCP relay](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-relay/).\n\n  6. (Optional) In **Directly attached subnet** > **Static NAT prefix**, enter a CIDR prefix to enable NAT (network address translation). The prefix you enter here should be the same size as the prefix entered in **Static addressing**. For example, both networks have a subnet mask of `/24`: `192.168.100.0/24` and `10.10.100.0/24`.\n\n  7. (Optional) If your LAN contains additional subnets behind a layer 3 router, select **Add routed subnet** under **Routed subnets** to add them:\n\n     * **Prefix**: The CIDR prefix for the subnet behind the L3 router.\n     * **Next hop**: The address of the L3 router to which the Magic WAN Connector should forward packets for this subnet.\n     * **Static NAT prefix**: Optional setting. If you want to enable NAT for a routed subnet, supply an \"external\" prefix for the overlay-facing side of the NAT to use. It must be the same size as **Prefix**.\\\n       Refer to [Routed subnets](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/routed-subnets/) for more information.\n\n  8. Select **Save**.\n\n  9. Select **Done** to finish your configuration. Tunnels and static routes will be automatically created for your Magic WAN Connector, once it boots up.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Make a `POST` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/lans/methods/create/) to create a LAN.\n\n  Example:",
      "language": "unknown"
    },
    {
      "code": "#### Network segmentation\n\nAfter setting up your LANs, you can configure your Magic WAN Connector to enable communication between them without traffic leaving your premises. Refer to [Network segmentation](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/network-segmentation/) for more information.\n\n#### DHCP options\n\nMagic WAN Connector supports different types of DHCP configurations. Magic WAN Connector can:\n\n* Connect to a DHCP server or use a static IP address instead of connecting to a DHCP server.\n* Act as a [DHCP server](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-server/).\n* Use [DHCP relay](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-relay/) to connect to a DHCP server outside the location your Magic WAN Connector is in.\n* [Reserve IP addresses](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-static-address-reservation/) for specific devices on your network.\n\n### Add your Magic WAN Connector to a site\n\nAfter finishing your Magic WAN Connector configuration, you need to add it to a site.\n\nSites represent the local network of a data center, office, or other physical location, and combine all on-ramps available there. Sites also allow you to check, at a glance, the state of your on-ramps and set up health alert settings so that Cloudflare notifies you when there are issues with the site's on-ramps.\n\nRefer to [Set up a site](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/sites/) for more information.\n\n## Set up your Magic WAN Connector\n\n### Device installation\n\nThere are several deployment options for Magic WAN Connector. Magic WAN Connector can act like a DHCP server for your local network, or integrate with your local setup and have static IP addresses assigned to it.\n\nWhen Magic WAN Connector acts like the WAN router for your site, deployment will be something like this:",
      "language": "unknown"
    },
    {
      "code": "In the example below, the Magic WAN Connector device sits behind the WAN router in your site, and on-ramps only some of the existing LANs to Cloudflare.",
      "language": "unknown"
    },
    {
      "code": "Refer to [Magic WAN Connector deployment options](https://developers.cloudflare.com/reference-architecture/diagrams/sase/magic-wan-connector-deployment/) for a high-level explanation of the deployment options that make sense to most environments, as well as a few advanced use cases.\n\n#### Firewall settings required\n\nIf there is a firewall deployed upstream of Magic WAN Connector, configure the firewall to allow the following traffic:\n\n| Protocol/port | Destination IP/URL | Purpose |\n| - | - | - |\n| `UDP/53` | DNS destination IP `1.1.1.1` | Needed to allow DNS traffic to Cloudflare DNS servers. Cloudflare uses this port for DNS lookups of control plane API. |\n| `TCP/443` | - | Magic WAN Connector will open outbound HTTPS connections over this port for control plane operations. |\n| `UDP/4500` | Destination IP `162.159.64.1` | Needed for Magic WAN Connector initialization and discovery through outbound connections. |\n| `UDP/4500` | Destination IP - Cloudflare anycast IPs | Needed for the Cloudflare anycast IPs assigned to your account for tunnel outbound connections. This traffic is tunnel traffic. |\n| `TCP/7844`, `UDP/7844` | Outbound connections | Used to support debugging features in Magic WAN Connector. |\n| `UDP/123` | `http://time.cloudflare.com/` | Needed for Magic WAN Connector to periodically contact Cloudflare's Time Services. |\n\n## Activate appliance\n\nThe Connector is shipped to you deactivated, and will only establish a connection to the Cloudflare network when it is activated. Cloudflare recommends leaving it deactivated until you finish [setting it up in the dashboard](#set-up-cloudflare-dashboard).\n\nWhen Magic WAN Connector is first activated, you need to have Internet connection. If you chose to set up your Magic WAN Connector with DHCP you will need to have one of the Magic WAN Connector ports connected to the Internet through a device that supports DHCP. This is required so that the Magic WAN Connector can reach the Cloudflare global network and download the required configurations that you [set up](#set-up-cloudflare-dashboard).\n\nIf you set up your Magic WAN Connector with a static IP through the bootstrap method, you do not need a DHCP port. Refer to [DHCP vs static IP connections](#decide-on-dhcp-vs-static-ip-connections) for more information.\n\nWarning\n\nRemember that if you chose the DHCP method you have to connect Magic WAN Connector through a route that supports DHCP for its first connection to the Internet. Otherwise, Magic WAN Connector will not work.\n\nWhen you are ready to connect your Magic WAN Connector to the Cloudflare network:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances**.\n3. Find the Magic WAN Connector you want to activate, select the three dots next to it > **Edit**. Make sure you verify the serial number to choose the right Magic WAN Connector you want to activate.\n4. In the new window, the **Status** dropdown will show as **Deactivated**. Select it to change the status to **Activated**.\n5. The **Interrupt window** is the time period when the Magic WAN Connector software can update, which may result in interruption to existing connections. Choose a time period to minimize disruption to your sites. Refer to [Interrupt window](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/interrupt-service-window/) for more details on how to define when the Magic WAN Connector can update its systems.\n6. Select **Update**.\n\n***\n\n## WAN with a static IP address\n\nAfter activating your device, you can use it in a network configuration with the WAN interface set to a static IP address  that is, an Internet configuration that is not automatically set by DHCP. To use your Magic WAN Connector on a network configuration with a static IP, follow the steps below.\n\nWarning\n\nMake sure you complete the setup workflow and activate your Magic WAN Connector before changing the WAN settings to a static IP.\n\n1. Connect Magic WAN Connector to a DHCP port with access to the Internet.\n2. [Create a new profile](#create-a-new-profile) in the Cloudflare dashboard.\n3. Create a [DHCP WAN](#create-a-wan).\n4. [Activate](#activate-appliance) and power on your Magic WAN Connector.\n5. Wait 60 seconds.\n6. Make changes to the [WAN settings](#create-a-wan) in the Cloudflare dashboard to a static IP set up.\n7. Wait 60 seconds again.\n8. Magic WAN Connector will go offline. This is normal and expected behavior.\n9. Adjust your physical connections as required to match the static configuration.\n10. Magic WAN Connector comes back online.\n\n## Bootstrap via Serial Console\n\nAdvanced users can locally configure their Magic WAN Connector to work in a static IP configuration. This local method does not require having access to a DHCP Internet connection. However, it does require being comfortable with using tools to access the serial port on Magic WAN Connector as well as using a serial terminal client to access the environment in your Magic WAN Connector.\n\nBelow is a detailed description of how to use the serial port to configure your Magic WAN Connector locally.\n\nNote\n\nThe `reset device` option in your Magic WAN Connector clears most of the configuration that is locally cached, resets the password to the default, and reboots.\n\n### Equipment required\n\nTo access the serial port on Magic WAN Connector you will need the following equipment:\n\n* The Magic WAN Connector device\n* A Phillips-head screwdriver\n* A micro-USB to USB-A cable (there should be one included in the packaging of your Magic WAN Connector device)\n* A computer with an available USB port\n* A serial terminal client\n* Optional: if needed, a USB-A to USB-C converter dongle if your computer requires it\n\n### 1. Access the device's serial port\n\n1. Using the Phillips screwdriver, loosen the screw covering the serial console panel on the back of the Magic WAN Connector and turn the panel out of the way.\n   * Pictures and more instructions can be found on [Dell's Technical Documents](https://www.dell.com/support/kbdoc/en-us/000134440/how-to-access-console-port-of-dell-emc-networking-virtual-edge-platform-1405-series).\n2. Connect your computer to your Magic WAN Connector device using the USB cable.\n\n#### Default password\n\nThe default password for your Magic WAN Connector device is the serial number (also known as a Service Tag for Dell devices), all uppercase followed by an `!` (for example, `A1B2C3D!`)\n\n### 2. Install a serial terminal client\n\nTo access the Magic WAN Connector device environment you need a serial terminal client. Follow the instructions below to install one, based on your operating system.\n\n#### Windows\n\nCloudflare recommends using PuTTY for Windows. Download PuTTY from the [official website](https://www.putty.org/) and then install it.\n\n1. Check the COM port of the USB to UART device in the Windows Device Manager. It should show up as something similar to `Silicon Labs CP210x USB to UART Bridge (COMX)`.\n2. Take note of the value in the parentheses (COMX).\n   * Refer to the [Dell Documentation Page](https://infohub.delltechnologies.com/l/virtual-edge-platform-vep-1405-series-diag-os-and-tools-release-notes/bios-installation-and-configuration) for more details on creating a serial console connection.\n3. Launch PuTTY.\n4. Under **Category**, make sure that **Session** (the first item) is selected.\n5. Under **Connection type**, select **Serial**.\n6. In the **Serial Line**, type in the COM port found in step 2 (for example, `COM1`).\n7. In the **Speed**, enter `115200`.\n8. Select Open on the bottom of the dialog box. A terminal window should pop up.\n9. The screen may need to be manually refreshed when a new device is connected. You can do that by pressing `CTRL + C`.\n\n#### macOS\n\nCloudflare recommends installing Screen for macOS. You can install Screen via `brew install screen`. If you do not have `brew` installed, follow the instructions on [Brew's Official Website](https://brew.sh/) to install it.\n\n1. Open the macOS Terminal.\n2. Run `ls /dev/cu.*` to list the connected serial devices.\n3. The command should return an output similar to `/dev/cu.usbserial-0001`. Copy this output to the clipboard or note this down somewhere else.\n4. Run `sudo screen -adRUS mconn <PATH_FROM_STEP_3> 115200`.\n5. The screen may need to be manually refreshed when a new device is connected. You can do that by pressing `CMD + C`.\n\n#### Linux\n\nCloudflare recommends installing Screen for Linux. You can install Screen via your package manager of choice. For example, for Debian/Ubuntu, install by running `sudo apt update && sudo apt install screen`\n\n1. Open Terminal.\n2. List the connected serial devices by running `ls /dev/serial/by-id/*`.\n3. The command should return an output similar to `/dev/serial/by-id/usb-Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0`. Copy this to the clipboard or note this down.\n4. Run `sudo screen -adRUS mconn <PATH_FROM_STEP_3> 115200`.\n5. The screen may need to be manually refreshed when a new device is connected. You can do that by pressing `CTRL + C`.\n\n### 3. Configure a static IP\n\nThe `reset device` option in your Magic WAN Connector clears most of the configuration that is locally cached, resets the password to the default, and reboots.\n\n1. Log into your Magic WAN Connector device. You will be prompted to change your password if you attempt to log in with the default password.\n2. From the menu, go to **Bootstrap** with the arrow keys and select it with the Enter key.\n3. Select the jack (physical port) you want to configure for the initialization of the connector.\n4. Enter the VLAN tag (if applicable) of the network. Leave it blank if untagged.\n5. Select the `static` option as your network type.\n\nNote\n\nThe main reason to use the bootstrapper is if every network your Magic WAN Connector device is plugged into is either static, behind a VLAN, or both. If you find yourself here and configuring a network with DHCP and no VLAN, you are probably not in the right place. See the section on configuring your Magic WAN Connector [via the dashboard](#set-up-cloudflare-dashboard).\n\n1. Enter the IP address you would like the connector to have in CIDR form (for example, `10.0.0.2/24`).\n2. Enter the IP address of the Internet gateway (this must be in the same subnet as the previous IP address you entered and must not be the same address).\n3. Select **Save** and confirm that you want to use the new settings.\n4. The Magic WAN Connector will download the rest of the settings from Cloudflare. The last heartbeat of the Magic WAN Connector should update once it has made contact with Cloudflare.\n\n***\n\n## About high availability configurations\n\nYou need to deploy two Connectors in your premises before you can set up a site in high availability. When you set up a site in high availability, the WANs and LANs in your Magic WAN Connector have the same configuration but are replicated on two nodes. In case of failure of one of the devices, the other device becomes the active node, taking over the configuration of the LAN gateway IP and allowing traffic to continue without disruption.\n\nBecause Magic WAN Connectors in high availability configurations share a single site, you need to set up:\n\n* **Static address**: The IP for the primary node in your site.\n* **Secondary static address**: The IP for the secondary node in your site.\n* **Virtual static address**: The IP that the LAN south of the Magic WAN Connector device will forward traffic to, which is the LAN's gateway IP.\n\nMake sure all IPs are part of the same subnet.\n\nFor detailed information about the expected behavior of high availability configurations, refer to the [High availability configurations](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/#high-availability-configurations) reference page.\n\n### Create a high availability configuration\n\nYou cannot enable high availability for an existing site. To add high availability to an existing site in the Cloudflare dashboard, you need to delete the site and start again.\n\nTo set up a high availability configuration:\n\n1. Follow the steps in [Create a new profile](#create-a-new-profile) up until step 4.\n\n1) After naming your site, select **Turn on high availability**.\n2) Select **Create and continue**.\n3) Select **Add appliance**.\n4) From the list, choose your first Magic WAN Connector > **Add appliance**.\n5) Back on the previous screen, select **Add secondary appliance**.\n6) From the list, choose your second Magic WAN Connector > **Add appliance**.\n7) Select **Continue** to create a WAN. If you are configuring a static IP, configure the IP for the primary node as the static address, and the IP for the secondary node as the secondary static address.\n8) To create a LAN, follow the steps mentioned above in [Create a LAN](#create-a-lan) up until step 4.\n9) In **Static address**, enter the IP for the primary node in your site. For example, `192.168.10.1/24`.\n10) In **Secondary static address**, enter the IP for the secondary node in your site. For example, `192.168.10.2/24`.\n11) In **Virtual static address**, enter the IP that the LAN south of the Magic WAN Connector device will forward traffic to. For example, `192.168.10.3/24`.\n12) Select **Save**.\n13) From the **High availability probing link** drop-down menu, select the port that should be used to monitor the node's health. Cloudflare recommends you choose a reliable interface as the HA probing link. The primary and secondary node's probing link should be connected over a switch, and cannot be a direct connection.\n14) Follow the instructions in [Set up your Magic WAN Connector](#set-up-your-magic-wan-connector) and [Activate appliance](#activate-appliance) to finish setting up your Connectors.\n\n***\n\n## IPsec tunnels and static routes\n\nMagic WAN Connector automatically creates [IPsec tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/gre-ipsec-tunnels/#ipsec-tunnels) and [static routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/) for you. You cannot configure these manually.\n\nTo check the IPsec tunnels and static routes created by your Magic WAN Connector:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Insights** > **Network visibility**.\n\n1) Select the name of the site for which you want to check the Magic WAN Connector's IPsec tunnels and static routes, and select **Edit**.\n2) Select **Tunnels** to check IPsec tunnels, and **Routes** for the static routes.\n\n***\n\n## Next steps\n\n* [Network options](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/)\n* [Maintenance](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/)\n* [Reference information](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/)\n* [Troubleshooting](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/troubleshooting/)\n\n</page>\n\n<page>\n---\ntitle: Configure Virtual Connector  Cloudflare One docs\ndescription: Learn how to configure Magic WAN Virtual Connector on VMWare ESXi\n  or Proxmox Virtual Environment\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/index.md\n---\n\nVirtual Connector is a virtual device alternative to the hardware based Magic WAN Connector. These two versions of Magic WAN Connector are identical otherwise.\n\nCurrently, you can set up Virtual Connector on VMWare ESXi and Proxmox Virtual Environment. Support for Proxmox is in beta.\n\nIn this page you will find instructions on how to configure Magic WAN Connector. This guide provides a step-by-step guide for Magic WAN Connector initial setup. You can either return here after setting up your Magic WAN Connector, or refer to the [Maintenance](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/) section where you will find instructions on how to update your settings.\n\n## Prerequisites\n\nBefore you can install Virtual Connector, you need an Enterprise account with Magic WAN. Additionally, you need to have a VMware or Proxmox host with sufficient compute, memory, and storage to run the virtual machine with Virtual Connector. This includes:\n\n* Intel x86 CPU architecture\n* ESXi hypervisor 7.0U1 or higher\n* 4 virtual CPUs per virtual connector (We recommend deployment with a 1:1 virtual CPU to physical core allocation to avoid CPU over contention which will cause packet loss.)\n* 8 GB of RAM per virtual connector\n* 8 GB of disk per virtual connector\n* One vSwitch port group or VLAN with access to the Internet (for example, through a WAN)\n* One or more vSwitch port group or VLAN that will be the internal LAN\n\nIf you are installing Virtual Connector on ESXi, refer to [VMware's documentation](https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.esxi.install.doc/GUID-B2F01BF5-078A-4C7E-B505-5DFFED0B8C38.html) for more information on how to install ESXi and configure a virtual machine.\n\nIf you are installing Virtual Connector on Virtual Environment, refer to [Proxmox documentation](https://www.proxmox.com/en/products/proxmox-virtual-environment/get-started) for more information on how to install Virtual environment and configure a virtual machine.\n\n***\n\n## Before you begin\n\nThere are a couple of decisions you need to make when installing your Virtual Connector. Refer to the topics below for more information.\n\n### Determine the need for a high availability configuration\n\nYou can install up to two instances of Virtual Connector for redundancy at each of your sites. If one of your devices fails, traffic will fail over to the other, ensuring that you never lose connectivity to that site.\n\nIn this type of high availability (HA) configuration, you will choose a reliable LAN interface as the HA link which will be used to monitor the health of the peer connector. HA links can be dedicated links or can be shared with other LAN traffic.\n\nYou must decide the type of configuration you want for your site from the beginning: no redundancy or with redundancy. You cannot add redundancy after finishing the configuration of your dashboard settings. If, at a later stage, you decide to enable redundancy, you will need to delete your Virtual Connector device in the Cloudflare dashboard, and start again.\n\nDo you need a high availability configuration?\n\n* If you need a high availability configuration for your premises, refer to [About high availability configurations](#about-high-availability-configurations) for more information and learn how to configure your Virtual Connector device in this mode.\n\n* If you do not need a high availability configuration for you premises, check if you need a [DHCP or a static IP setup](#decide-on-dhcp-vs-static-ip-connections) before proceeding to [Set up Cloudflare dashboard](#set-up-cloudflare-dashboard).\n\nWarning\n\nYou cannot enable high availability for an existing Virtual Connector on-ramp. To add high availability to an existing Virtual Connector on-ramp in the Cloudflare dashboard, you need to delete the on-ramp and start again. Plan accordingly to create a high availability configuration from the start if needed.\n\n### Decide on DHCP vs static IP connections\n\nVirtual Connector uses a DHCP connection at first boot to download your settings and go through the activation process. However, if you need to use a static IP in your Virtual Connector, and this is a fresh install:\n\n1. Connect the machine with your Virtual Connector VM to a DHCP port with access to the Internet.\n2. Go through the [setup flow](#set-up-cloudflare-dashboard) below and activate your Virtual Connector device.\n3. Refer to [WAN with a static IP address](#wan-with-a-static-ip-address).\n\n***\n\n## Configure a virtual machine\n\nSelect the appropriate tab below to learn how to configure Virtual Connector on VMWare ESXi or Proxmox Virtual Environment.\n\n* VMWare ESXi\n\n  **1. Obtain the VMWare image**\n\n  Contact your account team at Cloudflare to obtain the Virtual Connector OVA package and license keys. The OVA image includes the files required to install and configure the virtual machine (VM) for Virtual Connector with the appropriate settings. Refer to [VMWare VMs documentation](https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.vm_admin.doc/GUID-AE61948B-C2EE-436E-BAFB-3C7209088552.html) for more information on this topic.\n\n  This image can be deployed multiple times to create several instances of a Virtual Connector, in different locations or on the same ESXi host.\n\n  You will consume one license key for each instance created. For example, if you want to deploy 10 Virtual Connectors you should request 10 license keys, and your account team will create 10 Virtual Connector instances in your Cloudflare dashboard.\n\n  **2. Deploy the Virtual Connector on VMware**\n\n  The following instructions assume you already have VMware ESXi hypervisor installed with sufficient resources. Refer to [Prerequisites](#prerequisites) for more information.\n\n  1. When setting up your VMware ESXi, you need to create port groups for Virtual Connector. Go to **Networking** > **Port groups**, and prepare your vSwitch port groups and/or VLANs for your desired network topology. For example, a simple deployment typically has:\n\n     * A WAN port group where the Virtual Connector will get an IP address (static or DHCP) that has access to the Internet.\n     * A LAN port group, where the Virtual Connector will act as default router, and possibly DHCP server.\n     * A null, or unused, port group for allocating unused virtual interfaces in the Virtual Connector. You can, for example, create a null port group with the name of `Null port group`, and a **VLAN ID** of `999`.\n\n  VLAN tagging\n\n  Virtual Connector supports creating subinterfaces through the use of [802.1Q VLAN tagging](https://en.wikipedia.org/wiki/IEEE_802.1Q).\n\n  Use VLAN ID `0` when:\n\n  * Connected to a Port Group or Distributed Port Group that is associated with a specific VLAN.\n  * Connected to a Port Group or Distributed Port Group that is configured as a trunk that requires untagged packets.\n\n  You can also configure subinterfaces on the Virtual Connector by associating the network interface with a Port Group or Distributed Port Group trunk and specifying a VLAN ID in addition to the port associated with the network interface (VLAN ID `1`-`4094`).\n\n  Refer to [VMware's documentation](https://kb.vmware.com/s/article/1003825) for more information.\n\n  1. Extract the files in the OVA image provided by your Cloudflare account team. For example:",
      "language": "unknown"
    },
    {
      "code": "Take note of the folder where you are extracting the files to, as you will need to refer to that folder when creating the VM.\n\n  1. Go to **Virtual Machines** > **Create/Register VM** wizard to start deploying the Virtual Connector.\n\n  2. Select **Deploy a virtual machine from an OVF or OVA file** > **Next**.\n\n  3. Choose a descriptive name for your virtual machine.\n\n  4. Upload the files you have extracted from the OVA image. These include `mconn.ovf`, `mconn.nvram`, and `mconn.vmdk`.\n\n  5. Select where you want to save the files extracted from the OVA image > **Next**.\n\n  6. In **Networking mappings**, select assignments for your desired topology according to the port groups you set up previously:\n\n     1. For example, map `eno1` port to `VM Network` to create your WAN, and `eno2` to `LAN0` to act as your LAN port.\n     2. Allocate any unused ports to the `null` port group.\n     3. Take note of your configuration. You will need this information to configure your network in the Cloudflare dashboard.\n\n  7. In **Disk provisioning**, select **Thin**.\n\n  8. Before completing the deployment wizard, disable **Power on automatically**. This is important so that you can configure the license key prior to boot.\n\n  9. Configure the virtual machine with the license key your account team provided you:\n\n     1. Select the Virtual Connector's VM > **Settings**.\n\n     2. Go to **VM Options** > **Advanced** > **Edit Configuration**.\n\n     3. Select **Add parameter** to add your license key. Scroll down to the last entry (this is where VMware adds the new parameter), and add the following two new entries:\n\n        * **Key**: `guestinfo.cloudflare.identity`\n        * **Value** `<YOUR_LICENSE_KEY>`\n\n  Note\n\n  You cannot use the same license key twice, or reuse a key once the virtual machine has been registered with Cloudflare. You need a new key from your account team for every new Virtual Connector.\n\n  1. Select **Save** to finish configuring your Virtual Connector.\n  2. Continue setup in your [Cloudflare dashboard.](#set-up-cloudflare-dashboard)\n\n* Proxmox Virtual Environment (beta)\n\n  **1. Obtain the Virtual Connector script**\n\n  Contact your account team at Cloudflare to obtain your license keys and the Virtual Connector script for Proxmox. The script will set up and configure a Proxmox virtual machine with the appropriate settings for Virtual Connector. Refer to [Prerequisites](#prerequisites) for more information on system requirements.\n\n  The script can be deployed multiple times to create several instances of a Virtual Connector, in different locations or on the same Proxmox host. You will consume one license key for each instance created. For example, if you want to deploy 10 Virtual Connectors you should request 10 license keys, and your account team will create 10 Virtual Connector instances in your Cloudflare dashboard.\n\n  **2. Deploy the Virtual Connector on Proxmox**\n\n  The following instructions assume you already have Proxmox Virtual Environment installed with sufficient resources. Refer to [Prerequisites](#prerequisites) for more information.\n\n  1. In the terminal prompt of your Proxmox server, load the script provided by your account team. For example: `bash YOUR_SCRIPT`. You need elevated privileges to run the script.\n  2. You will be prompted to create a new Virtual Connector. Select **yes** to proceed.\n  3. Set up your Virtual Connector name.\n  4. Enter your license key.\n\n  Note\n\n  You cannot use the same license key twice, or reuse a key once the virtual machine has been registered with Cloudflare. You need a new key from your account team for every new Virtual Connector.\n\n  1. Select the network interface card (NIC) you want to use with Virtual Connector.\n  2. Select the network bridge that corresponds to the physical network interface card (NIC) on your host machine. This bridge allows the network adapter in the virtual machine to communicate through the NIC in the host, as if it were directly connected to the physical network.\n  3. (Optional) Configure your VLAN setting if needed.\n\n  VLAN tagging\n\n  Virtual Connector supports creating subinterfaces through the use of [802.1Q VLAN tagging](https://en.wikipedia.org/wiki/IEEE_802.1Q).\n\n  Use VLAN ID `0` when:\n\n  * Connected to a Port Group or Distributed Port Group that is associated with a specific VLAN.\n  * Connected to a Port Group or Distributed Port Group that is configured as a trunk that requires untagged packets.\n\n  You can also configure subinterfaces on the Virtual Connector by associating the network interface with a Port Group or Distributed Port Group trunk and specifying a VLAN ID in addition to the port associated with the network interface (VLAN ID `1`-`4094`).\n\n  Refer to [Proxmox documentation](https://www.proxmox.com/en/products/proxmox-virtual-environment/get-started) for more information.\n\n  1. Finish your configuration.\n  2. The script will apply your settings and configure the virtual machine template for Virtual Connector.\n  3. In the **Hardware settings** for the new VM, make sure the hardware settings match the minimum requirements for running Virtual Connector. Make changes to the RAM and CPU if needed.\n  4. Continue setup in your [Cloudflare dashboard](#set-up-cloudflare-dashboard).\n\n***\n\n## Set up Cloudflare dashboard\n\n### Create a new profile\n\nYou need to create a profile for your appliance before connecting it to the Internet.\n\nTo create a profile:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances**.\n3. Select **Create a profile**.\n\n1) In **Name**, enter a descriptive name for your Virtual Connector. Optionally, you can also add a description for it.\n\n2) You need to decide if you want to turn on high availability for the Virtual Connector. Refer to [About high availability configurations](#about-high-availability-configurations) for more information.\n\n3) Select **Create and continue**.\n\n4) Select **Add appliance**. This will show you a list of devices associated with your account. For a Virtual Connector to show up you need to:\n\n   * **VMWare:** Have already obtained your OVA package and license keys if you are installing on VMWare.\n   * **Proxmox:** Have already obtained your Virtual Connector Script and license keys if you are installing on Proxmox.\n\n   For more information, refer to [Configure a virtual machine](#configure-a-virtual-machine) and select the appropriate tab.\n\n5) If you have more than one Virtual Connector, choose the one that corresponds to the on-ramp you are creating. Virtual Connector devices are identified by a serial number, also known as a service tag. Use this information to choose the right Virtual Connector.\\\n   Select **Add Connector** when you are ready to proceed.\n\n6) Virtual Connector will be added to your account with an **Interrupt window** defined. The interrupt window is the time period when the Virtual Connector software can update, which may result in interruption to existing connections. You can change this later. Refer to [Interrupt window](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/interrupt-service-window/) for more details on how to define when the Virtual Connector can update its systems.\n\n7) Select **Continue** to proceed to creating your WAN and LAN networks.\n\n### Create a WAN\n\n* Dashboard\n\n  When you have more than one anycast IP configured in your account (set up during your Magic WAN onboarding), Virtual Connector will automatically create at most two tunnels per WAN port. This improves reliability and performance, and requires no additional configuration on your part.\n\n  1. In **WAN configuration**, select **Create**. You can create one or more [wide area networks (WANs)](https://www.cloudflare.com/learning/network-layer/what-is-a-wan/). Configuring multiple WANs will create multiple IPsec tunnels (one IPsec tunnel per WAN port). This allows Virtual Connector to load balance traffic over WANs of equal priority. It also allows Virtual Connector to failover between circuits according to their [health](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/). Refer to [WAN settings](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/#wan-settings) for more details.\n\n     Note\n\n     This is not the same as a high availability (HA) configuration. HA configurations need two Virtual Connector devices to work. Refer to [About high availability configurations](#about-high-availability-configurations) for more information.\n\n  2. In **Interface name**, enter a descriptive name for your WAN.\n\n  3. **Interface number** needs to correspond to the virtual network interface on the Virtual Connector instance you have set up in VMware. Following our example from the previous steps, you need to choose port `1` since that is what corresponds to the `eno1` port we set up in VMware.\n\n  4. In **VLAN ID**, enter a number between `0` and `4094` to specify a [VLAN ID](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/#vlan-id).\n\n  5. In **Priority**, choose the priority for your WAN. Lower numbers have higher priority. Refer to [Traffic steering](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/) to learn more about how Cloudflare calculates priorities.\n\n  6. In **Health check rate** configure the health check frequency for your site. Options are `low`, `mid`, and `high`. Refer to [Update tunnel health checks frequency](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/update-tunnel-health-checks-frequency/) for more information.\n\n  7. **Addressing**: Select **DHCP**. This is needed the first time you set up your Virtual Connector to successfully download all settings to the machine and activate it. If you need a static IP address in your network environment:\n\n     1. Continue the set up flow below to activate your Virtual Connector.\n     2. Refer to [WAN with a static IP address](#wan-with-a-static-ip-address). If you choose a static IP, you also need to specify the static IP and gateway addresses.\n\n  8. Select **Save** when you are finished.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Make a `POST` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/wans/methods/create/) to create a WAN.\n\n  The `static_addressing` object is optional. Omit it if you are using DHCP. If you are using static addressing, add the `secondary_address` parameter when your site is in high availability (HA) mode.\n\n  Example:",
      "language": "unknown"
    },
    {
      "code": "### Create a LAN\n\n* Dashboard\n\n  1. In **LAN configuration**, select **Create**.\n\n  2. Enter a descriptive name for your LAN in **Interface name**.\n\n  3. **Interface number** needs to correspond to the virtual LAN interface on the Virtual Connector instance you have set up in VMware. Following our example from the previous steps, you need to choose port `2` since that is what corresponds to the `eno2` port we set up in VMware.\n\n  4. In **VLAN ID**, specify a [VLAN ID](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/#vlan-id) to create virtual LANs.\n\n  5. In **Static addressing** > **Static address** give your Virtual Connector's LAN interface its IP address. You can also enable the following options if they suit your use case:\n\n     * **This is a DHCP server**: If your Virtual Connector is a [DHCP server](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-server/).\n     * **This is a DHCP relay**: If your Virtual Connector is a [DHCP relay](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-relay/).\n\n  6. (Optional) In **Directly attached subnet** > **Static NAT prefix**, enter a CIDR prefix to enable NAT (network address translation). The prefix you enter here should be the same size as the prefix entered in **Static addressing**. For example, both networks have a subnet mask of `/24`: `192.168.100.0/24` and `10.10.100.0/24`.\n\n  7. (Optional) If your LAN contains additional subnets behind a layer 3 router, select **Add routed subnet** under **Routed subnets** to add them:\n\n     * **Prefix**: The CIDR prefix for the subnet behind the L3 router.\n     * **Next hop**: The address of the L3 router to which the Virtual Connector should forward packets for this subnet.\n     * **Static NAT prefix**: Optional setting. If you want to enable NAT for a routed subnet, supply an \"external\" prefix for the overlay-facing side of the NAT to use. It must be the same size as **Prefix**.\\\n       Refer to [Routed subnets](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/routed-subnets/) for more information.\n\n  8. Select **Save**.\n\n  9. Select **Done** to finish your configuration. Tunnels and static routes will be automatically created for your Virtual Connector, once it boots up.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Make a `POST` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/lans/methods/create/) to create a LAN.\n\n  Example:",
      "language": "unknown"
    },
    {
      "code": "#### Network segmentation\n\nAfter setting up your LANs, you can configure your Virtual Connector to enable communication between them without traffic leaving your premises. Refer to [Network segmentation](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/network-segmentation/) for more information.\n\n#### DHCP options\n\nVirtual Connector supports different types of DHCP configurations. Virtual Connector can:\n\n* Connect to a DHCP server or use a static IP address instead of connecting to a DHCP server.\n* Act as a [DHCP server](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-server/).\n* Use [DHCP relay](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-relay/) to connect to a DHCP server outside the location your Virtual Connector is in.\n* [Reserve IP addresses](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-static-address-reservation/) for specific devices on your network.\n\n### Add your Virtual Connector to a site\n\nAfter finishing your Virtual Connector configuration, you need to add it to a site.\n\nSites represent the local network of a data center, office, or other physical location, and combine all on-ramps available there. Sites also allow you to check, at a glance, the state of your on-ramps and set up health alert settings so that Cloudflare notifies you when there are issues with the site's on-ramps.\n\nRefer to [Set up a site](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/sites/) for more information.\n\n## Activate appliance\n\nVirtual Connector is deactivated after you install it, and will only establish a connection to the Cloudflare network when it is activated. Cloudflare recommends leaving it deactivated until you finish [setting it up in the dashboard](#set-up-cloudflare-dashboard).\n\nWhen the Virtual Connector is first activated, one of the ports must be connected to the Internet through a device that supports DHCP. This is required so that the Virtual Connector can reach the Cloudflare global network and download the required configurations that you [set up](#set-up-cloudflare-dashboard).\n\nWarning\n\nRemember to connect Virtual Connector through a route that supports DHCP for its first connection to the Internet. Otherwise, Virtual Connector will not work.\n\nWhen you are ready to connect your Virtual Connector to the Cloudflare network:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances**.\n3. Find the Virtual Connector you want to activate, select the three dots next to it > **Edit**. Make sure you verify the serial number to choose the right Virtual Connector you want to activate.\n4. In the new window, the **Status** dropdown will show as **Deactivated**. Select it to change the status to **Activated**.\n5. The **Interrupt window** is the time period when the Virtual Connector software can update, which may result in interruption to existing connections. Choose a time period to minimize disruption to your sites. Refer to [Interrupt window](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/interrupt-service-window/) for more details on how to define when the Virtual Connector can update its systems.\n6. Select **Update**.\n\n## Boot your Virtual Connector\n\n## Default password to access Virtual Connector\n\nYour Virtual Connector's default password is the last seven characters of your license key, all uppercase, plus an `!` (exclamation mark).\n\nFor example, if your license key is `mconn-abcdefghijklmnopqrstuvwxyz`, your default password will be `TUVWXYZ!`.\n\n***\n\n## WAN with a static IP address\n\nAfter activating your device, you can use it in a network configuration with the WAN interface set to a static IP address - that is, an Internet configuration that is not automatically set by DHCP. To use your Virtual Connector on a network configuration with a static IP, follow the steps below.\n\nWarning\n\nMake sure you complete the setup workflow and activate your Virtual Connector before changing the WAN settings to a static IP.\n\n1. Connect the machine where you installed the VM with Virtual Connector to a DHCP port with access to the Internet.\n2. [Create a new profile](#create-a-new-profile) in the Cloudflare dashboard.\n3. Create a [DHCP WAN](#create-a-wan).\n4. [Activate](#activate-appliance) and boot your Virtual Connector.\n5. Wait 60 seconds.\n6. Make changes to the [WAN settings](#create-a-wan) in the Cloudflare dashboard to a static IP set up.\n7. Wait 60 seconds again.\n8. Modify your [Port Groups](#configure-a-virtual-machine) as needed to change the source from which the WAN port obtains its IP address.\n9. Reboot your virtual machine.\n\n***\n\n## About high availability configurations\n\nYou need to install two Virtual Connectors before you can set up a site in high availability. When you set up a site in high availability, the WANs and LANs in your Virtual Connector have the same configuration but are replicated on two nodes. In case of failure of one of the devices, the other device becomes the active node, taking over the configuration of the LAN gateway IP and allowing traffic to continue without disruption.\n\nBecause Virtual Connectors in high availability configurations share a single site, you need to set up:\n\n* **Static address**: The IP for the primary node in your site.\n* **Secondary static address**: The IP for the secondary node in your site.\n* **Virtual static address**: The IP that the LAN south of the Virtual Connector device will forward traffic to, which is the LAN's gateway IP.\n\nMake sure all IPs are part of the same subnet.\n\nFor detailed information about the expected behavior of high availability configurations, refer to the [High availability configurations](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/#high-availability-configurations) reference page.\n\n### Create a high availability configuration\n\nYou cannot enable high availability for an existing site. To add high availability to an existing site in the Cloudflare dashboard, you need to delete the site and start again.\n\nTo set up a high availability configuration:\n\n1. Follow the steps in [Create a new profile](#create-a-new-profile) up until step 4.\n\n1) After naming your site, select **Turn on high availability**.\n2) Select **Create and continue**.\n3) Select **Add appliance**.\n4) From the list, choose your first Virtual Connector > **Add appliance**.\n5) Back on the previous screen, select **Add secondary appliance**.\n6) From the list, choose your second Virtual Connector > **Add appliance**.\n7) Select **Continue** to create a WAN. If you are configuring a static IP, configure the IP for the primary node as the static address, and the IP for the secondary node as the secondary static address.\n8) To create a LAN, follow the steps mentioned above in [Create a LAN](#create-a-lan) up until step 4.\n9) In **Static address**, enter the IP for the primary node in your site. For example, `192.168.10.1/24`.\n10) In **Secondary static address**, enter the IP for the secondary node in your site. For example, `192.168.10.2/24`.\n11) In **Virtual static address**, enter the IP that the LAN south of the Virtual Connector device will forward traffic to. For example, `192.168.10.3/24`.\n12) Select **Save**.\n13) From the **High availability probing link** drop-down menu, select the port that should be used to monitor the node's health. Cloudflare recommends you choose a reliable interface as the HA probing link. The primary and secondary node's probing link should be connected over a switch, and cannot be a direct connection.\n14) Follow the instructions in [Activate appliance](#activate-appliance) to finish setting up your Connectors.\n\n***\n\n## IPsec tunnels and static routes\n\nVirtual Connector automatically creates [IPsec tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/gre-ipsec-tunnels/#ipsec-tunnels) and [static routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/) for you. You cannot configure these manually.\n\nTo check the IPsec tunnels and static routes created by your Virtual Connector:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Insights** > **Network visibility**.\n\n1) Select the name of the site for which you want to check the Virtual Connector's IPsec tunnels and static routes, and select **Edit**.\n2) Select **Tunnels** to check IPsec tunnels, and **Routes** for the static routes.\n\n***\n\n## Next steps\n\n* [Network options](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/)\n* [Maintenance](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/)\n* [Reference information](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/)\n* [Troubleshooting](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/troubleshooting/)\n\n</page>\n\n<page>\n---\ntitle: Device metrics  Cloudflare One docs\ndescription: Cloudflare customers can inspect metrics for a specific Magic WAN\n  Connector in the Cloudflare dashboard. These metrics help you troubleshoot\n  potential issues with your Magic WAN Connector. Refer to Troubleshooting for\n  more information.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/device-metrics/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/device-metrics/index.md\n---\n\nCloudflare customers can inspect metrics for a specific Magic WAN Connector in the Cloudflare dashboard. These metrics help you troubleshoot potential issues with your Magic WAN Connector. Refer to [Troubleshooting](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/troubleshooting/) for more information.\n\n## Query metrics with GraphQL\n\nCustomers can query Cloudflare's GraphQL API to fetch their Magic WAN Connector device metrics. The Cloudflare dashboard displays Magic WAN Connector device metrics over the past one hour. Via the GraphQL API, customers can query for up to 30 days of historical Magic WAN Connector device metrics.\n\nFor example:",
      "language": "unknown"
    },
    {
      "code": "[Run in GraphQL API Explorer](https://graphql.cloudflare.com/explorer?query=I4VwpgTgngBALmANmAtmO0AUAoGMAkAhgMbED2IAdnACqEDmAXDAM4YCWl9uBLlhABxYALMnBYAxdogQRmAQVIVqAWXKVKNJKnTQAyvyGjx8gCaC47AG5gA4hApCpMyAH0AkpQEg4AeQBGAFZgxHAAhDz4fIIiYirK4s6yCkpUcGpkGlrIaBhQBjHG8WksZhbWdg4gTtKyHl4+AcGhEXhRhrG0wpAohIiStZAp5GkZWdq5+h3GNN0Qvf1lApY29o4DLhD13n5BIeGRiOwo7HDMnHAAbAAsEQCUMADePFbsYADukE88eCQj1CxMAAzQZyJ4wP4JOhMAiQtLQmAAXwezzwaNY0zELGYKHUmgmunymPEOHR6JBm2Y7UKWKSkB+ZKOJzOBCZpwZ6LIEFMkAAQlBmABtcwISxoKQ2FScHxgFiuAAiAFE9ABhAC6HJgKM1eF6AA9vmSycRvCqEjq0YgyIRTPIbBAGGAAIwoC261BcqASCBgMD8hAsN0wNAoT00MR9f2yi2Ii2mY5gSgsdiZFiGo1ovH7LnuUxBkXoBMSsBSygywMZpGa2NG6JGOIJbHBvHZHR5Ar19KN0kZinJXjE4oAukQC1sln4ccWrk8iD8oUFsVgYul8sK5XqzXayv69OVwhWQjSQj+ZBRiuV+ARxDnmNxhNJlNJvcZrOhHN5y8wRdFiqrgN3kaNZknWnSzD0fRNrimT4jkhIdmBcwLICFp9kMA40l0EH9COY7HKcVJTpWM58gKMDCoQoq-pK0oBuuqoADQwG+cAfvRm5GtuGa7qil7ECAEA+tQKpIMQ7AgBeQH3mgj6pi+RosR++aUYW4p-rR0aVsB6LaVWeCxoiQA\\&variables=N4IghgxhD2CuB2AXAKmA5iAXCAggYTwHkBVAOWQH0BJAERABoQAbASwFsXEsBGABl4C+QA)\n\n### Average CPU load explained\n\nThe metric `average CPU load` is unique and distinctly different from `CPU utilization` which is another common CPU metric. The Magic WAN Connector uses a [Unix-style CPU load calculation](https://en.wikipedia.org/wiki/Load_\\(computing\\)).\n\nCPU load is a measure of the number of processes that are currently running and that are waiting to be run on the CPU. Cloudflare collects the one minute load average from the device and converts that into a percentage based on the total number of cores in the CPU. If the Magic WAN Connector CPU has eight cores, and a one minute load average of two, then the average CPU load is 25%. If the average CPU load is above 100%, then there are processes in the queue that are waiting to be executed on the CPU.\n\nCloudflare is still evaluating the typical CPU load operating range on the Magic WAN Connector. In general, a healthy range for average CPU load on any device is between 30% and 70%. Customers may experience decreased Magic WAN Connector performance if the average CPU load is consistently above 100%.\n\n</page>\n\n<page>\n---\ntitle: Network options  Cloudflare One docs\nlastUpdated: 2025-10-27T11:06:15.000Z\nchatbotDeprioritize: true\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/index.md\n---\n\n* [Application-aware policies](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/)\n* [DHCP options](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/)\n* [Enable NAT for a subnet](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/nat-subnet/)\n* [Network segmentation](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/network-segmentation/)\n* [Routed subnets](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/routed-subnets/)\n\n</page>\n\n<page>\n---\ntitle: Maintenance  Cloudflare One docs\nlastUpdated: 2025-10-27T11:06:15.000Z\nchatbotDeprioritize: true\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/index.md\n---\n\n* [Register a hardware Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/register-appliance/)\n* [Activate Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/activate-connector/)\n* [Edit basic information](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-basic-info/)\n* [Add or remove connectors](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/add-remove-connectors/)\n* [Edit network settings](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-network-settings/)\n* [Edit traffic steering settings](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-traffic-steering-settings/)\n* [Edit sites](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-sites/)\n* [Deactivate Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/deactivate-connector/)\n* [Default password](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/default-password/)\n* [Heartbeat](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/heartbeat/)\n* [Interrupt window](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/interrupt-service-window/)\n\n</page>\n\n<page>\n---\ntitle: Reference  Cloudflare One docs\ndescription: The Magic WAN Connector software is certified for use on the Dell\n  Networking Virtual Edge Platform. It can be purchased with software\n  pre-installed through our partner network for plug-and-play connectivity to\n  Cloudflare One.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/reference/index.md\n---\n\nThe Magic WAN Connector software is certified for use on the [Dell Networking Virtual Edge Platform](https://www.dell.com/support/home/en-us/product-support/product/dell-emc-networking-vep1445-vep1485/docs). It can be purchased with software pre-installed through our partner network for plug-and-play connectivity to Cloudflare One.\n\n## Security and other information\n\n* Cloudflare ensures the Magic WAN Connector device is secure and is not altered via TPM/Secure boot (does not apply to Virtual Connector).\n* Connectivity to the Cloudflare global network is secure and all traffic is encrypted through IPsec tunneling. The Magic WAN Connector uses ESP-in-UDP with GCM-AES-256 encryption. Cloudflare uses a non-IKE keying protocol built into our control plane, secured with TLS.\n* The Magic WAN Connector does not support fail open.\n* Customers have the ability to layer on additional security features/policies that are enforced at the Cloudflare network.\n\n***\n\n## ICMP traffic\n\nICMP traffic is routed through the Internet and bypasses [Cloudflare Gateway](https://developers.cloudflare.com/cloudflare-one/traffic-policies/). This enables you to ping resources on the Internet from the Magic WAN Connector directly, which can be useful for debugging.\n\n***\n\n## VLAN ID\n\nThis feature allows you to have multiple [virtual LANs](https://www.cloudflare.com/learning/network-layer/what-is-a-lan/) (VLANs) configured over the same physical port on your Magic WAN Connector. VLAN tagging adds an extra header to [packets](https://www.cloudflare.com/learning/network-layer/what-is-a-packet/) in order to identify which VLAN the packet belongs to and to route it appropriately. This effectively allows you to run multiple networks over the same physical port.\n\nA non-zero value set up for the VLAN ID field in your WAN/LAN is used to handle VLAN-tagged traffic. Cloudflare uses the VLAN ID to handle traffic coming into your Magic WAN Connector device, and applies a VLAN tag with the configured VLAN ID for traffic going out of your Magic WAN Connector through WAN/LAN.\n\nYou can setup VLAN IDs both for WAN and LAN. Refer to [Configure hardware Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/) or [Configure Virtual Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/) to learn where you can set up VLAN IDs.\n\n## High availability configurations\n\n### Terminology\n\n* **Primary/Secondary**: Used to identify the two nodes which are part of a high availability (HA) configuration pair of Magic WAN Connectors. This identity allows the node to identify which configuration is attributed to it  for example, specifying a primary and secondary IP in a LAN configuration. This identity is configured by the user on the Cloudflare dashboard.\n* **Active/Standby**: These are states that the two nodes in a HA pair will dynamically assume based on an election process. Only one node at any time is expected to be active.\n\n### High availability\n\nA site set up in high availability (HA) mode has two Magic WAN Connectors with the same configuration but replicated in two nodes. In case of failure of one Magic WAN Connector, the other Magic WAN Connector becomes the active node, taking over configuration of the LAN gateway IP and allowing traffic to continue without disruption.\n\n### Active/Standby Election\n\nDuring the LAN configuration, one of the LAN links is configured as a HA link, which is used to exchange heartbeats, resulting in the active / standby election of nodes.\n\nThe state election uses a `PRIORITY` parameter where the node with the higher priority becomes active and the other assumes the standby state. If the priority is the same, the state machine automatically picks one of the nodes as active.\n\nThe HA pair is configured in non-preemptive mode, meaning that once a node becomes active, it will remain active unless its priority drops below that of the other node.\n\n### Configuration\n\nThe two Magic WAN Connectors of a high availability (HA) pair are part of a single site. You designate the Magic WAN Connector [as primary and secondary](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#create-a-high-availability-configuration) in the Cloudflare dashboard.\n\nNote\n\nThe HA link cannot be connected back-to-back. It has to be connected over a switch. This is because, in a direct connection, if the link is unplugged on one end, the other end also detects a link failure. Since we have configured the system to enter a `FAULT` state when the HA link goes down, the affected node will be unable to function as the active node.\n\n### Failure detection and failover\n\nThe Magic WAN Connector's health can be in one of three states:\n\n* **Good** : All health parameters are good\n\n* **Degraded** : One of the following is true:\n\n  * Health of at least one configured tunnel is `DOWN`\n  * At least one of the LAN links is disconnected (physically unplugged)\n\n* **Down** : If one of the following is true:\n\n  * Health of all tunnels is `DOWN`\n  * All LAN interfaces are disconnected\n  * Magic WAN Connector's software is not healthy\n\nA failover happens when the active node's health declines to a level lower than that of the standby node. For example, from `GOOD` to `DEGRADED`, or from `DEGRADED` to `DOWN`. In the case of a failover where one Magic WAN Connector is acting as a DHCP server, DHCP leases will be synchronized.\n\nWhen a failover occurs, traffic is moved to the new active node. It could take up to 30 seconds for traffic to be fully restored over the new active node.\n\n## WAN settings\n\nThis is where you add and configure your WAN connections. Each configured WAN will create one IPsec tunnel, unless you have more than one anycast IP configured in your account.\n\nWhen you have more than one anycast IP configured in your account (set up during your Magic WAN onboarding), Magic WAN Connector will automatically create at most two tunnels per WAN port. This improves reliability and performance, and requires no additional configuration on your part.\n\nWhen you have multiple WANs you can attribute different priorities to each one. Lower values mean a higher priority. This translates in Magic WAN Connector routing traffic through the higher priority WANs or, more precisely, over the IPsec tunnels established over that interface. On the other hand, if you configure multiple WANs of equal priority, traffic will be distributed over those links through [Equal-Cost Multi-Path (ECMP routing)](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/#equal-cost-multi-path-routing).\n\nCreating several WAN connections also means Magic WAN Connector can failover between circuits according to their health.\n\n### High-capacity use cases\n\nFor high-capacity use cases, multiple tunnels can be established with equal priority. Outgoing traffic is then distributed across all available connections using an [ECMP routing](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/#equal-cost-multi-path-routing) algorithm, which balances the load base.\n\n### Configure multiple tunnels in the same WAN profile\n\nIf you do not have more than one anycast IP configured in your account, and you need to configure multiple tunnels for the same WAN profile, [set up multiple WAN connections](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#create-a-wan). Each WAN is assigned one IPsec tunnel.\n\n### WAN settings\n\n* **Interface number:** When using the hardware version of Magic WAN Connector, this refers to the Ethernet port that you are using for your WAN. If you need a throughput higher than 1 Gbps, you can use one of the SFP+ ports. Refer to [SFP+ port information](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/sfp-port-information/) for more information on the hardware supported.\\\n  If you are using Virtual Connector, this needs to correspond to the virtual network interface on the Virtual Connector instance you have set up in your virtual machine.\n* **VLAN ID**: Allows you to have multiple virtual WANs configured over the same port on your Magic WAN Connector. Refer to [VLAN ID](#vlan-id) for more information.\n* **Priority**: Assigns a priority to the WAN interface. Lower numbers have higher priority. Refer to [Traffic steering](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/) to learn more about how Cloudflare calculates priorities.\n* **Health check rate:** Configures the health check frequency for your WAN. Options are low, mid, and high. Refer to [Update tunnel health checks frequency](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/update-tunnel-health-checks-frequency/) for more information.\n* **Addressing:** Configures the Magic WAN Connector to work in a DHCP or static IP environment.\n\n## LAN settings\n\n* **Interface number:** When using the hardware version of Magic WAN Connector, this refers to the Ethernet port that you are using for your LAN. If you need a throughput higher than 1 Gbps, you can use one of the SFP+ ports. Refer to [SFP+ port information](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/sfp-port-information/) for more information on the hardware supported.\\\n  If you are using the Virtual Connector, this needs to correspond to the virtual LAN interface on the Virtual Connector instance you have set up in your virtual machine.\n* **VLAN ID**: Allows you to have multiple virtual LANs configured over the same port on your Magic WAN Connector. Refer to [VLAN ID](#vlan-id) for more information.\n* **Static addressing:** Configures the type of IP addressing for your Connector. Depending on your use case, this is where you configure your LAN interface IP address, or enable DHCP server or DHCP relay. Refer to [DHCP options](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/) to learn more.\n* **Static NAT prefix**: Enable NAT (network address translation). This is an optional setting.\n* **Routed subnets:** Configures additional subnets behind a layer 3 router. Refer to [Routed subnets](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/routed-subnets/) for more information.\n\n### Restrict traffic to your premises\n\nDepending on your use case, you can define policies in your Magic WAN Connector to either allow traffic to flow between your LANs without it leaving your local premises or to forward it via the Cloudflare network where you can add additional security features. The default behavior is to drop all LAN-to-LAN traffic. These policies can be created for specific subnets, and link two LANs.\n\nRefer to [Network segmentation](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/network-segmentation/) for more information.\n\n</page>\n\n<page>\n---\ntitle: Troubleshooting  Cloudflare One docs\ndescription: \"Cloudflare customers can inspect metrics for a specific Magic WAN\n  Connector in the Cloudflare dashboard. These metrics help you troubleshoot\n  potential issues with your device. The information spans categories such as:\"\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/troubleshooting/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/troubleshooting/index.md\n---\n\n## Device metrics\n\nCloudflare customers can inspect metrics for a specific Magic WAN Connector in the Cloudflare dashboard. These metrics help you troubleshoot potential issues with your device. The information spans categories such as:\n\n* Performance analytics\n* Port analytics\n* Event logs\n* DHCP leasing information\n\nTo find the information above and start troubleshooting your Magic WAN Connector:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks** > **Connectors**.\n2. Go to **Appliances** > **Profiles**.\n3. Select your Connector > **View analytics**.\n\n### Performance analytics\n\nIn Performance analytics you can review your Magic WAN Connector's performance over time including:\n\n* Kernel boot time (how long it has been running and if it is activated or not)\n* Last device snapshot (this also shows the frequency with which your device captures the snapshots that are used in several troubleshooting procedures)\n* CPU temperature\n* CPU load over time\n* Used RAM over time\n\nTo access performance analytics:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks** > **Connectors**.\n2. Go to **Appliances** > **Profiles**.\n3. Select your Connector > **View analytics**.\n\n1) Select **Performance analytics**.\n\n### Port analytics\n\nPort analytics gives you access to information related to the packets sent and received through the ports in your Magic WAN Connector. You can adjust the time range for the information displayed in the dashboard regarding to:\n\n* Rate for packets sent and received\n* Rate for data sent and received\n\nThe dashboard provides this information for all active ports in your Magic WAN Connector. To access port analytics:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks** > **Connectors**.\n2. Go to **Appliances** > **Profiles**.\n3. Select your Connector > **View analytics**.\n\n1) Select **Port analytics**.\n\n### Event logs\n\nUse Event logs to identify general patterns and changes over time. This is useful to find correlations with other data and gather deeper insights into your Magic WAN Connector. The following event logs are available:\n\n* `Init`: Initialized `mcon-agent` process. This process manages Connector.\n* `Leave`: Stopped `mcon-agent` process.\n* `StartAttestation`: Started attestation to verify the integrity of Connector before allowing the device to connect to your account.\n* `FinishAttestationSuccess`: Finished attestation successfully.\n* `FinishAttestationFailure`: Failed attestation.\n* `StartRotateCryptKey`: Started cryptography key rotation.\n* `FinishRotateCryptKeySuccess`: Finished cryptography key rotation.\n* `FinishRotateCryptKeyFailure`: Failed cryptography key rotation.\n* `StartRotatePki`: Started public key infrastructure (PKI) rotation.\n* `FinishRotatePkiSuccess`: Finished PKI rotation.\n* `FinishRotatePkiFailure`: Failed PKI rotation.\n* `StartUpgrade`: Began Connector's operating system upgrade.\n* `FinishUpgradeSuccess`: Finished operating system upgrade.\n* `FinishUpgradeFailure`: Failed operating system upgrade.\n* `Reconcile`: Cloudflare is comparing the system's current state against its desired state.\n* `ConfigureCloudflaredTunnel`: Configured Cloudflare Tunnel to debug device.\n\nTo access event logs:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks** > **Connectors**.\n2. Go to **Appliances** > **Profiles**.\n3. Select your Connector > **View analytics**.\n\n1) Select **Events**.\n2) You can filter results by specific events, and by time.\n\n### DHCP leasing\n\nRefer to the DHCP leasing section to identify DHCP assigned leases and their expiration dates. To access DHCP leasing:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks** > **Connectors**.\n2. Go to **Appliances** > **Profiles**.\n3. Select your Connector > **View analytics**.\n\n1) Select **DHCP leasing**.\n\n## Troubleshooting tips\n\nIf you are experiencing difficulties with your Magic WAN Connector, refer to the following tips to troubleshoot what might be happening.\n\n## I have set up a site, but my Magic WAN Connector is not working\n\nMake sure that you have [activated your Magic WAN Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#activate-connector). Cloudflare ships the Magic WAN Connector deactivated, and the it will only establish a connection to the Cloudflare network when it is activated.\n\n## I have tried to activate Magic WAN Connector, but it is still not working\n\nCheck if your Magic WAN Connector is connected to the Internet via a port that can serve DHCP. This is required the first time a Magic WAN Connector boots up so that it can reach the Cloudflare global network and download the required configurations that you set up in the Site configuration step. Refer to [Activate Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#activate-connector) for more details.\n\nIf you have a firewall deployed upstream of the Magic WAN Connector, [check your firewall settings](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#firewall-settings-required). You might need to configure your firewall to allow traffic in specific ports for the Magic WAN Connector to work properly.\n\n## I can access Magic WAN Connector's health checks, but there is no traffic\n\nIf you have a firewall deployed upstream of the Magic WAN Connector, make sure you review your [firewall settings](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#firewall-settings-required). You might need to configure your firewall to allow traffic in specific ports for the Magic WAN Connector to work properly.\n\n## Devices I have behind Magic WAN Connector cannot connect to the Internet\n\nIf you have other routing appliances behind Magic WAN Connector, make sure you create policy-based routing policies to send traffic from your devices through Magic WAN Connector, instead of these other routing devices.\n\n## How do I know if my device is contacting Cloudflare?\n\nMagic WAN Connector sends a heartbeat periodically to Cloudflare. You can [access the dashboard](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/heartbeat/), and check for the heartbeat status of your Connector device.\n\n## What do I do in the event of hardware issues with Magic WAN Connector?\n\nCloudflare is the single point of contact for any issues related to Magic WAN Connector, including issues with hardware. When required, Cloudflare Support will work with our partner, TD Synnex, to resolve any issues with the physical device.\n\n</page>\n\n<page>\n---\ntitle: How to  Cloudflare One docs\nlastUpdated: 2025-10-27T11:06:15.000Z\nchatbotDeprioritize: true\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/index.md\n---\n\n* [Configure tunnel endpoints](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/)\n* [Configure routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/)\n* [Configure Cloudflare source IPs](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-cloudflare-source-ips/)\n* [Run traceroute](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/traceroute/)\n\n</page>\n\n<page>\n---\ntitle: Third-party integration tutorials  Cloudflare One docs\ndescription: Learn how to integrate Cloudflare Magic WAN with third-party products.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: true\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/index.md\n---\n\n* [Alibaba Cloud VPN Gateway](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/alibaba-cloud/)\n* [Amazon AWS Transit Gateway](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/aws/)\n* [Aruba EdgeConnect Enterprise](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/aruba-edgeconnect/)\n* [Cisco IOS XE](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/cisco-ios-xe/)\n* [Cisco SD-WAN](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/viptela/)\n* [Fortinet](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/fortinet/)\n* [Furukawa Electric FITELnet](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/fitelnet/)\n* [Google Cloud VPN](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/google/)\n* [Juniper Networks SRX Series Firewalls](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/juniper/)\n* [Microsoft Azure](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/azure/)\n* [Oracle Cloud](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/oracle/)\n* [Palo Alto Networks NGFW](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/palo-alto/)\n* [pfSense](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/pfsense/)\n* [SonicWall](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/sonicwall/)\n* [Sophos Firewall](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/sophos-firewall/)\n* [strongSwan](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/strongswan/)\n* [Ubiquiti](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/ubiquiti/)\n* [VyOS](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/vyos/)\n\n</page>\n\n<page>\n---\ntitle: Check tunnel health in the dashboard  Cloudflare One docs\ndescription: The Cloudflare dashboard monitors the health of all anycast tunnels\n  on your account that route traffic from Cloudflare to your origin network.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/check-tunnel-health-dashboard/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/check-tunnel-health-dashboard/index.md\n---\n\nThe Cloudflare dashboard monitors the health of all anycast tunnels on your account that route traffic from Cloudflare to your origin network.\n\nThe dashboard shows the view of tunnel health as measured from each Cloudflare location where your traffic is likely to land. If the tunnels are healthy on your side, you will see the majority of servers reporting an **up** status. It is normal for a subset of these locations to show tunnel status as degraded or unhealthy, since the Internet is not homogeneous and intermediary path issues between Cloudflare and your network can cause interruptions for specific paths.\n\nNote\n\nTo access more than one hour of tunnel health data, you should use the [GraphQL API](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/analytics/query-tunnel-health/).\n\nNot all data centers are relevant to you at all times. You can refer to the **Average ingress traffic (last hour)** column to understand if a given data center is receiving traffic for your network, and if its health status is relevant to you.\n\nTo check for anycast tunnel health:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/) and go to **Insights**.\n\n2. Go to **Network health** > **WAN connector health**.\n\n3. In this screen you can access a list of your tunnels and their current health status. You can also check the amount of health checks passed in the last hour as well as traffic volume for each tunnel.\n\n4. Find the tunnel you want to inspect, select the three dots next to it, and choose:\n\n   * **Create alert**: Opens the [notifications wizard](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/configure-magic-tunnel-health-alerts/) so you can create specific alerts for that tunnel when specific conditions are met.\n   * **Network Analytics**: Opens the Analytics section of the dash, prefiltered with the tunnel you want to inspect.\n\n5. Alternatively, from the list of tunnels, select the tunnel you want to inspect to access details about it.\n\n## Check tunnel health for a specific tunnel\n\nYou can drill down into a specific tunnel to check its health status and other information.\n\n1. Go to **Insights > Network visibility > WAN connector health**.\n2. Find and select the tunnel you want to inspect.\n\nThe next screen shows you detailed information about the tunnel, including:\n\n* Status information\n\n  * Up: More than 80% of health checks pass.\n  * Degraded: More than 40% of health checks pass.\n  * Down: Less than 40% of health checks pass.\n\n* Health checks passed in the last hour\n\n* Traffic volume in the last hour\n\nIf you select the three dots in front of the tunnel you want to inspect, you have access to the following tools:\n\n* Packet captures: Collect [packet level data for your traffic](https://developers.cloudflare.com/magic-firewall/packet-captures/)\n* Network Analytics: Leverage real-time visibility into [network analytics](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/analytics/network-analytics/).\n\nNote\n\nMagic WAN customers with [Customer Metadata Boundary](https://developers.cloudflare.com/data-localization/metadata-boundary/) enabled for the European Union can access GRE, IPsec, and CNI (Cloudflare Network Interconnect) health check and traffic volume data in the Cloudflare dashboard and through the API. This ensures that customers who need to be General Data Protection Regulation (GDPR) compliant can access all Magic WAN features.\n\n## Connectors\n\nMagic WAN Connector also includes a heartbeat function, an additional way of communicating its health status which does not depend on successfully setting up any tunnels. The heartbeat function communicates periodically with Cloudflare through HTTPS and lets Cloudflare know that the Magic WAN Connector in question is connected to the Internet and reachable.\n\nRefer to [Heartbeat](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/heartbeat/) to learn more.\n\n</page>\n\n<page>\n---\ntitle: Configure tunnel health alerts  Cloudflare One docs\ndescription: Use the API to set up and configure tunnel health alerts\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/configure-magic-tunnel-health-alerts/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/configure-magic-tunnel-health-alerts/index.md\n---\n\nYou can configure Magic Tunnel health alerts to receive email, webhook, and PagerDuty notifications when the percentage of successful health checks for a Magic Tunnel drops below the selected [service-level objective (SLO)](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/how-cloudflare-calculates-magic-tunnel-health-alerts/).\n\nMagic Tunnel health alerts monitor the health check success rate of each Magic Tunnel included in the alert that has actively transferred customer traffic (excluding health check traffic) over the past six hours. You can define an SLO threshold for the percentage of health checks that must be successful for each Magic Tunnel. If the number of successful health checks for the Magic Tunnel(s) included in the alert drops below the SLO threshold, an alert fires.\n\n## Alert data\n\nWhen a Magic Tunnel health alert fires, you receive the following data in the email, webhook, and PagerDuty notification:\n\n* Cloudflare account name\n* Cloudflare account ID\n* Alert type\n* Tunnel name\n* Tunnel ID\n* Tunnel status\n* Alert SLO\n* Timestamp\n\n## SLO thresholds\n\nCurrently, there are seven SLO threshold values that you can configure through the Cloudflare dashboard. For a more granular approach, use the [API](#set-up-magic-tunnel-health-alerts).\n\nThe SLO threshold for Magic Tunnel health alerts is the percentage of successful health checks for each Magic Tunnel in the alert:\n\n| Alert Sensitivity Level | SLO threshold |\n| - | - |\n| Minimum | 95.0 |\n| Very low | 96.0 |\n| Low | 97.0 |\n| Medium | 98.0 |\n| High | 99.0 |\n| Very high | 99.5 |\n| Maximum | 99.9 |\n\nThe time it takes to receive alerts depends on the sensitivity level you configure for your SLO thresholds. Higher sensitivity levels notify you faster when a tunnel's health degrades, but they may also trigger alerts for brief or minor disruptions. Lower sensitivity levels reduce the chance of false alarms but may delay notifications for less severe issues.\n\nWhile the underlying detection timing remains consistent across sensitivity levels, the speed of notification depends on how significantly the tunnel's health has dropped and the sensitivity you have chosen. Cloudflare recommends that you [test SLO thresholds](#test-slos) to determine which one better serves your use case.\n\nRefer to [How Cloudflare calculates Magic Tunnel health alerts](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/how-cloudflare-calculates-magic-tunnel-health-alerts/) for more information on this topic.\n\n## Set up Magic Tunnel health alerts\n\n* Dashboard\n\n  1. Go to the **Notifications** page.\n\n     [Go to **Notifications**](https://dash.cloudflare.com/?to=/:account/notifications)\n\n  2. Select **Add**.\n\n  3. From the **Product** drop-down menu, select **Magic WAN**.\n\n  4. Select **Magic Tunnel Health Check Alert** > **Select** to add a notification. You can add alerts by tunnel or by data center (beta).\n\n  Alert by tunnel\n\n  1. Select **Alert by tunnel**.\n  2. Enter a name and description for the notification.\n  3. Add webhooks or an email address for the person who should receive the notification, and select **Next**.\n  4. Select the **Alert Sensitivity Level** threshold from the drop-down menu. The threshold defaults to *Medium (98.0)*. You can choose from options between *Minimum (95.0)* and *Maximum (99.9)*. Refer to [How Cloudflare calculates Magic Tunnel health alerts](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/how-cloudflare-calculates-magic-tunnel-health-alerts/) for more information on this topic.\n  5. From the **Alert interval** drop-down menu, set the minimum amount of time that must pass before Cloudflare sends you a duplicate alert. Options range from five minutes to seven days.\n  6. Enable **Set as default alert for any new tunnels created in the future** if you want the alert sensitivity level you chose to be automatically applied to all new tunnels you create.\n  7. Select **Next**.\n  8. Choose the tunnels you want to receive alerts for. You can search by specific tunnel names, or filter them by type (Generic Routing Encapsulation (GRE), Internet Protocol Security (IPsec), and CNI (Cloudflare Network Interconnect)). Select **Next**.\n  9. Review the details of your alert. If these details are correct, select **Create alert**.\n\n  Alert by data center (beta)\n\n  1. Select **Alert by data center**.\n  2. Enter a name and description for the notification.\n  3. Add webhooks or an email address for the person who should receive the notification, and select **Next**.\n  4. Select the **Alert Sensitivity Level** threshold from the drop-down menu. The threshold defaults to *Medium (98.0)*. You can choose from options between *Minimum (95.0)* and *Maximum (99.9)*. Refer to [How Cloudflare calculates Magic Tunnel health alerts](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/how-cloudflare-calculates-magic-tunnel-health-alerts/) for more information on this topic.\n  5. From the **Alert interval** drop-down menu, set the minimum amount of time that must pass before Cloudflare sends you a duplicate alert. Options range from five minutes to seven days.\n  6. Choose the data centers you want to receive alerts for, and select **Next**.\n  7. Choose the tunnels you want to receive alerts for. You can search by specific tunnel names, or filter them by type (GRE, IPsec, and CNI (Cloudflare Network Interconnect)). Select **Next**.\n  8. Review the details of your alert. If these details are correct, select **Create alert**.\n\n* API\n\n  Note\n\n  Refer to the [documentation for Notifications](https://developers.cloudflare.com/notifications/get-started/) to learn about specific permissions you need to access the service through the Application Programming Interface (API).\n\n  Send a [`POST` request](https://developers.cloudflare.com/api/resources/alerting/subresources/policies/methods/create/) to create a Magic WAN tunnel health alert. You can set tunnel health alerts with any SLO value between `0` and `99.99`.\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Notifications Write`\n  * `Account Settings Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## Test SLOs\n\nTo test whether a specific alert sensitivity level works for your use case:\n\n1. [Create an alert](#set-up-magic-tunnel-health-alerts) with a specific sensitivity level for a tunnel with active traffic within the past six hours. If you are unsure which tunnels to choose, refer to [Network Analytics](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/analytics/network-analytics/) to learn how you can view real-time and historical data about your network.\n2. Disable the tunnel you are testing, so there is 100% [health check failure](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/).\n3. The time it takes for Cloudflare to send you an alert depends on the sensitivity you chose for your alerts.\n\n</page>\n\n<page>\n---\ntitle: Custom IKE ID for IPsec  Cloudflare One docs\ndescription: Magic WAN customers can configure a custom IKE ID for their IPsec\n  tunnels. Customers that are using Magic WAN and a VeloCloud SD-WAN device\n  together should utilize this option to create a high availability\n  configuration.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/custom-ike-id-ipsec/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/custom-ike-id-ipsec/index.md\n---\n\nMagic WAN customers can configure a custom IKE ID for their IPsec tunnels. Customers that are using Magic WAN and a VeloCloud SD-WAN device together should utilize this option to create a high availability configuration.\n\nNote\n\nThis feature is only available via API. There are no configuration options for a custom IKE ID for an IPsec tunnel in the Cloudflare dashboard.\n\nVeloCloud has a high availability mechanism that allows customers to specify one set of IKE parameters (like IKE ID) and multiple remote IPs. Customers create an IKE ID, and then assign the same custom IKE ID to their primary IPsec tunnel and their backup IPsec tunnel. FQDN is the only supported type for custom IKE IDs.\n\nMagic WAN customers can set a custom IKE ID for an IPsec tunnel using the following API call. Customers will need to fill in the appropriate values for `<account_id>`, `<tunnel_id>`, and the FQDN wildcard before running the API call.",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Enable Magic user roles  Cloudflare One docs\ndescription: You can determine which users have, or do not have, configuration\n  edit access for Magic products.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/enable-magic-roles/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/enable-magic-roles/index.md\n---\n\nYou can determine which users have, or do not have, configuration edit access for Magic products, including Magic Transit, Magic WAN, and Magic Firewall.\n\nFor example, if multiple teams manage different Cloudflare products on the same account, you can provide select users with edit access and other users with read-only access.\n\n## Assign permissions\n\n1. Go to the **Members** page.\n\n   [Go to **Members**](https://dash.cloudflare.com/?to=/:account/members)\n\n2. Under **Members**, enter an existing user's name and select **Search**.\n\n3. Expand the menu at the end of the user row.\n\n4. From the list, locate **Network Services (Magic)**.\n\n5. Select one of two options:\n\n   * **Network Services (Magic)** - Enables users to view and edit Magic configurations.\n   * **Network Services (Magic, Read-Only)** - Enables users to view but not modify Magic configurations.\n\n</page>\n\n<page>\n---\ntitle: Set up a site  Cloudflare One docs\ndescription: Sites represent the local network of a data center, office, or\n  other physical location, and combine all on-ramps available there. Sites also\n  allow you to check, at a glance, the state of your on-ramps and set up health\n  alert settings so that you get notified when there are issues with the site's\n  on-ramps.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/sites/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/sites/index.md\n---\n\nSites represent the local network of a data center, office, or other physical location, and combine all on-ramps available there. Sites also allow you to check, at a glance, the state of your on-ramps and set up health alert settings so that you get notified when there are issues with the site's on-ramps.\n\nTo use a site, start by setting up your on-ramps. On-ramps can be:\n\n* [GRE or IPsec tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/)\n* [Magic WAN Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/)\n* Direct [CNI link](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/network-interconnect/)\n\nWhen you are finished setting these up, refer to the steps below to learn how to set up a site.\n\n## Add a site\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/).\n2. Go to **Insights** > **Network visibility**.\n3. In **Network overview**, select **Add site**.\n4. Add a name and description for your new site. Optionally, you can also add the geographical coordinates for your site in **Latitude** and **Longitude**. If you add geographical coordinates, once created your site's location will show in the map.\n5. Select **Create and continue**.\n6. Choose one or more on-ramps for your site from the list. Remember to only choose the on-ramps available to that particular site, as the list might show on-ramps available on other locations.\n7. Select **Continue**.\n8. In **Define alert settings** you set up alerts to notify you when there are issues with your site's on-ramps. If you want to set up alerts later, select **Skip this for now** to complete your setup. Otherwise, continue reading.\n9. In **Magic WAN Health Check Alert** > **Notification name**, enter a name for the site's alert.\n10. Under **Alert settings**, choose how you want to be notified when there is an issue. You can add webhooks as well as email addresses.\n11. In **Alert sensitivity level** define the threshold for Magic Tunnel health alerts to be fired. Refer to [How Cloudflare calculates Magic Tunnel health alerts](https://developers.cloudflare.com/magic-wan/reference/how-cloudflare-calculates-magic-tunnel-health-alerts/) for more information.\n12. Select **Complete setup** to finish setting up your site.\n\nYour site is now set up. If you have other sites you need to set up, repeat the steps above. If you did not set up alerts, we strongly recommend that you do it. Otherwise you will not be notified when there is a problem with one of your on-ramps.\n\n***\n\n## Network overview\n\nAfter adding your sites, the Network visibility section of the dashboard provides a summary of the connectivity status and traffic analytics for all your sites. This is a great place to start if you receive a Magic WAN alert, need to begin the troubleshooting process, or are performing routine monitoring.\n\nNetwork visibility has the following data types available:\n\nGeographic map summary\n\n* [Aggregate Magic WAN site health](#site-health)\n* [Magic WAN availability status for sites](#no-status-available)\n* [Magic WAN site geographic location](#no-location-set)\n\nMagic WAN site data table\n\n* Site Name\n* Site Health\n* Site Tunnel Names\n* Site Tunnel Statuses\n* Site Traffic Sent\n* Site Traffic Received\n\nMagic WAN site data\n\n* Traffic Sent by Tunnel\n* Traffic Received by Tunnel\n\nTo start using network overview:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/).\n2. Go to **Insights** > **Network visibility**.\n\nYou will have access to an overview map with all your active sites, and any alerts for sites that are unhealthy or have no status available to them.\n\nReview the topics below to learn more about the options available to you.\n\n### Network map and traffic overview\n\nThe network map section shows all the sites configured with Magic WAN. At a glance, you can check:\n\n* How many active sites you have\n* Location for sites in a map (if you set up their geographic location)\n* Sites that are healthy or unhealthy\n* Sites that have no status available\n* Sites that have no location set\n\nJust below the map, Traffic overview shows a more granular list of your sites and their status.\n\n#### Site health\n\nSites can be healthy or unhealthy, and Magic WAN uses this information to route traffic. Refer to [Set thresholds for site health](#set-thresholds-for-site-health) to learn more about this topic.\n\n#### No status available\n\nThe status of a site refers to its health. If your sites show a **No status available** message, this means you did not configure your alert settings when creating your site. Refer to [Configure Magic Tunnel health alerts](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/configure-magic-tunnel-health-alerts/) to learn how to create an alert for your site.\n\n#### No location set\n\nThe dashboard shows you the number of sites with no location set, meaning sites for which you did not set up a geographic location. To add a location to a site, find the site you want to add location to, and select **no location set** to edit its location settings. Refer to [Set geographic coordinates](#set-geographic-coordinates) for more information.\n\n### Traffic overview\n\nTraffic overview aggregates all Magic WAN sites configured in your account. Here, you can check at-a-glance information about each site like:\n\n* Site status\n* Traffic sent and received\n\nSelect one of your sites to have access to a more detailed view of its traffic, including traffic by tunnel.\n\n***\n\n## Edit a site\n\n### Add or remove on-ramps\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/).\n2. Go to **Insights** > **Network visibility**.\n3. In **Network overview** > **Traffic overview**, find your site > select the three dots in front of it > **Edit**.\n4. Select **On-ramps**.\n5. Select **Add** to add a new on-ramp.\n6. If you want to remove an on-ramp, select the three dots in front of your on-ramp > **Remove**.\n\n### Set geographic coordinates\n\nIf you add geographic coordinates to your site, it will show up in the Network map. To set up or edit geographic coordinates to an existing site:\n\n1. Go to **Insights** > **Network visibility**.\n2. In **Network overview** > **Traffic overview**, find your site > select the three dots in front of it > **Edit**.\n\n1) In **Basic information**, edit your site's **Latitude** and **Longitude** coordinates.\n2) Select **Save**.\n\n### Set thresholds for site health\n\nWhen you set up an alert for your site, you will be notified when there is an issue with one or more on-ramps. These alerts are sent when the percentage of successful health checks for a Magic WAN on-ramp drops below the selected service-level objective (SLO). Setting health alerts will also show unhealthy tunnels in the Network map and in the Traffic overview sections.\n\nTo set up health alerts:\n\n1. Configure [Magic Tunnel health alerts](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/configure-magic-tunnel-health-alerts/) across all of the Magic Tunnels associated with each Magic WAN site.\n2. After configuring Magic Tunnel health alerts, any Magic WAN site with a Magic Tunnel (on-ramp) that is outside of its SLO threshold will be labeled unhealthy in Network map and Traffic overview.\n\n</page>\n\n<page>\n---\ntitle: Update tunnel health checks frequency  Cloudflare One docs\ndescription: By default, Cloudflare servers send health checks to each GRE,\n  Cloudflare Network Interconnect (CNI), or IPsec tunnel endpoint you configure\n  to receive traffic from Magic WAN.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/update-tunnel-health-checks-frequency/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/update-tunnel-health-checks-frequency/index.md\n---\n\nBy default, Cloudflare servers send [health checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/) to each GRE, Cloudflare Network Interconnect (CNI), or IPsec tunnel endpoint you configure to receive traffic from Magic WAN.\n\nFor Magic WAN Connector, Cloudflare sends health checks to IPsec tunnel endpoints.\n\nYou can configure the health check frequency through the dashboard or [the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/gre_tunnels/methods/update/) to suit your use case. For example, if you are connecting a lower-traffic site that does not need immediate failover and you prefer a lower volume of health check traffic, set the frequency to `low`. On the other hand, if you are connecting a site that is extremely sensitive to any issues and you want proactive failover at the earliest sign of a potential problem, set this to `high`.\n\nAvailable options are `low`, `mid`, and `high`.\n\nTo configure health checks frequency in Magic WAN Connector, refer to [Configure Connector](#configure-connector)\n\n## Manual configuration\n\n* Dashboard\n\n  1. Refer to [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) to learn how to create or edit your tunnel.\n  2. Change the **Health check rate** to your desired rate. For example, *Low*.\n  3. Save your changes.\n\n* API\n\n  You can adjust the health check frequency by updating your [GRE](https://developers.cloudflare.com/api/resources/magic_transit/subresources/gre_tunnels/methods/update/), [IPsec](https://developers.cloudflare.com/api/resources/magic_transit/subresources/ipsec_tunnels/methods/update/), or [CNI](https://developers.cloudflare.com/api/resources/magic_transit/subresources/cf_interconnects/methods/update/) tunnels.\n\n  The following example adjusts tunnel health check frequency to `low`. Note that this command applies to GRE, IPsec and CNI tunnels:",
      "language": "unknown"
    },
    {
      "code": "## Configure Connector\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/) > **Insights**.\n2. In **Network overview**, select your site > **Edit**\n\n1) In **Network** > **WAN configuration** > select your WAN > **Edit**.\n2) Change the **Health check rate** to your desired rate.\n3) Select **Save**.\n\nNote\n\nMagic WAN customers with [Customer Metadata Boundary](https://developers.cloudflare.com/data-localization/metadata-boundary/) enabled for the European Union can access GRE, IPsec, and CNI (Cloudflare Network Interconnect) health check and traffic volume data in the Cloudflare dashboard and through the API. This ensures that customers who need to be General Data Protection Regulation (GDPR) compliant can access all Magic WAN features.\n\n</page>\n\n<page>\n---\ntitle: Local Domain Fallback  Cloudflare One docs\ndescription: By default, Cloudflare Zero Trust excludes common top-level\n  domains, used for local resolution, from being sent to Gateway for processing.\n  These top-level domains are resolved by the local DNS resolver configured for\n  the device on its primary interface.\nlastUpdated: 2025-11-20T23:13:05.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/index.md\n---\n\nBy default, Cloudflare Zero Trust excludes common top-level domains, used for local resolution, from being sent to Gateway for processing. These top-level domains are resolved by the local DNS resolver configured for the device on its primary interface.\n\nYou can add additional domains to the Local Domain Fallback list and specify a DNS server to use in place of the Gateway resolver. The WARP client proxies these requests directly to the configured fallback servers.\n\n## Limitations\n\nLocal Domain Fallback only applies to devices running the WARP client.\n\nBecause DNS requests subject to Local Domain Fallback bypass the Gateway resolver, they are not subject to Gateway DNS policies or DNS logging. If you want to route DNS queries to custom resolvers and apply Gateway filtering, use [resolver policies](https://developers.cloudflare.com/cloudflare-one/traffic-policies/resolver-policies/). If both Local Domain Fallback and resolver policies are configured for the same device, Cloudflare will apply client-side Local Domain Fallback rules first.\n\nLocal Domain Fallback or Gateway Resolver policies?\n\nIf your DNS server can be configured to connect to a Cloudflare on-ramp, Cloudflare recommends using Gateway Resolver policies rather than Local Domain Fallback. Gateway Resolver policies provide more visibility by allowing you to log and review DNS traffic.\n\n### AWS\n\nAvoid configuring your [Local Domain Fallback](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/) or [Resolver Policy](https://developers.cloudflare.com/cloudflare-one/traffic-policies/resolver-policies/) to direct all `*.amazonaws.com` DNS resolution via AWS Route 53 Resolver.\n\nSome AWS endpoints (such as `ssm.us-east-1.amazonaws.com`) are public AWS endpoints that are not resolvable via internal VPC resolution. This can break AWS Console features for users on WARP.\n\nOnly route specific Route 53 zones, or VPC Endpoints (such as `vpce.amazonaws.com`), through the internal VPC resolver.\n\n## Manage local domains\n\n### View domains\n\nTo view the domains subject to Local Domain Fallback:\n\n1. In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Team & Resources** > **Devices** > **Device profiles**.\n2. Locate the [device profile](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/) you would like to view or modify and select **Configure**.\n3. Scroll down to **Local Domain Fallback** and select **Manage**.\n\nOn this page, you will see a list of domains excluded from Gateway. You can [add](#add-a-domain) or [remove](#delete-a-domain) domains from the list at any time.\n\nWarning\n\nLocal Domain Fallback configuration only impacts where DNS requests get resolved, not the flow of traffic destined to those domains. If you want to prevent traffic from being sent to a specific domain or IP address, you must add those domains or IPs to your [Split Tunnel](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/) configuration.\n\nTo view the fallback domains applied to a device, you can:\n\n* In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Team & Resources** > **Devices** > find the target device and the **Last active device profile** > follow the [steps above](#view-domains).\n* (Desktop only) Run `warp-cli settings` in the terminal of the target device and review the [fallback domains](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/troubleshooting-guide/#fallback-domains) section of the output.\n* (Desktop only) Collect [WARP diagnostic logs](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/warp-logs/) for the device and review the [fallback domain](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/troubleshooting-guide/#fallback-domains) section in `warp_settings.txt`.\n\n### Add a domain\n\nTo add a domain to the Local Domain Fallback list:\n\n* Dashboard\n\n  1. In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Team & Resources** > **Devices** > **Device profiles**.\n  2. Locate the [device profile](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/) you would like to view or modify and select **Configure**.\n  3. Scroll down to **Local Domain Fallback** and select **Manage**.\n\n  1) In **Domain**, enter the apex domain (`example.com`) that you want to resolve using your private DNS server. All prefixes under the apex domain are subject to Local Domain Fallback (in other words, `example.com` is interpreted as `*.example.com`).\n\n  2) In **DNS Servers**, enter the IP address of the DNS servers that should resolve that domain name.\n\n  3) Enter an optional description and select **Save domain**.\n\n* Terraform (v5)\n\n  A Local Domain Fallback list is scoped to a specific [device profile](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/). If a device profile does not have a corresponding Local Domain Fallback resource, those devices will use the default local domains shown in Step 2.\n\n  1. Add the following permission to your [`cloudflare_api_token`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/api_token):\n\n     * `Zero Trust Write`\n\n  2. (Optional) Create a list of domains that you can reuse across multiple device profiles. For example, you can declare a local value in the same module as your device profiles:",
      "language": "unknown"
    },
    {
      "code": "3. To configure Local Domain Fallback for the default device profile, use the [`cloudflare_zero_trust_device_default_profile_local_domain_fallback`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/zero_trust_device_default_profile_local_domain_fallback) resource. To configure Local Domain Fallback for a custom device profile, use[`cloudflare_zero_trust_device_custom_profile_local_domain_fallback`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/zero_trust_device_custom_profile_local_domain_fallback). For example:",
      "language": "unknown"
    },
    {
      "code": "For `suffix`, specify the apex domain (`example.com`) that you want to resolve using your private DNS server. All prefixes under the apex domain are subject to Local Domain Fallback (in other words, `example.com` is interpreted as `*.example.com`). For `dns_server`, enter the IP address of the DNS servers that should resolve that domain name.\n\nWARP tries all servers and always uses the fastest response, even if that response is `no records found`. We recommend specifying at least one DNS server for each domain. If a value is not specified, the WARP client will try to identify the DNS server (or servers) used on the device before it started, and use that server for each domain in the Local Domain Fallback list.\n\n### Route traffic to fallback server\n\nThe WARP client routes DNS traffic to your [Local Domain Fallback server](#add-a-domain) according to your [Split Tunnel configuration](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/). To ensure that queries can reach your private DNS server:\n\n* If your DNS server is only reachable inside of the WARP tunnel (for example, via `cloudflared` or Magic WAN):\n\n  1. Go to **Networks** > **Routes** and verify that the DNS server is connected to Cloudflare. To connect a DNS server, refer to [Private networks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/private-net/).\n\n  2. In your [Split Tunnel configuration](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/), verify that the DNS server IP routes through the WARP tunnel.\n\n* If your DNS server is only reachable outside of the WARP tunnel (for example, via a third-party VPN), verify that the DNS server IP is [excluded from the WARP tunnel](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/).\n\nFor more information, refer to [How the WARP client handles DNS requests](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/#how-the-warp-client-handles-dns-requests).\n\n### Delete a domain\n\n1. In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Team & Resources** > **Devices** > **Device profiles**.\n2. Locate the [device profile](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/) you would like to view or modify and select **Configure**.\n3. Scroll down to **Local Domain Fallback** and select **Manage**.\n\n1) Find the domain in the list and select **Delete**.\n\nThe domain will no longer be excluded from Gateway DNS policies, effective immediately.\n\n## Reverse DNS lookups for internal IPs\n\nBy default, Warp sends [reverse DNS queries](https://www.cloudflare.com/learning/dns/glossary/reverse-dns/) to public DNS servers. To lookup the domain name associated with an internal IP address, [add a local domain fallback entry](#add-a-domain) for `in-addr.arpa` (IPv4) and/or `ip6.arpa` (IPv6) that points to your internal DNS server IP. `in-addr.arpa` and `ip6.arpa` are top-level domains [reserved](https://www.iana.org/domains/arpa) for reverse DNS queries. By adding a local domain fallback entry for these domains, all reverse DNS queries (such as `dig -x 1.1.1.1`) will now resolve through your local DNS server.\n\n## Related resources\n\n* [Split Tunnels](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/) - Control which traffic goes through WARP by including or excluding specific IPs or domains.\n* [WARP with firewall](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/firewall/) - Learn which IPs, domains, and ports to allow so users can deploy and connect WARP successfully behind a firewall.\n\n</page>\n\n<page>\n---\ntitle: WARP architecture  Cloudflare One docs\ndescription: Explore how the Cloudflare WARP client routes DNS and IP traffic to\n  apply your Zero Trust policies.\nlastUpdated: 2025-12-02T20:21:17.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/warp-architecture/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/warp-architecture/index.md\n---\n\nThis guide explains how the Cloudflare WARP client interacts with a device's operating system to route traffic in [Gateway with WARP](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/#gateway-with-warp-default) mode.\n\nIn [Gateway with DoH](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/#gateway-with-doh) mode, the IP traffic information does not apply. In [Secure Web Gateway without DNS filtering](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/#secure-web-gateway-without-dns-filtering) mode, the DNS traffic information does not apply.\n\n## WARP traffic flow\n\nThe WARP client allows organizations to have granular control over the applications an end user device can access. The client forwards DNS and network traffic from the device to Cloudflare's global network, where Zero Trust policies are applied in the cloud. On all operating systems, the WARP daemon maintains three connections between the device and Cloudflare:\n\n| Connection | Protocol | Purpose |\n| - | - | - |\n| WARP tunnel ([via WireGuard or MASQUE](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#device-tunnel-protocol)) | UDP | Send IP packets to Gateway for network policy enforcement, HTTP policy enforcement, and private network access. |\n| [DoH](https://www.cloudflare.com/learning/dns/dns-over-tls/) | HTTPS | Send DNS requests to Gateway for DNS policy enforcement. The DoH connection is maintained inside of the WARP tunnel. |\n| Device orchestration | HTTPS | Perform user registration, check device posture, apply WARP profile settings. |",
      "language": "unknown"
    },
    {
      "code": "Your [Split Tunnel](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/) configuration determines what IP traffic is sent down the WARP tunnel. Your [Local Domain Fallback](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/) configuration determines which DNS requests are sent to Gateway via DoH. Traffic to the [device orchestration API](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/firewall/#client-orchestration-api) endpoint does not obey Split Tunnel rules since the connection always operates outside of the WARP tunnel.\n\nNext, you will learn how WARP configures your operating system to apply your Local Domain Fallback and Split Tunnel routing rules. Implementation details differ between desktop and mobile clients.\n\n## Windows, macOS, and Linux\n\nThe desktop client consists of two components: a service/daemon that handles all WARP functionality on your device, and a GUI wrapper that makes it easier for a user to interact with the daemon.\n\n### DNS traffic\n\nWhen you turn on WARP, WARP creates a local DNS proxy on the device and binds it to these IP addresses on port 53 (the port designated for DNS traffic):\n\n* **IPv4**: `127.0.2.2` and `127.0.2.3`\n\n* **IPv6**:\n\n  * macOS and Linux: `fd01:db8:1111::2` and `fd01:db8:1111::3`\n  * Windows: `::ffff:127.0.2.2`\n\nWARP then configures the operating system to send all DNS requests to these IP addresses. All network interfaces on the device will now use this local DNS proxy for DNS resolution. In other words, all DNS traffic will now be handled by the WARP client.\n\nNote\n\nBrowsers with DoH configured will bypass the local DNS proxy. You may need to disable DoH settings in the browser.\n\nBased on your Local Domain Fallback configuration, WARP will either forward the request to Gateway for DNS policy enforcement or forward the request to your private DNS resolver.\n\n* Requests to Gateway are sent over our [DoH connection](#overview) inside the WARP tunnel.\n* Requests to your private DNS resolver are sent either inside or outside of the tunnel depending on your Split Tunnel configuration. For more information, refer to [How the WARP client handles DNS requests](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/#how-the-warp-client-handles-dns-requests).",
      "language": "unknown"
    },
    {
      "code": "You can verify that the operating system is using WARP's local DNS proxy:\n\n* macOS\n\n  On macOS, open a terminal window and run `scutil --dns`. The DNS servers should be set to WARP's local DNS proxy IPs.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "* Windows\n\n  On Windows, open a PowerShell window and run `ipconfig`. The DNS servers should be set to WARP's local DNS proxy IPs.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "* Linux\n\n  On Linux, check the `/etc/resolv.conf` file. The DNS servers should be set to WARP's local DNS proxy IPs.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### IP traffic\n\nWhen you turn on WARP, WARP makes three changes on the device to control if traffic is sent inside or outside of the WARP tunnel:\n\n* Creates a [virtual network interface](#virtual-interface).\n* Modifies the operating system [routing table](#routing-table) according to your Split Tunnel rules.\n* Modifies the operating system [firewall](#system-firewall) according to your Split Tunnel rules.",
      "language": "unknown"
    },
    {
      "code": "#### Virtual interface\n\nVirtual interfaces allow the operating system to logically subdivide a physical interface, such as a network interface controller (NIC), into separate interfaces for the purposes of routing IP traffic. WARP's virtual interface is what maintains the WireGuard/MASQUE connection between the device and Cloudflare. By default, its IP address is hardcoded as `172.16.0.2`. You can use [**Assign a unique IP address to each device**](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#assign-a-unique-ip-address-to-each-device) to override the default IP address with a unique CGNAT IP.\n\nTo view a list of all network interfaces on the operating system:\n\n* macOS\n\n  On macOS, run `ifconfig`. When WARP is turned on, you will see a `utun` interface with IP address `172.16.0.2`.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "* Windows\n\n  On Windows, run `ipconfig`. When WARP is turned on, you will see an adapter called `CloudflareWARP` with IP address `172.16.0.2`.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "* Linux\n\n  On Linux, run `ifconfig` or `ip addr`. When WARP is turned on, you will see a `utun` interface with IP address `172.16.0.2`.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "#### Routing table\n\nWARP edits the system routing table to control what IP traffic goes to Gateway. The routing table indicates which network interface should handle packets to a particular IP address. By default, all traffic routes through WARP's virtual interface except for the IPs and domains on your Split Tunnel exclude list (which use the default interface on your device).\n\nYou can verify that the routing table matches your Split Tunnel rules:\n\n* macOS\n\n  To view the entire routing table on macOS, run `netstat -r`.\n\n  You can also search the routing table for a domain or IP address. In this example, we see that traffic to `google.com` is sent through `utun3`, which is the WARP virtual interface on this device:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "In contrast, this DHCP address is excluded from WARP and uses the default interface:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "* Windows\n\n  To view the entire routing table on Windows, run `netstat -r`.\n\n  You can also search the routing table for an IP address. In this example, we see that traffic to `1.1.1.1` is sent through the WARP virtual interface:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "In contrast, this DHCP address is excluded from WARP and uses the default interface:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "* Linux\n\n  To view the entire routing table on Linux, run `ip -6 route show table all` or `ip -4 route show table all`.\n\n  You can also search the routing table for an IP address. In this example, we see that traffic to `1.1.1.1` is sent through the WARP virtual interface:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "In contrast, this DHCP address is excluded from WARP and uses the default interface:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "#### System firewall\n\nWARP modifies the operating system firewall to enforce your Split Tunnel rules. This adds a layer of protection in case a service bypasses the routing table and tries to send traffic directly through another interface. For example, if traffic to `203.0.113.0` is supposed to be inspected by Gateway, we create a firewall rule that blocks `203.0.113.0` on all interfaces except for `utun`.\n\n## iOS, Android, and ChromeOS\n\nOn iOS and Android/ChromeOS, the Cloudflare One Agent installs itself as a VPN client to capture and route all traffic. The app is built on the official VPN framework for iOS and Android. For more information, refer to Apple's [NetworkExtension documentation](https://developer.apple.com/documentation/networkextension) and Google's [Android developer documentation](https://developer.android.com/guide/topics/connectivity/vpn).\n\nNote that ChromeOS runs the Android app in a virtual machine, rather than running a native Chrome app.\n\n</page>\n\n<page>\n---\ntitle: Split Tunnels  Cloudflare One docs\ndescription: Split Tunnels can be configured to exclude or include IP addresses\n  or domains from going through WARP. This feature is commonly used to run WARP\n  alongside a VPN (in Exclude mode) or to provide access to a specific private\n  network (in Include mode).\nlastUpdated: 2025-11-21T18:29:21.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/index.md\n---\n\nSplit Tunnels can be configured to exclude or include IP addresses or domains from going through WARP. This feature is commonly used to run WARP alongside a VPN (in Exclude mode) or to provide access to a specific private network (in Include mode).\n\nWarning\n\nSplit Tunnels only impacts the flow of IP traffic. DNS requests are still resolved by Gateway and subject to DNS policies unless you add the domains to your [Local Domain Fallback](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/) configuration.\n\nBecause Split Tunnels controls what Gateway has visibility on at the network level, we recommend testing all changes before rolling out updates to end users.\n\n## Change Split Tunnels mode\n\n* Dashboard\n\n  1. In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Team & Resources** > **Devices** > **Device profiles**.\n\n  2. Locate the [device profile](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/) you would like to modify and select **Configure**.\n\n  3. Scroll down to **Split Tunnels**.\n\n  4. (Optional) To view your existing Split Tunnel configuration, select **Manage**. You will see a list of the IPs and domains Cloudflare Zero Trust excludes or includes, depending on the mode you have selected. We recommend making a copy of your Split Tunnel entries, as they will revert to the default upon switching modes.\n\n  5. Under **Split Tunnels**, choose a mode:\n\n     * **Exclude IPs and domains**  (Default) All traffic will be sent to Cloudflare Gateway except for the IPs and domains you specify.\n     * **Include IPs and Domains**  Only traffic destined to the IPs or domains you specify will be sent to Cloudflare Gateway. All other traffic will bypass Gateway and will no longer be filtered by your network or HTTP policies. In order to use certain features, you will need to manually add [Zero Trust domains](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#cloudflare-zero-trust-domains).\n\n* Terraform (v5)\n\n  1. Add the following permission to your [`cloudflare_api_token`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/api_token):\n\n     * `Zero Trust Write`\n\n  2. Choose a [`cloudflare_zero_trust_device_default_profile`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/zero_trust_device_default_profile) or [`cloudflare_zero_trust_device_custom_profile`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/zero_trust_device_custom_profile) resource to modify, or [create a new device profile](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/#create-a-new-profile).\n\n  3. In your device profile, configure either the `exclude` or `include` argument. You cannot set both `exclude` and `include` in a given device profile.\n\n     a. To manage Split Tunnel routes in **Exclude** mode, use the `exclude` argument:",
      "language": "unknown"
    },
    {
      "code": "In this example, all traffic will be sent to Cloudflare Gateway except for traffic destined to `10.0.0.0/8`. To exclude the default IPs and domains recommended by Cloudflare, refer to [Add a route](#add-a-route).\n\n     b. To manage Split Tunnel routes in **Include** mode, use the `include` argument:",
      "language": "unknown"
    },
    {
      "code": "In this example, only traffic destined to `10.0.0.0/8` will be sent to Cloudflare Gateway.\n\nAll clients with this device profile will now switch to the new mode and its default route configuration. Next, [add](#add-a-route) or [remove](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#remove-a-route) routes from your Split Tunnel configuration.\n\n## Add a route\n\n* Dashboard\n\n  1. In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Team & Resources** > **Devices** > **Device profiles**.\n\n  2. Locate the [device profile](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/) you would like to modify and select **Configure**.\n\n  3. Under **Split Tunnels**, check whether your [Split Tunnels mode](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#change-split-tunnels-mode) is set to **Exclude** or **Include**.\n\n  4. Select **Manage**.\n\n  5. You can exclude or include routes based on either their IP address or domain. When possible we recommend adding an IP address instead of a domain. To learn about the consequences of adding a domain, refer to [Domain-based Split Tunnels](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#domain-based-split-tunnels).\n\n     * Add an IP\n\n       To add an IP address to Split Tunnels:\n\n       1. Select *IP Address*.\n       2. Enter the IP address or CIDR you want to exclude or include.\n       3. Select **Save destination**.\n\n       Traffic to this IP address is now excluded or included from the WARP tunnel.\n\n       Note\n\n       If you would like to exclude a specific IP range from a larger IP range, you can use this calculator:\n\n     * Add a domain\n\n       To add a domain to Split Tunnels:\n\n       1. Select *Domain*.\n       2. Enter a [valid domain](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#valid-domains) to exclude or include.\n       3. Select **Save destination**.\n       4. (Optional) If your domain does not have a public DNS record, create a [Local Domain Fallback](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/) entry to allow a private DNS server to handle domain resolution.\n\n       When a user goes to the domain, the domain gets resolved according to your Local Domain Fallback configuration (either by Gateway or by your private DNS server). WARP Split Tunnels will then dynamically include or exclude the IP address returned in the DNS lookup.\n\n* Terraform (v5)\n\n  1. Add the following permission to your [`cloudflare_api_token`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/api_token):\n\n     * `Zero Trust Write`\n\n  2. Choose a [`cloudflare_zero_trust_device_default_profile`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/zero_trust_device_default_profile) or [`cloudflare_zero_trust_device_custom_profile`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/zero_trust_device_custom_profile) resource to modify, or [create a new device profile](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/#create-a-new-profile).\n\n  3. (Optional) Create a list of split tunnel routes that you can reuse across multiple device profiles. For example, you can declare a local value in the same module as your device profiles:",
      "language": "unknown"
    },
    {
      "code": "4. In the device profile, exclude or include routes based on either their IP address or domain:",
      "language": "unknown"
    },
    {
      "code": "When possible we recommend adding an IP address instead of a domain. To learn about the consequences of adding a domain, refer to [Domain-based Split Tunnels](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#domain-based-split-tunnels).\n\n* Add an IP\n\n  To add an IP address to Split Tunnels:\n\n  1. Select *IP Address*.\n  2. Enter the IP address or CIDR you want to exclude or include.\n  3. Select **Save destination**.\n\n  Traffic to this IP address is now excluded or included from the WARP tunnel.\n\n  Note\n\n  If you would like to exclude a specific IP range from a larger IP range, you can use this calculator:\n\n* Add a domain\n\n  To add a domain to Split Tunnels:\n\n  1. Select *Domain*.\n  2. Enter a [valid domain](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#valid-domains) to exclude or include.\n  3. Select **Save destination**.\n  4. (Optional) If your domain does not have a public DNS record, create a [Local Domain Fallback](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/) entry to allow a private DNS server to handle domain resolution.\n\n  When a user goes to the domain, the domain gets resolved according to your Local Domain Fallback configuration (either by Gateway or by your private DNS server). WARP Split Tunnels will then dynamically include or exclude the IP address returned in the DNS lookup.\n\nIt may take up to 10 minutes for newly updated settings to propagate to devices.\n\nWe recommend keeping the Split Tunnels list short, as each entry takes time for the client to parse. In particular, domains are slower to action than IP addresses because they require on-the-fly IP lookups and routing table / local firewall changes. A shorter list will also make it easier to understand and debug your configuration. For information on device profile limits, refer to [Account limits](https://developers.cloudflare.com/cloudflare-one/account-limits/#warp).\n\n### When to use Split Tunnels\n\nUse Split Tunnels when you need to bypass Gateway entirely for a site or allow traffic through the [firewall that WARP creates](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/warp-architecture/#system-firewall). Common scenarios include:\n\n* Connect to a third-party application which requires the actual IP address of the end-user device (for example, [Microsoft 365](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#directly-route-microsoft-365-traffic)).\n* Optimize voice and video.\n* Connect to a [third-party VPN](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/vpn/) endpoint.\n\n### When not to use Split Tunnels\n\nDo not exclude a site from Split Tunnels if you want to see the traffic in your Gateway logs. In particular, we do not recommend using Split Tunnels to:\n\n* Solve connectivity issues with a specific website. For configuration guidance, refer to our [troubleshooting guide](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/common-issues/#cannot-connect-to-a-specific-app-or-website).\n* Solve performance issues with a specific website. Since Cloudflare operates within 50 milliseconds of 95% of the Internet-connected population, it is usually faster to send traffic through us. If you are encountering a performance-related issue, it is best to first explore your Gateway policies or reach out to Support.\n\n## Routes for Split Tunnels Include mode\n\nMany Cloudflare Zero Trust services rely on traffic going through WARP, such as [device posture checks](https://developers.cloudflare.com/cloudflare-one/reusable-components/posture-checks/) and [WARP session durations](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-sessions/). If you are using Split Tunnels in Include mode, you will need to manually add Cloudflare Zero Trust domains and IPs in order for these features to function.\n\n### Cloudflare Zero Trust domains\n\nIf you are using Split Tunnels in Include mode, you must include the following domains:\n\n* The IdP used to authenticate to Cloudflare Zero Trust\n* `<your-team-name>.cloudflareaccess.com`\n* The application protected by the Access or Gateway policy\n* `edge.browser.run` if using [Browser Isolation](https://developers.cloudflare.com/cloudflare-one/remote-browser-isolation/)\n\n### Cloudflare Zero Trust IP addresses\n\n#### Block page\n\nIf you are using Split Tunnels in Include mode and have [DNS policies](https://developers.cloudflare.com/cloudflare-one/traffic-policies/dns-policies/) with the [block page](https://developers.cloudflare.com/cloudflare-one/reusable-components/custom-pages/gateway-block-page/) enabled, you must include the IPs that blocked domains will resolve to. Unless you are using a [dedicated or BYOIP resolver IP](https://developers.cloudflare.com/cloudflare-one/networks/resolvers-and-proxies/dns/locations/dns-resolver-ips/#dns-resolver-ip) the block page will resolve to:\n\n* `162.159.36.12`\n* `162.159.46.12`\n\n#### Team domain\n\nIn [Secure Web Gateway without DNS filtering](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/#secure-web-gateway-without-dns-filtering) WARP mode, you cannot [add domains](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/split-tunnels/#cloudflare-zero-trust-domains) to Split Tunnels. If you are using Split Tunnels in Include mode, you must include the IPs that resolve to `<your-team-name>.cloudflareaccess.com` instead:\n\n* `104.19.194.29`\n* `104.19.195.29`\n\n## Domain-based Split Tunnels\n\nDomain-based split tunneling has a few ramifications you should be aware of before deploying in your organization:.\n\n* Routes excluded or included from WARP and Gateway visibility may change day to day, and may be different for each user depending on where they are.\n* You may inadvertently exclude or include additional hostnames that happen to share an IP address. This commonly occurs if you add a domain hosted by a CDN or large Internet provider such as Cloudflare, AWS, or Azure. For example, if you wanted to exclude a VPN hosted on AWS, do not add `*.amazonaws.com` as that will open up your devices to all traffic on AWS. Instead, add the specific VPN endpoint (`*.cvpn-endpoint-<UUID>.prod.clientvpn.us-west-2.amazonaws.com`).\n* Most services are a collection of hostnames. Until Split Tunnels mode supports [App Types](https://developers.cloudflare.com/cloudflare-one/traffic-policies/application-app-types/), you will need to manually add all domains used by a particular app or service.\n* WARP must handle the DNS lookup request for the domain. If a DNS result has been previously cached by the operating system or otherwise intercepted (for example, via your browser's secure DNS settings), the IP address will not be dynamically added to your Split Tunnel.\n\n### Valid domains\n\n| Split tunnel domain | Matches | Does not match |\n| - | - | - |\n| `example.com` | exact match of `example.com` | subdomains such as `www.example.com` |\n| `example.example.com` | exact match of `example.example.com` | `example.com` or subdomains such as `www.example.example.com` |\n| `*.example.com` | subdomains such as `www.example.com` and `sub2.sub1.example.com` | `example.com` |\n\n### Platform differences\n\nDomain-based Split Tunnels work differently on mobile clients than on desktop clients. If both mobile and desktop clients will connect to your organization, it is recommended to use Split Tunnels based on IP addresses or CIDR, which work the same across all platforms.\n\n#### Windows, Linux and macOS\n\nClients on these platforms work by dynamically inserting the IP address of the domain immediately after it is resolved into the routing table for split tunneling. This allows the desktop clients to support wildcard domain prefixes (for example, `*.example.com`), not just a singular domain (like `example.com` or `www.example.com`).\n\n#### iOS, Android and ChromeOS\n\nDue to platform differences, mobile clients can only apply Split Tunnels rules when the tunnel is initially started. This means:\n\n* Domain-based Split Tunnels rules are created when the tunnel is established based on the IP address for that domain at that time. The route is refreshed each time the tunnel is established.\n* Wildcard domain prefixes (for example, `*.example.com`) are supported only if they have valid wildcard DNS records. Other wildcard domains are not supported because the client is unable to match wildcard domains to hostnames when starting up the tunnel. Unsupported wildcard domain prefixes can still exist in your configuration, but they will be ignored on mobile platforms.\n\n## Remove a route\n\nWarning\n\nRemoving default Split Tunnel entries may cause users to lose Internet connectivity or block their access to local resources.\n\n1. In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Team & Resources** > **Devices** > **Device profiles**.\n2. Under **Profiles**, locate the [device profile](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/) you would like to modify and select **Edit**.\n3. Under **Split Tunnels**, select **Manage**.\n4. Find the IP address or hostname in the list and select the **Action** button. From the dropdown, select *Delete*.\n\nIt may take up to 10 minutes for newly updated settings to propagate to devices.\n\nIf you need to revert to the default Split Tunnel entries recommended by Cloudflare, select **Restore default entries**.\n\n## Related resources\n\n* [Local Domain Fallback](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/) - Resolve selected domains via local DNS instead of Cloudflare Gateway.\n* [WARP with firewall](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/firewall/) - Learn which IPs, domains, and ports to allow so users can deploy and connect WARP successfully behind a firewall.\n\n</page>\n\n<page>\n---\ntitle: Enable Device Information Only  Cloudflare One docs\ndescription: Device Information Only mode allows you to enforce device posture\n  rules when a user connects to your self-hosted Access application. This mode\n  relies on a client certificate generated from your account to establish trust\n  between the Access application and the device.\nlastUpdated: 2025-10-24T18:24:10.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/device-information-only/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/device-information-only/index.md\n---\n\nFeature availability\n\n| System | Availability |\n| - | - |\n| Windows |  |\n| macOS |  |\n| Linux |  |\n| iOS |  |\n| Android |  |\n| ChromeOS |  |\n\nDevice Information Only mode allows you to enforce device posture rules when a user connects to your [self-hosted Access application](https://developers.cloudflare.com/cloudflare-one/access-controls/applications/http-apps/self-hosted-public-app/). This mode relies on a client certificate generated from your account to establish trust between the Access application and the device.\n\n## 1. Turn on account settings\n\nUsing the API, enable client certificate provisioning for [your zone](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/):\n\nRequired API token permissions\n\nAt least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n* `SSL and Certificates Write`",
      "language": "unknown"
    },
    {
      "code": "## 2. Configure the WARP client\n\n1. In [Cloudflare One](https://one.dash.cloudflare.com), go to **Team & Resources** > **Devices** > **Device profiles**.\n\n2. Under **Profiles**, choose a [device profile](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/) and select **Edit**.\n\n3. For **Service mode**, select **Device Information Only**.\n\n4. Select **Save profile**.\n\n5. [Enroll your device](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/manual-deployment/) into your Zero Trust organization.\n\n   When enrolled in Device Information Only mode, the WARP client will automatically generate a client certificate and install the certificate on the device. This certificate is necessary to confirm the source of outgoing traffic.\n\n## 3. (Optional) Verify the client certificate\n\n1. To view the client certificates installed on the device:\n\n   * Windows\n\n     1. Open the **Start** menu and select **Run**.\n     2. Enter `certlm.msc`.\n     3. Go to **Personal** > **Certificates**.\n\n   * macOS\n\n     1. Open **Keychain Access**.\n     2. Go to **System** > **My Certificates**.\n\n   * Linux\n\n     Open a terminal window and run the following command:",
      "language": "unknown"
    },
    {
      "code": "* iOS\n\n     Go to **Settings** > **General** > **About** > **Certificate Trust Settings**.\n\n   * Android\n\n     The location of the client certificate may vary depending on the Android device.\n\n     * **Samsung**: Go to **Settings** > **Security** > **Other security settings** > **View security certificates**.\n     * **Google Pixel**: Go to **Security** > **Advanced settings** > **Encryption & credentials** > **Credential storage**.\n\n   * ChromeOS\n\n     Go to **Settings** > **Apps** > **Google Play Store** > **Manage Android Preferences** > **Security** > **Credentials**.\n\n   The client certificate name should match the **Device ID** in your WARP client **Preferences**.\n\n2. To verify the client certificate in your Cloudflare account:\n\n   1. In the [Cloudflare dashboard](https://dash.cloudflare.com/), select the zone for which you enabled client certificates.\n   2. Go to **SSL/TLS** > **Client Certificates**.\n\n   The certificate name is the WARP enrollment **Device ID**. ![Example client certificate in the Cloudflare dashboard](https://developers.cloudflare.com/_astro/device-information-only-cert.CBHcWmIc_W803o.webp)\n\n## 4. Enforce the client certificate\n\nTo block traffic from devices that do not have a valid client certificate:\n\n1. In the [Cloudflare dashboard](https://dash.cloudflare.com/), go to **SSL/TLS** > **Client Certificates**.\n\n2. Under **Hosts**, select **Edit** and enter the hostname of your Access application (for example, `app.mycompany.com`). This enables mTLS authentication for the application.\n\n3. Select **Create mTLS rule**.\n\n4. Create a WAF custom rule that checks all requests to your application for a valid client certificate:\n\n   | Field | Operator | Value | Logic | Action |\n   | - | - | - | - | - |\n   | Client Certificate | equals | Off | And | Block |\n   | Hostname | equals | `app.mycompany.com` | | |\n\n5. Select **Deploy**.\n\nDevice Information Only mode is now enabled on the device. To start enforcing device posture, set up a [WARP client check](https://developers.cloudflare.com/cloudflare-one/reusable-components/posture-checks/warp-client-checks/) and add a *Require* device posture rule to your [Access policy](https://developers.cloudflare.com/cloudflare-one/access-controls/policies/). When the device connects to the Access application for the first time, the browser will ask to use the client certificate installed by WARP.\n\n![Browser prompts for client\ncertificate](https://developers.cloudflare.com/_astro/device-information-only-browser.BARL_mBj_2tjyFh.webp)\n\n## Limitations\n\nDevice Information mode is not compatible with the [Windows pre-login](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-prelogin/) feature. The user must be logged into Windows because WARP needs to [install a certificate](#3-optional-verify-the-client-certificate) in the user store.\n\n</page>\n\n<page>\n---\ntitle: Captive portal detection  Cloudflare One docs\ndescription: Captive portals are used by public Wi-Fi networks (such as\n  airports, coffee shops, and hotels) to make a user agree to their Terms of\n  Service or provide payment before allowing access to the Internet. When a user\n  connects to the Wi-Fi, the captive portal blocks all HTTPS traffic until the\n  user completes a captive portal login flow in their browser. This prevents the\n  WARP client from connecting to Cloudflare. At the same time, WARP creates\n  firewall rules on the device to send all traffic to Cloudflare. The user is\n  therefore unable to access the captive portal login screen unless they\n  temporarily disable WARP.\nlastUpdated: 2025-12-02T20:21:17.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/captive-portals/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/captive-portals/index.md\n---\n\nCaptive portals are used by public Wi-Fi networks (such as airports, coffee shops, and hotels) to make a user agree to their Terms of Service or provide payment before allowing access to the Internet. When a user connects to the Wi-Fi, the captive portal blocks all HTTPS traffic until the user completes a captive portal login flow in their browser. This prevents the WARP client from connecting to Cloudflare. At the same time, WARP creates [firewall rules](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/warp-architecture/#ip-traffic) on the device to send all traffic to Cloudflare. The user is therefore unable to access the captive portal login screen unless they temporarily disable WARP.\n\n## Allow users to connect to captive portals\n\nTo allow users to connect through a captive portal, administrators can configure the following WARP settings:\n\n### No user interaction required\n\n* Enable [Captive portal detection](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#captive-portal-detection). This allows WARP to temporarily turn off when it detects a captive portal on the network. For more details, refer to [how captive portal detection works](#how-captive-portal-detection-works) and its [limitations](#limitations).\n* Set [Device tunnel protocol](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#device-tunnel-protocol) to **MASQUE**. When using MASQUE, WARP traffic will look like standard HTTPS traffic and is therefore less likely to be blocked by captive portals.\n\n### User interaction required\n\n* Enable [Lock WARP switch](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#lock-warp-switch) and enable [Allow admin override codes](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#allow-admin-override-codes). Users can contact the IT administrator for a one-time code that allows them to manually turn off WARP and connect to a portal.\n* For employees who travel, disable [Lock WARP switch](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#lock-warp-switch) and set an [Auto connect](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#auto-connect) duration. This allows the user to manually turn off WARP without contacting IT.\n\n## How captive portal detection works\n\nIf WARP cannot establish a connection to Cloudflare, it will:\n\n1. Start the captive portal timer.\n\n2. Send a series of requests to the [Cloudflare captive portal URLs](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/firewall/#captive-portal) and other OS and browser-specific captive portal URLs. These requests are sent outside of the WARP tunnel.\n\n3. If a request is intercepted, WARP assumes the network is behind a captive portal and fully opens the [system firewall](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/warp-architecture/#ip-traffic). While the firewall is open, all device traffic will bypass WARP.\n\n4. Re-enable the firewall after the user successfully connects to the portal or after the timeout period expires.\n\n## Limitations\n\n* Due to [how captive portal detection works](#how-captive-portal-detection-works), it may be possible for an employee to spoof a captive portal in order to turn off WARP.\n\n* Some captive portals, particularly those on airlines, may be slow to respond and exceed the captive portal detection timeout. Users will likely see a [CF\\_CAPTIVE\\_PORTAL\\_TIMED\\_OUT](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/client-errors/#cf_captive_portal_timed_out) error when they try to connect. For context on the steps leading up to these errors, refer to [Connectivity status](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/connectivity-status/).\n\n* WARP may not be able to detect multi-stage captive portals, which redirect the user to different networks during the login process. Users will need to manually turn off WARP to get through the captive portal.\n\n* Some public Wi-Fi networks are incompatible with running WARP:\n\n  * Captive portals that intercept all DNS traffic will block WARP's [DoH connection](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/warp-architecture/#overview). Users will likely see a [CF\\_NO\\_NETWORK](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/client-errors/#cf_no_network) error after they login to the captive portal.\n  * Captive portals that only allow HTTPS traffic will block WARP's [Wireguard UDP connection](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/warp-architecture/#overview). Users will likely see a [CF\\_HAPPY\\_EYEBALLS\\_MITM\\_FAILURE](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/client-errors/#cf_happy_eyeballs_mitm_failure) error after they login to the captive portal.\n\n## Get captive portal logs Beta\n\nFeature availability\n\n| [WARP modes](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/) | [Zero Trust plans](https://www.cloudflare.com/teams-pricing/) |\n| - | - |\n| All modes | All plans |\n\n| System | Availability | Minimum WARP version |\n| - | - | - |\n| Windows |  | 2025.4.589.1 |\n| macOS |  | 2025.4.589.1 |\n| Linux |  | |\n| iOS |  | |\n| Android |  | |\n| ChromeOS |  | |\n\nCaptive portal logs are used by Cloudflare Support to troubleshoot WARP captive portal issues. When an end user reports an issue with a captive portal, the IT administrator can ask the user to collect captive portal logs on their device. The administrator can then attach the logs to a Cloudflare Support ticket.\n\nTo get captive portal logs:\n\n1. Open the WARP client.\n2. Go to **Settings** (gear icon) > **Preferences** > **Advanced**.\n3. Select **Collect Captive Portal Diag**.\n4. The WARP client will ask if the device is connected (or attempting to connect) to the Wi-Fi network that is causing issues. Select **Yes** to confirm.\n\nmacOS limitation\n\nOn macOS, [**Automatically join this network**](https://support.apple.com/guide/mac-help/wi-fi-settings-on-mac-mh11935/mac) should be enabled on the Wi-Fi network that is causing issues. This setting is enabled by default. If manually disabled, the captive portal diagnostic will fail to capture meaningful data and the device will not automatically reconnect to this network.\n\nOnce the diagnostic finishes running, WARP will place a `warp-captive-portal-diag-<date>-<time>.zip` file on the user's desktop. The end user can now share this file with their IT administrator.\n\n## Related resources\n\n* [Connectivity status](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/connectivity-status/) - Learn about the status messages displayed by the WARP client during its connection process, and understand each stage as WARP establishes a secure tunnel to Cloudflare.\n\n</page>\n\n<page>\n---\ntitle: Parameters  Cloudflare One docs\ndescription: Explore parameters for deploying Cloudflare WARP via MDM, including\n  organization setup and device registration for Zero Trust.\nlastUpdated: 2025-11-21T18:29:21.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/parameters/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/parameters/index.md\n---\n\nEach client supports the following set of parameters as part of their deployment, regardless of the deployment mechanism.\n\nNote\n\nMost of the parameters listed below are also configurable in Cloudflare One under **Team & Resources** > **Devices**. In the event of conflicting settings, the WARP client will always give precedence to settings on the local device (for example, in your `mdm.xml` or `com.cloudflare.warp.plist` files).\n\n## Required for full Cloudflare Zero Trust features\n\nFor the majority of Cloudflare Zero Trust features to work, you need to specify a team name. Examples of Cloudflare Zero Trust features which depend on the team name are [HTTP policies](https://developers.cloudflare.com/cloudflare-one/traffic-policies/http-policies/), [Browser Isolation](https://developers.cloudflare.com/cloudflare-one/remote-browser-isolation/), and [device posture](https://developers.cloudflare.com/cloudflare-one/reusable-components/posture-checks/).\n\n### `organization`\n\nInstructs the client to register the device with your organization. Registration requires authentication via an [IdP](https://developers.cloudflare.com/cloudflare-one/integrations/identity-providers/) or [Service Auth](https://developers.cloudflare.com/cloudflare-one/access-controls/service-credentials/service-tokens/).\n\n**Value Type:** `string`\n\n**Value:** Your team name.\n\n## Required for DNS-only policy enforcement\n\nThis field is used to enforce DNS policies when deploying the client in DoH-only mode.\n\n### `gateway_unique_id`\n\nInstructs the client to direct all DNS queries to a specific [Gateway DNS location](https://developers.cloudflare.com/cloudflare-one/networks/resolvers-and-proxies/dns/locations/). This value is only necessary if deploying without a [team name](#organization) or in an organization with multiple DNS locations. If you do not supply a DoH subdomain, we will automatically use the default Gateway DNS location for your organization.\n\n**Value Type:** `string`\n\n**Value:** Your DoH subdomain.\n\n## Organization parameters\n\nYou can use the following parameters to configure a specific Zero Trust organization.\n\n### `auth_client_id`\n\nEnrolls the device in your Zero Trust organization using a [service token](https://developers.cloudflare.com/cloudflare-one/access-controls/service-credentials/service-tokens/#create-a-service-token). Requires the `auth_client_secret` parameter.\n\n**Value Type:** `string`\n\n**Value:** Client ID of the service token.\n\nExample configuration:",
      "language": "unknown"
    },
    {
      "code": "Note\n\nThe service token must have *Service Auth* [device enrollment permissions](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/device-enrollment/#check-for-service-token). Allow permissions will not work for service tokens.\n\n### `auth_client_secret`\n\nEnrolls the device in your Zero Trust organization using a [service token](https://developers.cloudflare.com/cloudflare-one/access-controls/service-credentials/service-tokens/#create-a-service-token). Requires the `auth_client_id` parameter.\n\n**Value Type:** `string`\n\n**Value:** Client Secret of the service token.\n\n### `auto_connect`\n\nIf switch has been turned off by user, the client will automatically turn itself back on after the specified number of minutes. We recommend keeping this set to a very low value  usually just enough time for a user to log in to hotel or airport Wi-Fi. If any value is specified for `auto_connect` the default state of the WARP client will always be Connected (for example, after the initial install or a reboot).\n\n**Value Type:** `integer`\n\n**Value:**\n\n* `0`  Allow the switch to stay in the off position indefinitely until the user turns it back on.\n* `1` to `1440`  Turn switch back on automatically after the specified number of minutes.\n\nNote\n\nThis parameter replaces the old `enabled` property, which can no longer be used in conjunction with the new `switch_locked` and `auto_connect`. If you want to use these parameters, you must remove `enabled`.\n\n### `display_name`\n\nIdentifies a Zero Trust organization in the WARP GUI when WARP is deployed with [multiple organizations](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/switch-organizations/). Required if the `organization` parameter is specified within a [`configs` array](#configs).\n\n**Value Type:** `string`\n\n**Value:** Organization nickname shown to users in the WARP GUI (for example, `Test environment`).\n\n### `enable_pmtud`\n\n[Path MTU Discovery (PMTUD)](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/path-mtu-discovery/) allows WARP to discover the largest packet size that can be sent over the current network and optimize connection performance.\n\n**Value Type:** `boolean`\n\n**Value:**\n\n* `false`  (default) Disables PMTUD.\n* `true`  Enables PMTUD on the WARP tunnel interface.\n\n### `enable_post_quantum`\n\nFeature availability\n\n| [WARP modes](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/) | [Zero Trust plans](https://www.cloudflare.com/teams-pricing/) |\n| - | - |\n| * Gateway with WARP\n* Secure Web Gateway without DNS filtering | All plans |\n\n| System | Availability | Minimum WARP version |\n| - | - | - |\n| Windows |  | 2025.5.735.1 |\n| macOS |  | 2025.5.735.1 |\n| Linux |  | 2025.5.735.1 |\n| iOS |  | 1.10 |\n| Android |  | 2.4 |\n| ChromeOS |  | 2.4 |\n\nWARP uses [post-quantum cryptography](https://developers.cloudflare.com/ssl/post-quantum-cryptography/) to secure connections from the device to Cloudflare's network. Post-quantum cryptography requires the [MASQUE protocol](#warp_tunnel_protocol) and is enabled by default on all devices using MASQUE.\n\n**Value Type:** `boolean`\n\n**Value:**\n\n* `false`  Disables post-quantum key agreement.\n* `true`  Enables post-quantum key agreement for all traffic through the WARP tunnel.\n\n### `onboarding`\n\nControls the visibility of the onboarding screens that ask the user to review the privacy policy during an application's first launch.\n\n**Value Type:** `boolean`\n\n**Value:**\n\n* `false`  Screens hidden.\n* `true`  (default) Screens visible.\n\n### `override_api_endpoint`\n\nOverrides the [IP address](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/firewall/#client-orchestration-api) used by the WARP client to communicate with the client orchestration API. If you set this parameter, be sure to update your organization's firewall to ensure the new IP is allowed through.\n\nThis functionality is intended for use with a Cloudflare China local network partner or any other third-party network partner that can maintain the integrity of network traffic. Most IT admins should not set this setting as it will redirect all API traffic to a new IP.\n\n**Value Type:** `string`\n\n**Value:** `1.2.3.4`  Redirect all client orchestration API calls to `1.2.3.4`.\n\nThe string must be a valid IPv4 or IPv6 address, otherwise the WARP client will fail to parse the entire MDM file.\n\n### `override_doh_endpoint`\n\nNote\n\nOnly supported in Gateway with DoH mode.[1](#user-content-fn-1)\n\nOverrides the [IP address](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/firewall/#doh-ip) used by the WARP client to resolve DNS queries via DNS over HTTPS (DoH). If you set this parameter, be sure to update your organization's firewall to ensure the new IP is allowed through.\n\nThis functionality is intended for use with a Cloudflare China local network partner or any other third-party network partner that can maintain the integrity of network traffic. Most IT admins should not set this setting as it will redirect all DoH traffic to a new IP.\n\n**Value Type:** `string`\n\n**Value:** `1.2.3.4`  Redirect all DNS over HTTPS lookups to `1.2.3.4`.\n\nThe string must be a valid IPv4 or IPv6 address, otherwise the WARP client will fail to parse the entire MDM file.\n\n### `override_warp_endpoint`\n\nOverrides the [IP address and UDP port](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/firewall/#warp-ingress-ip) used by the WARP client to send traffic to Cloudflare's edge. If you set this parameter, be sure to update your organization's firewall to ensure the new IP is allowed through.\n\nThis functionality is intended for use with a Cloudflare China local network partner or any other third-party network partner that can maintain the integrity of network traffic. Most IT admins should not set this setting as it will redirect all WARP traffic to a new IP.\n\n**Value Type:** `string`\n\n**Value:** `203.0.113.0:500`  Redirect all WARP traffic to `203.0.113.0` on port `500`.\n\nThe string must be a valid IPv4 or IPv6 socket address (containing the IP address and port number), otherwise the WARP client will fail to parse the entire MDM file.\n\n### `service_mode`\n\nAllows you to choose the operational mode of the client.\n\n**Value Type:** `string`\n\n**Value:**\n\n* `warp`  (default) [Gateway with WARP](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/#gateway-with-warp-default).\n\n* `1dot1`  [Gateway with DoH](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/#gateway-with-doh).\n\n* `proxy`  [Proxy mode](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/#proxy-mode). Use the `proxy_port` parameter to specify the localhost SOCKS proxy port (between `0`-`66535`). For example,",
      "language": "unknown"
    },
    {
      "code": "* `postureonly`  [Device Information Only](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/#device-information-only).\n\n* `tunnelonly` - [Secure Web Gateway without DNS filtering](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/#secure-web-gateway-without-dns-filtering).\n\n### `support_url`\n\nWhen the WARP client is deployed via MDM, the in-app **Send Feedback** button is disabled by default. This parameter allows you to re-enable the button and direct feedback towards your organization.\n\n**Value Type:** `string`\n\n**Value:**\n\n* `https://<support.example.com>`  Use an `https://` link to open your company's internal help site.\n* `mailto:<yoursupport@example.com>`  Use a `mailto:` link to open your default mail client.\n\n### `switch_locked`\n\nAllows the user to turn off the WARP switch and disconnect the client.\n\n**Value Type:** `boolean`\n\n**Value:**\n\n* `false`  (default) The user is able to turn the switch on/off at their discretion. When the switch is off, the user will not have the ability to reach sites protected by Access that leverage certain device posture checks.\n* `true`  The user is prevented from turning off the switch. The WARP client will automatically start in the connected state.\n\nOn new deployments, you must also include the `auto_connect` parameter with at least a value of `0`. This will prevent clients from being deployed in the off state without a way for users to manually enable them.\n\nNote\n\nThis parameter replaces the old `enabled` property, which can no longer be used in conjunction with the new `switch_locked` and `auto_connect`. If you want to use these parameters, you must remove `enabled`.\n\n### `unique_client_id`\n\nNote\n\nOnly valid for iOS and Android/ChromeOS.\n\nAssigns a unique identifier to the device for the [device UUID posture check](https://developers.cloudflare.com/cloudflare-one/reusable-components/posture-checks/warp-client-checks/device-uuid).\n\n**Value Type:** `string`\n\n**Value:** UUID for the device (for example, `496c6124-db89-4735-bc4e-7f759109a6f1`).\n\n### `warp_tunnel_protocol`\n\nConfigures the protocol used to route IP traffic from the device to Cloudflare Gateway. For more information, refer to [Device tunnel protocol](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#device-tunnel-protocol).\n\n**Value Type:** `string`\n\n**Value:**\n\n* `masque`  (default) [MASQUE](https://datatracker.ietf.org/wg/masque/about/) protocol\n* `wireguard`  [WireGuard](https://www.wireguard.com/) protocol\n\n## Top-level parameters\n\nTop-level parameters determine how WARP manages device registrations.\n\n### `configs`\n\nAllows a user to [switch between Zero Trust organizations](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/switch-organizations/) in the WARP client GUI. The `configs` array is also required when using another [top-level parameter](#top-level-parameters) such as `multi_user` or `pre_login`, even if only one organization is specified.\n\n**Value Type:** `array`\n\n**Value:** An array containing one or more Zero Trust organizations.\n\n### `multi_user`\n\nEnables multiple user registrations on a Windows device.\n\n**Value Type:** `boolean`\n\n**Value:**\n\n* `false`  (default) Only one WARP registration is stored per device. After a user logs in to WARP, their settings and identity will apply to all traffic from the device.\n* `true`  Each Windows user has their own WARP registration. For more information, refer to [Multiple users on a Windows device](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-multiuser/).\n\n### `pre_login`\n\nAllows WARP to connect with a service token before a user completes the initial Windows login. For more information, refer to [Connect WARP before Windows login](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-prelogin/).\n\n## Per-app VPN parameters (Android)\n\n[Per-app VPN](https://support.google.com/work/android/answer/9213914?hl=en) parameters allow you to choose the Android apps that can send traffic through the WARP tunnel. Admins can configure these parameters via any MDM tool that supports deploying an Android app to managed devices or work profiles.\n\n### `app_identifier`\n\nAn application package name/bundle identifier which uniquely identifies the app on the Google Play Store. This application will be tunneled through the WARP service.\n\n**Value Type**: `string`\n\n**Value**: The app identifier can be found in the ID query parameter of the specific app's Play Store URL. For example: in the case of `https://play.google.com/store/apps/details?id=com.cloudflare.cloudflareoneagent`, the app identifier for the Cloudflare One Agent app is `com.cloudflare.cloudflareoneagent`.\n\n### `is_browser`\n\nAn optional property. `is_browser` will help the Cloudflare One Agent application decide which browser to open instead of the default browser for specific features such as re-authentication and Gateway block notifications. If needed, admins should explicitly indicate that a given `tunneled_app` is a browser, rather than relying on automatic browser detection.\n\n**Value Type**: `boolean`\n\n**Value**: If the value is `true`, identifies the application defined in `app_identifier` as a browser. The default value is `false` and `is_browser` is an optional property.\n\n## Footnotes\n\n1. Gateway with WARP is supported in client version 2025.2.664.0 and below. In version 2025.4.589.1 and above, this parameter does not apply to Gateway with WARP because all DoH traffic goes inside of the WARP tunnel. [](#user-content-fnref-1)\n\n</page>\n\n<page>\n---\ntitle: Deploy WARP with Technology Partners  Cloudflare One docs\ndescription: Cloudflare Zero Trust integrates with Cloudflare Technology Partner\n  tools to help you deploy the WARP client to bigger fleets of devices. Thanks\n  to these collaborations, you can distribute the WARP client application to\n  end-user devices and remotely set up advanced configurations in real time.\nlastUpdated: 2025-10-21T14:33:19.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/index.md\n---\n\nCloudflare Zero Trust integrates with [Cloudflare Technology Partner](https://www.cloudflare.com/partners/technology-partners/) tools to help you deploy the WARP client to bigger fleets of devices. Thanks to these collaborations, you can distribute the WARP client application to end-user devices and remotely set up advanced configurations in real time.\n\nThis is a list of Technology Partners Cloudflare Zero Trust works with:\n\n* [Fleet](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/fleet/)\n* [Hexnode](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/hexnode/)\n* [Intune](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/intune/)\n* [Jamf](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/jamf/)\n* [JumpCloud](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/jumpcloud/)\n* [Kandji](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/kandji/)\n\nIf you do not see your management software listed above, we can almost certainly still work with it. Refer to our [instructions for managed deployments](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/) to understand what configuration files are required.\n\n</page>\n\n<page>\n---\ntitle: Path MTU Discovery (PMTUD)  Cloudflare One docs\ndescription: The Maximum Transmission Unit (MTU) is the largest data packet size\n  that a device can send over a network without fragmentation. When you connect\n  to services through WARP, your data is encapsulated, which adds extra headers\n  and increases the overall packet size. On some networks, especially cellular\n  or guest Wi-Fi networks, the network's MTU may be smaller than WARP's default\n  packet size. This mismatch forces packets to be fragmented or dropped\n  entirely, leading to connection instability or complete connection failures.\nlastUpdated: 2025-12-02T16:07:23.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/path-mtu-discovery/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/path-mtu-discovery/index.md\n---\n\nFeature availability\n\n| [WARP modes](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/) | [Zero Trust plans](https://www.cloudflare.com/teams-pricing/) |\n| - | - |\n| * Gateway with WARP\n* Secure Web Gateway without DNS filtering | All plans |\n\n| System | Availability | Minimum WARP version |\n| - | - | - |\n| Windows |  | 2025.9.173.1 |\n| macOS |  | 2025.9.173.1 |\n| Linux |  | 2025.9.173.1 |\n| iOS |  | |\n| Android |  | |\n| ChromeOS |  | |\n\nThe [Maximum Transmission Unit (MTU)](https://www.cloudflare.com/learning/network-layer/what-is-mtu/) is the largest data packet size that a device can send over a network without fragmentation. When you connect to services through WARP, your data is encapsulated, which adds extra headers and increases the overall packet size. On some networks, especially cellular or guest Wi-Fi networks, the network's MTU may be smaller than WARP's [default packet size](#recommended-mtu). This mismatch forces packets to be fragmented or dropped entirely, leading to connection instability or complete connection failures.\n\nWARP's Path MTU Discovery (PMTUD) feature solves this problem by actively probing for the minimum MTU along the entire network path between the device and Cloudflare. WARP will then dynamically adjust its [tunnel interface](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/warp-architecture/#virtual-interface) MTU based on the probe results. This allows WARP to maintain a stable connection on low MTU networks and take advantage of higher MTUs when available.\n\nNote\n\nCertain features may be disabled or degraded at low MTU thresholds. For details, refer to [Minimum MTUs](#minimum-mtus).\n\n## Prerequisites\n\n* WARP must be configured to use the [MASQUE tunnel protocol](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-settings/#device-tunnel-protocol).\n\n## Enable Path MTU Discovery\n\nPMTUD is disabled by default. To enable PMTUD on your devices, [deploy an MDM file](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/#windows) with the `enable_pmtud` key set to `true`. For example:",
      "language": "unknown"
    },
    {
      "code": "This configuration enables the PMTUD feature and explicitly configures the MASQUE tunnel protocol.\n\nWARP will now send active probes to detect the network path MTU and will update its tunnel interface MTU accordingly. You can expect PMTUD probes to generate an extra 25 Mb/day of traffic coming from the device.\n\n## Minimum MTUs\n\n### Recommended MTU\n\nWARP requires the following MTUs for full functionality and performance:\n\n| Device tunnel protocol | IPv4 | IPv6 |\n| - | - | - |\n| WireGuard | 1340 bytes | 1360 bytes |\n| MASQUE | 1361 bytes | 1381 bytes |\n\n### Path MTU Discovery\n\nFor the PMTUD feature to work, the network path must support an MTU of at least 1281 bytes. The 1281 bytes consists of:\n\n* 1200 bytes: Minimum QUIC datagram\n* 53 bytes: WARP MASQUE encapsulation\n* 28 bytes: IP/UDP headers\n\n### IPv6\n\nTo send IPv6 traffic through WARP, the network path must support an MTU of at least 1361 bytes. The 1361 bytes consists of:\n\n* 1280 bytes: Minimum IPv6 packet size\n* 53 bytes: WARP MASQUE encapsulation\n* 28 bytes: IP/UDP headers\n\nIf PMTUD is enabled and the MTU is less than 1361 bytes, then WARP will automatically disable IPv6 on the tunnel interface.\n\n### WebRTC\n\nTo send WebRTC traffic through WARP, the network path must support an MTU of at least 1361 bytes. Below 1361 bytes, WebRTC connections will experience progressively degraded performance. This minimum MTU impacts [Cloudflare Browser Isolation](https://developers.cloudflare.com/cloudflare-one/remote-browser-isolation/) and any other website that uses WebRTC (such as video conferencing and media streaming services).\n\n## Check your MTU\n\nYou can check your current network path MTU by collecting [WARP diagnostic logs](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/warp-logs/).\n\n1. Run the `warp-diag` command on the device or [collect logs via the the dashboard](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/troubleshooting/warp-logs/#collect-logs-via-the-dashboard).\n\n2. Open the resulting `warp-debugging-info-<date>-<time>.zip` file.\n\n3. Open `connectivity.txt` and search for `PMTU`.",
      "language": "unknown"
    },
    {
      "code": "The example above shows an MTU of 1500 bytes, which meets the [recommended MTU requirements](#recommended-mtu) for WARP. If your MTU falls below the recommended threshold, consider [enabling Path MTU Discovery](#enable-path-mtu-discovery) to optimize connection performance.\n\n</page>\n\n<page>\n---\ntitle: Register WARP with minimal user interaction  Cloudflare One docs\ndescription: Administrators can automate WARP registration on managed devices\n  and minimize the number of clicks required from an end user.\nlastUpdated: 2025-10-30T21:17:22.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/protocol-handler/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/protocol-handler/index.md\n---\n\nAdministrators can automate WARP registration on managed devices and minimize the number of clicks required from an end user.\n\nDuring the default WARP enrollment process, end users typically need to complete several steps in order to login:\n\n1. Review Terms and Conditions in the WARP client GUI and acknowledge your company's use of Cloudflare WARP.\n2. Select their identity provider from the Cloudflare Access login screen.\n3. Complete the authentication steps required by the identity provider.\n4. Interact with a browser popup requesting permission to launch the WARP client.\n\nThis guide covers how to eliminate steps 1, 2 and 4 from your WARP deployment.\n\nService token authentication\n\nIf you are looking to eliminate all user interaction, you can [enroll devices using service tokens](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/device-enrollment/#check-for-service-token). Because users are not required to log in to an identity provider, identity-based policies and logging will not be available on these devices.\n\nOn iOS and Android / ChromeOS, end users will still be asked questions required by their platform such as accepting notifications or installing the VPN Profile.\n\n## Turn off onboarding screens\n\nTo skip the Terms and Conditions screens that are usually presented to users, set the [`onboarding` parameter](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/) to `false` in your [MDM deployment file](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/). Here is an example `mdm.xml` file:",
      "language": "unknown"
    },
    {
      "code": "## Turn on Instant Auth\n\nIf you are only using one identity provider for device enrollment, turn on **Instant Auth** in your [device enrollment permissions](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/device-enrollment/#set-device-enrollment-permissions). This allow users to skip the Cloudflare Access login page and go directly to your SSO login event.\n\n## Allow browser to launch WARP\n\nYou can configure your browser to automatically launch the Cloudflare WARP application after a successful login and skip the **Open Cloudflare WARP.app** popup.\n\n![Browser popup requesting permission to open WARP](https://developers.cloudflare.com/_astro/warp-protocol-handler.DL1xwNJc_ZsLho3.webp)\n\n### Chromium-based browsers\n\nChromium-based browsers such as Google Chrome and Microsoft Edge have a policy setting called [AutoLaunchProtocolsFromOrigins](https://learn.microsoft.com/en-us/DeployEdge/microsoft-edge-policies#autolaunchprotocolsfromorigins). This setting takes in two parameters: a protocol for the browser to launch and the origins that are allowed to launch it. For the browser to launch WARP, you need to set the protocol to `com.cloudflare.warp` and the origin to your Cloudflare Zero Trust team domain (`https://<your-team-name>.cloudflareaccess.com`).\n\n* Windows\n\n  On Windows, you can configure `AutoLaunchProtocolsFromOrigins` by adding a new registry key.\n\n  To add the registry key manually:\n\n  1. Open Registry Editor as Administrator.\n\n  2. Navigate to the policies folder for your browser:\n\n     * Google Chrome: `HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Google\\Chrome`\n     * Microsoft Edge: `HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Edge`\n\n     Note\n\n     You may need to create the `HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Google\\Chrome` folder if it does not already exist.\n\n  3. Create a new string value:\n\n     * **Value Name**: `AutoLaunchProtocolsFromOrigins`\n     * **Value Data**: `[{\"allowed_origins\": [\"https://<your-team-name>.cloudflareaccess.com/\"], \"protocol\": \"com.cloudflare.warp\"}]`\n\n     Be sure to replace `<your-team-name>` with your actual Zero Trust team name.\n\n  Instead of using the Registry Editor, the registry key can also be created using a Group Policy Object (GPO), PowerShell script, or with an MDM such as [Intune](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/intune/#update-mdm-parameters).\n\n* macOS\n\n  On macOS, you can configure `AutoLaunchProtocolsFromOrigins` by deploying a property list (plist) file for the browser. The exact instructions will vary depending on your [MDM](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/partners/). The general procedure is as follows:\n\n  1. Create a new plist file with the following name (case sensitive):\n\n     * Google Chrome: `com.google.Chrome.plist`\n     * Microsoft Edge: `com.microsoft.Edge.plist`\n\n  2. Using a text editor, add the following content to your plist:",
      "language": "unknown"
    },
    {
      "code": "Be sure to replace `<your-team-name>` with your actual Zero Trust team name.\n\n  3. Some MDMs require converting the `.plist` to a `.mobileconfig` before pushing it to a device. You can use a [file converter](https://github.com/timsutton/mcxToProfile) or modify the following example `com.google.Chrome.mobileconfig`:",
      "language": "unknown"
    },
    {
      "code": "4. Upload the `.plist` or `.mobileconfig` file to your preferred MDM.\n\n  5. Deploy the configuration profile to your devices.\n\n  For more information on configuring browser policies on macOS, refer to the [Google Chrome](https://support.google.com/chrome/a/answer/9020077?hl=en\\&ref_topic=7650028\\&sjid=15337530832025656704-NA) or [Microsoft Edge](https://learn.microsoft.com/en-us/deployedge/configure-microsoft-edge-on-mac) documentation.\n\n</page>\n\n<page>\n---\ntitle: Switch between Zero Trust organizations  Cloudflare One docs\ndescription: \"In Cloudflare WARP, users can switch between multiple Zero Trust\n  organizations (or other MDM parameters) that administrators specify in an MDM\n  file. Common use cases include:\"\nlastUpdated: 2025-11-21T21:36:55.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/switch-organizations/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/switch-organizations/index.md\n---\n\nFeature availability\n\n| [WARP modes](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/) | [Zero Trust plans](https://www.cloudflare.com/teams-pricing/) |\n| - | - |\n| All modes | All plans |\n\n| System | Availability | Minimum WARP version |\n| - | - | - |\n| Windows |  | 2024.1.159.0 |\n| macOS |  | 2024.1.160.0 |\n| Linux |  | 2024.2.62.0 |\n| iOS |  | 1.7 |\n| Android |  | 1.4 |\n| ChromeOS |  | 1.4 |\n\nIn Cloudflare WARP, users can switch between multiple Zero Trust organizations (or other [MDM parameters](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/parameters/)) that administrators specify in an MDM file. Common use cases include:\n\n* Allow IT security staff to switch between test and production environments.\n* Allow Managed Service Providers to support multiple customer accounts.\n* Allow users to switch between the default WARP ingress IPs and the [Cloudflare China ingress IPs](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/parameters/#override_warp_endpoint).\n\n## MDM file format\n\nTo enable multiple organizations, administrators need to modify their [MDM file](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/) to take an array of configurations. Each configuration must include a `display_name` parameter that will be visible to users in the WARP client GUI. Because display names are listed in the same order as they appear in the MDM file, we recommend putting the most used configurations at the top of the file. When a user opens the WARP client for the first time, they will be prompted to log into the first configuration in the list.\n\nAn MDM file supports a maximum of 25 configurations. The following example includes three configurations.\n\n### XML",
      "language": "unknown"
    },
    {
      "code": "### plist\n\n[Download](https://developers.cloudflare.com/cloudflare-one/static/mdm/multiple-orgs/com.cloudflare.warp.plist) an example `.plist` file.\n\n### mobileconfig\n\n[Download](https://developers.cloudflare.com/cloudflare-one/static/mdm/multiple-orgs/CloudflareWARP.mobileconfig) an example `.mobileconfig` file.\n\n## Switch organizations in WARP\n\n* Windows, macOS, and Linux\n\n  To switch to a different organization as a user:\n\n  1. Open the WARP client on your device.\n\n  2. Select the gear icon.\n\n  3. Select **Switch configurations**. The menu will show the organizations that the admin has configured for your device.\n\n  4. Select the organization that you want to connect to.\n\n  5. If prompted, complete the authentication steps required for the new organization. Your authentication information will be saved and you will be able to switch back and forth between organizations.\n\n  Note\n\n  Only admins can [add additional organizations](#mdm-file-format) to the WARP GUI. To connect to an organization that is not displayed in the GUI, go to **Preferences > Account** to manually log out of the old organization and log into the new organization.\n\n* iOS and Android\n\n  To switch to a different organization as a user:\n\n  1. Open the WARP client on your device.\n\n  2. Go to Settings > Advanced.\n\n  3. Select **Switch configurations**. The menu will show the organizations that the admin has configured for your device.\n\n  4. Select the organization that you want to connect to.\n\n  5. If prompted, complete the authentication steps required for the new organization. Your authentication information will be saved and you will be able to switch back and forth between organizations.\n\n  Note\n\n  Only admins can [add additional organizations](#mdm-file-format) to the WARP GUI. To connect to an organization that is not displayed in the GUI, go to **Settings > Account** to manually log out of the old organization and log into the new organization.\n\n### Troubleshooting\n\nWhen switching organizations or connecting for the first time, keep the following in mind:\n\n* If this is the first time connecting to an organization, web browsers like Chrome may require a full restart to correctly recognize and trust the organization's root certificate. Cloudflare recommends closing all browser windows after the initial connection. All subsequent switches should not require a restart.\n* On macOS, ensure the specific CA certificate for the new organization is properly trusted by verifying its status in Keychain Access.\n* Switching configurations may sometimes momentarily disconnect the WARP client. If this occurs, simply re-enable WARP to restore the connection.\n\n</page>\n\n<page>\n---\ntitle: Multiple users on a Windows device  Cloudflare One docs\ndescription: Cloudflare WARP supports multiple user registrations on a single\n  Windows device. When deployed in multi-user mode, the WARP client will\n  automatically switch user registrations after a user logs in to their Windows\n  account. All traffic to Cloudflare will be attributed to the currently active\n  Windows user. This allows administrators to apply identity-based policies and\n  device settings, audit user activity, and remove individual users from a\n  shared workstation.\nlastUpdated: 2025-10-21T14:33:19.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-multiuser/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-multiuser/index.md\n---\n\nFeature availability\n\n| [WARP modes](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/) | [Zero Trust plans](https://www.cloudflare.com/teams-pricing/) |\n| - | - |\n| All modes | All plans |\n\n| System | Availability | Minimum WARP version |\n| - | - | - |\n| Windows |  | 2025.6.1400.0 |\n| macOS |  | |\n| Linux |  | |\n| iOS |  | |\n| Android |  | |\n| ChromeOS |  | |\n\nCloudflare WARP supports multiple user registrations on a single Windows device. When deployed in multi-user mode, the WARP client will automatically switch user registrations after a user logs in to their Windows account. All traffic to Cloudflare will be attributed to the currently active Windows user. This allows administrators to apply identity-based policies and device settings, audit user activity, and remove individual users from a shared workstation.\n\nDNS logging\n\nIf a user enables **Log DNS queries** in the WARP GUI (or runs `warp-cli dns log enable`), WARP will store all DNS queries on the device onto disk. Any user on the device will be able to examine the DNS queries of another user.\n\n## Enable multi-user mode\n\nTo enable multi-user support on Windows, [deploy an MDM file](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/#windows) onto the device with the `multi_user` key set to `true`. For example:",
      "language": "unknown"
    },
    {
      "code": "To use multi-user mode alongside the [Windows pre-login](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-prelogin/) and [Switch between Zero Trust organizations](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/switch-organizations/) options:",
      "language": "unknown"
    },
    {
      "code": "When enabling multi-user mode for the first time, users will need to re-register even if they had a previous registration.\n\n## WARP registration logic\n\nThe following flowchart shows how WARP registration settings take effect as users log in and out:",
      "language": "unknown"
    },
    {
      "code": "### Fast user switching\n\nNote\n\nRequires [multi-user mode](#enable-multi-user-mode).\n\n[Fast user switching](https://learn.microsoft.com/windows/win32/shell/fast-user-switching) is a Windows feature that allows users to switch accounts without logging out. With fast user switching, multiple users may be logged in to the device and generating network traffic. The WARP client will attribute all traffic to the user who has the [interactive windows station](http://techcommunity.microsoft.com/blog/askperf/sessions-desktops-and-windows-stations/372473). For example, if user A is logged in and fast user switches to user B, traffic from both accounts will appear to come from user B. This is because user B is now actively using the Windows desktop GUI. Now assume that user B logs out and there is no [pre-login registration](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-prelogin/); WARP will continue to attribute traffic to user B until user A logs back in to the Windows desktop.\n\nTo accurately attribute network traffic to specific users, Cloudflare recommends disabling fast user switching or at the very least configuring a [pre-login registration](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-prelogin/).\n\n</page>\n\n<page>\n---\ntitle: Connect WARP before Windows login  Cloudflare One docs\ndescription: With Cloudflare Zero Trust, you can use an on-premise Active\n  Directory (or similar) server to validate a remote user's Windows login\n  credentials. Before the user enters their Windows login information for the\n  first time, the WARP client establishes a connection using a service token.\n  This initial connection is not associated with a user identity. Once the user\n  completes the Windows login, WARP switches to an identity-based session and\n  applies the user registration to all future logins.\nlastUpdated: 2025-11-20T23:13:05.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-prelogin/\n  md: https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-prelogin/index.md\n---\n\nFeature availability\n\n| [WARP modes](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/warp-modes/) | [Zero Trust plans](https://www.cloudflare.com/teams-pricing/) |\n| - | - |\n| * Gateway with WARP\n* Gateway with DoH\n* Secure Web Gateway without DNS filtering\n* Proxy mode | All plans |\n\n| System | Availability | Minimum WARP version |\n| - | - | - |\n| Windows |  | 2025.6.1400.0 |\n| macOS |  | |\n| Linux |  | |\n| iOS |  | |\n| Android |  | |\n| ChromeOS |  | |\n\nWith Cloudflare Zero Trust, you can use an on-premise Active Directory (or similar) server to validate a remote user's Windows login credentials. Before the user enters their Windows login information for the first time, the WARP client establishes a connection using a service token. This initial connection is not associated with a user identity. Once the user completes the Windows login, WARP switches to an identity-based session and applies the user registration to all future logins.\n\n## Prerequisites\n\n* Active Directory resources are [connected to Cloudflare](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/private-net/).\n\n## 1. Create a service token\n\n* Dashboard\n\n  1. In [Cloudflare One](https://one.dash.cloudflare.com), go to **Access controls** > **Service credentials** > **Service Tokens**.\n\n  2. Select **Create Service Token**.\n\n  3. Name the service token. The name allows you to easily identify events related to the token in the logs and to revoke the token individually.\n\n  4. Choose a **Service Token Duration**. This sets the expiration date for the token.\n\n  5. Select **Generate token**. You will see the generated Client ID and Client Secret for the service token, as well as their respective request headers.\n\n  6. Copy the Client Secret.\n\n     Warning\n\n     This is the only time Cloudflare Access will display the Client Secret. If you lose the Client Secret, you must generate a new service token.\n\n* API\n\n  1. Make a `POST` request to the [Access Service Tokens](https://developers.cloudflare.com/api/resources/zero_trust/subresources/access/subresources/service_tokens/methods/create/) endpoint:\n\n     Required API token permissions\n\n     At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n     * `Access: Service Tokens Write`",
      "language": "unknown"
    },
    {
      "code": "2. Copy the `client_id` and `client_secret` values returned in the response.",
      "language": "unknown"
    },
    {
      "code": "Warning\n\n     This is the only time Cloudflare Access will display the Client Secret. If you lose the Client Secret, you must generate a new service token.\n\n* Terraform (v5)\n\n  1. Add the following permission to your [`cloudflare_api_token`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/api_token):\n\n     * `Access: Service Tokens Write`\n\n  2. Configure the [`cloudflare_zero_trust_access_service_token`](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/zero_trust_access_service_token) resource:",
      "language": "unknown"
    },
    {
      "code": "3. Get the Client ID and Client Secret of the service token:\n\n     Example: Output to CLI\n\n     1. Output the Client ID and Client Secret to the Terraform state file:",
      "language": "unknown"
    },
    {
      "code": "2. Apply the configuration:",
      "language": "unknown"
    },
    {
      "code": "3. Read the Client ID and Client Secret:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Example: Store in HashiCorp Vault",
      "language": "unknown"
    },
    {
      "code": "## 2. Create a device enrollment policy\n\nIn your [device enrollment permissions](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/device-enrollment/#set-device-enrollment-permissions), create the following policy:\n\n| Rule Action | Rule type | Selector | Value |\n| - | - | - | - |\n| Service Auth | Include | Service Token | `<TOKEN-NAME>` |\n\n## 2. (Optional) Restrict access during pre-login\n\nDevices enrolled via a service token are identified by the email address `non_identity@<team-name>.cloudflareaccess.com`. Using this email address, you can apply specific [device profile settings](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/configure-warp/device-profiles/) and [Gateway network policies](https://developers.cloudflare.com/cloudflare-one/traffic-policies/network-policies/) during the pre-login state. For example, you could provide access to only those resources necessary to complete the Windows login and/or device management activities.\n\nExample device profile rule\n\n| Selector | Operator | Value | Logic |\n| - | - | - | - |\n| User email | in | `non_identity@<team-name>.cloudflareaccess.com` | And |\n| Operating system | is | Windows | |\n\nExample Gateway network policy\n\n| Selector | Operator | Value | Logic |\n| - | - | - | - |\n| Destination IP | in list | `Active Directory servers` | And |\n| User email | in | `non_identity@<team-name>.cloudflareaccess.com` | And |\n| Passed Device Posture Checks | in | `Windows 10 or higher (OS version)` | |\n\n| Action |\n| - |\n| Allow |\n\n## 3. Configure the MDM file\n\nTo enable the Windows pre-login feature, an MDM file in the following format must be [deployed](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/#windows) on the device. In the following example, the `pre_login` key allows the device to connect using the service token, while `configs` contains your default Zero Trust configuration.",
      "language": "unknown"
    },
    {
      "code": "WARP will apply the pre-login configuration when no other WARP registration exists and the user has not yet logged into Windows. When the pre-login configuration is in effect, the device will appear on **Team & Resources** > **Devices** with the email `non_identity@<team-name>.cloudflareaccess.com`.\n\nAfter the user logs into Windows, WARP will automatically switch to the default MDM configuration and prompt the user to authenticate with the IdP. Once authenticated, WARP registers and connects with the user identity. The **Team & Resources** > **Devices** page will now show a new device associated with the user's email.\n\nIf [multi-user mode](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-multiuser/) is turned off, this user registration will be used for any subsequent connections, including before the next Windows user login. Deleting the user registration would cause WARP to switch back to the pre-login configuration as soon as the user logs out of Windows.\n\nTo learn how the pre-login configuration works with [multi-user mode](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-multiuser/), refer to the [WARP registration flowchart](https://developers.cloudflare.com/cloudflare-one/team-and-resources/devices/warp/deployment/mdm-deployment/windows-multiuser/#warp-registration-logic).\n\n</page>\n\n<page>\n---\ntitle: Deliver emails to the junk email folder - Office 365  Cloudflare Email\n  security (formerly Area 1) docs\ndescription: In this tutorial, you will learn to deliver SUSPICIOUS and BULK\n  messages to the user's junk email folder, and MALICIOUS, SPAM, and SPOOF\n  messages to the Administrative Quarantine (this requires an administrator to\n  release the emails).\nlastUpdated: 2025-10-27T15:00:52.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/email-security/deployment/inline/setup/office-365-area1-mx/use-cases/five-junk-admin-quarantine/\n  md: https://developers.cloudflare.com/email-security/deployment/inline/setup/office-365-area1-mx/use-cases/five-junk-admin-quarantine/index.md\n---\n\nIn this tutorial, you will learn to deliver `SUSPICIOUS` and `BULK` messages to the user's junk email folder, and `MALICIOUS`, `SPAM`, and `SPOOF` messages to the Administrative Quarantine (this requires an administrator to release the emails).\n\n## Configure domains\n\nYou first need to configure the domains you are onboarding on the Email Security (formerly Area 1) dashboard. To configure your domains:\n\n1. Log in to the [Email Security dashboard](https://horizon.area1security.com/).\n\n2. Go to **Settings** (the gear icon).\n\n3. Go to **Email configuration** > **Domains & Routing** > **Domains**.\n\n4. Make sure each domain you are onboarding has been added.\n\n5. For each domain you are configuring, select **...** > **Edit**, and set the following options:\n\n   * **Domain** - `<YOUR_DOMAIN>`.\n   * **Configured as** - `MX Records`.\n   * **Forwarding to** - This should match the expected MX record for each domain in your [Office 365 account](https://admin.microsoft.com/#/Domains/).\n   * **IP Restrictions** - Leave this field empty.\n   * **Outbound TLS** - `Forward all messages over TLS`.\n   * **Quarantine Policy** - Do not check any dispositions.\n\n## Configure anti-spam policies\n\nTo configure anti-spam policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Policies**, select **Anti-spam**.\n\n5. Select the **Anti-spam inbound policy (Default)** text (not the checkbox).\n\n6. In **Actions**, scroll down and select **Edit actions**.\n\n   ![Go to Actions and find Edit actions](https://developers.cloudflare.com/_astro/step6-edit-actions.T4_p91g__FX92f.webp)\n\n7. Set the following conditions and actions (you might need to scroll up or down to find them):\n\n* **Spam**: *Move messages to Junk Email folder*.\n\n* **High confidence spam**: *Quarantine message*.\n  * **Select quarantine policy**: \\_AdminOnlyAccessPolicy\\_.\n\n* **Phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_AdminOnlyAccessPolicy\\_.\n\n* **High confidence phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_AdminOnlyAccessPolicy\\_.\n\n* **Retain spam in quarantine for this many days**: Default is 15 days. Email Security (formerly Area 1) recommends 15-30 days.\n\n  * Select the spam actions in the above step:\n\n    ![Select the spam actions in the above step](https://developers.cloudflare.com/_astro/case2-step7-spam.DSFGImyT_2jgw9V.webp)\n\n1. Select **Save**.\n\n## Create transport rules\n\nTo create the transport rules that will send emails with certain dispositions to Email Security:\n\n1. Open the new [Exchange admin center](https://admin.exchange.microsoft.com/#/homepage).\n\n2. Go to **Mail flow** > **Rules**.\n\n3. Select **Add a Rule** > **Create a new rule**.\n\n4. Set the following rule conditions:\n\n   * **Name**: *Email security Deliver to Junk Email folder\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-Area1Security-Disposition` > **Save**.\n     * **Enter words**: `` `SUSPICIOUS`, `BULK` `` > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs page](https://developers.cloudflare.com/email-security/deployment/inline/reference/egress-ips/).\n\n   * **Do the following** - *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_5\\_*.\n\n1) Select **Next**.\n\n2) You can use the default values on this screen. Select **Next**.\n\n3) Review your settings and select **Finish** > **Done**.\n\n4) Select the rule Email security Deliver to Junk Email folder\\` you have just created, and **Enable**.\n\n5) Select **Add a Rule** > **Create a new rule**.\n\n6) Set the following rule conditions:\n\n   * **Name**: *\\`Area 1 Admin Managed Host Quarantine\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-Area1Security-Disposition` > **Save**.\n     * **Enter words**: *\\`MALICIOUS\\`, \\`UCE\\`, \\`SPOOF\\`* > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs page](https://developers.cloudflare.com/email-security/deployment/inline/reference/egress-ips/).\n\n   * **Do the following**: *\\_Redirect the message to\\_ > \\_hosted quarantine\\_*.\n\n1. Select **Next**.\n\n2. You can use the default values on this screen. Select **Next**.\n\n3. Review your settings and select **Finish** > **Done**.\n\n4. Select the rule *\\`Area 1 Admin Managed Host Quarantine\\`* you have just created, and select **Enable**.\n\n</page>\n\n<page>\n---\ntitle: User managed quarantine and administrative quarantine - Office 365 \n  Cloudflare Email security (formerly Area 1) docs\ndescription: In this tutorial, you will learn to deliver SPAM and SPOOF messages\n  to the user managed quarantine, and MALICIOUS messages to the administrative\n  quarantine (this requires an administrator to release the emails).\nlastUpdated: 2025-10-27T15:00:52.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/email-security/deployment/inline/setup/office-365-area1-mx/use-cases/four-user-quarantine-admin-quarantine/\n  md: https://developers.cloudflare.com/email-security/deployment/inline/setup/office-365-area1-mx/use-cases/four-user-quarantine-admin-quarantine/index.md\n---\n\nIn this tutorial, you will learn to deliver `SPAM` and `SPOOF` messages to the user managed quarantine, and `MALICIOUS` messages to the administrative quarantine (this requires an administrator to release the emails).\n\n## Configure domains\n\nYou first need to configure the domains you are onboarding on the Email Security (formerly Area 1) dashboard. To configure your domains:\n\n1. Log in to the [Email Security dashboard](https://horizon.area1security.com/).\n\n2. Go to **Settings** (the gear icon).\n\n3. Go to **Email configuration** > **Domains & Routing** > **Domains**.\n\n4. Make sure each domain you are onboarding has been added.\n\n5. For each domain you are configuring, select **...** > **Edit**, and set the following options:\n\n   * **Domain** - `<YOUR_DOMAIN>`.\n   * **Configured as** - `MX Records`.\n   * **Forwarding to** - This should match the expected MX record for each domain in your [Office 365 account](https://admin.microsoft.com/#/Domains/).\n   * **IP Restrictions** - Leave this field empty.\n   * **Outbound TLS** - `Forward all messages over TLS`.\n   * **Quarantine Policy** - Do not check any dispositions.\n\n## Create quarantine policies\n\nTo create quarantine policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Add custom policy**.\n\n6. Set the **Policy name** to `UserNotifyUserRelease`.\n\n7. Select **Next**.\n\n8. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n   * In **Select release action preference**, choose *Allow recipients to release a message from quarantine*.\n   * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n   ![Configure the Recipient message access as stated in the step above](https://developers.cloudflare.com/_astro/step8-allow-message-release.C-1nPIVh_Z1GhJps.webp)\n\n9. Select **Next**.\n\n10. In **Quarantine notification**, select **Enable**.\n\n11. Select **Next**.\n\n12. Review your settings and select **Submit**.\n\n13. Select **Done**.\n\n14. Select **Add custom policy**.\n\n15. Set the **Policy name** to `UserNotifyAdminRelease`.\n\n16. Select **Next**.\n\n17. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n    * In **Select release action preference**, from the drop-down menu, choose *Allow recipients to request a message to be released from quarantine*.\n    * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n    ![Configure the Recipient message access as stated in the step above](https://developers.cloudflare.com/_astro/step8-request-message-release.DVEdlfTt_10mYfB.webp)\n\n18. Select **Next**.\n\n19. In **Quarantine notification**, select **Enable**.\n\n20. Select **Next**.\n\n21. Review your settings and select **Submit**.\n\n22. Select **Done**.\n\n## Configure quarantine notifications\n\nTo configure quarantine notifications:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Global settings**.\n\n6. Scroll to the bottom and set the desired frequency in **Send end-user spam notifications every (days)**. This value can only be incremented in days.\n\n   ![Configure the desired spam notification frequency](https://developers.cloudflare.com/_astro/step6-spam-notifications.5FY4mM54_Z2e4aOK.webp)\n\n7. Select **Save**.\n\n## Configure anti-spam policies\n\nTo configure anti-spam policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/)\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Policies**, select **Anti-spam**.\n\n5. Select the **Anti-spam inbound policy (Default)** text (not the checkbox).\n\n6. In the **Actions** section, scroll down and select **Edit actions**.\n\n   ![Go to Actions and find Edit actions](https://developers.cloudflare.com/_astro/step6-edit-actions.T4_p91g__FX92f.webp)\n\n7. Set the following conditions and actions (you might need to scroll up or down to find them):\n\n   * **Spam**: *Quarantine message*.\n     * **Select quarantine policy**: *UserNotifyUserRelease*.\n   * **High confidence spam**: *Quarantine message*.\n     * **Select quarantine policy**: *UserNotifyAdminRelease*.\n   * **Phishing**: *Quarantine message*.\n     * **Select quarantine policy**: *UserNotifyAdminRelease*.\n   * **High confidence phishing**: *Quarantine message*.\n     * **Select quarantine policy**: *UserNotifyAdminRelease*.\n   * **Retain spam in quarantine for this many days**: Default is 15 days. Email security recommends 15-30 days.\n\n   ![Select the spam actions in the above step](https://developers.cloudflare.com/_astro/step7-quarantine-message-case4.Bz4nU_HV_Z2qGHaq.webp)\n\n8. Select **Save**.\n\n## Create transport rules\n\nTo create the transport rules that will send emails with certain dispositions to Email Security:\n\n1. Open the new [Exchange admin center](https://admin.exchange.microsoft.com/#/homepage).\n\n2. Go to **Mail flow** > **Rules**.\n\n3. Select **Add a Rule** > **Create a new rule**.\n\n4. Set the following rule conditions:\n\n   * **Name**: *\\`Email security User Quarantine Message\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-Area1Security-Disposition` > **Save**.\n     * **Enter words**: `` `UCE`, `SPOOF` `` > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs page](https://developers.cloudflare.com/email-security/deployment/inline/reference/egress-ips/).\n\n   * **Do the following** - *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_5\\_*.\n\n1) Select **Next**.\n\n2) You can use the default values on this screen. Select **Next**.\n\n3) Review your settings and select **Finish** > **Done**.\n\n4) Select the rule \\`Email security User Quarantine Message\\` you have just created, and **Enable**.\n\n5) Select **Add a Rule** > **Create a new rule**.\n\n6) Set the following rule conditions:\n\n   * **Name**: *\\`Email security User Quarantine Message Admin Release\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-Area1Security-Disposition` > **Save**.\n     * **Enter words**: *\\`MALICIOUS\\`* > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs page](https://developers.cloudflare.com/email-security/deployment/inline/reference/egress-ips/).\n\n   * **Do the following**: *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_9\\_*.\n\n1. Select **Next**.\n\n2. You can use the default values on this screen. Select **Next**.\n\n3. Review your settings and select **Finish** > **Done**.\n\n4. Select the rule *\\`Email security User Quarantine Message Admin Release\\`* you have just created, and select **Enable**.\n\n</page>\n\n<page>\n---\ntitle: Junk email and Email security (formerly Area 1) Admin Quarantine - Office\n  365  Cloudflare Email security (formerly Area 1) docs\ndescription: In this tutorial, you will learn how to deliver emails to the\n  Office 365 junk email folder and the Admin Quarantine in Email security.\nlastUpdated: 2025-10-27T15:00:52.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/email-security/deployment/inline/setup/office-365-area1-mx/use-cases/one-junk-admin-quarantine/\n  md: https://developers.cloudflare.com/email-security/deployment/inline/setup/office-365-area1-mx/use-cases/one-junk-admin-quarantine/index.md\n---\n\nIn this tutorial, you will learn how to deliver emails to the Office 365 junk email folder and the Admin Quarantine in Email security.\n\n## Configure domains\n\nYou first need to configure the domains you are onboarding on the Email Security (formerly Area 1) dashboard. To configure your domains:\n\n1. Log in to the [Email Security dashboard](https://horizon.area1security.com/).\n\n2. Go to **Settings** (the gear icon).\n\n3. Go to **Email configuration** > **Domains & Routing** > **Domains**.\n\n4. Make sure each domain you are onboarding has been added.\n\n5. For each domain you are configuring, select **...** > **Edit**, and set the following options:\n\n   * **Domain** - `<YOUR_DOMAIN>`.\n   * **Configured as** - `MX Records`.\n   * **Forwarding to** - This should match the expected MX record for each domain in your [Office 365 account](https://admin.microsoft.com/#/Domains/).\n   * **IP Restrictions** - Leave this field empty.\n   * **Outbound TLS** - `Forward all messages over TLS`.\n   * **Quarantine Policy** - Check the \\`MALICIOUS\\`, \\`SPAM\\`, and \\`SPOOF\\` dispositions.\n\n## Create quarantine policies\n\nTo create quarantine policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/)\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Add custom policy**.\n\n6. Set the **Policy name** to `UserNotifyAdminRelease`.\n\n7. Select **Next**.\n\n8. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n   * In **Select release action preference**, choose *Allow recipients to request a message to be released from quarantine*.\n   * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n   ![Configure the Recipient message access as stated in the step above](https://developers.cloudflare.com/_astro/step8-request-message-release.DVEdlfTt_10mYfB.webp)\n\n9. Select **Next**.\n\n10. In **Quarantine notification**, select **Enable**.\n\n11. Select **Next**.\n\n12. Review your settings and select **Submit**.\n\n13. Select **Done**.\n\n## Configure quarantine notifications\n\nTo configure quarantine notifications:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Global settings**.\n\n6. Scroll to the bottom and set the desired frequency in **Send end-user spam notifications every (days)**. This value can only be incremented in days.\n\n   ![Configure the desired spam notification frequency](https://developers.cloudflare.com/_astro/step6-spam-notifications.5FY4mM54_Z2e4aOK.webp)\n\n7. Select **Save**.\n\n## Configure anti-spam policies\n\nTo configure anti-spam policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Policies**, select **Anti-spam**.\n\n5. Select the **Anti-spam inbound policy (Default)** text (not the checkbox).\n\n6. In **Actions**, scroll down and select **Edit actions**.\n\n   ![Go to Actions and find Edit actions](https://developers.cloudflare.com/_astro/step6-edit-actions.T4_p91g__FX92f.webp)\n\n7. Set the following conditions and actions (you might need to scroll up or down to find them):\n\n* **Spam**: *Move messages to Junk Email folder*.\n\n* **High confidence spam**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n\n* **Phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n\n* **High confidence phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n\n* **Retain spam in quarantine for this many days**: Default is 15 days. Email Security (formerly Area 1) recommends 15-30 days.\n\n  * Select the spam actions in the above step:\n\n    ![Select the spam actions in the above step](https://developers.cloudflare.com/_astro/case2-step7-spam.DSFGImyT_2jgw9V.webp)\n\n1. Select **Save**.\n\n## Create transport rules\n\nTo create the transport rules that will send emails with certain dispositions to Email security:\n\n1. Open the new [Exchange admin center](https://admin.exchange.microsoft.com/#/homepage).\n\n2. Go to **Mail flow** > **Rules**.\n\n3. Select **Add a Rule** > **Create a new rule**.\n\n4. Set the following rule conditions:\n\n   * **Name**: `Email security Deliver to Junk Email folder`.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-Area1Security-Disposition` > **Save**.\n     * **Enter words**: `SUSPICIOUS`, `BULK` > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs page](https://developers.cloudflare.com/email-security/deployment/inline/reference/egress-ips/).\n\n   * **Do the following** - *Modify the message properties* > *Set the Spam Confidence Level (SCL)* > *5*.\n\n   ![Set the rules in the above step](https://developers.cloudflare.com/_astro/step4-rules.BHhczWth_23FC11.webp)\n\n5. Select **Next**.\n\n6. You can use the default values on this screen. Select **Next**.\n\n7. Review your settings and select **Finish** > **Done**.\n\n8. Select the rule `Email security Deliver to Junk Email folder` you have just created, and select **Enable**.\n\n</page>\n\n<page>\n---\ntitle: Junk email and administrative quarantine - Office 365  Cloudflare Email\n  security (formerly Area 1) docs\ndescription: In this tutorial, you will learn how to deliver SUSPICIOUS and BULK\n  messages to the users's junk email folder, and MALICIOUS, SPAM, and SPOOF\n  messages to the administrative quarantine (this requires an administrator to\n  release the emails).\nlastUpdated: 2025-08-22T14:24:45.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/email-security/deployment/inline/setup/office-365-area1-mx/use-cases/three-junk-admin-quarantine/\n  md: https://developers.cloudflare.com/email-security/deployment/inline/setup/office-365-area1-mx/use-cases/three-junk-admin-quarantine/index.md\n---\n\nIn this tutorial, you will learn how to deliver `SUSPICIOUS` and `BULK` messages to the users's junk email folder, and `MALICIOUS`, `SPAM`, and `SPOOF` messages to the administrative quarantine (this requires an administrator to release the emails).\n\n## Configure domains\n\nYou first need to configure the domains you are onboarding on the Email Security (formerly Area 1) dashboard. To configure your domains:\n\n1. Log in to the [Email Security dashboard](https://horizon.area1security.com/).\n\n2. Go to **Settings** (the gear icon).\n\n3. Go to **Email configuration** > **Domains & Routing** > **Domains**.\n\n4. Make sure each domain you are onboarding has been added.\n\n5. For each domain you are configuring, select **...** > **Edit**, and set the following options:\n\n   * **Domain** - `<YOUR_DOMAIN>`.\n   * **Configured as** - `MX Records`.\n   * **Forwarding to** - This should match the expected MX record for each domain in your [Office 365 account](https://admin.microsoft.com/#/Domains/).\n   * **IP Restrictions** - Leave this field empty.\n   * **Outbound TLS** - `Forward all messages over TLS`.\n   * **Quarantine Policy** - Do not check any dispositions.\n\n## Create quarantine policies\n\nTo create quarantine policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/)\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Add custom policy**.\n\n6. Set the **Policy name** to `UserNotifyAdminRelease`.\n\n7. Select **Next**.\n\n8. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n   * In **Select release action preference**, choose *Allow recipients to request a message to be released from quarantine*.\n   * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n   ![Configure the Recipient message access as stated in the step above](https://developers.cloudflare.com/_astro/step8-request-message-release.DVEdlfTt_10mYfB.webp)\n\n9. Select **Next**.\n\n10. In **Quarantine notification**, select **Enable**.\n\n11. Select **Next**.\n\n12. Review your settings and select **Submit**.\n\n13. Select **Done**.\n\n## Configure quarantine notifications\n\nTo configure quarantine notifications:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Global settings**.\n\n6. Scroll to the bottom and set the desired frequency in **Send end-user spam notifications every (days)**. This value can only be incremented in days.\n\n   ![Configure the desired spam notification frequency](https://developers.cloudflare.com/_astro/step6-spam-notifications.5FY4mM54_Z2e4aOK.webp)\n\n7. Select **Save**.\n\n## Configure anti-spam policies\n\nTo configure anti-spam policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Policies**, select **Anti-spam**.\n\n5. Select the **Anti-spam inbound policy (Default)** text (not the checkbox).\n\n6. In **Actions**, scroll down and select **Edit actions**.\n\n   ![Go to Actions and find Edit actions](https://developers.cloudflare.com/_astro/step6-edit-actions.T4_p91g__FX92f.webp)\n\n7. Set the following conditions and actions (you might need to scroll up or down to find them):\n\n* **Spam**: *Move messages to Junk Email folder*.\n\n* **High confidence spam**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n\n* **Phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n\n* **High confidence phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n\n* **Retain spam in quarantine for this many days**: Default is 15 days. Email Security (formerly Area 1) recommends 15-30 days.\n\n  * Select the spam actions in the above step:\n\n    ![Select the spam actions in the above step](https://developers.cloudflare.com/_astro/case2-step7-spam.DSFGImyT_2jgw9V.webp)\n\n1. Select **Save**.\n\n## Create transport rules\n\nTo create the transport rules that will send emails with certain dispositions to Email Security:\n\n1. Open the new [Exchange admin center](https://admin.exchange.microsoft.com/#/homepage).\n\n2. Go to **Mail flow** > **Rules**.\n\n3. Select **Add a Rule** > **Create a new rule**.\n\n4. Set the following rule conditions:\n\n   * **Name**: *\\`Area 1 Deliver to Junk Email folder\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-Area1Security-Disposition` > **Save**.\n     * **Enter words**: `` `SUSPICIOUS`, `BULK` `` > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs page](https://developers.cloudflare.com/email-security/deployment/inline/reference/egress-ips/).\n\n   * **Do the following** - *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_5\\_*.\n\n1) Select **Next**.\n\n2) You can use the default values on this screen. Select **Next**.\n\n3) Review your settings and select **Finish** > **Done**.\n\n4) Select the rule \\`Area 1 Deliver to Junk Email folder\\` you have just created, and **Enable**.\n\n5) Select **Add a Rule** > **Create a new rule**.\n\n6) Set the following rule conditions:\n\n   * **Name**: *\\`Area 1 User Quarantine Message\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-Area1Security-Disposition` > **Save**.\n     * **Enter words**: *\\`MALICIOUS\\`, \\`UCE\\`, \\`SPOOF\\`* > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs page](https://developers.cloudflare.com/email-security/deployment/inline/reference/egress-ips/).\n\n   * **Do the following**: *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_9\\_*.\n\n1. Select **Next**.\n\n2. You can use the default values on this screen. Select **Next**.\n\n3. Review your settings and select **Finish** > **Done**.\n\n4. Select the rule *\\`Area 1 User Quarantine Message\\`* you have just created, and select **Enable**.\n\n</page>\n\n<page>\n---\ntitle: Junk email and user managed quarantine - Office 365  Cloudflare Email\n  security (formerly Area 1) docs\ndescription: In this tutorial, you will learn how to deliver SUSPICIOUS and BULK\n  messages to the user's junk folder, and SPAM and SPOOF messages to the user\n  managed quarantine.\nlastUpdated: 2025-08-22T14:24:45.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/email-security/deployment/inline/setup/office-365-area1-mx/use-cases/two-junk-user-quarantine/\n  md: https://developers.cloudflare.com/email-security/deployment/inline/setup/office-365-area1-mx/use-cases/two-junk-user-quarantine/index.md\n---\n\nIn this tutorial, you will learn how to deliver `SUSPICIOUS` and `BULK` messages to the user's junk folder, and `SPAM` and `SPOOF` messages to the user managed quarantine.\n\n## Configure domains\n\nYou first need to configure the domains you are onboarding on the Email Security (formerly Area 1) dashboard. To configure your domains:\n\n1. Log in to the [Email Security dashboard](https://horizon.area1security.com/).\n\n2. Go to **Settings** (the gear icon).\n\n3. Go to **Email configuration** > **Domains & Routing** > **Domains**.\n\n4. Make sure each domain you are onboarding has been added.\n\n5. For each domain you are configuring, select **...** > **Edit**, and set the following options:\n\n   * **Domain** - `<YOUR_DOMAIN>`.\n   * **Configured as** - `MX Records`.\n   * **Forwarding to** - This should match the expected MX record for each domain in your [Office 365 account](https://admin.microsoft.com/#/Domains/).\n   * **IP Restrictions** - Leave this field empty.\n   * **Outbound TLS** - `Forward all messages over TLS`.\n   * **Quarantine Policy** - Only MALICIOUS dispotions should be checked.\n\n## Create quarantine policies\n\nTo create quarantine policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Add custom policy**.\n\n6. Set the **Policy name** to `UserNotifyUserRelease`.\n\n7. Select **Next**.\n\n8. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n   * In **Select release action preference**, choose *Allow recipients to release a message from quarantine*.\n   * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n   ![Configure the Recipient message access as stated in the step above](https://developers.cloudflare.com/_astro/step8-allow-message-release.C-1nPIVh_Z1GhJps.webp)\n\n9. Select **Next**.\n\n10. In **Quarantine notification**, select **Enable**.\n\n11. Select **Next**.\n\n12. Review your settings and select **Submit**.\n\n13. Select **Done**.\n\n14. Select **Add custom policy**.\n\n15. Set the **Policy name** to `UserNotifyAdminRelease`.\n\n16. Select **Next**.\n\n17. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n    * In **Select release action preference**, from the drop-down menu, choose *Allow recipients to request a message to be released from quarantine*.\n    * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n    ![Configure the Recipient message access as stated in the step above](https://developers.cloudflare.com/_astro/step8-request-message-release.DVEdlfTt_10mYfB.webp)\n\n18. Select **Next**.\n\n19. In **Quarantine notification**, select **Enable**.\n\n20. Select **Next**.\n\n21. Review your settings and select **Submit**.\n\n22. Select **Done**.\n\n## Configure quarantine notifications\n\nTo configure quarantine notifications:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Global settings**.\n\n6. Scroll to the bottom and set the desired frequency in **Send end-user spam notifications every (days)**. This value can only be incremented in days.\n\n   ![Configure the desired spam notification frequency](https://developers.cloudflare.com/_astro/step6-spam-notifications.5FY4mM54_Z2e4aOK.webp)\n\n7. Select **Save**.\n\n## Configure anti-spam policies\n\nTo configure anti-spam policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Policies**, select **Anti-spam**.\n\n5. Select the **Anti-spam inbound policy (Default)** text (not the checkbox).\n\n6. In **Actions**, scroll down and select **Edit actions**.\n\n   ![Go to Actions and find Edit actions](https://developers.cloudflare.com/_astro/step6-edit-actions.T4_p91g__FX92f.webp)\n\n7. Set the following conditions and actions (you might need to scroll up or down to find them):\n\n* **Spam**: *Move messages to Junk Email folder*.\n\n* **High confidence spam**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyUserRelease\\_.\n\n* **Phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n\n* **High confidence phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n\n* **Retain spam in quarantine for this many days**: Default is 15 days. Email Security (formerly Area 1) recommends 15-30 days.\n\n  * Select the spam actions in the above step:\n\n    ![Select the spam actions in the above step](https://developers.cloudflare.com/_astro/case2-step7-spam.DSFGImyT_2jgw9V.webp)\n\n1. Select **Save**.\n\n## Create transport rules\n\nTo create the transport rules that will send emails with certain dispositions to Email Security:\n\n1. Open the new [Exchange admin center](https://admin.exchange.microsoft.com/#/homepage).\n\n2. Go to **Mail flow** > **Rules**.\n\n3. Select **Add a Rule** > **Create a new rule**.\n\n4. Set the following rule conditions:\n\n   * **Name**: *\\`Area 1 Deliver to Junk Email folder\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-Area1Security-Disposition` > **Save**.\n     * **Enter words**: `` `SUSPICIOUS`, `BULK` `` > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs page](https://developers.cloudflare.com/email-security/deployment/inline/reference/egress-ips/).\n\n   * **Do the following** - *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_5\\_*.\n\n1) Select **Next**.\n\n2) You can use the default values on this screen. Select **Next**.\n\n3) Review your settings and select **Finish** > **Done**.\n\n4) Select the rule \\`Area 1 Deliver to Junk Email folder\\` you have just created, and **Enable**.\n\n5) Select **Add a Rule** > **Create a new rule**.\n\n6) Set the following rule conditions:\n\n   * **Name**: *\\`Area 1 User Quarantine Message\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-Area1Security-Disposition` > **Save**.\n     * **Enter words**: *\\`UCE\\`, \\`SPOOF\\`* > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs page](https://developers.cloudflare.com/email-security/deployment/inline/reference/egress-ips/).\n\n   * **Do the following**: *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_9\\_*.\n\n1. Select **Next**.\n\n2. You can use the default values on this screen. Select **Next**.\n\n3. Review your settings and select **Finish** > **Done**.\n\n4. Select the rule *\\`Area 1 User Quarantine Message\\`* you have just created, and select **Enable**.\n\n</page>\n\n<page>\n---\ntitle: Add BCC rules  Cloudflare One docs\ndescription: This page will show you how to add BCC rules in the Google Admin Console.\nlastUpdated: 2025-11-28T17:39:34.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/add-bcc-rules/\n  md: https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/add-bcc-rules/index.md\n---\n\nThis page will show you how to add BCC rules in the Google Admin Console.\n\nBCC stands for Blind Carbon Copy. A BCC rule is a Google Workspace feature that allows you to create a secure copy of all selected outbound and inbound emails. When you allow Email security to receive a copy of your emails, Cloudflare can perform post-delivery analysis to protect your email inbox.\n\nTo add BCC rules:\n\n1. Log in to the [Google Admin Console](https://admin.google.com/).\n\n2. On the sidebar, go to **Apps** > **Google Workspace** > **Gmail** > **Compliance**.\n\n3. Go to **Content Compliance** > Select **Edit**.\n\n4. Add a **Content Compliance** filter, and name it `Email security - BCC`.\n\n5. In **Email messages to affect**, select **Inbound**.\n\n6. Select the recipients you want to send emails to Email security via BCC. Under **Add expressions that describe the content you want to search for in each message**:\n\n   * Select **If ANY of the following match the message**.\n\n   * Select **Add** to configure the expression.\n\n     * Select **Advanced content match**.\n     * In **Location**, select **Headers + Body**.\n     * In **Match type**, select **Matches regex**.\n     * In **Regexp**, input `.*`. You can customize the regex as needed and test within the admin page or on sites like [Regexr](https://regexr.com/).\n     * Select **SAVE**.\n\n7. In **If the above expressions match, do the following**:\n\n   * Select **Modify message**.\n\n     * Ensure that **Envelope recipient** > **Change envelope recipient** is unselected, so that emails will not be dropped as an unintended consequence. You will select this option at a later stage.\n\n     * Go to **Also deliver to**, select **Add more recipients** > **ADD** > Choose **Advanced**:\n\n       * Under **Envelope recipient**, select **Change envelope recipient** > **Replace recipient** > Enter the service address. This is the service address you copied and pasted in step 5 when [connecting your domains](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/connect-domains/). If you did not copy and paste the service address: - In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Email security**. - Go to **Settings** and locate your domain under **Your domains**. - Select the three dots > **View domain** > **Service address**. Copy and paste the service address.\n       * Under **Spam and delivery options**, ensure **Suppress bounces from this recipient** is not enabled.\n       * Under **Headers**, select **Add X-Gm-Spam and X-Gm-Phishy headers**.\n       * Select **SAVE**.\n\n8. In **Account types to affect**, select **Users** and **Groups**.\n\n9. Select **SAVE**.\n\nTo verify that BCC rules have been configured successfully:\n\n1. In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Email security** > **Settings**.\n2. Select **Domains** > **View**.\n3. Locate your domain. Under Status, the dashboard should display **Active**. This means that the BCC rules have been configured successfully, and your mail flow is being detected.\n\n</page>\n\n<page>\n---\ntitle: Enable Gmail BCC integration  Cloudflare One docs\ndescription: This guide describes the process for enabling Email security with\n  Google Workspace. It requires setting up a service account and a JSON key in\n  Google Cloud Platform (GCP), followed by configuring domain-wide delegation in\n  the Google Workspace Admin Console to authorize the integration.\nlastUpdated: 2025-11-28T14:54:16.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/enable-gmail-integration/\n  md: https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/enable-gmail-integration/index.md\n---\n\nThis guide describes the process for enabling Email security with Google Workspace. It requires setting up a [service account](https://docs.cloud.google.com/iam/docs/service-account-overview) and a JSON key in Google Cloud Platform (GCP), followed by configuring domain-wide delegation in the Google Workspace Admin Console to authorize the integration.\n\n## Prerequisites\n\nTo use Email security, you will need to have:\n\n* A [Cloudflare account](https://dash.cloudflare.com/sign-up)\n* A [Zero Trust organization](https://developers.cloudflare.com/cloudflare-one/setup/#create-a-zero-trust-organization)\n* A domain to protect\n\n## Enable Gmail BCC integration:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/).\n2. Select **Email security**.\n3. Select **Overview**. Select one of the following options:\n\n* If you have not purchased Email security, select **Contact sales**.\n\n* If you have not associated any integration:\n\n  * Select **Set up**, then choose **BCC/Journaling**.\n  * Select **Integrate with Google** > **Authorize**.\n  * Name your integration, then select **Next**.\n  * Go to [step 1](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/enable-gmail-integration/#1-create-a-service-account-in-your-gcp-project) to continue the process of associating an integration.\n\n* If you have associated an integration, but have not connected a domain:\n\n  * Select **Connect a domain**.\n  * Choose **BCC/Journaling** > **Integrate with Google**.\n  * Refer to [Connect your domains](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/connect-domains/) to connect your domain(s).\n\n### 1. Create a Service Account in your GCP Project\n\n1. Once you have named your integration, select **Next**.\n\n2. On the [Google Cloud Console](https://console.cloud.google.com/welcome/new), go to the sidebar, select **APIs & Services**, then select **Credentials**.\n\n3. Select **CREATE CREDENTIALS** > **Service account**. Refer to [Service accounts overview](https://docs.cloud.google.com/iam/docs/service-account-overview) to learn more about service accounts.\n\n4. Fill in the details to create a service account:\n\n   * **Service account name**: Enter `Cloudflare Google Integration`.\n   * **Service account ID**: Enter `cloudflare-google-integration`.\n   * **Service account description**: Enter `Cloudflare Google Integration`.\n   * Select **CREATE AND CONTINUE**.\n\n### 2. Create a JSON Key for your Service Account\n\nOn the [Google Cloud Console](https://console.cloud.google.com/welcome/new):\n\n1. On the sidebar, select **IAM & Admim** > **Service Accounts**.\n2. Locate your email, select the three dots, then select **Manage keys**.\n3. Select **Add key** > **Create new key**.\n4. Select **JSON** > Select **CREATE**. This downloads a `.json` file which you will use when [uploading a JSON key](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/enable-gmail-integration/#3-upload-json-key).\n\n### 3. Upload JSON Key\n\nOn the [Cloudflare One dashboard](https://one.dash.cloudflare.com/), upload the `.json` file downloaded on step 3.\n\n### 4. Enable Necessary Google Workspace APIs in GCP\n\nEnable the following APIs on the Google Cloud Console:\n\n* [Google Calendar API](https://console.cloud.google.com/apis/library/calendar-json.googleapis.com?project=winter-surf-439414-h1)\n* [Google Drive API](https://console.cloud.google.com/apis/library/drive.googleapis.com?project=winter-surf-439414-h1)\n* [Google Admin SDK API](https://console.cloud.google.com/apis/library/admin.googleapis.com?project=winter-surf-439414-h1)\n* [Gmail API](https://console.cloud.google.com/apis/library/gmail.googleapis.com?project=winter-surf-439414-h1)\n* [Google Service Usage API](https://console.cloud.google.com/apis/library/serviceusage.googleapis.com?project=winter-surf-439414-h1)\n\n### 5. Log in to Google Workspace Admin Console\n\nLog in to Google Workspace Admin Console: Enter your password and log in to the Google Workspace Admin Console.\n\n### 6. Create a Domain-Wide Delegation API Client\n\n1. Copy the **Client ID** and **Scopes** displayed on the Cloudflare One dashboard.\n2. On Google Admin, go to **Security** > **Access and data control** > **API controls**.\n3. Select **MANAGE DOMAIN WIDE DELEGATION** > **Add new**.\n4. Use the Client ID and copy the scopes to create a new API client. Refer to [Delegate domain-wide authority to your service account](https://cloud.google.com/chronicle/docs/soar/marketplace-integrations/google-alert-center?_gl=1*skktsb*_ga*MTMxODg5NDExMy4xNzI5NjA1MzYy*_ga_WH2QY8WWF5*MTcyOTc3MDg2Ny40LjEuMTcyOTc3MDg5OC4yOS4wLjA.#delegate_domain-wide_authority_to_your_service_account). Then, select **Next**.\n\n### 7. Confirm Workspace Administrator Email\n\nEnter the email associated with the Google Workspace Administrator account. Your email must match the email associated with your Google Workspace account, or else your integration will not work.\n\n### 8. Create integration\n\n1. Select **Create integration**.\n2. Once you created your integration, you will be redirected to the **Review details** page, where you will be able to review **Integration details**.\n3. Review your details, then select **Complete Email security set up** > **Continue to Email security**.\n\n## Verify integration\n\nTo verify that the integration has been successful:\n\n1. In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Integrations**.\n2. Under **Your integrations**, locate your integration, and ensure that the integration displays **CASB+EMAIL** under **Type**.\n\nNote\n\nIf you do not reach the step to complete the Email security set up:\n\n1. Go to **Integrations** > **Cloud & SaaS Integrations** > **Integrations**.\n2. Delete the integration, if present. Locate your integration, select **Configure**, then select **Delete**.\n3. Follow the steps from the beginning to [enable Gmail BCC integration](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/enable-gmail-integration/#enable-gmail-bcc-integration).\n\n## Next steps\n\nNow that you have created an integration:\n\n* [Connect your domains](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/connect-domains/) for Email security to start scanning your inbox.\n* [Enable logs](https://developers.cloudflare.com/cloudflare-one/insights/logs/enable-logs/) to send detection data to an endpoint of your choice.\n\n</page>\n\n<page>\n---\ntitle: Enable auto-moves  Cloudflare One docs\ndescription: \"If you do not have an integration:\"\nlastUpdated: 2025-10-27T15:00:52.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/enable-auto-moves/\n  md: https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/enable-auto-moves/index.md\n---\n\nIf you do not have an integration:\n\n1. In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Email security**.\n2. Go to **Settings** > **Domain management** > **Domains** > select **View**.\n3. Locate your domain, select the three dots > Select **Associate an integration**.\n4. Select **Connect an integration**. You will then be redirected to the **Add an integration** page.\n5. Select **Google Workspace CASB+EMAIL** > **Select Integration**.\n6. Once you select an integration, you can [enable Gmail BCC integration](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/enable-gmail-integration/#enable-gmail-bcc-integration).\n\n</page>\n\n<page>\n---\ntitle: Connect your domains  Cloudflare One docs\ndescription: To connect your domains, you will need to enable your Gmail BCC\n  integration. Once you have enabled your Gmail BCC integration, the Cloudflare\n  dashboard will redirect you to the Set up Email security page.\nlastUpdated: 2025-12-03T11:00:02.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/connect-domains/\n  md: https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/connect-domains/index.md\n---\n\nTo connect your domains, you will need to [enable your Gmail BCC integration](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/enable-gmail-integration/#enable-gmail-bcc-integration). Once you have enabled your Gmail BCC integration, the Cloudflare dashboard will redirect you to the **Set up Email security** page.\n\nOn the **Set up Email security** page:\n\n1. **Connect domains**: Select at least one domain. Then, select **Continue**.\n2. (**Optional**) **Add manual domains**: Select **Add domain name** to manually enter additional domains. Then, select **Continue**.\n3. (**Optional**) **Adjust hop count**: Enter the number of hops. Then, select **Continue**. Configuring the hop count will determine where you want Cloudflare to sit in the email processing chain.\n4. (**Optional**, select **Skip for now** to skip this step) **Move messages**: Refer to [Auto-moves](https://developers.cloudflare.com/cloudflare-one/email-security/settings/auto-moves/) to configure auto-moves. Then, select **Continue**.\n5. **Select your processing location**: Configure where you want Cloudflare to process your email. **Global** will be the default option. If you choose **Global**, `<account tag>@CF-emailsecurity.com` will be your regional service address. Once you have chosen your processing location, select **Continue**.\n6. **Review details**: Review your connected domains and service addresses. Then, select **Go to domains.**\n\nYour domains are now added successfully.\n\nOn the **Domains** page, select the three dots > **View integration**. The dashboard will display your [domain information](https://developers.cloudflare.com/cloudflare-one/email-security/settings/domain-management/domain/).\n\nUnder **Source**, the dashboard will display **Google integration**, along with the **Integration name**.\n\n## Add additional domains\n\nTo add additional domains:\n\n1. In [Cloudflare One](https://one.dash.cloudflare.com/), go to **Email security** > **Settings**.\n\n2. Select **Connect an integration** > **BCC/Journaling** > **Integrate with Google** > **Authorize**.\n\n3. **Connect domains**: Select the domains you want to add, then select **Next**.\n\n4. (Optional) Select **Add manual domains**: Enter additional domains manually, then select **Next**.\n\n5. (Optional) Select **Adjust hop count**: Enter the number of hops.\n\n6. **Review details**: Review your selected domains, then use the following email to configure the service address with your third-party email provider:",
      "language": "unknown"
    },
    {
      "code": "7. Select **Save**.\n\n## Verify successful deployment\n\nTo verify that the deployment has been successful and that your emails are being scanned:\n\n1. In [Cloudflare One](https://one.dash.cloudflare.com/), select **Email security**.\n2. Go to **Settings** > **Domain management** > **Domains**, then select **View**.\n3. Under **Your domains**, locate your domain, and verify that **Status** (which describes the state of the configuration) displays **Active**.\n\n</page>\n\n<page>\n---\ntitle: Overview  Cloudflare One docs\ndescription: For customers using Gmail as their email provider, setting up Email\n  security is quick and easy.\nlastUpdated: 2025-12-08T21:48:49.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/gmail-bcc-setup/\n  md: https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/gmail-bcc-setup/index.md\n---\n\nFor customers using Gmail as their email provider, setting up Email security is quick and easy.\n\nYou will need to [create an integration](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/enable-gmail-integration/), [add BCC rules](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/add-bcc-rules/), and [connect your domain(s)](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/connect-domains/). You can choose to [add additional domains](https://developers.cloudflare.com/cloudflare-one/email-security/setup/post-delivery-deployment/bcc-journaling/bcc-setup/gmail-bcc-setup/connect-domains/#add-additional-domains) at a later stage.\n\nOnce you set up Google integration, Email security will receive a copy of your email messages. You will need a Google integration to enable [auto-moves](https://developers.cloudflare.com/cloudflare-one/email-security/settings/auto-moves/).\n\nThe following email flow shows how this works:\n\n![Gmail BCC deployment flow](https://developers.cloudflare.com/_astro/Gmail_Deployment_BCC.YSoTUoiz_WVGh7.webp)\n\n</page>\n\n<page>\n---\ntitle: Deliver emails to the junk email folder - Microsoft 365  Cloudflare One docs\ndescription: In this tutorial, you will learn to deliver BULK messages to the\n  user's junk email folder, and MALICIOUS, SPAM, and SPOOF messages to the\n  Administrative Quarantine (this requires an administrator to release the\n  emails).\nlastUpdated: 2025-10-27T15:00:52.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/prerequisites/m365-email-security-mx/use-cases/five-junk-admin-quarantine/\n  md: https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/prerequisites/m365-email-security-mx/use-cases/five-junk-admin-quarantine/index.md\n---\n\nIn this tutorial, you will learn to deliver `BULK` messages to the user's junk email folder, and `MALICIOUS`, `SPAM`, and `SPOOF` messages to the Administrative Quarantine (this requires an administrator to release the emails).\n\n## Configure anti-spam policies\n\nTo configure anti-spam policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Policies**, select **Anti-spam**.\n\n5. Select the **Anti-spam inbound policy (Default)** text (not the checkbox).\n\n6. In **Actions**, scroll down and select **Edit actions**.\n\n7. Set the following conditions and actions (you might need to scroll up or down to find them):\n\n* **Spam**: *Move messages to Junk Email folder*.\n* **High confidence spam**: *Quarantine message*.\n  * **Select quarantine policy**: \\_AdminOnlyAccessPolicy\\_.\n* **Phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_AdminOnlyAccessPolicy\\_.\n* **High confidence phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_AdminOnlyAccessPolicy\\_.\n* **Retain spam in quarantine for this many days**: Default is 15 days. Email security recommends 15-30 days.\n  * Select the spam actions in the above step.\n\n1. Select **Save**.\n\n## Create transport rules\n\nTo create the transport rules that will send emails with certain [disposition](https://developers.cloudflare.com/cloudflare-one/email-security/reference/dispositions-and-attributes/#dispositions) to Email security:\n\n1. Open the new [Exchange admin center](https://admin.exchange.microsoft.com/#/homepage).\n\n2. Go to **Mail flow** > **Rules**.\n\n3. Select **Add a Rule** > **Create a new rule**.\n\n4. Set the following rule conditions:\n\n   * **Name**: *Email security Deliver to Junk Email folder\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-CFEmailSecurity-Disposition` > **Save**.\n     * **Enter words**: `BULK` > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs](https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/egress-ips/) page.\n\n   * **Do the following** - *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_5\\_*.\n\n5. Select **Next**.\n\n6. You can use the default values on this screen. Select **Next**.\n\n7. Review your settings and select **Finish** > **Done**.\n\n8. Select the rule Email security Deliver to Junk Email folder\\` you have just created, and **Enable**.\n\n9. Select **Add a Rule** > **Create a new rule**.\n\n10. Set the following rule conditions:\n\n    * **Name**: *\\`Email security Admin Managed Host Quarantine\\`*.\n\n    * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n      * **Enter text**: `X-CFEmailSecurity-Disposition` > **Save**.\n      * **Enter words**: *\\`MALICIOUS\\`, \\`UCE\\`, \\`SPOOF\\`* > **Add** > **Save**.\n\n    * **Apply this rule if**: Select **+** to add a second condition.\n\n    * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs](https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/egress-ips/) page.\n\n    * **Do the following**: *\\_Redirect the message to\\_ > \\_hosted quarantine\\_*.\n\n11. Select **Next**.\n\n12. You can use the default values on this screen. Select **Next**.\n\n13. Review your settings and select **Finish** > **Done**.\n\n14. Select the rule *\\`Email security Admin Managed Host Quarantine\\`* you have just created, and select **Enable**.\n\n</page>\n\n<page>\n---\ntitle: User managed quarantine and administrative quarantine - Microsoft 365 \n  Cloudflare One docs\ndescription: In this tutorial, you will learn to deliver SPAM and SPOOF messages\n  to the user managed quarantine, and MALICIOUS messages to the administrative\n  quarantine (this requires an administrator to release the emails).\nlastUpdated: 2025-10-27T15:00:52.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/prerequisites/m365-email-security-mx/use-cases/four-user-quarantine-admin-quarantine/\n  md: https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/prerequisites/m365-email-security-mx/use-cases/four-user-quarantine-admin-quarantine/index.md\n---\n\nIn this tutorial, you will learn to deliver `SPAM` and `SPOOF` messages to the user managed quarantine, and `MALICIOUS` messages to the administrative quarantine (this requires an administrator to release the emails).\n\n## Create quarantine policies\n\nTo create quarantine policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Add custom policy**.\n\n6. Set the **Policy name** to `UserNotifyUserRelease`.\n\n7. Select **Next**.\n\n8. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n   * In **Select release action preference**, choose *Allow recipients to release a message from quarantine*.\n   * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n9. Select **Next**.\n\n10. In **Quarantine notification**, select **Enable**.\n\n11. Select **Next**.\n\n12. Review your settings and select **Submit**.\n\n13. Select **Done**.\n\n14. Select **Add custom policy**.\n\n15. Set the **Policy name** to `UserNotifyAdminRelease`.\n\n16. Select **Next**.\n\n17. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n    * In **Select release action preference**, from the drop-down menu, choose *Allow recipients to request a message to be released from quarantine*.\n    * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n18. Select **Next**.\n\n19. In **Quarantine notification**, select **Enable**.\n\n20. Select **Next**.\n\n21. Review your settings and select **Submit**.\n\n22. Select **Done**.\n\n## Configure quarantine notifications\n\nTo configure quarantine notifications:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Global settings**.\n\n6. Scroll to the bottom and set the desired frequency in **Send end-user spam notifications every (days)**. This value can only be incremented in days.\n\n7. Select **Save**.\n\n## Configure anti-spam policies\n\nTo configure anti-spam policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/)\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Policies**, select **Anti-spam**.\n\n5. Select the **Anti-spam inbound policy (Default)** text (not the checkbox).\n\n6. In the **Actions** section, scroll down and select **Edit actions**.\n\n7. Set the following conditions and actions (you might need to scroll up or down to find them):\n\n   * **Spam**: *Quarantine message*.\n     * **Select quarantine policy**: *UserNotifyUserRelease*.\n   * **High confidence spam**: *Quarantine message*.\n     * **Select quarantine policy**: *UserNotifyAdminRelease*.\n   * **Phishing**: *Quarantine message*.\n     * **Select quarantine policy**: *UserNotifyAdminRelease*.\n   * **High confidence phishing**: *Quarantine message*.\n     * **Select quarantine policy**: *UserNotifyAdminRelease*.\n   * **Retain spam in quarantine for this many days**: Default is 15 days. Email security recommends 15-30 days.\n\n8. Select **Save**.\n\n## Create transport rules\n\nTo create the transport rules that will send emails with certain [disposition](https://developers.cloudflare.com/cloudflare-one/email-security/reference/dispositions-and-attributes/#dispositions) to Email security:\n\n1. Open the new [Exchange admin center](https://admin.exchange.microsoft.com/#/homepage).\n\n2. Go to **Mail flow** > **Rules**.\n\n3. Select **Add a Rule** > **Create a new rule**.\n\n4. Set the following rule conditions:\n\n   * **Name**: *\\`Email security User Quarantine Message\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-CFEmailSecurity-Disposition` > **Save**.\n     * **Enter words**: `` `UCE`, `SPOOF` `` > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs](https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/egress-ips/) page.\n\n   * **Do the following** - *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_5\\_*.\n\n5. Select **Next**.\n\n6. You can use the default values on this screen. Select **Next**.\n\n7. Review your settings and select **Finish** > **Done**.\n\n8. Select the rule \\`Email security User Quarantine Message\\` you have just created, and **Enable**.\n\n9. Select **Add a Rule** > **Create a new rule**.\n\n10. Set the following rule conditions:\n\n    * **Name**: *\\`Email security User Quarantine Message Admin Release\\`*.\n\n    * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n      * **Enter text**: `X-CFEmailSecurity-Disposition` > **Save**.\n      * **Enter words**: *\\`MALICIOUS\\`* > **Add** > **Save**.\n\n    * **Apply this rule if**: Select **+** to add a second condition.\n\n    * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs](https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/egress-ips/) page.\n\n    * **Do the following**: *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_9\\_*.\n\n11. Select **Next**.\n\n12. You can use the default values on this screen. Select **Next**.\n\n13. Review your settings and select **Finish** > **Done**.\n\n14. Select the rule *\\`Email security User Quarantine Message Admin Release\\`* you have just created, and select **Enable**.\n\n</page>\n\n<page>\n---\ntitle: Junk email and user managed quarantine - Microsoft 365  Cloudflare One docs\ndescription: In this tutorial, you will learn how to deliver BULK messages to\n  the user's junk folder, and SPAM and SPOOF messages to the user managed\n  quarantine.\nlastUpdated: 2025-10-27T15:00:52.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/prerequisites/m365-email-security-mx/use-cases/two-junk-user-quarantine/\n  md: https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/prerequisites/m365-email-security-mx/use-cases/two-junk-user-quarantine/index.md\n---\n\nIn this tutorial, you will learn how to deliver `BULK` messages to the user's junk folder, and `SPAM` and `SPOOF` messages to the user managed quarantine.\n\n## Create quarantine policies\n\nTo create quarantine policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Add custom policy**.\n\n6. Set the **Policy name** to `UserNotifyUserRelease`.\n\n7. Select **Next**.\n\n8. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n   * In **Select release action preference**, choose *Allow recipients to release a message from quarantine*.\n   * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n9. Select **Next**.\n\n10. In **Quarantine notification**, select **Enable**.\n\n11. Select **Next**.\n\n12. Review your settings and select **Submit**.\n\n13. Select **Done**.\n\n14. Select **Add custom policy**.\n\n15. Set the **Policy name** to `UserNotifyAdminRelease`.\n\n16. Select **Next**.\n\n17. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n    * In **Select release action preference**, from the drop-down menu, choose *Allow recipients to request a message to be released from quarantine*.\n    * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n18. Select **Next**.\n\n19. In **Quarantine notification**, select **Enable**.\n\n20. Select **Next**.\n\n21. Review your settings and select **Submit**.\n\n22. Select **Done**.\n\n## Configure quarantine notifications\n\nTo configure quarantine notifications:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Global settings**.\n\n6. Scroll to the bottom and set the desired frequency in **Send end-user spam notifications every (days)**. This value can only be incremented in days.\n\n7. Select **Save**.\n\n## Configure anti-spam policies\n\nTo configure anti-spam policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Policies**, select **Anti-spam**.\n\n5. Select the **Anti-spam inbound policy (Default)** text (not the checkbox).\n\n6. In **Actions**, scroll down and select **Edit actions**.\n\n7. Set the following conditions and actions (you might need to scroll up or down to find them):\n\n* **Spam**: *Move messages to Junk Email folder*.\n* **High confidence spam**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyUserRelease\\_.\n* **Phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n* **High confidence phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n* **Retain spam in quarantine for this many days**: Default is 15 days. Email security recommends 15-30 days.\n  * Select the spam actions in the above step.\n\n1. Select **Save**.\n\n## Create transport rules\n\nTo create the transport rules that will send emails with certain [disposition](https://developers.cloudflare.com/cloudflare-one/email-security/reference/dispositions-and-attributes/#dispositions) to Email security:\n\n1. Open the new [Exchange admin center](https://admin.exchange.microsoft.com/#/homepage).\n\n2. Go to **Mail flow** > **Rules**.\n\n3. Select **Add a Rule** > **Create a new rule**.\n\n4. Set the following rule conditions:\n\n   * **Name**: *\\`Email security Deliver to Junk Email folder\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-CFEmailSecurity-Disposition` > **Save**.\n     * **Enter words**: `BULK` > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs](https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/egress-ips/) page.\n\n   * **Do the following** - *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_5\\_*.\n\n5. Select **Next**.\n\n6. You can use the default values on this screen. Select **Next**.\n\n7. Review your settings and select **Finish** > **Done**.\n\n8. Select the rule \\`Email security Deliver to Junk Email folder\\` you have just created, and **Enable**.\n\n9. Select **Add a Rule** > **Create a new rule**.\n\n10. Set the following rule conditions:\n\n    * **Name**: *\\`Email security User Quarantine Message\\`*.\n\n    * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n      * **Enter text**: `X-CFEmailSecurity-Disposition` > **Save**.\n      * **Enter words**: *\\`UCE\\`, \\`SPOOF\\`* > **Add** > **Save**.\n\n    * **Apply this rule if**: Select **+** to add a second condition.\n\n    * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs](https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/egress-ips/) page.\n\n    * **Do the following**: *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_9\\_*.\n\n11. Select **Next**.\n\n12. You can use the default values on this screen. Select **Next**.\n\n13. Review your settings and select **Finish** > **Done**.\n\n14. Select the rule *\\`Email security User Quarantine Message\\`* you have just created, and select **Enable**.\n\n</page>\n\n<page>\n---\ntitle: Junk email and administrative quarantine - Microsoft 365  Cloudflare One docs\ndescription: In this tutorial, you will learn how to deliver BULK messages to\n  the users's junk email folder, and MALICIOUS, SPAM, and SPOOF messages to the\n  administrative quarantine (this requires an administrator to release the\n  emails).\nlastUpdated: 2025-10-27T15:00:52.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/prerequisites/m365-email-security-mx/use-cases/three-junk-admin-quarantine/\n  md: https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/prerequisites/m365-email-security-mx/use-cases/three-junk-admin-quarantine/index.md\n---\n\nIn this tutorial, you will learn how to deliver `BULK` messages to the users's junk email folder, and `MALICIOUS`, `SPAM`, and `SPOOF` messages to the administrative quarantine (this requires an administrator to release the emails).\n\n## Create quarantine policies\n\nTo create quarantine policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/)\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Add custom policy**.\n\n6. Set the **Policy name** to `UserNotifyAdminRelease`.\n\n7. Select **Next**.\n\n8. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n   * In **Select release action preference**, choose *Allow recipients to request a message to be released from quarantine*.\n   * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n9. Select **Next**.\n\n10. In **Quarantine notification**, select **Enable**.\n\n11. Select **Next**.\n\n12. Review your settings and select **Submit**.\n\n13. Select **Done**.\n\n## Configure quarantine notifications\n\nTo configure quarantine notifications:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Global settings**.\n\n6. Scroll to the bottom and set the desired frequency in **Send end-user spam notifications every (days)**. This value can only be incremented in days.\n\n7. Select **Save**.\n\n## Configure anti-spam policies\n\nTo configure anti-spam policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Policies**, select **Anti-spam**.\n\n5. Select the **Anti-spam inbound policy (Default)** text (not the checkbox).\n\n6. In **Actions**, scroll down and select **Edit actions**.\n\n7. Set the following conditions and actions (you might need to scroll up or down to find them):\n\n* **Spam**: *Move messages to Junk Email folder*.\n* **High confidence spam**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n* **Phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n* **High confidence phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n* **Retain spam in quarantine for this many days**: Default is 15 days. Email security recommends 15-30 days.\n  * Select the spam actions in the above step.\n\n1. Select **Save**.\n\n## Create transport rules\n\nTo create the transport rules that will send emails with certain [disposition](https://developers.cloudflare.com/cloudflare-one/email-security/reference/dispositions-and-attributes/#dispositions) to Email security:\n\n1. Open the new [Exchange admin center](https://admin.exchange.microsoft.com/#/homepage).\n\n2. Go to **Mail flow** > **Rules**.\n\n3. Select **Add a Rule** > **Create a new rule**.\n\n4. Set the following rule conditions:\n\n   * **Name**: *\\`Email security Deliver to Junk Email folder\\`*.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-CFEmailSecurity-Disposition` > **Save**.\n     * **Enter words**: `BULK` > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs](https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/egress-ips/) page.\n\n   * **Do the following** - *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_5\\_*.\n\n5. Select **Next**.\n\n6. You can use the default values on this screen. Select **Next**.\n\n7. Review your settings and select **Finish** > **Done**.\n\n8. Select the rule \\`Email security Deliver to Junk Email folder\\` you have just created, and **Enable**.\n\n9. Select **Add a Rule** > **Create a new rule**.\n\n10. Set the following rule conditions:\n\n    * **Name**: *\\`Email security User Quarantine Message\\`*.\n\n    * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n      * **Enter text**: `X-CFEmailSecurity-Disposition` > **Save**.\n      * **Enter words**: *\\`MALICIOUS\\`, \\`UCE\\`, \\`SPOOF\\`* > **Add** > **Save**.\n\n    * **Apply this rule if**: Select **+** to add a second condition.\n\n    * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs](https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/egress-ips/) page.\n\n    * **Do the following**: *\\_Modify the message properties\\_ > \\_Set the Spam Confidence Level (SCL)\\_ > \\_9\\_*.\n\n11. Select **Next**.\n\n12. You can use the default values on this screen. Select **Next**.\n\n13. Review your settings and select **Finish** > **Done**.\n\n14. Select the rule *\\`Email security User Quarantine Message\\`* you have just created, and select **Enable**.\n\n</page>\n\n<page>\n---\ntitle: Junk email and Email security Admin Quarantine - Microsoft 365 \n  Cloudflare One docs\ndescription: In this tutorial, you will learn how to deliver emails to the\n  Microsoft 365 junk email folder and the Admin Quarantine in Email security.\nlastUpdated: 2025-10-27T15:00:52.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/prerequisites/m365-email-security-mx/use-cases/one-junk-admin-quarantine/\n  md: https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/prerequisites/m365-email-security-mx/use-cases/one-junk-admin-quarantine/index.md\n---\n\nIn this tutorial, you will learn how to deliver emails to the Microsoft 365 junk email folder and the Admin Quarantine in Email security.\n\n## Create quarantine policies\n\nTo create quarantine policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/)\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Add custom policy**.\n\n6. Set the **Policy name** to `UserNotifyAdminRelease`.\n\n7. Select **Next**.\n\n8. In **Recipient message access**, select **Set specific access (Advanced)**, and then:\n\n   * In **Select release action preference**, choose *Allow recipients to request a message to be released from quarantine*.\n   * In **Select additional actions recipients can take on quarantined messages**, select the **Delete** and **Preview** checkboxes.\n\n9. Select **Next**.\n\n10. In **Quarantine notification**, select **Enable**.\n\n11. Select **Next**.\n\n12. Review your settings and select **Submit**.\n\n13. Select **Done**.\n\n## Configure quarantine notifications\n\nTo configure quarantine notifications:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Rules**, select **Quarantine policies**.\n\n5. Select **Global settings**.\n\n6. Scroll to the bottom and set the desired frequency in **Send end-user spam notifications every (days)**. This value can only be incremented in days.\n\n7. Select **Save**.\n\n## Configure anti-spam policies\n\nTo configure anti-spam policies:\n\n1. Open the [Microsoft 365 Defender console](https://security.microsoft.com/).\n\n2. Go to **Email & collaboration** > **Policies & rules**.\n\n3. Select **Threat policies**.\n\n4. Under **Policies**, select **Anti-spam**.\n\n5. Select the **Anti-spam inbound policy (Default)** text (not the checkbox).\n\n6. In **Actions**, scroll down and select **Edit actions**.\n\n7. Set the following conditions and actions (you might need to scroll up or down to find them):\n\n* **Spam**: *Move messages to Junk Email folder*.\n* **High confidence spam**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n* **Phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n* **High confidence phishing**: *Quarantine message*.\n  * **Select quarantine policy**: \\_UserNotifyAdminRelease\\_.\n* **Retain spam in quarantine for this many days**: Default is 15 days. Email security recommends 15-30 days.\n  * Select the spam actions in the above step.\n\n1. Select **Save**.\n\n## Create transport rules\n\nTo create the transport rules that will send emails with certain dispositions to Email security:\n\n1. Open the new [Exchange admin center](https://admin.exchange.microsoft.com/#/homepage).\n\n2. Go to **Mail flow** > **Rules**.\n\n3. Select **Add a Rule** > **Create a new rule**.\n\n4. Set the following rule conditions:\n\n   * **Name**: `Email security Deliver to Junk Email folder`.\n\n   * **Apply this rule if**: *The message headers* > *includes any of these words*.\n\n     * **Enter text**: `X-CFEmailSecurity-Disposition` > **Save**.\n     * **Enter words**: `BULK` > **Add** > **Save**.\n\n   * **Apply this rule if**: Select **+** to add a second condition.\n\n   * **And**: *The sender* > *IP address is in any of these ranges or exactly matches* > enter the egress IPs in the [Egress IPs](https://developers.cloudflare.com/cloudflare-one/email-security/setup/pre-delivery-deployment/egress-ips/) page.\n\n   * **Do the following** - *Modify the message properties* > *Set the Spam Confidence Level (SCL)* > *5*.\n\n5. Select **Next**.\n\n6. You can use the default values on this screen. Select **Next**.\n\n7. Review your settings and select **Finish** > **Done**.\n\n8. Select the rule `Email security Deliver to Junk Email folder` you have just created, and select **Enable**.\n\n</page>\n\n<page>\n---\ntitle: Run as a service on Linux  Cloudflare One docs\ndescription: You can install cloudflared as a system service on Linux.\nlastUpdated: 2025-10-21T14:33:19.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/as-a-service/linux/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/as-a-service/linux/index.md\n---\n\nYou can install `cloudflared` as a system service on Linux.\n\n## Prerequisites\n\nBefore you install Cloudflare Tunnel as a service on Linux, follow Steps 1 through 4 of the [Tunnel CLI setup guide](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/create-local-tunnel/). At this point you should have a named tunnel and a `config.yml` file in your `.cloudflared` directory.\n\n## 1. Configure `cloudflared` as a service\n\nBy default, Cloudflare Tunnel expects all of the configuration to exist in the `$HOME/.cloudflared/config.yml` [configuration file](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/configuration-file/). At a minimum you must specify the following arguments to run as a service:\n\n| Argument | Description |\n| - | - |\n| `tunnel` | The UUID of your tunnel |\n| `credentials-file` | The location of the credentials file for your Tunnel |\n\n## 2. Run `cloudflared` as a service\n\n1. Install the `cloudflared` service.",
      "language": "unknown"
    },
    {
      "code": "2. Start the service.",
      "language": "unknown"
    },
    {
      "code": "3. (Optional) View the status of the service.",
      "language": "unknown"
    },
    {
      "code": "## Next steps\n\nYou can now [route traffic through your tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/create-local-tunnel/#5-start-routing-traffic). If you add IP routes or otherwise change the configuration, restart the service to load the new configuration:",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Run as a service on macOS  Cloudflare One docs\ndescription: You can install cloudflared as a system service on macOS.\nlastUpdated: 2025-10-21T14:33:19.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/as-a-service/macos/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/as-a-service/macos/index.md\n---\n\nYou can install `cloudflared` as a system service on macOS.\n\n## Prerequisites\n\nBefore you install Cloudflare Tunnel as a service on your OS, follow Steps 1 through 4 of the [Tunnel CLI setup guide](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/create-local-tunnel/). At this point you should have a named tunnel and a `config.yml` file in your `$HOME/.cloudflared` directory.\n\n## 1. Configure `cloudflared` as a service\n\nBy default, Cloudflare Tunnel expects all of the configuration to exist in the `$HOME/.cloudflared/config.yml` [configuration file](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/configuration-file/). At a minimum you must specify the following arguments to run as a service:\n\n| Argument | Description |\n| - | - |\n| `tunnel` | The UUID of your tunnel |\n| `credentials-file` | The location of the credentials file for your tunnel |\n\n## 2. Run `cloudflared` as a service\n\nYou can install the service to either run at login or at boot.\n\n### Run at login\n\nOpen a terminal window and run the following command:",
      "language": "unknown"
    },
    {
      "code": "Cloudflare Tunnel will be installed as a launch agent and start whenever you log in, using your local user configuration found in `~/.cloudflared/`.\n\n### Run at boot\n\nOpen a terminal window and run the following command:",
      "language": "unknown"
    },
    {
      "code": "Cloudflare Tunnel will be installed as a launch daemon and start whenever your system boots, using your configuration found in `/etc/cloudflared`.\n\n## 3. Manually start the service\n\nRun the following command:",
      "language": "unknown"
    },
    {
      "code": "The output will be logged to `/Library/Logs/com.cloudflare.cloudflared.err.log` and `/Library/Logs/com.cloudflare.cloudflared.out.log`.\n\n## Next steps\n\nYou can now [route traffic through your tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/create-local-tunnel/#5-start-routing-traffic). If you add IP routes or otherwise change the configuration, restart the service to load the new configuration:",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Run as a service on Windows  Cloudflare One docs\ndescription: You can install cloudflared as a system service on Windows.\nlastUpdated: 2025-12-22T21:34:44.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/as-a-service/windows/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/as-a-service/windows/index.md\n---\n\nYou can install `cloudflared` as a system service on Windows.\n\n## Configure `cloudflared` as a service\n\nBy default, Cloudflare Tunnel expects all of the configuration to exist in the `%USERPROFILE%\\.cloudflared\\config.yml` [configuration file](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/configuration-file/). At a minimum you must specify the following arguments to run as a service:\n\n| Argument | Description |\n| - | - |\n| `tunnel` | The UUID of your tunnel |\n| `credentials-file` | The location of the credentials file for your tunnel |\n\n## Run `cloudflared` as a service\n\n1. [Download](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/downloads/) the latest `cloudflared` version.\n\n2. Create a new directory:",
      "language": "unknown"
    },
    {
      "code": "3. Copy the `.exe` file you downloaded in step 1 to the new directory and rename it to `cloudflared.exe`.\n\n4. Open CMD as an administrator and go to `C:\\Cloudflared\\bin`.\n\n5. Run this command to install `cloudflared`:",
      "language": "unknown"
    },
    {
      "code": "6. Next, run this command to create another directory:",
      "language": "unknown"
    },
    {
      "code": "7. Log in and authenticate `cloudflared`:",
      "language": "unknown"
    },
    {
      "code": "8. The login command will generate a `cert.pem` file and save it to your user profile by default. Copy the file to the `.cloudflared` folder created in step 5 using this command:",
      "language": "unknown"
    },
    {
      "code": "9. Next, create a tunnel:",
      "language": "unknown"
    },
    {
      "code": "This will generate a [credentials file](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/local-tunnel-terms/#credentials-file) in `.json` format.\n\n10. [Create a configuration file](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/create-local-tunnel/#4-create-a-configuration-file) with the following content:",
      "language": "unknown"
    },
    {
      "code": "11. Copy the credentials file to the folder created in step 6:",
      "language": "unknown"
    },
    {
      "code": "12. Validate the ingress rule entries in your configuration file using the command:",
      "language": "unknown"
    },
    {
      "code": "13. In the Registry Editor, go to `Computer\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\Cloudflared`.\n\n14. In the Cloudflared registry entry, modify `ImagePath` to point to the `cloudflared.exe` and `config.yml` files. Make sure that there are no extra spaces or characters while you modify the registry entry, as this could cause problems with starting the service.",
      "language": "unknown"
    },
    {
      "code": "15. If the service does not start, run the following command from `C:\\Cloudflared\\bin`:",
      "language": "unknown"
    },
    {
      "code": "You will see the output below:",
      "language": "unknown"
    },
    {
      "code": "## Next steps\n\nYou can now [route traffic through your tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/create-local-tunnel/#5-start-routing-traffic). If you add IP routes or otherwise change the configuration, restart the service to load the new configuration:",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: SFP+ port information  Cloudflare One docs\ndescription: The hardware version of Magic WAN Connector includes two SFP+ ports\n  that support 10G throughput. These ports can be configured as either a WAN or\n  a LAN port, like all of the 1G RJ45 ports in the machine. Because a 10G WAN\n  uplink will often be bottlenecked by IPsec tunnel speeds, the SFP+ ports are\n  most useful for configuring high speed LANs, and for using fiber connections.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/sfp-port-information/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/sfp-port-information/index.md\n---\n\nThe hardware version of Magic WAN Connector includes two [SFP+ ports](https://en.wikipedia.org/wiki/Small_Form-factor_Pluggable) that support 10G throughput. These ports can be configured as either a WAN or a LAN port, like all of the 1G RJ45 ports in the machine. Because a 10G WAN uplink will often be bottlenecked by IPsec tunnel speeds, the SFP+ ports are most useful for configuring high speed LANs, and for using fiber connections.\n\nVirtual Connector and SFP+ ports\n\nSince you decide and set up the hardware where Virtual Connector runs, you can ignore the information on this page.\n\n## Port configuration\n\nSFP+ ports are next to the regular LAN ports. They are represented as follows in the dashboard:\n\n* SFP+ **port 1** is represented by **port 7** in the dashboard\n* SFP+ **port 2** is represented by **port 8** in the dashboard\n\n![The left port, SFP+ 1, is port 7. The right port, SFP+ 2, is port 8.](https://developers.cloudflare.com/_astro/sfp-ports.B7f8iPPa_ZCE8mL.webp)\n\n*The left port, SFP+ 1, is port 7. The right port, SFP+ 2, is port 8.*\n\n## SFP+ module compatibility\n\nMagic WAN Connector only supports 10Gbps SFP+ modules, including RJ45, DAC, and fiber, among others. Many 1 Gbps modules are incompatible with the Intel driver used internally, and thus are not supported.\n\nCloudflare supports the following SFP+ inputs:\n\n* 10 Gbps Intel-compatible optics using 10GBase-SR, LR, ER. This includes Intel-compatible active optical cables (AOC) cables at 10 Gbps.\n* 10 Gbps DAC Twinax cables, compatible with SFF-8431 v4.1 and SFF-8472 v10.4\n* 10GBASE-T RJ45 converter modules\n\nCloudflare successfully deployed commonly available 10G modules that are also compatible across many vendors:\n\n* StarTech Dell EMC Twinax SFP+ DAC\n* Ubiquiti multi-mode, duplex, 10 Gbps fiber transceiver modules\n\nKeep in mind that SFP+ modules/cables have to be compatible at both ends, that is, both sides of the connection should be 10 Gbps, and it should really be the same module/cable that is compatible with both hardware stacks. The choice of module/optic/cable ultimately depends on your specific interoperability needs, and it is much less of a \"plug and play\" situation as one expects from RJ45.\n\n## Recover from unsupported SFP+ inputs\n\nSFP+ modules should be installed and tested prior to deploying Magic WAN Connector into production usage.\n\nAn unsupported SFP+ input is indicated by the interface failing to come up (that is, the Magic WAN Connector has no status lights), and also by the port (7 or 8) going offline until the hardware is rebooted.\n\nWhen an unsupported module is plugged, the module should be removed and then Magic WAN Connector rebooted by removing power for five seconds. The module should not remain plugged during reboot, or Magic WAN Connector will have to be rebooted again after the module is removed.\n\n</page>\n\n<page>\n---\ntitle: Application-aware policies  Cloudflare One docs\ndescription: In addition to traffic policies based on network-layer attributes\n  like IP and port ranges, Magic WAN Connector supports the ability to classify\n  traffic based on well-known applications. Application-aware policies provide\n  easier management and more granularity over traffic flows.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/index.md\n---\n\nIn addition to traffic policies based on network-layer attributes like IP and port ranges, Magic WAN Connector supports the ability to classify traffic based on well-known applications. Application-aware policies provide easier management and more granularity over traffic flows.\n\nCloudflare's implementation of application awareness leverages the intelligence of our global network, using the same categorization/classification already shared across security tools like our [Secure Web Gateway](https://developers.cloudflare.com/cloudflare-one/policies/gateway/), so IT and security teams can expect consistent behavior across routing and inspection decisions.\n\nFor more information, refer to [Applications and app types](https://developers.cloudflare.com/cloudflare-one/policies/gateway/application-app-types/).\n\nMagic WAN Connector's ability to classify traffic allows you to define which applications should bypass Cloudflare's security filtering, and go directly to the Internet. You can also give some applications a higher priority, and Connector will process them first. This is useful when your network is at capacity, for example.\n\nRefer to the following pages for more information.\n\n* [Breakout traffic](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/breakout-traffic/)\n* [Prioritized traffic](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/application-based-policies/prioritized-traffic/)\n\n</page>\n\n<page>\n---\ntitle: DHCP options  Cloudflare One docs\nlastUpdated: 2025-10-27T11:06:15.000Z\nchatbotDeprioritize: true\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/index.md\n---\n\n* [DHCP relay](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-relay/)\n* [DHCP server](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-server/)\n* [DHCP static address reservation](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/dhcp/dhcp-static-address-reservation/)\n\n</page>\n\n<page>\n---\ntitle: Enable NAT for a subnet  Cloudflare One docs\ndescription: Enable static NAT for subnets in Connector to  re-use address spaces locally.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/nat-subnet/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/nat-subnet/index.md\n---\n\n## Overview\n\nEach subnet (directly attached or routed) must use a unique address space within the Magic WAN overlay. Many networks already reuse private RFC 1918 space at different sites. To avoid renumbering and still satisfy the Magic WAN uniqueness requirements, you can enable static network address translation (NAT) for a subnet on a Magic WAN Connector.\n\nWith subnet NAT, the Connector performs a static, 1:1 translation between:\n\n* The **local prefix** used inside the site.\n* A **NAT prefix** that is advertised into the Magic WAN overlay.\n\nBecause the mapping is static, the Connector supports both outbound connections from the site and inbound connections from Magic WAN to the site. Connections do not have to be initiated by hosts behind the Magic WAN Connector.\n\n## How subnet NAT works in Magic WAN\n\nNAT is static and 1:1 between equal-sized prefixes. When you enable NAT for a subnet on a Connector:\n\n* The **local prefix** is the subnet on the LAN side of the Connector.\n\n* The **NAT prefix** is a WAN-facing prefix of the same size.\n\n* The Connector translates addresses 1:1 between the two prefixes:\n\n  * For traffic leaving the site towards Magic WAN, it replaces local addresses with the corresponding NAT addresses.\n  * For traffic arriving at the site from Magic WAN, it replaces NAT addresses with the corresponding local addresses.\n\n## Addressing rules\n\nTo avoid overlapping addresses in the overlay, Magic WAN enforces the following rules:\n\n* **Uniqueness within a LAN**\n\n  * The local prefix for each subnet must be unique within that LAN on the Connector.\n  * You can reuse the same local prefix on a different LAN or on a different site.\n\n* **Uniqueness in the Magic WAN overlay**\n\n  * Every **overlay-facing prefix** must be unique across all sites in your Magic WAN deployment.\n  * For a subnet **with NAT enabled**, the overlay-facing prefix is the **NAT prefix**.\n  * For a subnet **without NAT**, the overlay-facing prefix is the **local prefix**.\n\nThese rules allow you to reuse local space at multiple sites, as long as each subnet in the Magic WAN overlay has a unique overlay-facing prefix.\n\n## Example\n\nConsider a subnet that uses the following prefixes:\n\n* **Local prefix**: `192.168.100.0/24`\n* **NAT prefix**: `10.10.100.0/24`\n\nIn this case:\n\n* When a host inside the site with address `192.168.100.13` sends traffic into the Magic WAN overlay, the Connector translates the address to `10.10.100.13`.\n* When traffic from another site, or from the Internet via Magic WAN, targets `10.10.100.13`, the Connector translates the address back to `192.168.100.13`.\n\n## Configure NAT for subnets\n\nYou configure subnet NAT when you create or edit a LAN on a Magic WAN Connector. In the Connector configuration:\n\n* You define the **local prefix** for the subnet on the LAN side.\n* You optionally define a **static NAT prefix** of the same size. When present, this prefix becomes the overlay-facing prefix for that subnet.\n\nFor step-by-step instructions to configure a LAN and supply a static NAT prefix, refer to:\n\n* [Configure hardware Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#create-a-lan)\n* [Configure Virtual Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/#create-a-lan)\n\n</page>\n\n<page>\n---\ntitle: Routed subnets  Cloudflare One docs\ndescription: Learn how to configure routed subnets on a Connector, including\n  setting static routes and next-hop addresses for complex LAN setups.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/routed-subnets/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/routed-subnets/index.md\n---\n\nEach LAN interface (physical port + VLAN tag) on Magic WAN Connector is part of a *directly-attached subnet*. When you specify a static address for the LAN interface, you indicate both the interface's address as well as the subnet it attaches to. For example, `192.168.100.13/24` means the LAN interface has the IP address `192.168.100.13`, and is part of the subnet `192.168.100.0/24`.\n\nSome LANs are more complex. In addition to the directly-attached subnet, they might have additional subnets sitting behind L3 routers south of the Magic WAN Connector. We call these *routed subnets*.\n\nRefer to the diagram below for an example of how this might work:\n\nNote\n\nBlue represents directly-attached subnets, and red represents routed subnets.",
      "language": "unknown"
    },
    {
      "code": "To add a routed subnet to your LAN, you need:\n\n* **A prefix**: The subnet's CIDR prefix; Cloudflare will automatically install static routes to this prefix in our global network (to forward [packets](https://www.cloudflare.com/learning/network-layer/what-is-a-packet/) for this subnet to the right Magic WAN Connector), and in your Magic WAN Connector (to forward packets for this subnet to the right LAN interface). In the figure above, the routed subnet in the center has the prefix `192.168.200.0/24`.\n* **A next-hop address**: The address of the L3 router to which the Magic WAN Connector should forward packets for this subnet. In the figure, the routed subnet in the center has the next-hop address `192.168.100.10`.\n\nOptionally, you can also [enable NAT for a subnet](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/nat-subnet/) by providing a static overlay prefix.\n\n## Create routed subnets\n\nFor more information on how to create routed subnets, refer to **Create a LAN**, either in either in [Configure hardware Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#create-a-lan) or in [Configure Virtual Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/#create-a-lan).\n\n</page>\n\n<page>\n---\ntitle: Network segmentation  Cloudflare One docs\ndescription: Define policies to define if traffic should flow between your LANs\n  without leaving your local premises, or if traffic should be forwarded to\n  Cloudflare for additional security configurations.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/network-segmentation/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/network-options/network-segmentation/index.md\n---\n\nYou can define policies in your Magic WAN Connector to either allow traffic to flow between your LANs without it leaving your local premises or to forward it via the Cloudflare network where you can add additional security features. The default behavior is to drop all LAN-to-LAN traffic. These policies can be created for specific subnets, and link two LANs.",
      "language": "unknown"
    },
    {
      "code": "*In the above example, the red path shows traffic that stays in the customer's premises (allowing direct communication between LAN 3 and LAN 4), and the orange path shows traffic that goes to Cloudflare before returning to the customer's premises (processing traffic between LAN 1 and LAN 2 in Cloudflare).*\n\n\n\nAs a best practice for security, we recommend sending all traffic through Cloudflare's network for Zero Trust security filtering. Use these policies with care and only for scenarios where you have a hard requirement for LAN-to-LAN traffic flows.\n\nIf you enable LAN to LAN traffic flows, communications can only be initiated from origin to destination  for example, LAN 1 to LAN 2  and not the other way around. This is by design and prevents potential exfiltration of information. This does not mean bidirectional communication on TCP is not possible. It only means that the origin is the only one authorized to initiate communications.\n\nUnidirectional communication can be enabled for UDP and ICMP, but it is not available for TCP, as it would break that protocol.\n\nThe following guide assumes you have already created a site and configured your Magic WAN Connector. To learn how to create a site and configure your Magic WAN Connector, refer to [Configure hardware Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/) or [Configure Virtual Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/), depending on the type of Magic WAN Connector you have on your premises.\n\n## Create a policy\n\n* Dashboard\n\n  Follow the steps below to create a new LAN policy to segment your network. Only the fields marked **required** are mandatory.\n\n  1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select the Magic WAN Connector you want to configure > **Edit**.\n\n  1. Select **LAN policies** > **Create**.\n\n  2. In **Policy name**, enter a descriptive name for the policy you are creating.\n\n  3. From the drop-down menu **Origin (required)**, select your origin LAN.\n\n  4. Specify a subnet for your first LAN in **Subnets**.\n\n  5. In **Ports** specify the TCP/UDP ports you want to use. Valid ports range from `1` to `65535`. Zero (`0`) is not a valid port number. Add a comma to separate each of the ports or add a port range. For example, `2,5,6,9-14`.\n\n  6. In **Destination (required)**, select the destination LAN and repeat the above process to configure it.\n\n  7. In **Protocols**, select the type of traffic you want to allow. You can choose **TCP**, **UDP**, and **ICMP**. You can also select **Any** to choose all types of traffic.\n\n  8. In **Traffic direction** you can choose between bidirectional traffic (the default) and unidirectional traffic. What you can choose depends on the protocol that you chose for the policy:\n\n     * **Any**: If **Any** is selected and you choose **Unidirectional**, the system will alert you that this will break TCP traffic.\n     * **TCP**: You can only select **Bidirectional**.\n     * **UDP**: The system defaults to **Bidirectional** but you can choose **Unidirectional**.\n     * **ICMP**: The system defaults to **Bidirectional** but you can choose **Unidirectional**.\n\n  9. In **Traffic path**, select **Forwarded via Cloudflare** if you want traffic to be forwarded to Cloudflare to be processed. If you do not select this option, traffic will flow locally, in your premises without passing through Cloudflare.\n\n  10. Select **Save**.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a `POST` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/acls/methods/create/) to create a network policy.\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Take note of the `id` parameter, as you will need it to edit or delete network policies.\n\nThe new policy will ensure that traffic between the specified LANs flows locally, bypassing Cloudflare.\n\n## Edit a policy\n\n* Dashboard\n\n  1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select the Magic WAN Connector you want to configure > **Edit**.\n\n  1. Select **LAN policies**.\n  2. Select the policy you need to edit > **Edit**.\n  3. Make your changes, and select **Update policy**.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a `PUT` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/acls/methods/update/) to edit a network policy.\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## Delete a policy\n\n* Dashboard\n\n  1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n  1) Select the Magic WAN Connector you want to configure > **Edit**.\n\n  1. Select **LAN policies**.\n  2. Select the policy you need to edit > **Edit**.\n  3. Select **Delete**.\n  4. Select **I understand that deleting a policy is permanent** in the dialog box > **Delete**.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a `DELETE` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/sites/subresources/acls/methods/delete/) to delete a network policy.\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Activate Connector  Cloudflare One docs\ndescription: \"Before you can activate your Magic WAN Connector, you need to\n  follow Cloudflare's instructions regarding DHCP. For full instructions on\n  this, refer to:\"\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/activate-connector/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/activate-connector/index.md\n---\n\nBefore you can activate your Magic WAN Connector, you need to follow Cloudflare's instructions regarding DHCP. For full instructions on this, refer to:\n\n* The [hardware version of Magic WAN Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-hardware-connector/#activate-appliance)\n* The [virtual version of Magic WAN Connector](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/configure-virtual-connector/#activate-appliance)\n\n</page>\n\n<page>\n---\ntitle: Add or remove connectors  Cloudflare One docs\ndescription: To add a new Magic WAN Connector you first need to remove the one\n  associated with the on-ramps. You can only have more than one Magic WAN\n  Connector if you initially enabled high availability on your on-ramp.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/add-remove-connectors/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/add-remove-connectors/index.md\n---\n\nTo add a new Magic WAN Connector you first need to remove the one associated with the on-ramps. You can only have more than one Magic WAN Connector if you initially enabled high availability on your on-ramp.\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n1) Find the Magic WAN Connector that you want to edit > select the three dots next to it > **Edit**.\n2) In **Appliances**, remove the Magic WAN Connector associated with the on-ramp.\n3) Select **Add appliance** to add a different Magic WAN Connector to your on-ramp.\n4) Select **Save**.\n\n</page>\n\n<page>\n---\ntitle: Deactivate Connector  Cloudflare One docs\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/deactivate-connector/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/deactivate-connector/index.md\n---\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Appliances**.\n3. Find the Magic WAN Connector you want to deactivate, select the three dots next to it > **Edit**.\n\n1) In **Status**, select *Deactivated* from the dropdown.\n2) Select **Update**.\n\n</page>\n\n<page>\n---\ntitle: Default password  Cloudflare One docs\ndescription: Learn how to edit Magic WAN Connector's default password.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/default-password/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/default-password/index.md\n---\n\nMagic WAN Connector ships to you with a default password that enables you to access the hardware box or the virtual machine. Cloudflare recommends that you change this password after the first boot.\n\n## Default password to access hardware Magic WAN Connector\n\nThe default password for Magic WAN Connector is the serial number (also known as a Service Tag for Dell devices), all uppercase followed by an `!` (exclamation mark). For example, `A1B2C3D!`\n\n## Default password to access Virtual Connector\n\nThe default password for Virtual Connector is the last seven characters of your license key, all uppercase, plus an `!` (exclamation mark).\n\nFor example, if your license key is `mconn-abcdefghijklmnopqrstuvwxyz`, your default password will be `TUVWXYZ!`.\n\n</page>\n\n<page>\n---\ntitle: Edit basic information  Cloudflare One docs\ndescription: In Basic information, you can change the name and description of\n  your Magic WAN Connector.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-basic-info/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-basic-info/index.md\n---\n\nIn **Basic information**, you can change the name and description of your Magic WAN Connector.\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Appliances**.\n\n1) Find the Magic WAN Connector that you want to edit > select the three dots next to it > **Edit**.\n2) In **Basic information** make the necessary changes.\n3) Select **Save**.\n\n</page>\n\n<page>\n---\ntitle: Edit network settings  Cloudflare One docs\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-network-settings/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-network-settings/index.md\n---\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n1) Find the Connector that you want to edit > select the three dots next to it > **Edit**.\n2) Go to **Network configuration** > **WAN configuration** or **LAN configuration**.\n3) Find the WAN/LAN you want to edit > select the three dots next to it > **Edit**.\n4) Make the necessary changes.\n5) Select **Save**.\n\n</page>\n\n<page>\n---\ntitle: Edit sites  Cloudflare One docs\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-sites/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-sites/index.md\n---\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/) > **Insights**.\n2. Go to **Network visibility** > **Traffic overview**, and find the site you want to make changes on.\n3. Select the three dots next to it > **Edit**.\n4. In **Basic information**, make changes to the site's name, description, and geographic coordinates.\n5. In **On-ramps**, add new on-ramps to your site. You can also remove existing ones.\n\n</page>\n\n<page>\n---\ntitle: Edit traffic steering settings  Cloudflare One docs\ndescription: \"You can only add or remove applications to Breakout traffic and\n  Prioritized traffic. To add or remove applications:\"\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-traffic-steering-settings/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/edit-traffic-steering-settings/index.md\n---\n\nYou can only add or remove applications to Breakout traffic and Prioritized traffic. To add or remove applications:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Profiles**.\n\n1) Find the Connector that you want to edit > select the three dots next to it > **Edit**.\n2) Go to **Traffic steering** > **Breakout traffic** or **Prioritized traffic**.\n3) Select **Add** to add a new application.\n4) To delete an application, find the one you want to delete from **Breakout traffic** or **Prioritized traffic** > select the three dots next to it > **Remove**.\n\n</page>\n\n<page>\n---\ntitle: Heartbeat  Cloudflare One docs\ndescription: Magic WAN Connector communicates periodically with Cloudflare via\n  HTTPS. This is also known as a heartbeat, and lets Cloudflare know that the\n  Magic WAN Connector in question is connected to the Internet and reachable.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/heartbeat/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/heartbeat/index.md\n---\n\nMagic WAN Connector communicates periodically with Cloudflare via HTTPS. This is also known as a heartbeat, and lets Cloudflare know that the Magic WAN Connector in question is connected to the Internet and reachable.\n\nThe heartbeat calls are made to `api.cloudflare.com`. Each Magic WAN Connector has a heartbeat frequency of 10 seconds, independently of the number of WAN interfaces you have running on your device.\n\nThere are three symbols for the heartbeat signal that allow you to quickly check the status of Magic WAN Connector:\n\n* **Blue `i`**: Magic WAN Connector is contacting Cloudflare as expected.\n* **Yellow triangle**: Magic WAN Connector has not yet connected to Cloudflare.\n* **Red triangle**: There is a potential problem with Magic WAN Connector.\n\n### Access Magic WAN Connector's heartbeat\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances** > **Appliances**.\n3. Find your Magic WAN Connector, and place your cursor over the icon on the **Status** column to check the timestamp. The timestamp shows you the last time Magic WAN Connector successfully contacted Cloudflare.\n\n</page>\n\n<page>\n---\ntitle: Interrupt window  Cloudflare One docs\ndescription: Learn how to set up when Connector can update its systems.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/interrupt-service-window/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/interrupt-service-window/index.md\n---\n\nThe Interrupt window defines when Magic WAN Connector can update its systems. When Magic WAN Connector is updating, this may result in an interruption to existing connections. Set up a time window that minimizes disruption to your sites.\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks** > **Connectors**.\n2. In **Appliances** > **Appliances**, select the Magic WAN Connector for which you want to set up the update window > **Edit**.\n\n1) In **Interrupt window**, select the most appropriate time for the Magic WAN Connector to update its systems:\n\n   * **Timezone**: Select the time zone for the Magic WAN Connector to update.\n   * **Start time**: Choose an hour for the Magic WAN Connector to start updating. Cloudflare recommends you choose an hour when there is minimal activity in your network, to avoid potential disruptions.\n   * **Duration**: Duration indicates the time window during which the Magic WAN Connector is scheduled to update. For example, if you configure your Magic WAN Connector to update at `22:00` and specify a **Duration** of `4 hours`, the Magic WAN Connector will attempt to update within the four-hour period following `22:00`.\n\n</page>\n\n<page>\n---\ntitle: Register a hardware Connector  Cloudflare One docs\ndescription: To set up and use the hardware version of Magic WAN Connector, you\n  first need to register it with your account. This is not applicable to Virtual\n  Magic WAN Connector.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/register-appliance/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/appliances/maintenance/register-appliance/index.md\n---\n\nTo set up and use the hardware version of Magic WAN Connector, you first need to register it with your account. This is not applicable to Virtual Magic WAN Connector.\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Connectors** > **Appliances**, and select **Register an appliance**.\n\n1) In **Appliance details** > **Serial number**, insert the serial number for your device. You can optionally add notes about the Magic WAN Connector you are adding to the dashboard.\n2) (Optional) Select **Add** below **Serial number** to add multiple Magic WAN Connectors at once to your account.\n3) Select **Register appliance**.\n\nYour device is now registered with your account.\n\n</page>\n\n<page>\n---\ntitle: Configure Cloudflare source IPs  Cloudflare One docs\ndescription: Configure the Cloudflare source IP range used when you receive\n  traffic from Cloudflare services sent to your Cloudflare One private networks.\nlastUpdated: 2025-11-25T17:44:26.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-cloudflare-source-ips/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-cloudflare-source-ips/index.md\n---\n\nYou can configure the source IP address range used by Cloudflare whenever a Cloudflare service, such as Cloudflare Load Balancing, sends traffic to a Cloudflare One private network. This address range is referred to as the Proxy Source IP Prefix (or `cloudflare_source` subnet type in the API).\n\n* IPv4 traffic is sourced from `100.64.0.0/12`. This range is configurable.\n* IPv6 traffic is sourced from `2606:4700:cf1:5000::/64`. This range is not configurable.\n\nCustomers may wish to change the default allocated range to avoid IP conflicts or fit with an existing IP Address Management plan.\n\nYou must configure routes in your network so that response traffic for these source ranges is sent back to Cloudflare over your Cloudflare One connections.\n\n## Prerequisites\n\nBefore you begin, ensure that:\n\n* You have Cloudflare One Unified Routing. If your account is not yet on Unified Routing, contact your account team to discuss migration and availability.\n\n* You have [Cloudflare One Networks Write](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) permission.\n\n* Your desired new network range meets the following requirements:\n\n  * Your network must be defined as a single CIDR with a prefix length of `/12`.\n\n  * Cloudflare One subnets in the same account cannot overlap. Default allocations include:\n\n    * Proxy Source IPs (`100.64.0.0/12`)\n    * Hostname Route Token IPs (`100.80.0.0/16`)\n    * WARP Clients (`100.96.0.0/12`)\n    * Private Load Balancers (`100.112.0.0/16`)\n\n  * The source subnet cannot match or contain any existing route in your Cloudflare One routing table. The source subnet can be within a supernet route.\n\n## Affected Connectors\n\nExcept for Cloudflare Tunnel, all Cloudflare One Connectors (network offramps) see the `cloudflare_source` subnet (default `100.64.0.0/12`) as the source of traffic from a Cloudflare service, such as Cloudflare Load Balancing, to a private network.\n\nThe following Connectors are affected:\n\n* GRE\n* IPsec\n* CNI\n* WARP Connector\n* WARP Client\n\n## Configure source IPs via API\n\nCurrently, you must use the Cloudflare API to configure this setting. To set up your source IPs, send a `PATCH` request to the [Update Cloudflare Source Subnet endpoint](https://developers.cloudflare.com/api/resources/zero_trust/subresources/networks/subresources/subnets/subresources/cloudflare_source/) with your desired network range. The payload must include the network (your new `/12` range), and may include a name and comment.\n\nExample:\n\nRequired API token permissions\n\nAt least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n* `Cloudflare One Networks Write`",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Configure tunnel endpoints  Cloudflare One docs\ndescription: Cloudflare recommends two tunnels for each ISP and network location\n  router combination, one per Cloudflare endpoint. Learn how to configure IPsec\n  or GRE tunnels.\nlastUpdated: 2025-12-09T10:00:44.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/index.md\n---\n\nCloudflare recommends two tunnels for each ISP and network location router combination, one per Cloudflare endpoint. Shortly after your onboarding kickoff call, Cloudflare will assign two Cloudflare endpoint addresses that you can use as the tunnel destinations on your network location's routers/endpoints.\n\nTo configure the tunnels between Cloudflare and your locations, you must provide the following data for each tunnel:\n\n* **Tunnel name**: For both GRE and IPsec tunnels, the name cannot contain spaces or special characters, and cannot be shared with other tunnels.\n\n* **Cloudflare endpoint address**: The public IP address of the Cloudflare side of the tunnel.\n\n* **Customer endpoint**: A public Internet routable IP address which is outside of the prefixes that Cloudflare will advertise on your behalf. These are generally IP addresses provided by your ISP. If you intend to use a physical or virtual connection like [Cloudflare Network Interconnect](https://developers.cloudflare.com/network-interconnect/), you do not need to provide endpoints because Cloudflare will provide them.\\\n  This value is not required for IPsec tunnels, unless your router is using an Internet Key Exchange (IKE) ID of type `ID_IPV4_ADDR`.\n\n* **Interface address**: A 31-bit (recommended) or 30-bit subnet (`/31` or `/30` in CIDR notation) supporting two hosts, one for each side of the tunnel. Select the subnet from the following private IP space:\n\n  * `10.0.0.0/8`\n\n  * `172.16.0.0/12`\n\n  * `192.168.0.0/16`\n\n  * `169.254.240.0/20` (this address space is also a link-local address)\n\n    Warning\n\n    Make sure the prefixes are always within the allowed Cloudflare ranges, especially for cloud service providers that might automatically generate prefixes for you. Otherwise, the tunnel will not work.\n\n* **TTL**: Time to Live (TTL) in number of hops for the GRE tunnel. The default value is 64.\n\n* **MTU**: Maximum transmission unit (MTU) in bytes for the GRE tunnel. The default value is 1476.\n\n## Ways to onboard traffic to Cloudflare\n\n### GRE and IPsec tunnels\n\nYou can use GRE or IPsec tunnels to onboard your traffic to Magic WAN, and set them up through the Cloudflare dashboard or the API. If you use the API, you need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API key](https://developers.cloudflare.com/fundamentals/api/get-started/keys/#view-your-global-api-key).\n\n#### IPsec supported ciphers\n\nRefer to [Tunnels and encapsulation](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/gre-ipsec-tunnels/) to learn more about the technical requirements for GRE and IPsec tunnels used in Magic WAN. In that page, you can also find the [supported ciphers for IPsec](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/gre-ipsec-tunnels/#supported-configuration-parameters).\n\nNote\n\nIPsec tunnels only support Internet Key Exchange version 2 (IKEv2).\n\n#### Anti-replay protection\n\nIf you use Magic WAN and anycast IPsec tunnels, we recommend disabling anti-replay protection. Cloudflare disables this setting by default. However, you can enable it through the API or the Cloudflare dashboard for devices that do not support disabling it, including Cisco Meraki, Velocloud, and AWS VPN Gateway.\n\nRefer to [Anti-replay protection](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/anti-replay-protection/) for more information on this topic, or [Add IPsec tunnels](#add-tunnels) to learn how to enable this feature.\n\n### Network Interconnect (CNI)\n\nBeyond GRE and IPsec tunnels, you can also use Network Interconnect (CNI) to onboard your traffic to Magic WAN. Refer to [Network Interconnect (CNI)](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/network-interconnect/) for more information.\n\n## Add tunnels\n\nWarning\n\nMagic Firewall rules apply to Internet Control Message Protocol (ICMP) traffic. If you enable Magic Firewall, ensure your rules allow ICMP traffic sourced from Cloudflare public IPs. Otherwise, health checks will fail. Refer to [Magic Firewall rules](https://developers.cloudflare.com/magic-firewall/about/ruleset-logic/#magic-firewall-rules-and-magic-transit-endpoint-health-checks) for more information.\n\n* Dashboard\n\n  1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Connectors** > **WAN Tunnels**, and select **Create**.\n  3. On the **Add Tunnel** page, choose either a **GRE tunnel** or **IPsec tunnel**.\n\n  GRE tunnel\n\n  1. In **Name**, give your tunnel a descriptive name. This name must be unique, and must not contain spaces or special characters. Hover over `i` in the dashboard for more information.\n  2. Give your tunnel a description in **Description**. You do not have character restrictions here.\n  3. In **IPv4 Interface address**, enter the internal IP address for your tunnel along with the interface's prefix length (either `/31` or `/30`). This is used to route traffic through the tunnel on the Cloudflare side. We recommend using an RFC1918 address scheme with a `/31` netmask, as it provides the most efficient use of IP address space.\n  4. In **Customer GRE endpoint**, enter your router's public IP address. You do not need this value if you use a physical or virtual connection like Cloudflare Network Interconnect because Cloudflare provides it.\n  5. In **Cloudflare GRE endpoint**, enter the anycast address you received from your account team.\n  6. Leave the default values for **TTL** and **MTU**.\n  7. *(Optional)* **Tunnel health checks** are enabled by default. If you disable Tunnel health checks, your tunnels appear 100% down in your [tunnel health dashboard](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/check-tunnel-health-dashboard/) even when working. Cloudflare keeps sending traffic through the tunnel without the means to detect if the tunnel goes down. You must set up your own system to detect down tunnels, as Cloudflare cannot warn you about down tunnels. Refer to [Tunnel health checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/) for more information.\n  8. *(Optional)* If you keep **Tunnel health checks** enabled, choose a [health check rate](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/update-tunnel-health-checks-frequency/) for your tunnel. Available options are *Low*, *Medium*, and *High*.\n  9. The **Health check type** defaults to *Reply* and to creating an ICMP (Internet Control Message Protocol) reply. If your firewall drops this type of packet because it assumes the packet is an attack, change this option to *Request* which creates an ICMP request. Refer to [Tunnel health checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/) for more information.\n  10. The **Health check direction** defaults to **bidirectional** for Magic WAN. Refer to [Bidirectional vs unidirectional health checks](#bidirectional-vs-unidirectional-health-checks) for more details.\n  11. *(Optional)* **Health check target** is the customer end of the tunnel. This field is only visible when the **Health check direction** is set to *Unidirectional*.\n  12. *(Optional)* We recommend you test your tunnel before officially adding it. To test the tunnel, select **Test tunnels**.\n\n  1) (Optional) Select **Automatic return routing** if you are setting up this tunnel for a site that only needs to send traffic to and receive responses from Cloudflare, and does not need to receive traffic from other sites in your WAN. Refer to [Configure Automatic Return Routing](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#configure-automatic-return-routing-beta) for more information.\n\n  1. To add multiple tunnels, select **Add GRE tunnel** for each new tunnel.\n\n  1) After adding your tunnel information, select **Add tunnels**.\n\n  IPsec tunnel\n\n  1. In **Name**, give your tunnel a descriptive name. This name must be unique, and must not contain spaces or special characters. Hover over `i` in the dashboard for more information.\n\n  2. Give your tunnel a description in **Description**. You do not have character restrictions here.\n\n  3. In **IPv4 Interface address**, enter the internal IP address for your tunnel along with the interface's prefix length (either `/31` or `/30`). This is used to route traffic through the tunnel on the Cloudflare side. We recommend using an RFC1918 address scheme with a `/31` netmask, as it provides the most efficient use of IP address space.\n\n  4. In **Customer endpoint**, enter your router's public IP address. This value is only required if your router uses an IKE (Internet Key Exchange) ID of type `ID_IPV4_ADDR`.\n\n  5. In **Cloudflare endpoint**, enter the anycast address you received from your account team.\n\n  6. *(Optional)* **Tunnel health checks** are enabled by default. If you disable Tunnel health checks, your tunnels appear 100% down in your [tunnel health dashboard](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/check-tunnel-health-dashboard/) even when working. Cloudflare keeps sending traffic through the tunnel without the means to detect if the tunnel goes down. You must set up your own system to detect down tunnels, as Cloudflare cannot warn you about down tunnels. Refer to [Tunnel health checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/) for more information.\n\n  7. *(Optional)* If you keep **Tunnel health checks** enabled, choose a [health check rate](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/update-tunnel-health-checks-frequency/) for your tunnel. Available options are *Low*, *Medium* and *High*.\n\n  8. *(Optional)* The **Health check type** defaults to *Reply* and to creating an ICMP reply. If your firewall drops this type of packet because it assumes the packet is an attack, change this option to *Request* which creates an ICMP request. Refer to [Tunnel health checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/) for more information.\n\n  9. *(Optional)* The **Health check direction** defaults to **bidirectional** for Magic WAN. Refer to [Bidirectional vs unidirectional health checks](#bidirectional-vs-unidirectional-health-checks) for more details.\n\n  10. *(Optional)* **Health check target** is the customer end of the tunnel. This field is only visible when the **Health check direction** is set to *Unidirectional*.\n\n      Note\n\n      IPsec tunnels will not function without a pre-shared key (PSK).\n\n  11. If you do not have a pre-shared key yet:\n\n      1. Select **Add pre-shared key later**.\n      2. *(Optional)* We recommend you test your tunnel configuration before officially adding it. To test the tunnel, select **Test tunnels**.\n      3. Select **Add tunnels**.\n      4. The Cloudflare dashboard loads the list of tunnels you have configured. The IPsec tunnel you just created displays a warning triangle icon to indicate it is not yet functional. Select **Edit**.\n      5. Choose **Generate a new pre-shared key** > **Update and generate a pre-shared key**. Save the key to a safe place, and select **Done**.\n\n  12. If you already have a pre-shared key:\n\n      1. Select **Use my own pre-shared key**.\n      2. Paste your key in **Your pre-shared key**.\n      3. *(Optional)* We recommend you test your tunnel before officially adding it. To test the tunnel, select **Test tunnels**.\n      4. Select **Add tunnels**.\n\n  13. (Optional) Enable **Replay protection** if you have devices that do not support disabling it. Refer to [Anti-replay protection](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/anti-replay-protection/) for more information.\n\n  1) (Optional) Select **Automatic return routing** if you are setting up this tunnel for a site that only needs to send traffic to and receive responses from Cloudflare, and does not need to receive traffic from other sites in your WAN. Refer to [Configure Automatic Return Routing](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#configure-automatic-return-routing-beta) for more information.\n\n  1. To add multiple tunnels, select **Add IPsec tunnel** for each new tunnel.\n\n  1) After adding your tunnel information, select **Add tunnels**.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  GRE tunnel\n\n  Create a `POST` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/gre_tunnels/methods/create/) to create a GRE tunnel.\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "IPsec tunnel\n\n  1. Create a `POST` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/ipsec_tunnels/methods/create/) to create an IPsec tunnel.\n\n     Note that in the example, replay protection is disabled by default. You can enable it with the flag `\"replay_protection\": true` for each IPsec tunnel, if the devices you use do not support disabling this feature. If you have already created IPsec tunnels, update them with a [`PUT` request](https://developers.cloudflare.com/api/resources/magic_transit/subresources/ipsec_tunnels/methods/update/). Refer to [Anti-replay protection](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/anti-replay-protection/) for more information on this topic.\n\n     Required API token permissions\n\n     At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n     * `Magic WAN Write`\n     * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Take note of the tunnel `id` value. We will use it to generate a pre-shared key (PSK).\n\n  2. Create a `POST` [request](https://developers.cloudflare.com/api/resources/magic_transit/subresources/ipsec_tunnels/methods/psk_generate/) to generate a PSK. Use the tunnel `id` value you received from the previous command.\n\n     Required API token permissions\n\n     At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n     * `Magic WAN Write`\n     * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Take note of your `psk` value.\n\n  3. Create a `PUT` [request](https://developers.cloudflare.com/api/resources/magic_transit/subresources/ipsec_tunnels/methods/update/) to update your IPsec tunnel with the PSK.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "1. Use the `psk` value from step 3 to configure the IPsec tunnel on your equipment as well.\n\n  Configure bidirectional health checks\n\n  Bidirectional health checks are available for GRE and IPsec tunnels. For WAN Tunnels this option defaults to bidirectional.\n\n  You can change this setting via the API with `\"bidirectional\"` or `\"unidirectional\"`:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## Bidirectional vs unidirectional health checks\n\nTo check for tunnel health, Cloudflare sends a [health check probe](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/) consisting of ICMP (Internet Control Message Protocol) reply [packets](https://www.cloudflare.com/learning/network-layer/what-is-a-packet/) to your network. Cloudflare needs to receive these probes to know if your tunnel is healthy.\n\nCloudflare defaults to bidirectional health checks for Magic WAN, and unidirectional health checks for Magic Transit (direct server return). However, routing unidirectional ICMP reply packets over the Internet to Cloudflare is sometimes subject to drops by intermediate network devices, such as stateful firewalls. Magic Transit customers with egress traffic can modify this setting to bidirectional.\n\n### Legacy bidirectional health checks\n\nFor customers using the legacy health check system with a public IP range, Cloudflare recommends:\n\n* Configuring the tunnel health check target IP address to one within the `172.64.240.252/30` prefix range.\n* Applying a policy-based route that matches [packets](https://www.cloudflare.com/learning/network-layer/what-is-a-packet/) with a source IP address equal to the configured tunnel health check target (for example `172.64.240.253/32`), and route them over the tunnel back to Cloudflare.\n\n## Next steps\n\n* Now that you have set up your tunnel endpoints you need to configure routes to route your traffic through Cloudflare. Refer to [Configure routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/) to learn more about static routing and BGP peering (only available through CNI with Dataplane v2 (beta) connection).\n* After configuring either static routes or BGP routing, you need to [set up a site](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/sites/).\n\n</page>\n\n<page>\n---\ntitle: Configure routes  Cloudflare One docs\ndescription: Magic WAN uses a static configuration to route your traffic through\n  anycast tunnels from Cloudflare's global network to your locations. If you are\n  connected through Direct CNI you also have access to BGP peering.  Learn how\n  to configure routing.\nlastUpdated: 2025-12-09T10:00:44.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/index.md\n---\n\nMagic Networking uses a routing table to steer your traffic from Cloudflare's global network to your connected networks via next-hop. You can add entries to the Magic routing table through static route configuration or routes learned from BGP peering (only available over CNI with Dataplane v2 (beta)).\n\nRefer to [Traffic Steering](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/) for more information about all the technical aspects related to:\n\n* Routes' priorities and weights\n* Regional scoping of traffic to reduce latency\n* BGP peering\n\n- Automatic Return Routing (ARR)\n\n## Configure static routes\n\nThe following IPv4 address ranges are allowed in the Magic Routing table:\n\n* [RFC 1918](https://datatracker.ietf.org/doc/html/rfc1918) address space, specifically `10.0.0.0/8`, `172.16.0.0/12`, and `192.168.0.0/16`.\n\nWhen using Magic WAN and Cloudflare Tunnel together, consider the IP ranges utilized in the static routes of Cloudflare Tunnel when selecting static routes for Magic WAN. For more information, refer to [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/zero-trust/cloudflare-tunnel/).\n\nFor prefixes outside RFC 1918, contact your Cloudflare customer service manager.\n\n### Create a static route\n\n* Dashboard\n\n  1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n  2. Go to **Routes** > **WAN Routes**, and select **Create** to add a new route.\n\n  1) Enter a descriptive name for your route in **Description**.\n\n  2) In **Prefix**, enter your range of IP addresses. For example, `10.10.10.100/24`.\n\n  3) In **Tunnel/Next hop**, select a tunnel for your route from the tunnels you created in [Configure tunnel endpoints](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/).\n\n  4) Choose the **Priority** for your route. Lower numbers have higher priorities.\n\n     Note\n\n     Cloudflare routing applies longest-prefix match. A more specific static route (like `/30`) always takes precedence over a less specific one (like `/29`), regardless of tunnel priority  unless you remove the more specific route.\n\n     Keep this in mind when configuring priorities for your routes. Refer to [Route prioritization](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/#route-prioritization) for more information.\n\n  5) (Optional) Choose a **Weight** for your route. Refer to [Set priority and weights for static routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/#set-priority-and-weights-for-static-routes) for examples.\n\n  6) (Optional) If you need to scope your route to a specific region, you can do it in **Region code**.\n\n  7) (Optional) We highly recommend testing your route before adding it by selecting **Test routes**.\n\n  8) Select **Add routes**.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a `POST` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/routes/methods/create/) to create one or more static routes.\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### Edit a static route\n\n* Dashboard\n\n  1. In **Routes** > **WAN Routes**, locate the route to modify.\n  2. Select the three dots next to it > **Edit**.\n\n  1) Enter the updated route information.\n  2) (Optional) We highly recommend testing your route before adding it by selecting **Test routes**.\n  3) Select **Edit routes**.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a `PUT` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/routes/methods/update/) to update one or more static routes.\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### Delete static route\n\n* Dashboard\n\n  1. In **Routes** > **WAN Routes**, locate the static route to delete.\n  2. Select the three dots next to it > **Delete**.\n\n  1) Confirm the action by selecting the checkbox and select **Delete**.\n\n* API\n\n  Note\n\n  You will need your [account ID](https://developers.cloudflare.com/fundamentals/account/find-account-and-zone-ids/) and [API token](https://developers.cloudflare.com/fundamentals/api/get-started/account-owned-tokens/) to use the API.\n\n  Create a `DELETE` request [using the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/routes/methods/delete/) to delete a static route.\n\n  Example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## Configure Automatic Return Routing (beta)\n\n[Automatic Return Routing (beta)](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/#automatic-return-routing-beta) allows Cloudflare to track network flows from your Magic WAN connected locations, ensuring return traffic is routed back to the connection where it was received without requiring static or dynamic routes. This functionality requires the new [Unified Routing mode](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/#unified-routing-mode).\n\nTo enable ARR:\n\n* Dashboard\n\n  1. Follow the [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) information to learn how to create an IPsec or GRE tunnel.\n  2. On the tunnel's options, select **Automatic return routing**.\n  3. Select **Add tunnels** to save your changes.\n\n* API\n\n  Create a `POST` request to create an [IPsec](https://developers.cloudflare.com/api/resources/magic_transit/subresources/ipsec_tunnels/methods/create/) or [GRE](https://developers.cloudflare.com/api/resources/magic_transit/subresources/gre_tunnels/methods/create/) tunnel with ARR enabled. For example:\n\n  Required API token permissions\n\n  At least one of the following [token permissions](https://developers.cloudflare.com/fundamentals/api/reference/permissions/) is required:\n\n  * `Magic WAN Write`\n  * `Magic Transit Write`",
      "language": "unknown"
    },
    {
      "code": "## Configure BGP routes\n\nBGP peering is available when using [CNI with Dataplane v2 (beta)](https://developers.cloudflare.com/network-interconnect/) as an on-ramp.\n\n### Choose an ASN for BGP peering\n\nThe Magic routing table is managed by the customer. You can select both the Cloudflare-side ASN (Autonomous System Number) and the ASN for your customer device. The customer device ASN can be 2-byte or 4-byte.\n\nBy default, each BGP peering session uses the same Cloudflare-side ASN to represent peering with the Magic WAN routing table. This ASN is called the **CF Account ASN** and is set to `13335`. You can configure this to a private 2-byte ASN (any value between `64512` and `65534`, such as `65000`).\n\nTo set this ASN:\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Routes** > **WAN configuration**.\n3. In **Border Gateway Protocol (BGP) configuration**, select **Edit** and enter your ASN.\n4. Select **Save**.\n\nMagic WAN customers should also be aware of the following:\n\n* The customer chooses their device ASN, which must be different from the Cloudflare-side ASN.\n\n* The Cloudflare side ASN will be included in the `AS_PATH` of announced routes to any BGP enabled interconnect.\n\n* The customer-announced `AS_PATH` is transitive between interconnects  meaning the origin (customer) ASN is visible in the `AS_PATH` of routes received from Cloudflare via BGP. Due to default BGP loop prevention mechanisms, a router will reject any route that contains its own ASN in the `AS_PATH`. For example, if two Magic WAN-connected sites both use `ASN 65000`, site A will not accept routes from site B, and vice versa, because each site sees its own ASN in the advertised `AS_PATH`.\\\n  To enable routing between private networks over Magic WAN, you should either:\n\n  * Assign a unique ASN to each site/network, or\n  * Configure your edge CPE to accept BGP routes that include its own ASN in the `AS_PATH`.\n\n### Set up BGP peering\n\nWarning\n\nBGP peering is only available to Magic WAN customers with CNI with Dataplane v2 (beta) as an on-ramp. If your network is set up with GRE or IPsec tunnels, you cannot use BGP peering.\n\nYou need to configure two ASNs:\n\n* The Cloudflare [account-scoped ASN](#choose-an-asn-for-bgp-peering) named **CF Account ASN**.\n* One ASN for each interconnect you want to configure with BGP.\n\nIf you have already set up your Cloudflare account ASN, skip steps two and three below.\n\n1. Log in to [Cloudflare One](https://one.dash.cloudflare.com/), and go to **Networks**.\n2. Go to **Routes** > **WAN configuration**.\n3. In **Border Gateway Protocol (BGP) configuration**, select **Edit ASN** and enter your ASN.\n4. Go to **Networks** > **Connectors** > **Interconnects**.\n\n1) Locate the CNI interconnect with Dataplane v2 (beta) to configure with BGP > select the **three dots** next to it > **Configure BGP**.\n\n2) In **Customer device ASN**, enter the ASN for your network.\n\n   Note\n\n   Multiple interconnects with the same ASN will not exchange routes if standard BGP loop prevention is enabled. Consider using a different ASN per session, or enabling duplicate ASNs (like Cisco's `allowas-in` feature) to exchange routes between networks.\n\n3) In **MD5 key**, you can optionally enter the key for your network. Note that this is meant to prevent accidental misconfigurations, and is not a security mechanism.\n\n4) (Optional) In **Advertised prefix list**, input the additional prefixes automatically assigned by Cloudflare during the creation of the CNI interconnect. These prefixes advertise alongside your existing routes. Leave this blank if you do not want to advertise extra routes.\\\n   Typical prefixes to configure here include:\n\n   * A route to `0.0.0.0/0`, the default route  to attract all Internet-bound traffic if using WAN Tunnels with Gateway.\n   * A route to `100.96.0.0/12`, the portion of CGNAT space [used by default with WARP clients](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/private-net/warp-connector/user-to-site/#add-ip-route-to-router).\n\n5) Select **Save**.\n\n## Next steps\n\nNow that you have configured your tunnels and routes, the next step is to create a site.\n\nSites represent the local network of a data center, office, or other physical location, and combine all on-ramps available there. Sites also allow you to check, at a glance, the state of your on-ramps and set up health alert settings so that Cloudflare notifies you when there are issues with the site's on-ramps.\n\nRefer to [Set up a site](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/sites/) for more information.\n\n</page>\n\n<page>\n---\ntitle: Run traceroute  Cloudflare One docs\ndescription: Learn what settings you need to change to perform a useful\n  `traceroute` to an endpoint behind a Cloudflare Tunnel.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/traceroute/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/traceroute/index.md\n---\n\nIf you have a Magic WAN client connected through [GRE](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/), [IPsec](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/), [CNI](https://developers.cloudflare.com/network-interconnect/) or [WARP](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/zero-trust/warp/) and want to perform a `traceroute` to an endpoint behind a [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/zero-trust/cloudflare-tunnel/), the following settings must be applied for the command to return useful information.\n\n## Inherited TTL value\n\nOn the machine where the `traceroute` client is executed, make sure the tunnel device does not inherit the TTL value of the inner packet. This is the default behavior on Linux and can result in unhelpful `traceroute` results:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "Setting the TTL explicitly returns much better results:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## WARP client\n\nSome Linux distributions default to a very strict setting for [reverse path filtering](https://sysctl-explorer.net/net/ipv4/rp_filter/). This strict setting attempts to drop fake traffic as a security measure. Performing a `traceroute` with this setting on can unintentionally drop `traceroute` packets. If you use WARP on Linux, set a less strict policy before attempting to perform a `traceroute`:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Alibaba Cloud VPN Gateway  Cloudflare One docs\ndescription: This tutorial provides information on how to connect Alibaba Cloud\n  infrastructure to Magic WAN through IPsec tunnels. For more information\n  regarding Alibaba Cloud technology, refer to Alibaba's documentation.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/alibaba-cloud/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/alibaba-cloud/index.md\n---\n\nThis tutorial provides information on how to connect Alibaba Cloud infrastructure to Magic WAN through IPsec tunnels. For more information regarding Alibaba Cloud technology, refer to [Alibaba's documentation](https://www.alibabacloud.com/help/en/vpn-gateway).\n\n## Alibaba Cloud\n\n### 1. Create a VPC\n\n1. Log in to your Alibaba Cloud account.\n2. Go to **VPC** > **VPN Gateways**, and select **Create VPC** to create a new virtual private cloud.\n3. Give your VPC a descriptive name. For example, `Cloudflare-Magic-WAN`.\n4. Choose the **Region** that aligns with where your servers are located.\n5. In **IPv4 CIDR block**, choose from one of the recommended IP blocks. For example, `192.168.20.0/24`. Take note of the IP block you choose, as you will need it to create a static route in Magic WAN.\n\n### 2. Create a VPN gateway\n\n1. Still in your Alibaba Cloud account, go to **VPC** > **VPN Gateway**, and select **Create VPN Gateway**.\n2. Give your VPN Gateway a descriptive name. For example, `VPN-Gateway-Magic-WAN`.\n3. In **Region**, choose the server that is best for your geographic region. For example, **US (Silicon Valley)**.\n4. For **Gateway Type**, choose **Standard**.\n5. In **Network Type**, choose **Public**.\n6. For **Tunnels**, select **Single-tunnel**.\n7. In the **VPC** dropdown menu, choose the name of the VPC you created before for Magic WAN. For example, `Cloudflare-Magic-WAN`.\n8. In the **VSwitch** dropdown menu, choose the VSwith you created previously. For example, `VSwitch-CF`.\n9. For options such as **Maximum Bandwidth**, **Traffic**, and **Duration**, select the options that best suit your use case.\n10. In **IPsec-VPN**, select **Enable**.\n11. For **SSL-VPN**, select **Disable**.\n12. When you are finished configuring your VPN gateway, return to the main VPN Gateway window.\n13. Select the VPN gateway you have just created, and then select **Destination-based Routing**.\n14. Select **Add Route Entry**, and enter whatever subnets are needed to reach the required destinations. You can, for example, just add a default route to send all traffic through your Magic WAN tunnel.\n15. When you are finished, return to the main window.\n16. Select **Publish** > **OK** to publish the route.\n\n### 3. Create IPsec connections\n\n1. Go to **VPC** > **Customer Gateways** > **Create Customer Gateway**.\n\n2. Create a customer gateway with the Cloudflare anycast IP address given to you by your account team. Typically starts with `162.xx.xx.xx`.\n\n3. Now, go to **VPC** > **IPsec Connections** > **Create IPsec Connection**.\n\n4. Create an IPsec connection with the following settings:\n\n   1. **Name**: give it a descriptive name, like `CF-Magic-WAN-IPsec`.\n   2. **Associate Resource**: **VPN Gateway**.\n   3. **VPN Gateway**: From the dropdown menu, choose the VPN gateway you created previously. In our example, `VPN-Gateway-Magic-WAN`.\n   4. **Customer Gateway**: Select the customer gateway you created above for Magic WAN.\n   5. **Routing Mode**: **Destination Routing Mode**.\n   6. **Effective Immediately**: **Yes**.\n   7. **Pre-Shared Key**: This is the pre-shared key (PSK) you will have to use in the Magic WAN IPsec tunnel. If you do not specify one here, the Alibaba system will generate a random PSK for you.\n\n5. Go to **Advanced Settings**, and expand the **Encryption Configuration** settings.\n\n6. In **IKE Configurations**, select the following settings to configure the IPsec connection. These settings have to match the supported configuration parameters for [Magic WAN IPsec tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/gre-ipsec-tunnels/#supported-configuration-parameters):\n\n   1. **Version**: *ikev2*\n   2. **Negotiation Mode**: *main*\n   3. **Encryption Algorithm**: *aes256*\n   4. **Authentication Algorithm**: *sha256*\n   5. **DH Group**: *group20*\n   6. **Localid**: This is the customer endpoint. These are generally IP addresses provided by your ISP. For example, `47.xxx.xxx.xxx`.\n\n## Magic WAN\n\n### 1. IPsec tunnels\n\n1. Follow the [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) instructions to create the required IPsec tunnels with the following options:\n\n   1. **Tunnel name**: Give your tunnel a descriptive name, like `Alibaba`.\n   2. **Interface address**: Choose from the subnet in your Alibaba Cloud configuration. For example, if your Alibaba default configuration is `169.xx.xx.1/30`, you might want to choose `169.xx.xx.2/30` for your Magic WAN side of the IPsec tunnel.\n   3. **Customer endpoint**: This is the IP address you entered for **Locali** in Alibaba's IPsec connection. For example, `47.xxx.xxx.xxx`.\n   4. **Cloudflare endpoint**: Enter the same anycast IP address provided by Cloudflare you have entered for Alibaba's Customer Gateway. Typically starts with `162.xx.xx.xx`.\n   5. **Pre-shared key**: Select **Use my own pre-shared key**, and enter the PSK key from your Alibaba Cloud IPsec tunnel.\n   6. **Replay protection**: **Enabled**.\n\n2. Select **Add tunnels** when you are done.\n\n### 2. Static route\n\n1. Follow the [Configure static routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) instructions to create a static route.\n2. In **Prefix**, enter the IP CIDR you used to create your virtual private cloud in the Alibaba Cloud interface. In our example we used `192.168.20.0/24`.\n\n</page>\n\n<page>\n---\ntitle: Aruba EdgeConnect Enterprise  Cloudflare One docs\ndescription: Cloudflare partners with Aruba's EdgeConnect SD-WAN solution to\n  provide users with an integrated solution. The EdgeConnect appliances manage\n  subnets associated with branch offices or retail locations. Anycast tunnels\n  are set up between the EdgeConnect appliances and Cloudflare to securely route\n  traffic.\nlastUpdated: 2025-11-04T17:07:51.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/aruba-edgeconnect/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/aruba-edgeconnect/index.md\n---\n\nCloudflare partners with Aruba's EdgeConnect SD-WAN solution to provide users with an integrated solution. The EdgeConnect appliances manage subnets associated with branch offices or retail locations. Anycast tunnels are set up between the EdgeConnect appliances and Cloudflare to securely route traffic.\n\nThis tutorial describes how to configure the EdgeConnect device for both east-west (branch to branch) and north-south (Internet-bound) use cases.\n\nWarning\n\nNote that north-south traffic routed through Cloudflare's Secure Web Gateway is an optional add-on feature set and requires a Cloudflare Zero Trust account.\n\n### Prerequisites\n\nBefore setting up a connection between EdgeConnect and Cloudflare, you must have:\n\n* A contract that includes Magic WAN and Secure Web Gateway.\n* Received two Cloudflare endpoints (anycast IP address).\n* Determined a private static /31 IP pair to use with each tunnel. The /31 pairs should be from a different private subnet, separate from the private subnets used behind each EdgeConnect appliance.\n* The EdgeConnect devices used in this tutorial and on v9.0.\n\n## Example scenario\n\nGRE tunnel configuration\n\nFor the purpose of this tutorial, the integration will refer to a scenario with two branch offices, each with distinct subnets.\n\nThere are 2 branch offices each with distinct subnets.\n\n* The east branch office has a `10.3.0.0/16` network with an EdgeConnect terminating the anycast GRE tunnel.\n* The west branch office has a `10.30.0.0/16` network with an EdgeConnect terminating the anycast GRE tunnel.\n\n![Table of branch subnet information](https://developers.cloudflare.com/_astro/branch-subnets.DXU4G0d8_1RaRSA.webp)\n\nBelow is an example of the **east\\_branch** deployment on the Orchestrator.\n\n![GCP East deployment configuration](https://developers.cloudflare.com/_astro/east-branch-deployment.C2wtem9-_2v3k5n.webp)\n\nThe Deployment screenshot displays several different IP addresses and interfaces. From left to right:\n\n* **Next Hop 10.3.0.1** - This example uses Google Cloud. This IP defines the default gateway IP for the subnet and is built into GCP.\n* **IP/Mask (LAN) 10.3.0.2/24** - This defines the LAN0 interface IP of the EdgeConnect appliance.\n* **IP/Mask (WAN) 10.2.0.2/24** - This defines the WAN0 interface IP of the EdgeConnect appliance.\n* **Next Hop 10.2.0.1** - This example uses Google Cloud. This IP defines the default gateway IP for the subnet and is built into GCP.\n\nIPsec tunnel configuration\n\nFor the purpose of this tutorial, the integration will refer to a scenario with two branch offices, each with distinct subnets.\n\nThe central branch office has a `10.22.0.0/24` network with an EdgeConnect terminating the anycast IPsec tunnel.\n\nThe west branch office has a `10.77.0.0/24` network with an EdgeConnect terminating the anycast IPsec tunnel.\n\n![IPsec tunnel values for east and west branches](https://developers.cloudflare.com/_astro/central-west-branch-ipsec.CsmmyLAQ_1gveqI.webp)\n\nBelow is an example of the **central\\_branch** deployment on the Orchestrator.\n\n![Values for central branch configuration within Orchestrator](https://developers.cloudflare.com/_astro/orchestrator-ipsec.BroLLE2X_2jelXM.webp)\n\nThe Deployment screenshot displays several different IP addresses and interfaces. From left to right:\n\n* **Next Hop 10.22.0.1** - This example uses Google Cloud. This IP defines the default gateway IP for the subnet and is built into GCP.\n* **IP/Mask (LAN) 10.22.0.2/24** - This defines the LAN0 interface IP of the EdgeConnect appliance.\n* **IP/Mask (WAN) 10.32.0.2/24** - This defines the WAN0 interface IP of the EdgeConnect appliance.\n* **Next Hop 10.32.0.1** - This example uses Google Cloud. This IP defines the default gateway IP for the subnet and is built into GCP.\n\n## 1. Define a common site on the Orchestrator\n\nFor all EdgeConnect devices using Cloudflare, modify the devices to put them on the same site. This disables automatic IPsec tunnel creation between the EdgeConnect devices using the same labels for the WAN interfaces in use.\n\nThis step is only required if Cloudflare is used for east-west traffic routing.\n\n## 2. Configure overlay policies\n\nWe use Aruba Orchestrator's Business Intent Overlays to create intuitive policies which automatically identify and steer application traffic to Cloudflare. Two Business Intent Overlay (BIO) policies are created in this example.\n\nGRE tunnel configuration\n\nCloudflare's [tunnel health checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/) are ping reply packets encapsulated in GRE packets. The source IP is the Edgeconnect WAN interface used to establish a tunnel, and the destination IP is Cloudflare servers. These packets need to be sent directly from the WAN interface and not through the established tunnels.\n\nTo create the overlay policy:\n\n1. Create a compound application, which is a combination of all [Cloudflare public IPs](https://www.cloudflare.com/ips/) and ICMP packets.\n\n![Application definition screen with IP values](https://developers.cloudflare.com/_astro/app-definition.rcGh7Hqx_JhsFK.webp)\n\n1. Create a breakout Business Intent Overlay (BIO) to bypass the GRE tunnel as the first policy and use this newly created application as the match criteria.\n\n2. Define at least one additional overlay policy and the traffic you want to send to Cloudflare over the GRE tunnels.\n\nThe service name used to send traffic through the tunnel created in the next step is **Cloudflare\\_GRE**. The example uses **Match Everything** to send all other traffic through the established tunnel (both private east-west traffic & Internet bound north-south traffic through Cloudflare's Secure Web Gateway).\n\n![Business Intent Overlay screen with breakout and CF overlays](https://developers.cloudflare.com/_astro/biz-intent-overlay.BKoZhAig_10ARsk.webp)\n\nIPsec tunnel configuration\n\nCloudflare's [tunnel health checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/tunnel-health-checks/) are ping reply packets encapsulated in IPsec packets. The source IP is the Edgeconnect WAN interface used to establish a tunnel, and the destination IP is Cloudflare servers. These packets need to be sent directly from the WAN interface and not through the established tunnels.\n\nTo create the overlay policy:\n\n1. Create a compound application, which is a combination of all [Cloudflare public IPs](https://www.cloudflare.com/ips/) and ICMP packets.\n\n![Application definition screen with IP values](https://developers.cloudflare.com/_astro/app-definition.rcGh7Hqx_JhsFK.webp)\n\n1. Create a breakout Business Intent Overlay (BIO) to bypass the IPsec tunnel as the first policy and use this newly created application as the match criteria.\n\n2. Define at least one additional overlay policy and the traffic you want to send to Cloudflare over the IPsec tunnels.\n\nThe service name used to send traffic through the tunnel created in the next step is **Cloudflare\\_IPsec**. The example uses **Match Everything** to send all other traffic through the established tunnel (both private east-west traffic and Internet bound north-south traffic through Cloudflare's Secure Web Gateway).\n\n![Business Intent Overlay screen with breakout and CF overlays for IPsec](https://developers.cloudflare.com/_astro/biz-intent-overlay-ipsec.3QFGazIP_dafR.webp)\n\n## 3. Create tunnels on Cloudflare and EdgeConnect\n\nGRE tunnel configuration\n\n![Diagram of GCP, Aruba Orchestratror, and Cloudflare products](https://developers.cloudflare.com/_astro/gcp-edgeconnect-diagram.K9bkvdja_19dWwF.webp)\n\n1. Create a tunnel on the EdgeConnect using Cloudflare's assigned public anycast IP and the service used in the overlay policy in the [previous step](#2-configure-overlay-policies).\n2. Create a Virtual Tunnel Interface (VTI) using the private IP pair shared with CF GRE tunnel endpoint and the passthrough tunnel to match the newly created tunnel alias (**CF\\_GRE\\_east** in our example).\n\n![Modify Passthrough Tunnel screen](https://developers.cloudflare.com/_astro/modify-passthrough._Sp9J4KQ_ZkjeDa.webp)\n\n![Edit Virtual Tunnel Interface screen](https://developers.cloudflare.com/_astro/edit-vti.BFWttrT1_NxkOo.webp)\n\n1. Define a GRE tunnel on the Cloudflare dashboard using the EdgeConnect appliance's public IP and the private IP pair /31 shared with the appliance.\n\n![GRE tunnels information for each branch](https://developers.cloudflare.com/_astro/gre-tunnels-edgeconnect.CPxCqhiR_dQp8a.webp)\n\nIPsec tunnel configuration\n\n![Diagram of GCP, Aruba Orchestratror, and Cloudflare products for IPsec tunnels](https://developers.cloudflare.com/_astro/gcp-edgeconnect-diagram-ipsec.CZWCUCOA_1Qfzux.webp)\n\nFor additional information on creating IPsec tunnels, refer to [API documentation for IPsec tunnels](https://developers.cloudflare.com/api/resources/magic_transit/subresources/ipsec_tunnels/methods/create/).\n\n* `X-Auth-Email`: Your Cloudflare email ID\n* `X-Auth-Key`: Seen in the URL (`dash.cloudflare.com/<X-Auth-Key>/....`)\n* `Account key`: Global API token in Cloudflare dashboard\n\n1. Test new IPsec tunnel creation",
      "language": "unknown"
    },
    {
      "code": "1. Create a new IPsec tunnel",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "1. Generate Pre Shared Key (PSK) for tunnel\n\nUse the tunnel ID from the response in Step 2. Save the pre-shared key generated in this step as you will need it to set up tunnels on the Orchestrator.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "**Create an IPsec tunnel on EdgeConnect**\n\nYou can create a tunnel after the Business Intent Overlay policies have been defined. Use the correct policy or service created in [configure overlay policy](#2-configure-overlay-policies). The local IP is the local WAN interface of the EdgeConnect device, and the remote IP is the Cloudflare public IP assigned as the tunnel endpoint.\n\n![Modify Passthrough Tunnel dialog with General values](https://developers.cloudflare.com/_astro/general-modify-passthrough.3ViqT0DH_Z1CHaiN.webp)\n\n![Modify Passthrough Tunnel dialog with IKE values](https://developers.cloudflare.com/_astro/ike-modify-passthrough.BbQLufk__BXURg.webp)\n\n![Modify Passthrough Tunnel dialog with IPsec values](https://developers.cloudflare.com/_astro/ipsec-modify-passthrough.gtfn_fS__Z90jp1.webp)\n\n**Create a Virtual Tunnel Interface (VTI) on the EdgeConnect appliance**\n\n![Values for Edit VTI Interface](https://developers.cloudflare.com/_astro/vti-interface-ipsec.R28dnfpw_Z1EQNdC.webp)\n\n## 4. Create static routes on Cloudflare and EdgeConnect\n\nGRE tunnel configuration\n\n1. Define static routes on the Cloudflare dashboard for the LAN subnet(s) attached to the EdgeConnect appliance. Use the private IP pair for the EdgeConnect tunnel endpoint.\n\n   In the example below, the traffic to subnet `10.3.0.0/16` attached to the **east\\_branch** EdgeConnect appliance has a next hop of `10.40.8.10`.\n\n![Static route information for each branch](https://developers.cloudflare.com/_astro/static-routes-cf.7x1mHyLW_wg3qp.webp)\n\n1. Define static routes on the Orchestrator so Cloudflare can route traffic between sites.\n\n   In the example below, we create a route for the subnet `10.30.0.0/24` on the **west\\_branch** to be routed via the established GRE tunnel between the EdgeConnect appliance and Cloudflare.\n\n![Static route information for each branch](https://developers.cloudflare.com/_astro/static-routes-edgeconnect.UNNAmHeW_18j552.webp)\n\nIPsec tunnel configuration\n\n![Static route values from Cloudflare dashboard](https://developers.cloudflare.com/_astro/static-routes-ipsec.QCWLampc_gKkPv.webp)\n\n**Static routes for central branch on EdgeConnect**\n\n![Static route values from EdgeConnect for central branch](https://developers.cloudflare.com/_astro/static-routes-central-ipsec.DXXq0rMA_24j8QC.webp)\n\n**Static routes for west branch on EdgeConnect**\n\n![Static route values from EdgeConnect for west branch](https://developers.cloudflare.com/_astro/static-routes-west-ipsec.DEkt69AP_103xKH.webp)\n\n## 5. Validate traffic flow\n\nGRE tunnel configuration\n\n**Validate Secure Web Gateway**\n\nTo validate traffic flow from the local subnet through Cloudflare's Secure Web Gateway, perform a curl as show in the example below.\n\n![Curl example for validating Secure Web Gateway](https://developers.cloudflare.com/_astro/validate-swg-curl.K6-tj_O9_Z1QbWM8.webp)\n\nYou can validate the request went through Gateway with the presence of the `Cf-Team` response header, or by looking at the logs in the dashboard under **Logs** > **Gateway** > **HTTP**.\n\n![Dashboard example for validating Secure Web Gateway](https://developers.cloudflare.com/_astro/dash-validate-swg.CyAEktkx_87B87.webp)\n\n**Validate east-west traffic**\n\nTo validate east-west traffic flow, perform a traceroute as shown in the example.\n\n![Traceroute example for verifying east-west traffic](https://developers.cloudflare.com/_astro/validate-traceroute.B1qfKEZn_Z14GqQm.webp)\n\nThe example shows a client in GCP East (`10.3.0.3`), which can ping the private IP of a client in GCP West (`10.30.0.4`).\n\nThe traceroute shows the path going from the client (`10.3.0.3`) to:\n\n* the GCP East lan0 IP on the EdgeConnect (`10.3.0.2`)\n* the Cloudflare private GRE endpoint IP (`10.4.8.11`)\n* the GCP West lan0 IP on the West EdgeConnect (`10.30.0.3`)\n* the GCP West client (`10.30.0.4`)\n\nThis validates the east-west traffic flow through Cloudflare Magic WAN.\n\nIPsec tunnel configuration\n\n**Validate Secure Web Gateway**\n\nTo validate traffic flow from the local subnet through Cloudflare's Secure Web Gateway, perform a cURL as shown in the example below.\n\n![cURL example for validating traffic](https://developers.cloudflare.com/_astro/static-routes-west-ipsec.DEkt69AP_103xKH.webp)\n\nYou can validate the request was sent through Secure Web Gateway with the presence of the `Cf-Team` response header or by looking at the logs in the dashboard under **Logs** > **Gateway** > **HTTP**.\n\n![Dashboard example for validating Secure Web Gateway](https://developers.cloudflare.com/_astro/dash-validation-ipsec.5ZgrnH6b_Z1NpSYA.webp)\n\n**Validate east-west traffic**\n\nTo validate east-west traffic flow, perform a traceroute as shown in the example.\n\n![Traceroute example for IPsec validation](https://developers.cloudflare.com/_astro/traceroute-ipsec.DIQvLqN1_Z1ccpF4.webp)\n\nThe example shows a client in GCP Central (`10.22.0.9`), which can ping the private IP of a client in GCP West (`10.77.0.10`).\n\nThe traceroute shows the path going from the client (`10.22.0.9`) to:\n\n* the GCP Central lan0 IP on the EdgeConnect (`10.22.0.2`)\n* the Cloudflare private IPsec endpoint IP (`192.168.10.11`)\n* the GCP West EdgeConnect private IPsec endpoint IP (`192.168.15.10`)\n* the GCP West client (`10.77.0.10`)\n\nThis validates the east-west traffic flow through Cloudflare Magic WAN.\n\n## 6. Cloudflare policies\n\nAt this point, the GRE or IPsec tunnels should be connected from the EdgeConnect appliances to Cloudflare's global network, and traffic is scoped to route over the tunnels using the EdgeConnect Business Intent Overlays.\n\nTo begin filtering traffic and gathering analytics, refer to the [Magic Firewall documentation](https://developers.cloudflare.com/magic-firewall/) to learn how to create filters for east-west inter-branch traffic and the [Secure Web Gateway documentation](https://developers.cloudflare.com/cloudflare-one/traffic-policies/) to learn how to configure Gateway policies if you decide to send traffic from your local private subnets to the Internet through Cloudflare Gateway.\n\n</page>\n\n<page>\n---\ntitle: Amazon AWS Transit Gateway  Cloudflare One docs\ndescription: This tutorial provides information and examples of how to configure\n  IPsec VPN between Cloudflare Magic WAN with an AWS Transit Gateway.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/aws/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/aws/index.md\n---\n\nThis tutorial provides information and examples of how to configure IPsec VPN between Cloudflare Magic WAN with an AWS Transit Gateway.\n\n## Prerequisites\n\nYou need to have an AWS transit gateway created in your AWS account. This is needed to route traffic between your AWS virtual private cloud (VPC) and Cloudflare Magic WAN. Refer to the [AWS documentation](https://docs.aws.amazon.com/vpc/latest/tgw/tgw-getting-started.html) to learn more about creating a transit gateway.\n\nAdditionally, you also need to configure the necessary route table entries for the virtual machine (VM) in your AWS virtual private cloud, as well the route table entries for the transit gateway. Otherwise, connectivity between your VM and another VM routed via Magic WAN will not work. Refer to the [AWS documentation](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html) to learn more about routing tables.\n\n## AWS\n\n### Create AWS transit gateway VPN attachment\n\n1. Go to **Transit gateways** > **Transit gateway attachments**, and select **Create transit gateway attachment**.\n\n2. Select the **Transit gateway ID** that you created previously from the dropdown.\n\n3. For **Attachment type**, select *VPN*.\n\n4. Under VPN attachment, select the following settings (you can leave settings not mentioned here with their default values):\n\n   1. **Customer Gateway**: Select **New**.\n   2. **IP Address**: Enter your Cloudflare anycast IP address.\n   3. **Routing options**: Select **Static**.\n\n5. Select **Create transit gateway attachment**.\n\n### Configure the VPN connection\n\n1. Select the VPN connection you created > **Download configuration**.\n\n2. This action downloads a text file. Search for the IP range that the AWS Transit Gateway assigned your tunnel. The first IP range should be the one used by the AWS Transit Gateway. Use the second IP range to configure your [Interface address](#ipsec-tunnels) in Magic WAN.\n\n3. Select the VPN connection you created > **Actions** > **Modify VPN tunnel options**.\n\n4. From the **VPN tunnel outside IP address** drop-down menu, choose one of tunnels.\n\n5. Take note of the **IP address** you chose, as this corresponds to the customer endpoint IP that you will need to configure on the Cloudflare side of the IPsec tunnel.\n\n6. The number of options for the VPN connection will expand. Take note of the **Pre-shared key**. You will need it to create the IPsec tunnel on Cloudflare's side.\n\n7. In **Inside IPv4 CIDR**, AWS enforces that only a `/30` block within the `169.254.0.0/16` range can be used. To accommodate this, Cloudflare supports a subset of this IP block. Namely, Cloudflare supports `169.254.240.0/20` to be assigned as the IPsec tunnel's (internal) interface IPs. This example will use `169.254.244.0/30` as the CIDR block for the IPsec tunnel: `169.254.244.1` for the AWS side of the tunnel, and `169.254.244.2` for the Cloudflare side of the tunnel.\n\n   Warning\n\n   Make sure you input an IP address supported by Cloudflare. If you do not input a value here, AWS will randomly generate an IP address that might not be supported by Cloudflare.\n\n8. Configure the following settings for the IPsec tunnel. Note that the **Startup action** needs to be set to **Start**, which means the AWS side will initiate IPsec negotiation. Settings not mentioned here can be left at their default settings:\n\n   * **Phase 1 encryption algorithms**: `AES256-GCM-16`\n   * **Phase 2 encryption algorithms**: `AES256-GCM-16`\n   * **Phase 1 integrity algorithms**: `SHA2-256`\n   * **Phase 2 integrity algorithms**: `SHA2-256`\n   * **Phase 1 DH group numbers**: `20`\n   * **Phase 2 DH group numbers**: `20`\n   * **IKE Version**: `ikev2`\n   * **Startup action**: **Start**\n   * **DPD timeout action**: `Restart`\n\n9. Select **Save changes**.\n\n10. Repeat the steps above to configure the second VPN connection. Use the second outside IP address, and make the appropriate changes to IP addresses as well when configuring Cloudflare's side of the tunnel.\n\nNote\n\nECMP over two VPN tunnels is not supported with a static routing configuration. You will need to configure dynamic routing for the VPN between the transit gateway and the customer gateway device. Refer to [AWS documentation](https://docs.aws.amazon.com/vpc/latest/tgw/tgw-transit-gateways.html) for more information.\n\n## Magic WAN\n\nAfter configuring the AWS transit gateway VPN connection and the tunnel as mentioned above, go to the Cloudflare dashboard and create the corresponding IPsec tunnel and static routes on the Magic WAN side.\n\n### IPsec tunnels\n\n1. Refer to [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) to learn how to add an IPsec tunnel. When creating your IPsec tunnel, make sure you define the following settings:\n\n   * **Tunnel name**: `tunnel01`\n   * **Interface address**: The `/30`CIDR block enforced by AWS (first usable IP is for the AWS side). For example, `169.254.244.2`.\n   * **Customer endpoint**: The IP address from AWS's VPN tunnel outside IP address. For example, `35.xx.xx.xx`.\n   * **Cloudflare endpoint**: Enter the first of your two anycast IPs.\n   * **Pre-shared key**: Choose **Use my own pre-shared key**, and enter the PSK you created for the AWS VPN tunnel.\n   * **Health check type**: Choose **Request**\n   * **Health check direction**: Choose **Bidirectional**\n   * **Replay protection**: Select **Enabled**.\n\n2. Select **Save**.\n\n3. Repeat the above steps for `tunnel02`. Chose the same prefix, but select the second IPsec tunnel for **Tunnel/Next hop**.\n\n### Static routes\n\nThe static route in Magic WAN should point to the appropriate virtual machine (VM) subnet you created inside your AWS virtual private cloud. For example, if your VM has a subnet of `192.168.192.0/26`, you should use it as the prefix for your static route.\n\nTo create a static route:\n\n1. Refer to [Create a static route](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) to learn how to create one.\n2. In **Prefix**, enter the subnet for your VM. For example, `192.xx.xx.xx/24`.\n3. For the **Tunnel/Next hop**, choose the IPsec tunnel you created in the previous step.\n4. Repeat the steps above for the second IPsec tunnel you created.\n\n</page>\n\n<page>\n---\ntitle: Cisco IOS XE  Cloudflare One docs\ndescription: This tutorial contains a configuration example for setting up an\n  IPsec tunnel between Cisco IOS XE and Cloudflare. For this tutorial, the\n  tested Cisco IOS XE software was version 17.03.07.\nlastUpdated: 2025-10-27T11:06:15.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/cisco-ios-xe/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/cisco-ios-xe/index.md\n---\n\nThis tutorial contains a configuration example for setting up an IPsec tunnel between Cisco IOS XE and Cloudflare. For this tutorial, the tested Cisco IOS XE software was version 17.03.07.\n\nYou should replace peer addresses with the anycast IP addresses assigned to your account. For example:\n\n* **Anycast 01**: `162.159.###.###`\n* **Anycast 02**: `172.64.###.###`\n\n## Cisco IOS XE configuration example",
      "language": "unknown"
    },
    {
      "code": "### Establish IPsec behind a NAT or CGNAT with port `4500`\n\nIf your Cisco router is behind a NAT or CGNAT and you need to establish a connection on port `4500`, you can use the `nat force-encap`command.\n\nAdd the `nat force-encap`command when setting up the `crypto ikev2 profile` for your tunnels:",
      "language": "unknown"
    },
    {
      "code": "## Diagnostic output: show crypto session detail",
      "language": "unknown"
    },
    {
      "code": "## Diagnostic output: show crypto session remote `<ANYCAST 01>` detail",
      "language": "unknown"
    },
    {
      "code": "## Diagnostic output: show crypto session remote `<ANYCAST 02>` detail",
      "language": "unknown"
    },
    {
      "code": "## Troubleshooting\n\nIf you notice connectivity issues after rebooting your Cisco router, your IPsec Security Associations (SAs) might be out of sync. Cisco recommends that you enable the Invalid Security Parameter Index (SPI) recovery feature to solve this issue. To do so, add the following lines to your configuration file:",
      "language": "unknown"
    },
    {
      "code": "Refer to [Cisco's documentation](https://www.cisco.com/c/en/us/support/docs/security-vpn/ipsec-negotiation-ike-protocols/115801-technote-iosvpn-00.html) for more information.\n\n</page>\n\n<page>\n---\ntitle: Microsoft Azure  Cloudflare One docs\ndescription: \"Microsoft Azure integration guides currently available:\"\nlastUpdated: 2025-10-27T11:06:15.000Z\nchatbotDeprioritize: true\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/azure/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/azure/index.md\n---\n\nMicrosoft Azure integration guides currently available:\n\n* [Microsoft Azure Virtual WAN](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/azure/azure-virtual-wan/)\n* [Microsoft Azure VPN Gateway](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/azure/azure-vpn-gateway/)\n\n</page>\n\n<page>\n---\ntitle: Furukawa Electric FITELnet  Cloudflare One docs\ndescription: This tutorial describes how to configure the Furukawa Electric's\n  FITELnet F220 and F70 devices to connect to Cloudflare Magic WAN via IPsec\n  tunnels. The use cases described in this tutorial are for both east-west\n  (branch to branch) and north-south (Internet-bound).\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/fitelnet/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/fitelnet/index.md\n---\n\nThis tutorial describes how to configure the Furukawa Electric's FITELnet F220 and F70 devices to connect to Cloudflare Magic WAN via IPsec tunnels. The use cases described in this tutorial are for both east-west (branch to branch) and north-south (Internet-bound).\n\n## Testing environment\n\nThese configurations were tested on FITELnet F220 and F70 series with the following firmware versions:\n\n* **F220 series**: Version 01.11(00)\n* **F70 series**: Version 01.09(00)\n\n## IPsec configuration\n\n### Magic WAN configuration\n\n1. Follow the [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) instructions to create the required IPsec tunnels with the following options:\n\n2. For the first IPsec tunnel, ensure the following settings are defined:\n\n   * **Tunnel name**: `FITEL-tunnel-1`\n   * **Interface address**: Enter `10.0.0.1/31` for your first tunnel.\n   * **Customer endpoint**: This setting is not required unless your router is using an IKE ID of [type `ID_IPV4_ADDR`](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/).\n   * **Cloudflare endpoint**: The Cloudflare anycast IP assigned to you by your account team.\n   * **Pre-shared key**: Create a pre-shared key for your first tunnel.\n\n3. For the second IPsec tunnel, make the same changes as you did for the first tunnel, and ensure these additional setting is defined:\n\n   * **Tunnel name**: `FITEL-tunnel-2`\n   * **Interface address**: Enter `10.0.0.3/31` for your second tunnel.\n   * **Customer endpoint**: This setting is not required unless your router is using an IKE ID of [type `ID_IPV4_ADDR`](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/).\n   * **Cloudflare endpoint**: The Cloudflare anycast IP assigned to you by your account team.\n   * **Pre-shared key**: Create a pre-shared key for your second tunnel.\n\n### FITELnet router configuration\n\n#### Router 1 settings\n\nUse the CLI to configure these settings:",
      "language": "unknown"
    },
    {
      "code": "#### Router 2 settings\n\nUse the CLI to configure these settings:",
      "language": "unknown"
    },
    {
      "code": "## Static route configuration\n\nTo configure routes for east-west (branch to branch) connections, refer to the following settings.\n\n### Magic WAN\n\n1. Follow the [Configure static routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) instructions to create a static route.\n2. For the first route, ensure the following settings are defined:\n\n* **Prefix**: `192.168.0.0/24`\n* **Tunnel/Next hop**: *FITEL-tunnel-1 / 10.0.0.0*\n\n1. For the second route, ensure the following settings are defined:\n\n* **Prefix**: `192.168.1.0/24`\n* **Tunnel/Next hop**: *FITEL-tunnel-2 / 10.0.0.2*\n\n### FITELnet router configuration\n\n#### Router 1\n\nUse the CLI to configure these settings:",
      "language": "unknown"
    },
    {
      "code": "#### Router 2\n\nUse the CLI to configure these settings:",
      "language": "unknown"
    },
    {
      "code": "## Connection test\n\n### IPsec status\n\nIn the FITELnet router CLI, you can run `show crypto sa` to check the status of the IPsec security associations (SAs). `Total number of ISAKMP/IPSEC SA` shows the number of established SAs.",
      "language": "unknown"
    },
    {
      "code": "### Route Status\n\nIn the FITELnet router CLI, you can run `show ip route` to check the route information. A `*` in the route information indicates that the route information is valid.",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Google Cloud VPN  Cloudflare One docs\ndescription: This tutorial provides information and examples of how to configure\n  IPsec VPN between Cloudflare Magic WAN with a GCP Cloud VPN.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/google/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/google/index.md\n---\n\nThis tutorial provides information and examples of how to configure IPsec VPN between Cloudflare Magic WAN with a GCP Cloud VPN.\n\n## Prerequisites\n\nYou need to have a GCP VPN gateway created in your GCP account. This is needed to route traffic between your GCP virtual private cloud (VPC) and Cloudflare Magic WAN. Refer to the [GCP documentation](https://cloud.google.com/network-connectivity/docs/vpn/how-to/creating-static-vpns) to learn more about creating a Cloud VPN gateway.\n\nA Classic VPN Gateway is required to support static routing. Route tables will also need to be manually configured to allow the routing between the VPN and Cloudflare Magic WAN to work. Refer to [GCP routing options](https://cloud.google.com/network-connectivity/docs/vpn/concepts/choosing-networks-routing#ts-tun-routing) to learn more about GCP VPC routing.\n\n## Google Cloud Platform\n\n### Create a GCP Cloud VPN Gateway\n\n1. Go to **Network Connectivity** > **VPN**.\n2. Select the **Cloud VPN Gateways** tab > **Create VPN Gateway**.\n3. Give your gateway a descriptive name.\n4. Choose the network you want to connect to with this Cloud VPN Gateway (VPC).\n5. Select a region where this Cloud VPN Gateway should be located.\n6. Choose **IPv4** as the IP traffic type that will flow through this Gateway.\n\nNote\n\nCloudflare Magic WAN does not yet support private routing via IPv6.\n\n### Configure the VPN connection\n\n1. Go to **Network Connectivity** > **VPN**.\n2. Select the **Cloud VPN Tunnels** tab > **Create VPN Tunnel**.\n3. Select the VPN Gateway you have created > **Continue**.\n4. Give your tunnel a descriptive name.\n5. For **Remote Peer IP Address**, use one of the public anycast Magic WAN IPs given to you by your account team.\n6. In **IKE version**, select **IKEv2**.\n7. You can generate an IKE pre-shared key, or add one you already own. If you generate one during this set up, keep it somewhere safe since you will need it in other steps to finish setting up Magic WAN and GCP.\n8. Choose **Route-based** as routing option.\n9. In **Remote network IP range** define the network you are going to expose to GCP via Cloudflare Magic WAN.\n\nNote\n\nYou can add new IP ranges once the VPN object is created. They will need to be created as VPC routes using this VPN connection (refer to the **Static Routes** section).\n\n1. Repeat the same process using your second Cloudflare anycast IP.\n\n### Static Routes\n\nStatic routing is necessary to route traffic between your VPN and Cloudflare Magic WAN. Follow these steps to create them for your VPC. Refer to [VPN route documentation](https://cloud.google.com/vpc/docs/routes) to learn more about VPN routing.\n\n1. Go to **VPN Network** > **Routes**.\n2. Select **Route Management**.\n3. Create a route.\n4. Choose the VPC network you want to use for that route.\n5. In **Route type** select **Static Routing**.\n6. In **IP Version** select **IPv4**.\n7. Configure the network you want to expose to your VPN in the **Destination IPv4 Range**.\n8. Choose a priority for your static route.\n9. (Optional) You can link that route to a specific instance tag, so only impacted instances will use that route.\n10. In **Next hop** select the VPN tunnel you created previously.\n11. Select **Create**.\n\n## Magic WAN\n\nAfter configuring the Cloud VPN gateway VPN and the tunnels as mentioned above, go to the Cloudflare dashboard and create the corresponding IPsec tunnels and static routes on the Magic WAN side.\n\n### IPsec tunnels\n\n1. Refer to [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) to learn how to add an IPsec tunnel. When creating your IPsec tunnel, make sure you define the following settings:\n\n   * **Tunnel name**: `tunnel01`\n   * **Interface address**: The IPsec tunnel inner `/30`CIDR block. For example, `169.254.244.2`.\n   * **Customer endpoint**: The IP address from GCP VPN tunnel outside IP address. For example, `35.xx.xx.xx`.\n   * **Cloudflare endpoint**: Enter the first of your two anycast IPs.\n   * **Pre-shared key**: Choose **Use my own pre-shared key**, and enter the PSK you created for the GCP VPN tunnel.\n   * **Health check type**: Choose **Reply**\n   * **Health check destination**: Choose **custom** and set the IP corresponding to the interface address for the tunnel\n   * **Health check direction**: Choose **Bidirectional**\n   * **Replay protection**: Select **Enabled**.\n\n2. Select **Save**.\n\n3. Repeat the above steps for `tunnel02`. Chose the same prefix, but select the second IPsec tunnel for **Tunnel/Next hop**.\n\nNote\n\nDo not forget to create a route in the corresponding GCP VPC covering for the healthcheck configuration of the tunnel. The route subnet should match the interface address CIDR of the Magic WAN tunnel (`169.254.244.2` in the example above).\n\nRefer to the **Static Routes** section for more detail on how to create a VPC route leading to your newly created tunnel.\n\n### Static routes\n\nThe static route in Magic WAN should point to the appropriate virtual machine (VM) subnet you created inside your GCP virtual private cloud. For example, if your VM has a subnet of `192.168.192.0/26`, you should use it as the prefix for your static route.\n\nTo create a static route:\n\n1. Refer to [Create a static route](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) to learn how to create one.\n2. In **Prefix**, enter the subnet for your VM. For example, `192.xx.xx.xx/24`.\n3. For the **Tunnel/Next hop**, choose the IPsec tunnel you created in the previous step.\n4. Repeat the steps above for the second IPsec tunnel you created.\n\n</page>\n\n<page>\n---\ntitle: Fortinet  Cloudflare One docs\ndescription: This tutorial provides information and examples of how to configure\n  Cloudflare Magic WAN with IPsec tunnels in conjunction with Fortinet FortiGate\n  firewalls.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/fortinet/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/fortinet/index.md\n---\n\nThis tutorial provides information and examples of how to configure Cloudflare Magic WAN with IPsec tunnels in conjunction with Fortinet FortiGate firewalls.\n\nThe FortiGate configuration settings presented here support [bidirectional health checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) as required by Cloudflare Magic WAN. However, they do not factor in any other traffic flows outside of the tunnel health checks. The configuration may need to be adjusted based on your current FortiGate configuration.\n\n## Testing Environment\n\nThe FortiGate configuration was tested on two different FortiGate firewalls:\n\n* FortiGate Virtual Appliance version 7.0.8, running on VMware ESXi 6.5\n* FortiGate FG80F, version 7.0.12\n\n## Magic WAN configuration\n\nThe first step to setting up Magic WAN is to add IPsec tunnels and Magic static routes to your Cloudflare account via the dashboard or API.\n\nBefore proceeding, ensure that you have the anycast IPs associated with your account. Check with your Cloudflare account team if you do not yet have them.\n\n### Magic IPsec Tunnels\n\nCloudflare recommends customers configure two Magic IPsec tunnels per firewall/router - one to each of the two anycast IP addresses.\n\n1. Follow the [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) instructions to create the required IPsec tunnels with the following options:\n\n   * **Health check type**: Change to *Request*.\n   * **Replay Protection**: Do not change from the default setting.\n\n### Magic static routes\n\nAdd two Magic static routes to define the IP address space that exists behind the Magic IPsec tunnels - one to each of the two Magic IPsec tunnels defined in the previous section.\n\nBy default, the Magic static routes are defined with the priority set to `100`. Cloudflare leverages [Equal Cost Multipath Routing (ECMP)](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/#equal-cost-multi-path-routing) and will load balance the traffic equally across the two tunnels. If you prefer to use an Active/Passive model, you can leave the default value for the first route set to `100`, and set the value for the second tunnel to `150` (higher value is a lower priority).\n\n1. Follow the [Configure static routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) instructions to create a static route.\n\n2. For the first route, ensure the following settings are defined:\n\n   * **Prefix**: Specify the [RFC1918](https://datatracker.ietf.org/doc/html/rfc1918) subnet that exists behind the first Magic IPsec tunnel you have defined in the previous section.\n   * **Tunnel/Next hop**: Select your first tunnel (Tunnel 01 of 02).\n\n3. For the second route, ensure the following settings are defined:\n\n   * **Prefix**: Specify the [RFC1918](https://datatracker.ietf.org/doc/html/rfc1918) subnet that exists behind the second Magic IPsec tunnel defined in the previous section.\n   * **Tunnel/Next hop**: Select your second tunnel (Tunnel 02 of 02).\n\n## Fortinet FortiGate configuration\n\n### Enable asymmetric routing\n\nTo ensure health checks work as expected, enable asymmetric routing for ICMP. This option is required. Otherwise, the tunnel health checks which are critical for proper Magic WAN functionality will not work as designed.\n\nNote that enabling asymmetric routing will affect FortiGate behavior. To learn more, refer to [How FortiGate behaves when asymmetric routing is enabled](https://community.fortinet.com/t5/FortiGate/Technical-Note-How-the-FortiGate-behaves-when-asymmetric-routing/ta-p/198575).",
      "language": "unknown"
    },
    {
      "code": "### Configure NAT-T (optional)\n\nIf you have NAT traversal (NAT-T) on your network, you need to enable this feature and initiate IKE communications on port `4500`.\n\nTo set the IKE port, add the following to your system settings:",
      "language": "unknown"
    },
    {
      "code": "To enable NAT-T, add `set nattraversal enable` to the IPsec tunnels you are configuring.",
      "language": "unknown"
    },
    {
      "code": "Refer to [Fortinet's documentation](https://community.fortinet.com/t5/FortiGate/Technical-Tip-IPSec-VPN-NAT-traversal/ta-p/197873) for more details.\n\n### Disable anti-replay protection\n\nFor route-based IPsec configurations, you will need to disable anti-replay protection. The command below disables anti-replay protection globally, but you can also do this per firewall policy. Refer to Fortinet's documentation on [anti-replay support per policy](https://community.fortinet.com/t5/FortiGate/Technical-Tip-Anti-Replay-option-support-per-policy/ta-p/191435) to learn more.",
      "language": "unknown"
    },
    {
      "code": "### IPsec tunnels\n\nMagic IPsec tunnels leverage a route-based site-to-site VPN model. This model relies on the use of virtual tunnel interfaces and routing to define the traffic that flows across the IPsec tunnels.\n\nConfigure two IPsec tunnels using the `phase1-interface` and `phase2-interface` objects.\n\nNote\n\nRefer to the Cloudflare Magic WAN dashboard to obtain the FQDN ID value when specifying the `localid` attribute/value pair in the `phase1-interface` configuration. To find this value go to **Tunnels** in the Cloudflare dashboard. Then, find your IPsec tunnel and expand it to reveal all the information associated to it.\n\n[Go to **Configuration**](https://dash.cloudflare.com/?to=/:account/magic-wan/configuration)\n\nThe following examples assume `wan1` is the external/egress interface of the FortiGate firewall.\n\n#### Add Phase 1 interfaces\n\n`MWAN_IPsec_Tun1` corresponds to Tunnel 01 of 02 added earlier in the Cloudflare section of the configuration. `MWAN_IPsec_Tun2` corresponds to Tunnel 02 of 02 added earlier in the Cloudflare section of the configuration.",
      "language": "unknown"
    },
    {
      "code": "#### Add Phase 2 interfaces\n\nAdd two `phase2-interfaces` - one for each of the two `phase1-interfaces` as follows:",
      "language": "unknown"
    },
    {
      "code": "### Network interfaces\n\n#### Virtual tunnel interfaces\n\nConfigure the virtual tunnel interfaces that were automatically added when specifying the `set net-device enable` within the `phase1-interface` settings.\n\nThese are the only settings that should need to be added to the virtual tunnel interfaces:\n\n* `ip`: The local IP address (specify with a `/32` netmask - `255.255.255.255`).\n* `remote-ip`: The value associated with the interface address specified earlier in the Magic IPsec tunnels section (specify with a `/31` netmask - `255.255.255.254`).\n* `alias`: This value is optional.\n\nThe following examples assume `wan1` is the external/egress interface of the FortiGate firewall.",
      "language": "unknown"
    },
    {
      "code": "### Validate communication across virtual tunnel interfaces\n\nOnce the virtual tunnel interfaces have been configured, you should be able to ping the IP address associated with the `remote-ip` attribute.\n\nBelow you have examples of a successful result from pinging across both of the virtual tunnel interfaces configured in the previous section:\n\n#### MWAN\\_IPsec\\_Tun1",
      "language": "unknown"
    },
    {
      "code": "#### MWAN\\_IPsec\\_Tun2",
      "language": "unknown"
    },
    {
      "code": "### Zone objects (optional)\n\nThis sample configuration assumes there are three zones configured on the FortiGate firewall. These zone objects are used in the policies referenced later in this document:\n\n* `Trust_Zone`: Contains the LAN interface(s).\n* `Untrust_Zone`: Contains the WAN interface.\n* `Cloudflare_Zone`: Contains both IPsec Tunnel interfaces.",
      "language": "unknown"
    },
    {
      "code": "### Create Address Objects\n\nCreate Address Objects to represent the [Cloudflare IPv4 address space](https://www.cloudflare.com/ips) as well as objects for the bidirectional health check anycast IPs:",
      "language": "unknown"
    },
    {
      "code": "### Configure Address Group Object\n\nCreate an Address Object that contains all of the Cloudflare IPv4 subnets as specified in the previous section. You can copy/paste the CLI commands below into an SSH terminal and the objects will get created automatically:",
      "language": "unknown"
    },
    {
      "code": "### Add security policy\n\nAdd a firewall rule to permit the ICMP traffic associated with the reply style bidirectional health checks.\n\nNote\n\nThis example assumes this rule is the second rule in the firewall policy (`edit 2`). If you opt to copy/paste the example into an SSH session, edit the numeric value associated with the rule position accordingly.",
      "language": "unknown"
    },
    {
      "code": "### Policy-based routing\n\nPolicy-based routing rules are required to ensure the traffic associated with the bidirectional health checks received over a Magic IPsec tunnel is sent back across the same Magic IPsec tunnel.\n\nAdd two policy-based routing rules, one for each of the two Magic IPsec tunnels.\n\nNote\n\nThis example assumes the rules below are the first and second rules respectively (`edit 1` and `edit 2`). If you opt to copy/paste the example into an SSH session, edit the numeric value associated with the rule position accordingly.",
      "language": "unknown"
    },
    {
      "code": "## Monitor Cloudflare Magic IPsec tunnel health checks\n\nThe Cloudflare dashboard monitors the health of all anycast tunnels on your account that route traffic from Cloudflare to your origin network. Refer to [Check tunnel health in the dashboard](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/check-tunnel-health-dashboard/) for more information.\n\n## Troubleshooting\n\n### Packet Capture\n\nPacket captures allow you to determine whether or not the policy-based routing rules are working as expected.\n\nNote\n\nDue to the nature of the reply-style tunnel health checks, you will see ICMP Reply packets in both the ingress and egress direction. This is expected behavior.\n\nThe expected behavior should look like the examples below - traffic ingressing Tunnel 01 of 02 should egress the same tunnel.",
      "language": "unknown"
    },
    {
      "code": "Conversely, traffic ingressing Tunnel 02 of 02 should egress the same tunnel:",
      "language": "unknown"
    },
    {
      "code": "### Flow Debugging\n\nFlow debugging can be helpful when it comes to determining whether or not traffic is ingressing/egressing the firewall via the expected path. It takes steps much further than the sniffer packet captures in the previous section, but it creates a tremendous amount of logging and should only be enabled when absolutely necessary.\n\nAdditionally, customers will likely need to contact Fortinet technical support for assistance with interpreting the flow debug logs, as well as to obtain recommendations in terms of how to configure FortiGate to ensure flows are routed correctly based on the application's requirements.",
      "language": "unknown"
    },
    {
      "code": "### Disable Flow Debugging\n\nThe typical use of `CTR + C` will not stop Flow Debugging.\n\nYou can disable Flow Debugging simply by typing the following at any point while the debug logs are scrolling by:",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Juniper Networks SRX Series Firewalls  Cloudflare One docs\ndescription: This tutorial provides information and examples of how to configure\n  Juniper Networks SRX Series Firewalls with Magic WAN.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/juniper/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/juniper/index.md\n---\n\nThis tutorial provides information and examples of how to configure Juniper Networks SRX Series Firewalls with Magic WAN.\n\nThe configuration settings in this document are based on JUNOS 23.4R2.13.\n\n## Prerequisites\n\nConfirm that you have two Cloudflare anycast IPs allocated to your account. You will establish IPsec tunnels to the two anycast IPs irrespective of the location of your Juniper SRX devices (from now on referred to as endpoint)  traffic will be naturally attracted to the closest Cloudflare colocation facility via BGP anycast.\n\nCloudflare recommends that customers configure two IPsec tunnels (one to each of the two anycast IPs allocated to you Cloudflare account) per Internet service provider per endpoint. This provides tunnel redundancy.\n\nEqual-cost multi-path routing (ECMP) ensures traffic is load-balanced across the tunnels, and you can control traffic steering across the tunnels through route prioritization.\n\nCloudflare supports route-based site-to-site IPsec tunnels, which require the creation of virtual tunnel interfaces (VTIs). We recommend you select one subnet per Magic IPsec tunnel with either a `/30` or `/31` netmask.\n\nUsing a `/31` netmask is a more efficient use of IP addresses as it doubles the number of available subnets compared to a `/30`netmask. This is possible because with a `/31`netmask there is no need to reserve IP addresses for the subnet and broadcast addresses, as there would be if you opt to use a `/30` netmask. Additional details can be found in [RFC 3021 - Using 31-Bit Prefixes on IPv4 Point-to-Point Links](https://datatracker.ietf.org/doc/html/rfc3021).\n\n## Cloudflare Magic WAN configuration\n\nThis section of the document will cover the configuration of:\n\n* Magic IPsec tunnels\n* Magic static routes\n\n### Magic WAN topology\n\nThis documentation assumes there are two locations connected via Magic WAN:\n\n| Site | Local/Remote | Security Zone | Subnet |\n| - | - | - | - |\n| A | Local | trust | `10.1.20.0/24` |\n| B | Remote | Cloudflare | `10.1.100.0/24` |\n\n### Magic IPsec tunnels\n\n1. Start by [creating the IPsec tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) in the Cloudflare dashboard with the following values:\n\n   * **Tunnel name**: Up to 15 characters (no spaces).\n   * **Description** (Optional).\n   * **Interface address**: This is the Virtual Tunnel Interface (VTI = `st0.x`) RFC 1918 address  the IP address specified in this dialog box is the address on the Cloudflare side of the tunnel.\n   * **Customer endpoint**: Specify the Internet IP address on the untrust side of the SRX firewall.\n   * **Cloudflare endpoint**: One of the two Cloudflare anycast IP addresses.\n   * **Pre-shared key**: Choose **Add pre-shared key later**.\n\n2. Select **Add IPsec Tunnel** and fill in the values for the second tunnel to the same Juniper SRX:\n\n   * Ensure you use a unique RFC 1918 IP address for the Interface Address (`/31` or `/30`).\n   * Once again, specify the Internet IP address on the untrust side of the SRX firewall for the **Customer Endpoint**.\n   * The **Cloudflare Endpoint** for the second tunnel will be the second Cloudflare anycast IP provisioned for your account.\n\n3. Select **Add Tunnels**. We also recommend selecting **Test Tunnels** to ensure that the settings do not conflict with any other tunnels defined in your account and that you specified the correct anycast IP addresses.\n\n4. You will see a warning indicator next to the tunnel names after creating them because we chose to add a pre-shared key later. This is expected behavior and indicates that a pre-shared key has not been generated yet for the associated tunnel.\n\n5. Select **Edit** next to one of the tunnels to generate a pre-shared key.\n\n6. Select **Generate a new pre-shared key** > **Update and generate a pre-shared key**. Make a note of the pre-shared key and store it somewhere safe.\n\n   Note\n\n   You can update the pre-shared key at any time by repeating this step. Just make sure to add the new value of the new pre-shared key to the corresponding tunnel configuration on the Juniper device.\n\n7. Repeat the previous step for the second tunnel.\n\n8. Expand the first tunnel's properties and note the **Tunnel ID** and **FQDN ID** values.\n\n9. Repeat the previous steps for the second tunnel.\n\n   Note\n\n   The **Tunnel ID** and **FQDN ID** values are unique per tunnel and remain unchanged unless you delete and recreate the tunnel. Generating a new Pre-Shared Key will not change the values.\n\n### Magic static routes\n\nRefer to the Magic WAN Topology section above for more details on the IP subnet scheme.\n\n[Magic static routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) effectively tell Magic WAN which tunnels to route traffic destined for a given Magic WAN site.\n\nSince two tunnels are configured to each endpoint, it is necessary to configure two static routes.\n\nCloudflare leverages [equal-cost multi-path](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/) routing to control traffic steering across the tunnels. The default priority for each route is 100  traffic will be load-balanced across the two tunnels equally via ECMP. You can modify the priorities as needed, however best practices dictate leaving the default values in place.\n\n1. Create a static route with the following values. Make sure you select the first tunnel in **Tunnel/Next hop**:\n\n   * **Description:** The description for the static route assigned to your first tunnel.\n   * **Prefix**: Enter the destination subnet for which this route is intended. For this example, it is `10.1.20.0/24` as stated above.\n   * **Tunnel/Next hop**: Choose your first tunnel from the drop-down menu.\n   * **Priority**: The default value is `100`.\n   * **Region code**: Leave set to **All Regions** unless otherwise specified.\n\n2. Select **Add Static Route** to add a second route for the same subnet. Make sure the second tunnel is selected in **Tunnel/Next hop**.\n\n3. Select **Test Routes** to ensure the settings are accepted, then select **Add Routes**.\n\n4. Confirm the routes were added correctly in **Magic WAN** > **Configuration** > **Static Routes**.\n\n## Juniper SRX configuration\n\nThere may be some differences in the syntax of the commands in the version on your SRX devices. However, the principles are the same. Refer to the Juniper product documentation for more information.\n\nThe interface naming convention for VTI interfaces (also known as Secure Tunnel Interfaces) in Junos is `st0.x`.\n\n[Secure Tunnel Interface in a Virtual Router - Juniper IPsec VPN User Guide](https://www.juniper.net/documentation/us/en/software/junos/vpn-ipsec/topics/topic-map/security-secure-tunnel-interface-in-a-virtual-router.html)\n\nThe following elements will be configured on the Juniper SRX firewall(s):\n\n* Ensure the LAN interface is in the `trust` zone\n* Add virtual tunnel Interfaces (`st0.0` and `st0.1`)\n* Assign tunnel interfaces to the `cloudflare` security zone\n* Allow required protocols to both the tunnel and untrust security zones\n* IKE configuration\n* IPsec configuration\n* Policy-based routing (filter-based forwarding)\n* Security policies\n\n### Tunnel interfaces\n\n1. Add two tunnel interfaces:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### Security Zone (Cloudflare) - tunnel interfaces\n\nDefine a security zone and add both tunnel interfaces to it. At a minimum, the interfaces should allow `ping`, but this zone only contains point-to-point connections between the firewall and the customer network namespace. Setting it to `all` for system-services and protocols should be fine.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### Security zone (untrust) - `host-inbound-traffic`\n\nAdd `ping` and `ike` to the security zone containing the external interface used to establish the IPsec tunnels to Cloudflare.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### IKE - Phase 1\n\n#### IKE proposal\n\nAdd an IKE proposal that specifies the [Phase 1 Configuration Parameters](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/gre-ipsec-tunnels/#supported-configuration-parameters):",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "#### IKE policies\n\nDefine two IKE policies - one for each of the two Magic IPsec tunnels:\n\n\\***Tunnel 1 (SRX300\\_IPSEC\\_01)**",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "**Tunnel 2 (SRX300\\_IPSEC\\_02)**",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "#### IKE gateways\n\nDefine two IKE gateways  one for each of the two Magic IPsec tunnels. In the examples below, note the use of the **FQDN ID** value obtained from the Cloudflare dashboard in the `local-identity` hostname setting.\n\n**Tunnel 1 (SRX300\\_IPSEC\\_01)**",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "**Tunnel 2 (SRX300\\_IPSEC\\_02)**",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### Phase 2 - IPsec\n\n#### IPsec proposal\n\nAdd an IPsec proposal that specifies the [Phase 2 Configuration Parameters](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/gre-ipsec-tunnels/#supported-configuration-parameters):",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "#### IPsec Policy\n\nDefine one IPsec policy  reference the IPsec proposal created above.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "#### IPsec VPN tunnels\n\nDefine two IPsec policies - one for each of the two Magic IPsec tunnels. It is crucial to ensure that:\n\n* [Anti-replay](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/anti-replay-protection/) protection is disabled.\n  * Use the [`no-anti-replay`](https://www.juniper.net/documentation/us/en/software/junos/interfaces-adaptive-services/topics/ref/statement/no-anti-replay-edit-services.html) option.\n\n* The SRX is the tunnel initiator:\n\n  * Cloudflare will not instantiate the tunnel\n  * If the SRX does not initiate the tunnel, then the tunnel will not be established until there is an attempt to connect to resources through the tunnel\n  * Use [`establish-tunnels immediately`](https://www.juniper.net/documentation/us/en/software/junos/interfaces-adaptive-services/topics/ref/statement/establish-tunnels-edit-services-ipsec-vpn.html) to ensure the SRX is the tunnel initiator.\n\n**VPN Tunnel 1 (cf\\_magic\\_wan\\_ipsec\\_tun\\_01)**",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "**VPN Tunnel 2 (cf\\_magic\\_wan\\_ipsec\\_tun\\_02)**",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### Policy-Based Routing\n\nThe SRX platform provides policy-based routing functionality, which Juniper refers to as [filter-based forwarding](https://www.juniper.net/documentation/us/en/software/junos/routing-policy/topics/concept/firewall-filter-option-filter-based-forwarding-overview.html).\n\nFilter-based forwarding is implemented by configuring the following:\n\n1. **Routing Instance**: Specify the routing table(s) to which a packet is forwarded and the destination to which the packet is forwarded at the \\[edit routing-instances] hierarchy level.\n2. **Firewall Filter**: Use a stateless firewall filter to specify the source and destination addresses in conjunction with a routing instance that forwards traffic across the Magic IPsec tunnels, then bind the firewall filter to the ingress interface (trust zone).\n3. **RIB Group**: Share interface routes with the forwarding routing instances used in filter-based forwarding (FBF).\n\nNote\n\nFirewall filters must incorporate at least two terms:\n\n* **Term 1**: Classify the traffic to forward to Magic WAN\n* **Term 2**: Permit all other traffic  otherwise, the firewall filters will discard any traffic not intended for Magic WAN destinations.\n\nThis configuration only factors in one local site (`10.1.20.0/24`). In this example, we assume devices in the trust zone must route traffic to a remote subnet at another Magic WAN-protected site (`10.1.100.0/24`).\n\nDefine a static route on the SRX to route traffic to `10.1.100.0/24` with redundant routes referencing each of the two tunnels.\n\n**Routing Instance:**\n\n[Routing Instances](https://www.juniper.net/documentation/us/en/software/junos/routing-overview/topics/concept/routing-instances-overview.html) effectively add additional routing tables to the SRX platform.\n\nAs mentioned earlier, any traffic destined for other Magic WAN protected sites must be routed over the Magic IPsec tunnels.\n\nThe example includes two static routes - one to each of the two VTIs on the Cloudflare side of the Magic IPsec Tunnels (`10.252.2.20` and `10.252.2.22`).\n\nWhile it is possible to be more prescriptive in terms of the destination subnets, we simply use `0.0.0.0/0` as the firewall filter ensures only traffic destined for `10.1.100.0/24` will be forwarded to the routing instance. Any other traffic not destined for `10.1.100.0/24` will continue to the primary routing table (`inet.0`) as it falls outside the scope of the firewall filter configured in the next section below.\n\nLeaving the destination subnet as `0.0.0.0/0` eases some administrative burden as you only need to modify the firewall filter to specify which traffic is destined for Magic WAN.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "**Firewall Filter:**\n\nIn this step, we create a stateless firewall filter to ensure only packets from `10.1.20.0/24` destined for `10.1.100.0/24` are sent to the `MAGIC_WAN_RI` routing instance.\n\n* **Term 1** - `MAGIC_WAN_NETS` ensures only packets from `10.1.20.0/24` destined for `10.1.100.0/24` are sent to the `MAGIC_WAN_RI` routing instance. Take note of the `count` statement defined in this term. [Count](https://www.juniper.net/documentation/us/en/software/junos/routing-policy/topics/example/firewall-filter-stateless-example-act-on-sampling.html) allows you to view how many packets are processed by this term in the firewall filter. An example of how to view the Counter is included below.\n* **Term 2** - `ALLOW_EVERYTHING_ELSE` ensures all other traffic continues to the primary routing table (`inet.0`).",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "**View Firewall Filter Counters**\n\nTo view the firewall filter counter:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "**Bind Firewall Filter to the interface in the** **trust** **zone:**",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "**RIB Group:**\n\nRIB Groups allow you to concatenate the contents of multiple routing tables into a routing table group.\n\nThe primary routing table in the RIB group should be `inet.0` followed by the secondary routing table `MAGIC_WAN_RI.inet.0` which is the `MAGIC_WAN_RI` routing-instance created above.\n\n[Interface Routes](https://www.juniper.net/documentation/us/en/software/junos/cli-reference/topics/ref/statement/interface-routes-edit-routing-options.html) referenced below by the `interface-routes` statement determines which interfaces and Routing Instances are bound to the RIB Group.",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### Security policies\n\nDefine security policies to permit traffic flows destined for Magic WAN-protected resources. The source/destination zones must incorporate the zone containing the tunnel interfaces.\n\nThere are two very simple rules to allow traffic bidirectionally  it is generally recommended to start with a similar policy and then add more stringent rules once general connectivity is established successfully.\n\n**From Zone:** *Cloudflare* **To Zone:** *trust*",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "**From Zone:** *trust* **To Zone:** *Cloudflare*",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## Troubleshooting\n\n### Validate tunnel connectivity\n\nThere are several diagnostic commands available to view the status of IPsec tunnels.\n\n#### Ping across virtual tunnel interfaces\n\nUse ping to test connectivity from the SRX side of the tunnel to the Cloudflare side of the tunnel. Ensure you use the source option to specify the IP address associated with tunnel interfaces `st0.0` and `st0.1`, respectively:\n\n**Tunnel 1** - `st0.0 - 10.252.2.21`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "**Tunnel 2** - `st0.1 - 10.252.2.23`",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "#### Phase 1 - View Active Peers\n\n[`show security ike active-peer`](https://www.juniper.net/documentation/us/en/software/junos/cli-reference/topics/ref/command/show-security-ike-active-peer.html)",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "#### Phase 1 - View IKE Security Associations\n\n[`show security ike security-associations`](https://www.juniper.net/documentation/us/en/software/junos/cli-reference/topics/ref/command/show-security-ike-security-associations.html)",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "#### Phase 2 - View IPsec Security Associations\n\n[`show security ipsec security-associations`](https://www.juniper.net/documentation/us/en/software/junos/vpn-ipsec/topics/ref/command/show-security-ipsec-security-associations.html)",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### IKE `traceoptions`\n\nIt can be very helpful to enable debug logging via traceoptions while setting up the tunnels. The log data can help determine if there are issues and, if so, where they might be occurring.\n\nPlease note that some errors in the log are benign. The types of errors to look for are those related to authentication or encryption/integrity (that is, no proposal chosen).\n\n#### Enable IKE `traceoptions`\n\n[traceoptions (Security IKE)](https://www.juniper.net/documentation/us/en/software/junos/cli-reference/topics/ref/statement/security-edit-traceoptions-ike.html)",
      "language": "unknown"
    },
    {
      "code": "The log file can be viewed by doing the following:\n\n1. From an operational mode, run **start shell**.\n\n2. Use the `tail` command to view the contents of the log file in real-time:",
      "language": "unknown"
    },
    {
      "code": "3. Press `CTRL + C` when finished.\n\n4. Type `exit` to return to the operational mode prompt.\n\nEither deactivate `traceoptions` or delete `traceoptions` once debugging is complete.\n\n#### Deactivate IKE `traceoptions`",
      "language": "unknown"
    },
    {
      "code": "Confirm `traceoptions` is deactivated with:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "### IPsec `traceoptions`\n\nRefer to [traceoptions (Security IPsec)](https://www.juniper.net/documentation/us/en/software/junos/cli-reference/topics/ref/statement/security-edit-traceoptions-ipsec.html) for more information on this topic.\n\n#### Enable IPsec `traceoptions`",
      "language": "unknown"
    },
    {
      "code": "To view the log file:\n\n1. From an operational mode, run `start shell`.\n2. Use the tail command to view the contents of the log file in real time: `tail -f /var/log/ipsec-debug.log`\n3. Press `CTRL + C` when finished.\n4. Type `exit` to return to the operational mode prompt.\n\nEither deactivate `traceoptions` or delete `traceoptions` once debugging is complete.\n\n#### Delete IPsec `traceoptions`",
      "language": "unknown"
    },
    {
      "code": "#### Deactivate IPsec `traceoptions`",
      "language": "unknown"
    },
    {
      "code": "Confirm `traceoptions` is deactivated:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "</page>\n\n<page>\n---\ntitle: Oracle Cloud  Cloudflare One docs\ndescription: This tutorial provides information and examples of how to configure\n  IPsec between Cloudflare Magic WAN and an Oracle Cloud Site-to-site VPN.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/oracle/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/oracle/index.md\n---\n\nThis tutorial provides information and examples of how to configure IPsec between Cloudflare Magic WAN and an Oracle Cloud Site-to-site VPN.\n\n## Prerequisites\n\nYou need a pre-shared key to establish the IPsec tunnel. You can use the following code to create a random key:",
      "language": "unknown"
    },
    {
      "code": "Warning\n\nThe code above is an example of how you might generate a random key. However, make sure you generate a key that is strong enough to comply with your security needs.\n\nYou can try this code in the [Workers playground](https://workers.cloudflare.com/playground#LYVwNgLglgDghgJwgegGYHsHALQBM4RwDcABAEbogB2+CAngLzbPYDqApmQNJQQBimYACFKNRHSoBzAB4ArAEoBBANYR5AEVYAJAOJCAagA0AXCxYduvAVhHVaEmQpVrNug4YCwAKADC6KhDsAdjqUADOMOhhvFD+xiQYWHgExCRUcMDsDABEUDTs0gB0smHZpKhQYEEZWbn5RSXZ3n4BQRDYACp0MOzxcDAwYFAAxgSxVMiycABucGHDCLAQANTA6Ljg7N7eBZFIJLjsqHDgECQA3l4AkHMSwwnsEMMAFgAUAJQXXtdXw-5hZzgJAYaXYAHcSABVPIQAAcigQCDgdFeABZYe8iD8Ft0IOhCpJHvI4DR0MB9HAwCB2GFXnBMT8qmcyHN2AA2VEAZQgiykwPIeLgr25vMkhVQCDJPmeiD8h0K-UGKKo4DAABoSPSGT8WWF2VyeXlJPzdfqRUbCgh2IM4MN2K9kAAdZbISQagDk7vePyuvr9JADlutYFt9qdyFdHq9Pr9voDJCDNrtDoYkZInu1vr+VABCTylPNfJBpo5hbFYRAZABoteAAYNQBmABMmauVogIAQVFBEPkNMiOftFXSYDLGsufue7DghwQYXiE792WzgWCEG67Gy8WygWkKGeEGAYGyap9AF9T76zwyrhevGesd4zMwLDx+IJbGJ6FI5EpVBptD0Ixmn8Vd2lCCIohiOIEkEZJCFIdJMhyTJCHwQgyjzKokNqMgwHQMgml8UC2k6Dc+gGIZRmgfxJjCfxti8c5lzJeBoDISpeDoAB9dDN2MbIm1rJtUWwWsGzEgB2E8WOANioA4oZ1241AQ0kUpjAAbWyKh1nYEpuL+OSCGyABdNVsmAOA8m4tYNiqLc6kOBpSjPJ9n1fKwP1Eewfycf9XCAwxmG8IA).\n\n## Oracle Cloud\n\n### 1. Create Oracle Cloud customer-premises equipment\n\n1. Go to **Networking** > **Customer connectivity**, and select **Customer-premises equipment**.\n\n2. Select **Create CPE**.\n\n3. Select the following settings (you can leave settings not mentioned here with their default values):\n\n   * **Name**: Enter a name.\n   * **IP Address**: Enter your Cloudflare anycast IP address.\n   * **CPE vendor information**: Select **Other**.\n\n4. Select **Create CPE**.\n\n### 2. Create Oracle Cloud dynamic routing gateways\n\n1. Go to **Networking** > **Customer connectivity**, and select **Dynamic routing gateways**.\n2. Select **Create Dynamic routing gateways**.\n3. Select the following settings (you can leave settings not mentioned here with their default values):\n   * **Name**: Enter a name.\n4. Select **Create Dynamic routing gateways**.\n\n### 3. Create an IPsec connection\n\n1. Go to **Networking** > **Customer connectivity**, and select **Site-to-Site VPN**.\n\n2. Select **Create IPsec connection**.\n\n3. Select the following settings (you can leave settings not mentioned here with their default values):\n\n   * **Name**: Enter a name.\n\n   * **Customer-premises equipment**: Select the CPE you have created in step 1.\n\n   * **Dynamic routing gateways**: Select the DRG you have created in step 2.\n\n   * **Routes to your on-premises network**: Enter a CIDR range you want to route to Magic WAN.\n\n   * **Tunnel 1**\n\n     * **Name**: Enter a name.\n\n     * Select **Provide custom shared secret**.\n\n     * Enter the **pre-shared key** you created in the Prerequisites section.\n\n     * **IKE version**: **IKEv2**\n\n     * **Routing type**: **Static routing**\n\n     * **IPv4 inside tunnel interface - CPE**: Enter the internal tunnel IP on the Cloudflare side of the IPsec tunnel. In this example, it is `10.200.1.0/31`.\n\n     * **IPv4 inside tunnel interface - Oracle**: Enter the internal tunnel IP on the Oracle side of the IPsec tunnel. In this example, it is `10.200.1.1/31`. This matches with the Cloudflare side for this tunnel.\n\n       1. Select **Show advanced options**\n\n       2. Select **Phase one (ISAKMP) configuration**\n\n          * Select **Set custom configurations**\n          * **Custom encryption algorithm**: **AES\\_256\\_CBC**\n          * **Custom authentication algorithm**: **SHA2\\_256**\n          * **Custom Diffie-Hellman group**: **GROUP20**\n          * **IKE session key lifetime in seconds**: **86400**\n\n       3. Select **Phase two (IPsec) configuration**\n\n          * Select **Set custom configurations**\n          * **Custom encryption algorithm**: **AES\\_256\\_CBC**\n          * **HMAC\\_SHA2\\_256\\_128**: **HMAC\\_SHA2\\_256\\_128**\n          * **IPsec session key lifetime in seconds**: **28800**\n          * **Perfect forward secrecy Diffie-Hellman group**: **GROUP20**\n\n   * **Tunnel 2**\n     * Repeat the above steps for Tunnel 2. Select the right IP for **IPv4 inside tunnel interface - CPE**: `10.200.2.0/31` and **IPv4 inside tunnel interface - Oracle**: `10.200.2.1/31`\n\n4. Select **Create IPsec connection**\n\n## Magic WAN\n\nAfter configuring the Oracle Site-to-site VPN connection and the tunnels as mentioned above, go to the Cloudflare dashboard and create the corresponding IPsec tunnel and static routes on the Magic WAN side.\n\n### IPsec tunnels\n\n1. Refer to [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) to learn how to add an IPsec tunnel. When creating your IPsec tunnel, make sure you define the following settings:\n\n   * **Tunnel name**: Enter a name.\n   * **Interface address**: Enter the internal tunnel IP on the Cloudflare side of the IPsec tunnel. In this example, it is `10.200.1.0/31`.\n   * **Customer endpoint**: The Oracle VPN public IP address.\n   * **Cloudflare endpoint**: Enter your Cloudflare anycast IP address.\n   * **Health check type**: **Request**\n   * **Health check direction**: **Unidirectional**\n   * **Health check target**: **Default**\n   * **Pre-shared key**: Choose **Use my own pre-shared key**, and enter the pre-shared key you created in the Prerequisites section.\n   * **Replay protection**: **Enabled**.\n\n2. Select **Add tunnels**.\n\n3. Repeat the above steps for Tunnel 2. Chose the same Cloudflare anycast IP address and select the right IP for **Interface address**: `10.200.2.0/31`\n\n### Static routes\n\nThe static route in Magic WAN should point to the appropriate virtual machine (VM) subnet you created inside your Oracle Virtual Cloud Network (VCN). For example, if your VM has a subnet of `192.168.192.0/26`, you should use it as the prefix for your static route.\n\nTo create a static route:\n\n1. Refer to [Create a static route](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) to learn how to create one.\n2. In **Prefix**, enter the subnet for your VM. For example, `192.xx.xx.xx/24`.\n3. For the **Tunnel/Next hop**, choose the IPsec tunnel you created in the previous step.\n4. Repeat the steps above for the second IPsec tunnel you created.\n\n</page>\n\n<page>\n---\ntitle: Palo Alto Networks Next-Generation Firewall  Cloudflare One docs\ndescription: This tutorial includes the steps required to configure IPsec\n  tunnels to connect a Palo Alto Networks Next-Generation Firewall (NGFW) to\n  Cloudflare Magic WAN through a Layer 3 deployment.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/palo-alto/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/palo-alto/index.md\n---\n\nThis tutorial includes the steps required to configure IPsec tunnels to connect a Palo Alto Networks Next-Generation Firewall (NGFW) to Cloudflare Magic WAN through a Layer 3 deployment.\n\n## Software version tested\n\n* PAN-OS 9.1.14-h4\n\n## Use Cases\n\n* **Magic WAN**: Connecting two or more locations with [RFC-1918](https://datatracker.ietf.org/doc/html/rfc1918) private non-routable address space.\n* **Magic WAN with Cloudflare Zero Trust (Gateway egress)**: Same as Magic WAN, with the addition of outbound Internet access from Magic WAN protected sites egressing the Cloudflare edge network.\n\n## Prerequisites\n\nThis tutorial assumes you have a standalone NGFW with two network interfaces:\n\n* One in a trust security zone (`Trust_L3_Zone`) with an [RFC-1918](https://datatracker.ietf.org/doc/html/rfc1918) non-Internet routable IP address (internal network);\n* And the other in an untrust security zone (`Untrust_L3_Zone`) with a legally routable IP address (Internet facing).\n\nAdditionally, there must be a default gateway set on the Virtual Router (default) pointing to the router of your Internet service provider(s).\n\n## Environment\n\nThe following IP addresses are used throughout this tutorial. Any legally routable IP addresses have been replaced with IPv4 Address Blocks Reserved for Documentation ([RFC5737](https://datatracker.ietf.org/doc/html/rfc5737)) addresses within the `203.0.113.0/24` subnet.\n\n| Description | Address | Address |\n| - | - | - |\n| NGFW external interface | `203.0.113.254/24` | |\n| NGFW internal interface | `10.1.100.254/24` | |\n| Local trust subnet (LAN) | `10.1.100.0/24` | |\n| NGFW tunnel interface 01 | `10.252.2.26/31` (Cloudflare side) | `10.252.2.27/31` (NGFW side) |\n| NGFW tunnel interface 02 | `10.252.2.28/31` (Cloudflare side) | `10.252.2.29/31` (NGFW side) |\n| Magic WAN anycast IP | `162.159.66.164` | `172.64.242.164` |\n| Magic WAN health check anycast IP | `172.64.240.253` | `172.64.240.254` |\n| VLAN0010 - remote Magic WAN site | `10.1.10.0/24` | |\n| VLAN0020 - remote Magic WAN site | `10.1.20.0/24` | |\n\n## Cloudflare Magic WAN\n\n### Magic IPsec Tunnels\n\nUse the Cloudflare dashboard or API to [configure two IPsec Tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels). The settings mentioned in [Add IPsec tunnels](#add-ipsec-tunnels) below are used for the IPsec tunnels referenced throughout the remainder of this guide.\n\nThese are the target IP addresses for bidirectional tunnel health checks:\n\n* `172.64.240.253`: Use with the primary IPsec tunnel.\n* `172.64.240.254`: Use with the secondary IPsec tunnel.\n\nWarning\n\nYou need to [configure bidirectional health checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) with Magic WAN. The settings must include custom target IP addresses for each tunnel. Additionally, Cloudflare recommends that you lower the rate at which health check probes are sent.\n\n#### Add IPsec tunnels\n\n1. Follow the [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/) instructions to create the required IPsec tunnels with the following options:\n\n   * **Tunnel name**: `SFO_IPSEC_TUN01`\n   * **Interface address**: `10.252.2.96/31`\n   * **Customer endpoint**: `203.0.113.254`\n   * **Cloudflare endpoint**: `162.159.66.164`\n   * **Health check rate**: *Low* (default value is *Medium*)\n   * **Health check type**: *Reply*\n   * **Health check target**: *Custom* (default is *Default*)\n   * **Target address**: `172.64.240.253`\n\n2. Select **Add pre-shared key later** > **Add tunnels**.\n\n3. Repeat the process to create a second IPsec tunnel with the following options:\n\n   * **Tunnel name**: `SFO_IPSEC_TUN02`\n   * **Interface address**: `10.252.2.98/31`\n   * **Customer endpoint**: `203.0.113.254`\n   * **Cloudflare endpoint**: `172.64.242.164`\n   * **Health check rate**: *Low* (default value is *Medium*)\n   * **Health check type**: *Reply*\n   * **Health check target**: *Custom* (default is *Default*)\n   * **Target address**: `172.64.240.254`\n\n#### Generate Pre-shared keys\n\nWhen you create IPsec tunnels with the option **Add pre-shared key later**, the Cloudflare dashboard will show you a warning indicator:\n\n![Magic IPsec Tunnels - No PSK](https://developers.cloudflare.com/_astro/03_magic_ipsec_tun_no_psk.BtN-GBSa_aKP0c.webp)\n\n1. Select **Edit** to edit the properties of each tunnel.\n2. Select **Generate a new pre-shared key** > **Update and generate pre-shared key**. ![Generatre a new pre-shared key for each of your IPsec tunnels](https://developers.cloudflare.com/_astro/04_magic_ipsec_tun_01_gen_psk.DmjWjXn7_16iC2z.webp)\n3. Copy the pre-shared key value for each of your IPsec tunnels, and save these values somewhere safe. Then, select **Done**. ![Take note of your pre-shared key, and keep it in a safe place](https://developers.cloudflare.com/_astro/05_magic_ipsec_tun_01_show_psk.hKhA9tvM_ZSIU09.webp)\n\n#### IPsec identifier - FQDN (Fully Qualified Domain Name)\n\nAfter creating your IPsec tunnels, the Cloudflare dashboard will list them under the **Tunnels** tab. Select the arrow (**>**) on each of your IPsec tunnel to collect the FQDN ID value from each of them. The FQDN ID value will be required when configuring IKE Phase 1 on the Palo Alto Networks Next-Generation Firewall.\n\n![Take note of the FQDN ID value for each of your IPsec tunnels](https://developers.cloudflare.com/_astro/08_magic_ipsec_tun_01_fqdn.C7qdzNJI_dLAfU.webp)\n\n### Magic Static Routes\n\nIf you refer to the [Environment section](#environment), you will notice there is one subnet within `Trust_L3_Zone`: `10.1.100.0/24`.\n\nCreate a [static route](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) for each of the two IPsec tunnels configured in the previous section, with the following settings (settings not mentioned here can be left with their default settings):\n\n#### Tunnel 01\n\n* **Description**: `SFO_VLAN100_01`\n* **Prefix**: `10.1.100.0/24`\n* **Tunnel/Next hop**: `SFO_IPSEC_TUN01`\n\n#### Tunnel 02\n\n* **Description**: `SFO_VLAN100_02`\n* **Prefix**: `10.1.100.0/24`\n* **Tunnel/Next hop**: `SFO_IPSEC_TUN02`\n\n![Add static routes for each of the IPsec tunnels you created in the previous step](https://developers.cloudflare.com/_astro/10_magic_ipsec_static_routes.CJCRbqXL_Z1yuHVG.webp)\n\n## Palo Alto Networks Next-Generation Firewall\n\n### Tags\n\nWhile [Tags are optional](https://docs.paloaltonetworks.com/pan-os/9-1/pan-os-admin/policy/use-tags-to-group-and-visually-distinguish-objects/create-and-apply-tags), they can greatly improve object and policy visibility. The following color scheme was implemented in this configuration:\n\n| Tag | Color |\n| - | - |\n| `Trust_L3_Zone` | Green |\n| `Untrust_L3_Zone` | Red |\n| `Cloudflare_L3_Zone` | Orange |\n\nUse the Palo Alto Networks Next-Generation Firewall command-Line to set the tags:",
      "language": "unknown"
    },
    {
      "code": "### Objects\n\nThe use of **Address** and **Address Group** objects wherever possible is strongly encouraged. These objects ensure that configuration elements that reference them are defined accurately and consistently.\n\nAny configuration changes should be applied to the objects and will automatically be applied throughout the remainder of the configuration.\n\n#### Address Objects\n\nNote\n\nAny objects without a netmask specified are `/32`.\n\n| Name | Type | Address | Tags |\n| - | - | - | - |\n| `CF_Health_Check_Anycast_01` | IP Netmask | `172.64.240.253` | `Cloudflare_L3_Zone` |\n| `CF_Health_Check_Anycast_02` | IP Netmask | `172.64.240.254` | `Cloudflare_L3_Zone` |\n| `CF_Magic_WAN_Anycast_01` | IP Netmask | `162.159.66.164` | `Cloudflare_L3_Zone` |\n| `CF_Magic_WAN_Anycast_02` | IP Netmask | `172.64.242.164` | `Cloudflare_L3_Zone` |\n| `CF_MWAN_IPsec_VTI_01_Local` | IP Netmask | `10.252.2.27/31` | `Cloudflare_L3_Zone` |\n| `CF_MWAN_IPsec_VTI_01_Remote` | IP Netmask | `10.252.2.26` | `Cloudflare_L3_Zone` |\n| `CF_MWAN_IPsec_VTI_02_Local` | IP Netmask | `10.252.2.29/31` | `Cloudflare_L3_Zone` |\n| `CF_MWAN_IPsec_VTI_02_Remote` | IP Netmask | `10.252.2.28` | `Cloudflare_L3_Zone` |\n| `CF_WARP_Client_Prefix` | IP Netmask | `100.96.0.0/12` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_01` | IP Netmask | `173.245.48.0/20` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_02` | IP Netmask | `103.21.244.0/22` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_03` | IP Netmask | `103.22.200.0/22` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_04` | IP Netmask | `103.31.4.0/22` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_05` | IP Netmask | `141.101.64.0/18` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_06` | IP Netmask | `108.162.192.0/18` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_07` | IP Netmask | `190.93.240.0/20` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_08` | IP Netmask | `188.114.96.0/20` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_09` | IP Netmask | `197.234.240.0/22` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_10` | IP Netmask | `198.41.128.0/17` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_11` | IP Netmask | `162.158.0.0/15` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_12` | IP Netmask | `104.16.0.0/13` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_13` | IP Netmask | `104.24.0.0/14` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_14` | IP Netmask | `172.64.0.0/13` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_15` | IP Netmask | `131.0.72.0/22` | `Cloudflare_L3_Zone` |\n| `Internet_L3_203-0-113-254--24` | IP Netmask | `203.0.113.254/24` | `Untrust_L3_Zone` |\n| `VLAN0010_10-1-10-0--24` | IP Netmask | `10.1.10.0/24` | `Cloudflare_L3_Zone` |\n| `VLAN0020_10-1-20-0--24` | IP Netmask | `10.1.20.0/24` | `Cloudflare_L3_Zone` |\n| `VLAN0100_10-1-100-0--24` | IP Netmask | `10.1.100.0/24` | `Trust_L3_Zone` |\n| `VLAN0100_L3_10-1-100-254--24` | IP Netmask | `10.1.10.254/24` | `Trust_L3_Zone` |\n\nUse the Palo Alto Networks Next-Generation Firewall command-Line to set the objects:",
      "language": "unknown"
    },
    {
      "code": "#### Address Group object\n\nThe **Address Group** object used in this configuration provides a single object representation of the entire Cloudflare IPv4 public address space.\n\n| Name | Type | Addresses | Tags |\n| - | - | - | - |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_01` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_02` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_03` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_04` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_05` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_06` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_07` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_08` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_09` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_10` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_11` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_12` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_13` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_14` | `Cloudflare_L3_Zone` |\n| `Cloudflare_IPv4_Static_Grp` | Static | `Cloudflare_IPv4_15` | `Cloudflare_L3_Zone` |\n\nUse the Palo Alto Networks Next-Generation Firewall command-Line to set the address group object:",
      "language": "unknown"
    },
    {
      "code": "Note\n\nWhile not covered by this tutorial, it is also possible to use External Dynamic Lists to automatically obtain the most current list of Cloudflare IPv4 addresses by periodically polling <https://www.cloudflare.com/ips-v4>.\n\n### Interface Mgmt - Network Profiles\n\n**Interface Mgmt** profiles control what traffic is allowed *to* the firewall, as opposed to *through* the firewall.\n\nAdding an Interface Mgmt profile to the tunnel interfaces will provide the ability to ping the Virtual Tunnel Interface on your firewall(s).\n\n#### Set up via dashboard\n\nYou can define an Interface Management Profile to allow ping from the dashboard:\n\n1. Go to **Network Profiles** > **Interface Mgmt**.\n2. In the **Network** tab select **Add**.\n3. Create profiles to allow Ping, and in the **Network Services** group select **Ping**.\n\n![Interface Mgmt Profile](https://developers.cloudflare.com/_astro/01_int_mgmt_prof.YUAT08zt_Z2ruNjF.webp) ![Interface Mgmt Profile](https://developers.cloudflare.com/_astro/02_int_mgmt_prof.Ciz0_Zwm_Z1d8wtW.webp)\n\n#### Set up via command line\n\nYou can also use the command line to allow ping:",
      "language": "unknown"
    },
    {
      "code": "### Network Interfaces\n\nPalo Alto Networks Next-Generation Firewall (NGFW) is configured with two Ethernet interfaces:\n\n| Interface | Interface Type | IP Address | Virtual Router |\n| - | - | - | - |\n| ethernet1/1 | Layer3 | `10.1.100.254/24` | default |\n| ethernet1/2 | Layer3 | `203.0.113.254/24` | default |\n\n#### Set up via dashboard\n\nFollow the guidance on the images below to set up the Ethernet interfaces through the dashboard.\n\n##### ethernet1/1: `Trust_L3_Zone`\n\n| Name | Option | Value |\n| - | - | - |\n| **ethernet1/1** | Interface Type | *Layer3* |\n| | Netflow Profile | *None* |\n| **Config tab** | Virtual Router | *default* |\n| | Security Zone | *Trust\\_L3\\_Zone* |\n| **IPv4 tab** | Type | **Static** |\n| | IP | `VLAN0100_L3_10-1-100-254--24` address object |\n| **Advanced tab** | Management Profile | *Mgmt\\_Services* |\n\n![Set up ethernet1/1 on the dashboard](https://developers.cloudflare.com/_astro/01_ethernet-1-1_page1.1VA7M8cP_FgL8P.webp)![Set up ethernet1/1 on the dashboard](https://developers.cloudflare.com/_astro/02_ethernet-1-1_page2.7jxa3xfp_jcLoB.webp)![Set up ethernet1/1 on the dashboard](https://developers.cloudflare.com/_astro/03_ethernet-1-1_page3.CokR1vvm_2QT9f.webp)\n\n##### ethernet1/2: `Untrust_L3_Zone`\n\n| Name | Option | Value |\n| - | - | - |\n| **ethernet1/2** | Interface Type | *Layer3* |\n| | Netflow Profile | *None* |\n| **Config tab** | Virtual Router | *default* |\n| | Security Zone | *Untrust\\_L3\\_Zone* |\n| **IPv4 tab** | Type | **Static** |\n| | IP | `Internet_L3_203-0-113-254--24` address object |\n| **Advanced tab** | Management Profile | *Allow\\_Ping* |\n| | MTU | `576 - 1500` |\n| | Adjust TCP MSS | **Enable** |\n| | IPv4 MSS Adjustment | `64` |\n\n![Set up ethernet1/2 on the dashboard](https://developers.cloudflare.com/_astro/04_ethernet-1-2_page1.By0-oLRS_ZafJek.webp)![Set up ethernet1/2 on the dashboard](https://developers.cloudflare.com/_astro/05_ethernet-1-2_page2.BUQ0TYrt_1uRhr1.webp)![Set up ethernet1/2 on the dashboard](https://developers.cloudflare.com/_astro/06_ethernet-1-2_page3.lN-Y3jvL_ZHX3aI.webp)\n\nAfter setting up your Ethernet interfaces, they should show up on the overview page:\n\n![Ethernet Interfaces - Overview](https://developers.cloudflare.com/_astro/07_ethernet_interfaces_overview.B03fT-27_1UC97w.webp)\n\n#### Set up via command line\n\nYou can also use the command line to set up the Ethernet interfaces.",
      "language": "unknown"
    },
    {
      "code": "### Tunnel interfaces\n\nEstablishing IPsec Tunnels to Cloudflare Magic WAN requires two tunnel interfaces - one to each of the two Cloudflare anycast IP addresses. You also have to ensure that `Allow_Ping` is bound to both tunnel adapters in **Advanced** > **Managementt Profile**.\n\nReview the images below for more information.\n\nNote\n\nMTU is set to `1450`. This value may need to be adjusted for optimal performance on your network.\n\n#### Set up via dashboard\n\n##### tunnel.1 - `Cloudflare_L3_Zone`\n\n| Name | Option | Value |\n| - | - | - |\n| **tunnel.1** | Netflow Profile | *None* |\n| **Config tab** | Virtual Router | *default* |\n| | Security Zone | *Cloudflare\\_L3\\_Zone* |\n| **IPv4 tab** | IP | `CF_MWAN_IPsec_VTI_01_Local` address object |\n| **Advanced tab** | Management Profile | *Allow\\_Ping* |\n| | MTU | `1450` |\n\n![Set up tunnel 1](https://developers.cloudflare.com/_astro/01_tunnel_1_page1.CeB5lZ8G_OiV2A.webp)![Set up tunnel 1](https://developers.cloudflare.com/_astro/02_tunnel_1_page2.DTmX2oQG_Z251Mqn.webp)![Set up tunnel 1](https://developers.cloudflare.com/_astro/03_tunnel_1_page3.B-KN29cx_Z22Q2rq.webp)\n\n##### tunnel.2 - `Cloudflare_L3_Zone`\n\n| Name | Option | Value |\n| - | - | - |\n| **tunnel.2** | Netflow Profile | *None* |\n| **Config tab** | Virtual Router | *default* |\n| | Security Zone | *Cloudflare\\_L3\\_Zone* |\n| **IPv4 tab** | IP | `CF_MWAN_IPsec_VTI_02_Local` address object |\n| **Advanced tab** | Management Profile | *Allow\\_Ping* |\n| | MTU | `1450` |\n\n![Set up tunnel 2](https://developers.cloudflare.com/_astro/04_tunnel_2_page1.ChXQsll2_2cS7Dq.webp)![Set up tunnel 2](https://developers.cloudflare.com/_astro/05_tunnel_2_page2.5MNYKPA6_wuF87.webp)![Set up tunnel 2](https://developers.cloudflare.com/_astro/06_tunnel_2_page3.Dv0L63U8_E4Yub.webp)\n\nAfter setting up your Tunnel interfaces, they should show up on the overview page:\n\n![Tunnel Interfaces - Overview](https://developers.cloudflare.com/_astro/07_tunnel_interfaces_overview.CNcfvGAr_24K2FG.webp)\n\n#### Set up via command line\n\nYou can also set up your tunnels in the command line:",
      "language": "unknown"
    },
    {
      "code": "### Zones\n\nThe Palo Alto Networks Next-Generation Firewall (NGFW) used to create this tutorial includes the following zones and corresponding network interfaces:\n\n| Zone | Interface | Interface |\n| - | - | - |\n| `Trust_L3_Zone` | ethernet1/1 | |\n| `Untrust_L3_Zone` | ethernet1/2 | |\n| `Cloudflare_L3_Zone` | tunnel.1 | tunnel.2 |\n\nThe tunnel interfaces are placed in a separate zone to facilitate the configuration of more granular security policies. The use of any other zone for the tunnel interfaces will require adapting the configuration accordingly.\n\nNote\n\nAny Magic WAN protected networks that are not local should be considered part of the `Cloudflare_L3_Zone`.\n\n#### Set up via dashboard\n\n##### `Trust_L3_zone`\n\n| Name | Option | Value |\n| - | - | - |\n| `Trust_L3_zone` | Log setting | *None* |\n| | Type | *Layer3* |\n| | Interfaces | **ethernet1/1** |\n| | Zone Protection Profile | *None* |\n\n![The Palo Alto interface showing the Trust\\_L3\\_Zone](https://developers.cloudflare.com/_astro/01_trust_zone.CtMShlqH_Z2ib2xD.webp)\n\n##### `Untrust_L3_zone`\n\n| Name | Option | Value |\n| - | - | - |\n| `Untrust_L3_zone` | Log setting | *None* |\n| | Type | *Layer3* |\n| | Interfaces | **ethernet1/2** |\n| | Zone Protection Profile | *Untrust\\_Zone\\_Prof* |\n\n![The Palo Alto interface showing the Untrust\\_L3\\_Zone](https://developers.cloudflare.com/_astro/02_untrust_zone.BFBnvKrn_Z1VVK2X.webp)\n\n##### `Cloudflare_L3_zone`\n\n| Name | Option | Value |\n| - | - | - |\n| `Cloudflare_L3_zone` | Log setting | *None* |\n| | Type | *Layer3* |\n| | Interfaces | **tunnel.1** **tunnel.2** |\n| | Zone Protection Profile | *None* |\n\n![The Palo Alto interface showing the Cloudflare\\_L3\\_Zone](https://developers.cloudflare.com/_astro/03_cloudflare_zone.UclPW1ul_zAunJ.webp)![The Palo Alto interface showing the Tunnel Interfaces overview section](https://developers.cloudflare.com/_astro/04_zones_overview.CePNdHuU_1QWC0n.webp)\n\n#### Set up via command line\n\nYou can also use the command line to associate zones and interfaces:",
      "language": "unknown"
    },
    {
      "code": "### Apply Changes\n\nThis would be a good time to save and commit the configuration changes made so far. Once complete, make sure you test basic connectivity to and from the firewall.\n\n### IKE crypto profile Phase 1\n\nAdd a new IKE crypto profile to support the required parameters for Phase 1.\n\nMultiple DH groups and authentication settings are defined in the desired order. Palo Alto Networks Next-Generation Firewall (NGFW) will automatically negotiate the optimal settings based on specified values.\n\n#### Set up via dashboard\n\n| Name | Option | Value |\n| - | - | - |\n| `CF_IKE_Crypto_CBC` | DH Group | **group20** |\n| | Authentication | **sha512** **sha384** **sha256** |\n| | Encryption | **aes-256-cbc** |\n| | Key Lifetime | 24 hours |\n| | IKEv2 Authentication Multiple | `0` |\n\n#### Set up via command line\n\nYou can also set up the crypto profile for Phase 1 via the command line:",
      "language": "unknown"
    },
    {
      "code": "### IPsec crypto profile Phase 2\n\nAdd a new IPsec crypto profile to support the required parameters for Phase 2.\n\nMultiple Authentication settings are defined in the desired order. Palo Alto Networks Next-Generation Firewall (NGFW) will automatically negotiate the optimal settings based on specified values.\n\n#### Set up via dashboard\n\n| Name | Option | Value |\n| - | - | - |\n| `CF_IPsec_Crypto_CBC` | Encryption | **aes-256-cbc** |\n| | Authentication | **sha256** **sha1** |\n| | DH Group | **group20** |\n| | Lifetime | 8 hours |\n\n#### Set up via command line\n\nYou can also set up the IPsec crypto profile for Phase 2 via the command line:",
      "language": "unknown"
    },
    {
      "code": "### IKE Gateways\n\nNote\n\nAny other settings not specified should be left at their default values. Any deviation may lead to undesirable behavior and are not supported.\n\nDefine two IKE Gateways to establish the two IPsec tunnels to Cloudflare. Make sure to define the following values:\n\n#### Set up via dashboard\n\n##### Tunnel 1 settings: `CF_Magic_WAN_IKE_01`\n\nNote\n\nMake sure you select `CF_IKE_Crypto_CBC` as the IKE Crypto profile.\n\n| Tab | Option | Value |\n| - | - | - |\n| **General tab** | Name | `CF_Magic_WAN_IKE_01` |\n| | Version | *IKEv2 only mode*. Make sure both IKE Gateways are based only on this setting. |\n| | Local IP Address | `Internet_L3_203-0-113-254--24` |\n| | Peer address | `CF_Magic_WAN_Anycast_01` |\n| | Pre-Shared Key | This value can be obtained from the Cloudflare dashboard - value is unique per tunnel. |\n| | Local Identification | *FQDN (hostname)*. You can obtain this value from the Cloudflare Dashboard - value is unique per tunnel. |\n| | Peer Identification | *None* |\n| **Advanced tab** | IKE Crypto Profile | *CF\\_IKE\\_Crypto\\_CBC* |\n| | Liveness Check | The default value (five seconds) is sufficient. This setting is used to periodically determine if there are any underlying connectivity issues that may adversely affect the creation of Phase 1 Security Associations. |\n\n![IKE gateway settings for tunnel 1](https://developers.cloudflare.com/_astro/03_ike_gw01_page1.DTZw4kT3_ZVe0NF.webp)![IKE gateway settings for tunnel 1](https://developers.cloudflare.com/_astro/04_ike_gw01_page2.CP3dTmKi_ZhRnTt.webp)\n\n##### Tunnel 2 settings: `CF_Magic_WAN_IKE_02`\n\nNote\n\nMake sure you select `CF_IKE_Crypto_CBC` as the IKE Crypto profile.\n\n| Tab | Option | Value |\n| - | - | - |\n| **General tab** | Name | `CF_Magic_WAN_IKE_02` |\n| | Version | *IKEv2 only mode*. Make sure both IKE Gateways are based only on this setting. |\n| | Local IP Address | `Internet_L3_203-0-113-254--24` |\n| | Peer address | `CF_Magic_WAN_Anycast_02` |\n| | Pre-Shared Key | This value can be obtained from the Cloudflare dashboard - value is unique per tunnel. |\n| | Local Identification | *FQDN (hostname)*. You can obtain this value from the Cloudflare Dashboard - value is unique per tunnel. |\n| | Peer Identification | *None* |\n| **Advanced tab** | IKE crypto profile | *CF\\_IKE\\_Crypto\\_CBC* |\n| | Liveness Check | The default value (five seconds) is sufficient. This setting is used to periodically determine if there are any underlying connectivity issues that may adversely affect the creation of Phase 1 Security Associations. |\n\n![IKE gateway settings for tunnel 2](https://developers.cloudflare.com/_astro/05_ike_gw02_page1.DhdWpbT6_Z20Ew4A.webp)![IKE gateway settings for tunnel 2](https://developers.cloudflare.com/_astro/06_ike_gw02_page2.B0Jsctzf_whU04.webp)\n\n#### Set up via command line\n\n##### Tunnel 1 settings: `CF_Magic_WAN_IKE_01`",
      "language": "unknown"
    },
    {
      "code": "##### Tunnel 2 settings: `CF_Magic_WAN_IKE_02`",
      "language": "unknown"
    },
    {
      "code": "### IPsec Tunnels\n\nWith the IKE Gateways defined, the next step is to configure two IPsec Tunnels - one corresponding to each of the two IKE Gateways configured in the previous section.\n\n#### Prerequisites\n\nThere are a few prerequisites you should be aware of before continuing:\n\n* Do not configure Proxy IDs. Magic WAN IPsec tunnels are based on the route-based VPN model. Proxy IDs are used with policy-based VPNs.\n* Disable Replay Protection, under the Advanced Options.\n* Disable Tunnel Monitor. It can cause undesirable results. Tunnel Monitor is a Palo Alto Networks proprietary feature that assumes there are Palo Alto Networks Next-Generation Firewall devices on both sides of the IPsec tunnel. Also, Tunnel Monitor is intended for use with IPsec tunnels based on IKEv1 (Magic WAN IPsec tunnels are based on IKEv2).\n\n#### Set up via dashboard\n\n##### Tunnel 1 settings: `CF_Magic_WAN_IPsec_01`\n\n| Name | Option | Value |\n| - | - | - |\n| `CF_Magic_WAN_IPsec_01` | Tunnel interface | tunnel.1 |\n| | IKE Gateway | *CF\\_Magic\\_WAN\\_IKE\\_01* |\n| | IPsec crypto profile | *CF\\_IKE\\_Crypto\\_CBC* |\n| | Enable Replay Protection | **Disable** |\n\n![Set up the IPsec tunnel](https://developers.cloudflare.com/_astro/07_ipsec_tun01_page1.CGxYzIX1_1r6TCG.webp)![Set up the IPsec tunnel](https://developers.cloudflare.com/_astro/08_ipsec_tun01_page2.BlnyIOG4_ZLzPzU.webp)\n\n##### Tunnel 2 settings: `CF_Magic_WAN_IPsec_02`\n\n| Name | Option | Value |\n| - | - | - |\n| `CF_Magic_WAN_IPsec_02` | Tunnel interface | tunnel.2 |\n| | IKE Gateway | *CF\\_Magic\\_WAN\\_IKE\\_02* |\n| | IPsec crypto profile | *CF\\_IKE\\_Crypto\\_CBC* |\n| | Enable Replay Protection | **Disable** |\n\n![Set up the IPsec tunnel](https://developers.cloudflare.com/_astro/09_ipsec_tun02_page1.BcU-8MkR_2m7wHw.webp)![Set up the IPsec tunnel](https://developers.cloudflare.com/_astro/10_ipsec_tun02_page2.DjeZ2TKf_Z1UAtRP.webp)\n\n#### Set up via command line\n\n##### Tunnel 1 settings: `CF_Magic_WAN_IPsec_01`",
      "language": "unknown"
    },
    {
      "code": "##### Tunnel 2 settings: `CF_Magic_WAN_IPsec_02`",
      "language": "unknown"
    },
    {
      "code": "### Apply Changes\n\nThis would be a good time to save and commit the configuration changes made thus far. Once complete, make sure you test basic connectivity across the IPsec tunnels.\n\n### IPsec tunnel connectivity tests\n\nThis is a good time to ensure the IPsec tunnels are established and to validate basic connectivity.\n\nNote\n\nTunnel health checks will not function until security policies and policy-based forwarding are configured. This series of tests is focused on testing IPsec connectivity exclusively.\n\n#### Verify IKE Phase 1 Communications\n\nThe first step is to verify IKE Phase 1 completed successfully:\n\n##### Syntax",
      "language": "unknown"
    },
    {
      "code": "##### Example for `CF_Magic_WAN_IKE_01`",
      "language": "unknown"
    },
    {
      "code": "##### Example for `CF_Magic_WAN_IKE_02`",
      "language": "unknown"
    },
    {
      "code": "#### Troubleshooting IKE Phase 1 Communications\n\nMagic WAN IPsec tunnels expect the customer device will initiate the IPsec tunnels. The tunnels may not establish if there is no traffic that would traverse the tunnel under normal conditions. In this case, it may be necessary to force IKE Phase 1.\n\n##### Syntax",
      "language": "unknown"
    },
    {
      "code": "##### Example for `CF_Magic_WAN_IKE_01`",
      "language": "unknown"
    },
    {
      "code": "##### Example for `CF_Magic_WAN_IKE_02`",
      "language": "unknown"
    },
    {
      "code": "Repeat these commands for the respective tunnel to ensure the IKE SA(s) display as expected.\n\n#### Verify IPsec Phase 2 Communications\n\nTo ensure the IPsec tunnels are established, ping the remote Virtual Tunnel Interface (Cloudflare side) from the command line on the Palo Alto Networks Next-Generation Firewall. Ensure you specify the source IP address of the ping from the local side of the Virtual Tunnel Interface:\n\n##### Syntax",
      "language": "unknown"
    },
    {
      "code": "##### Example for `CF_Magic_WAN_IPsec_01`",
      "language": "unknown"
    },
    {
      "code": "##### Example for `CF_Magic_WAN_IPsec_02`",
      "language": "unknown"
    },
    {
      "code": "#### Troubleshooting IPsec Phase 2 Communications\n\nMagic WAN IPsec tunnels expect the customer device will initiate the IPsec tunnels. The tunnels may not establish if there is no traffic that would traverse the tunnel under normal conditions. In this case, it may be necessary to force IPsec Phase 2. This is typically unnecessary as once IKE Phase 1 negotiates successfully, IPsec Phase 2 automatically establishes the tunnel. The test is still worth performing.\n\n##### Syntax",
      "language": "unknown"
    },
    {
      "code": "##### Example for `CF_Magic_WAN_IPsec_01`",
      "language": "unknown"
    },
    {
      "code": "##### Example for `CF_Magic_WAN_IPsec_02`",
      "language": "unknown"
    },
    {
      "code": "Repeat these commands for the respective tunnel to ensure the IPsec SA(s) display as expected.\n\n#### Ping Remote Virtual Tunnel interfaces\n\nUse ping to source traffic from the IP address of the Virtual Tunnel interface on Palo Alto Networks Next-Generation Firewall (NGFW) to the IP address of the Virtual Tunnel Interface on the Cloudflare side of the IPsec tunnel.\n\nNote\n\nThe interface address is defined with a `/31` netmask. There have been isolated cases where NGFW exhibited issues when using ping to verify connectivity between the local and remote Virtual Tunnel interfaces. This behavior can vary depending on the version of PAN-OS installed on the firewall. If you encounter this issue, either switch to a `/30` netmask, or contact Palo Alto Networks support for assistance.\n\n##### Syntax",
      "language": "unknown"
    },
    {
      "code": "##### Example for Tunnel 1",
      "language": "unknown"
    },
    {
      "code": "##### Example for Tunnel 2",
      "language": "unknown"
    },
    {
      "code": "### Virtual Router\n\nWhile we will leverage policy-based forwarding to implement policy-based routing, it is still a good idea to configure routing on the Virtual Router.\n\nCloudflare Magic WAN implements [equal-cost multi-path (ECMP) routing](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/traffic-steering/#equal-cost-multi-path-routing) to steer traffic across IPsec tunnels. The default behavior is to load balance traffic equally across both tunnels.\n\nNote\n\nECMP is disabled on the Palo Alto Networks Next-Generation Firewall by default. Enabling ECMP will force the Virtual Router to restart. While a restart of the Virtual Router is much faster than restarting the entire firewall, it is still recommended that you make this change during a scheduled maintenance window.\n\n#### Enable ECMP\n\nFirst, ensure the General tab displays both the Ethernet and tunnel interfaces. If any of the interfaces are not displayed, either use **Add** to specify the missing interface(s), or visit the Interfaces menu to ensure the relevant Virtual Router is selected.\n\n![Make sure the Ethernet and tunnel interfaces show up in Virtual Router](https://developers.cloudflare.com/_astro/01_virtual_router_interfaces.CKKz8rSw_ZGTEpL.webp)\n\n1. Open the **Router settings** for the default Virtual Router and select the **ECMP** tab.\n2. Select the checkboxes next to **Enable**, **Symmetric Return**, and **Strict Source Path** (all three checkboxes should be selected).\n3. Under **Load Balance**, change the **Method** from *IP Modulo* to *Weighted Round Robin* and add both tunnel interfaces. Ensure the weights match the weights defined in Magic WAN Static Routes (reference the Cloudflare Dashboard).\n\n![Make sure all checkboxes are selected](https://developers.cloudflare.com/_astro/02_virtual_router_ecmp.Dg9F5MXo_ZYIPL3.webp)\n\nYou can also use the command line to make these changes:",
      "language": "unknown"
    },
    {
      "code": "#### Add static routes\n\nAdd two static routes for each Magic WAN Protected Network - one for each of the two tunnel interfaces.\n\nNote\n\nPalo Alto Networks Next-Generation Firewall will not allow for configuring two routes to the same destination with equal metrics - even if they reference different interfaces and ECMP is enabled. The examples provided here use Metric 10 for the route via interface tunnel.1 and Metric 11 for the route via interface tunnel.2.\n\nThe environment used for this tutorial assumes two Magic WAN Protected Networks:\n\n* **VLAN0010**: `10.1.10.0/24`\n* **VLAN0020**: `10.1.20.0/24`\n\n##### VLAN0010 (`10.1.10.0/24`) via tunnel.1\n\n| Name | Option | Value |\n| - | - | - |\n| `Magic_WAN_VLAN0010_Tun01` | Destination | *VLAN0010\\_10-1-10-0--24* |\n| | Interface | *tunnel.1* |\n| | Next hop | *IP Address* |\n| | | *CF\\_MWAN\\_IPsec\\_VTI\\_01\\_Remote* |\n| | Metric | `10` |\n| | Route Table | *Unicast* |\n| | BFD Profile | *Disable BFD* |\n\n![Static Route - VLAN0010 (10.1.10.0/24 via tunnel.1)](https://developers.cloudflare.com/_astro/03_virtual_router_static_vlan0010_tun01.BeoPOPsP_Z227Pyc.webp)\n\n##### VLAN0010 (`10.1.10.0/24`) via tunnel.2\n\n| Name | Option | Value |\n| - | - | - |\n| `Magic_WAN_VLAN0010_Tun02` | Destination | *VLAN0010\\_10-1-10-0--24* |\n| | Interface | *tunnel.2* |\n| | Next hop | *IP Address* |\n| | | *CF\\_MWAN\\_IPsec\\_VTI\\_02\\_Remote* |\n| | Metric | `11` |\n| | Route Table | *Unicast* |\n| | BFD Profile | *Disable BFD* |\n\n![Static Route - VLAN0010 (10.1.10.0/24 via tunnel.2)](https://developers.cloudflare.com/_astro/04_virtual_router_static_vlan0010_tun02.BfU79pNf_1muFYD.webp)\n\n##### VLAN0020 (`10.1.20.0/24`) via tunnel.1\n\n| Name | Option | Value |\n| - | - | - |\n| `Magic_WAN_VLAN0020_Tun01` | Destination | *VLAN0020\\_10-1-20-0--24* |\n| | Interface | *tunnel.1* |\n| | Next hop | *IP Address* |\n| | | *CF\\_MWAN\\_IPsec\\_VTI\\_01\\_Remote* |\n| | Metric | `10` |\n| | Route Table | *Unicast* |\n| | BFD Profile | *Disable BFD* |\n\n![Static Route - VLAN0020 (10.1.20.0/24 via tunnel.1)](https://developers.cloudflare.com/_astro/05_virtual_router_static_vlan0020_tun01.u8FPv6T8_1bzIlq.webp)\n\n##### VLAN0020 (`10.1.20.0/24`) via tunnel.2\n\n| Name | Option | Value |\n| - | - | - |\n| `Magic_WAN_VLAN0020_Tun02` | Destination | *VLAN0020\\_10-1-20-0--24* |\n| | Interface | *tunnel.2* |\n| | Next hop | *IP Address* |\n| | | *CF\\_MWAN\\_IPsec\\_VTI\\_02\\_Remote* |\n| | Metric | `11` |\n| | Route Table | *Unicast* |\n| | BFD Profile | *Disable BFD* |\n\n![Static Route - VLAN0020 (10.1.20.0/24 via tunnel.1)](https://developers.cloudflare.com/_astro/06_virtual_router_static_vlan0020_tun02.BnhXyIho_VN9BU.webp)\n\nYou can also configure these settings via command line:\n\n##### VLAN0010 - `10.1.10.0/24`",
      "language": "unknown"
    },
    {
      "code": "##### VLAN0020 - `10.1.20.0/24`",
      "language": "unknown"
    },
    {
      "code": "### Magic health checks\n\nCloudflare crafts ICMP probes which are sent through the IPsec tunnels from random servers across Cloudflare's global anycast network. These ICMP probes are unique because an ICMP reply packet is sent (as opposed to an ICMP Request).\n\nNote\n\nThe construct of the security policies may seem counter-intuitive - this is due to the use of ICMP reply probes. As long as you adhere to the recommended policies in this documentation, the bi-directional health checks will work as expected.\n\nCloudflare Magic WAN customers must configure IPsec tunnels to use custom anycast IP addresses for the health check endpoints:\n\n* **CF\\_Health\\_Check\\_Anycast\\_01**: `172.64.240.253`\n* **CF\\_Health\\_Check\\_Anycast\\_02**: `172.64.240.254`\n\n#### Security Policy - Tunnel health checks\n\nYou must define a rule to allow the ICMP reply probes as Palo Alto Networks Next-Generation Firewall's default behavior will drop the health checks.\n\nNote\n\nCloudflare health checks are sent from random servers across Cloudflare's global network and can originate from any addresses within the Cloudflare IPv4 address space represented by the `Cloudflare_IPv4_Static_Grp`.\n\n##### Setup via dashboard\n\n| Name | Option | Value |\n| - | - | - |\n| `Cloudflare_Tunnel_Bidirect_HC` | Rule Type | *universal (default)* |\n| | Description | `Permit bidirectional HCs` |\n| | Group Rules By Tag | *None* |\n| **Source tab** | Source Zone | **Cloudflare\\_L3\\_Zone** |\n| | Source Address | **CF\\_Health\\_Check\\_Anycast\\_01** **CF\\_Health\\_Check\\_Anycast\\_02** |\n| **Destination tab** | Destination Zone | **Cloudflare\\_L3\\_Zone** |\n| | Destination Address | **Cloudflare\\_IPv4\\_Static\\_Grp** |\n| **Application tab** | Applications | **icmp** **ping** |\n| **Actions tab** | Action | *Allow* |\n| | Log Setting | **Log at Session End** |\n| | Profile type | *None* |\n| | Schedule | *None* |\n| | QoS Marking | *None* |\n\n![Bidirectional Health Check Rule - General](https://developers.cloudflare.com/_astro/01_bidirect_hc_general.Jesbnt_L_ZwaAHv.webp)![Bidirectional Health Check Rule - Source](https://developers.cloudflare.com/_astro/02_bidirect_hc_source.D5_oto5__rVAcl.webp)![Bidirectional Health Check Rule - Destination](https://developers.cloudflare.com/_astro/03_bidirect_hc_dest.fLuLEdbu_Z1Xym35.webp)![Bidirectional Health Check Rule - Apps](https://developers.cloudflare.com/_astro/04_bidirect_hc_apps.BS9-zTeJ_xF5tA.webp)![Bidirectional Health Check Rule - Service/URL Category](https://developers.cloudflare.com/_astro/05_bidirect_hc_service-url.BO7RsvHM_2qBy1a.webp)![Bidirectional Health Check Rule - Action](https://developers.cloudflare.com/_astro/06_bidirect_hc_action.BepoEJ0K_PKo4h.webp)\n\n##### Setup via command line",
      "language": "unknown"
    },
    {
      "code": "Note\n\nLogging is enabled on the rule to permit heath checks. While the amount of bandwidth consumed by health checks is negligible, the flows generate a significant number of log entries. You may want to disable logging on this rule once in production, and only enable it if any troubleshooting becomes necessary.\n\n#### Policy-based forwarding - tunnel health checks\n\nTraffic matching the Security Rule defined in the last step must be routed symmetrically across the tunnel the ingress traffic was received through. Two policy-based forwarding rules ensure the traffic is routed accordingly.\n\nEnsure have the following:\n\n* **Source Zone**: `Cloudflare_L3_Zone`\n* **Source Addresses**: `CF_Health_Check_Anycast_01` and `CF_Health_Check_Anycast_02`\n* **Destination Zone**: `Cloudflare_L3_Zone`\n* **Destination Addresses**: `Cloudflare_IPv4_Static_Grp`\n* **Application**: `icmp` and `ping`\n\n##### Set up via dashboard tunnel.1\n\n| Name | Option | Value |\n| - | - | - |\n| `PBF_Cloudflare_Health_Check_01` | Tags | *Cloudflare\\_L3\\_Zone* |\n| | Group Rules By Tag | *None* |\n| **Source tab** | Type | *Zone* |\n| | Zone | **Cloudflare\\_L3\\_Zone** |\n| | Source Address | **CF\\_Health\\_Check\\_Anycast\\_01** |\n| **Destination/Application/Service tab** | Destination Address | **Cloudflare\\_IPv4\\_Static\\_Grp** |\n| **Forwarding tab** | Action | *Forward* |\n| | Egress interface | *tunnel.1* |\n| | Next Hop | *IP Address* |\n| | | *CF\\_MWAN\\_IPsec\\_VTI\\_01\\_Remote* |\n\n![Bidirectional Health Checks via tunnel.1 - General](https://developers.cloudflare.com/_astro/01_pbf_hc_01_general.BvF5tM5Y_ZoiF5V.webp)![Bidirectional Health Checks via tunnel.1 - Source](https://developers.cloudflare.com/_astro/02_pbf_hc_01_source.sLm5lJYK_Z1LxGXo.webp)![Bidirectional Health Checks via tunnel.1 - Destination](https://developers.cloudflare.com/_astro/03_pbf_hc_01_dest-app-service.B7G6nLZp_kIjoa.webp)![Bidirectional Health Checks via tunnel.1 - Forwarding](https://developers.cloudflare.com/_astro/04_pbf_hc_01_forwarding.Ceb7zhxs_Z23rdea.webp)\n\n##### Set up via dashboard tunnel.2\n\n| Name | Option | Value |\n| - | - | - |\n| `PBF_Cloudflare_Health_Check_02` | Tags | *Cloudflare\\_L3\\_Zone* |\n| | Group Rules By Tag | *None* |\n| **Source tab** | Type | *Zone* |\n| | Zone | **Cloudflare\\_L3\\_Zone** |\n| | Source Address | **CF\\_Health\\_Check\\_Anycast\\_02** |\n| **Destination/Application/service tab** | Destination Address | **Cloudflare\\_IPv4\\_Static\\_Grp** |\n| **Forwarding tab** | Action | *Forward* |\n| | Egress interface | *tunnel.2* |\n| | Next Hop | *IP Address* |\n| | | *CF\\_MWAN\\_IPsec\\_VTI\\_02\\_Remote* |\n\n![Bidirectional Health Checks via tunnel.2 - General](https://developers.cloudflare.com/_astro/05_pbf_hc_02_general.VE6FLgMw_2IX50.webp)![Bidirectional Health Checks via tunnel.2 - Source](https://developers.cloudflare.com/_astro/06_pbf_hc_02_source.CAlZ5-Oc_Zw0see.webp)![Bidirectional Health Checks via tunnel.2 - Destination](https://developers.cloudflare.com/_astro/07_pbf_hc_02_dest-app-service.Bijf-cAH_xdf5i.webp)![Bidirectional Health Checks via tunnel.2 - Forwarding](https://developers.cloudflare.com/_astro/08_pbf_hc_02_forwarding.DQQYjV92_ZeUQkC.webp)\n\n##### Set up via command line tunnel.1",
      "language": "unknown"
    },
    {
      "code": "##### Set up via command line tunnel.2",
      "language": "unknown"
    },
    {
      "code": "### Troubleshooting tunnel health checks\n\n#### Security Policy\n\nUse the Traffic log viewer to ensure that the health check traffic is allowed. Start by adding a rule to filter the logs based on the name of the Security Policy rule permitting the applicable traffic.\n\n##### Filter by rule name",
      "language": "unknown"
    },
    {
      "code": "![Bidirectional health check logging - Filter by rule name](https://developers.cloudflare.com/_astro/02_logging_tunnel_hc_filter_rulename.CpyoLiq5_1xYukE.webp)\n\nIf you do not see any traffic matching the filter, replace the filter with one that displays log entries based on the addresses associated with the `CF_Health_Check_Anycast_01` and `CF_Health_Check_Anycast_02` Address objects.\n\n##### Filter by health check anycast IPs",
      "language": "unknown"
    },
    {
      "code": "![Bidirectional health check logging - filter by health check anycast IPs](https://developers.cloudflare.com/_astro/01_logging_tunnel_hc_filter_ip.DY1yUwDH_1tjcOR.webp)\n\n#### Policy-based forwarding\n\nTroubleshooting policy-based forwarding can be a bit challenging. The ideal way to determine if traffic is flowing through the intended path is to select the detailed view for a log entry.\n\n1. Select the magnifying glass next to one of the log entries with source IP address `172.64.240.253`.\n\n2. Traffic originating from `CF_Health_Check_Anycast_01` (`172.64.240.253`) should ingress and egress interface tunnel.1.\n\n![Bidirectional Health Check Logging - tunnel.1](https://developers.cloudflare.com/_astro/03_logging_tunnel_hc_tun01.aWSnG56V_ZVDsIW.webp)\n\n1. Select the magnifying glass next to one of the log entries with source IP address `172.64.240.254`.\n\n2. Traffic originating from `CF_Health_Check_Anycast_02` (`172.64.240.254`) should ingress and egress interface tunnel.2.\n\n![Bidirectional Health Check Logging - tunnel.2](https://developers.cloudflare.com/_astro/04_logging_tunnel_hc_tun02.D1f2hkGw_ZhmTi3.webp)\n\nIf the traffic is not ingressing/egressing the same interface, you likely have an issue with the policy-based forwarding rule(s) not matching.\n\n### Security Policies - Production Traffic\n\nAs mentioned earlier, this tutorial includes examples for two different use-cases:\n\n* **Magic WAN**: permit traffic between two or more locations with [RFC-1918](https://datatracker.ietf.org/doc/html/rfc1918) private non-routable address space.\n* **Magic WAN with Cloudflare Zero Trust (Gateway egress)**: same as Magic WAN with the addition of outbound Internet access from Magic WAN protected sites egressing the Cloudflare edge network.\n\n#### Magic WAN only\n\nRules must be defined to facilitate traffic from the trust network to the Magic WAN protected sites. While it may be possible to define one rule for traffic in both directions, this example includes two rules:\n\n* From Trust to Magic WAN protected sites.\n\n* From Magic WAN protected sites to Trust.\n\n##### Trust to Magic WAN dashboard\n\n| Name | Option | Value |\n| - | - | - |\n| `Trust_to_Cloudflare_Magic_WAN_Allow` | Rule Type | *universal (default)* |\n| | Group Rules by Tag | *None* |\n| **Source tab** | Source Zone | **Trust\\_L3\\_Zone** |\n| | Source Address | **VLAN0100\\_10-1-100-0--24** |\n| **Destination tab** | Destination Zone | **Cloudflare\\_L3\\_Zone** |\n| | Destination Address | **VLAN0010\\_10-1-10-0--24** **VLAN0020\\_10-1-20-0--24** |\n| **Actions tab** | Action | *Allow* |\n| | Log Setting | **Log at Session End** |\n| | Profile type | *None* |\n| | Schedule | *None* |\n| | QoS Marking | *None* |\n\n![Trust to Magic WAN - General](https://developers.cloudflare.com/_astro/07_trust_to_mwan_general.34vAITJy_Z2bxubM.webp)![Trust to Magic WAN - Source](https://developers.cloudflare.com/_astro/08_trust_to_mwan_source.BpuRH05s_Z1Da7xK.webp)![Trust to Magic WAN - Destination](https://developers.cloudflare.com/_astro/09_trust_to_mwan_dest.De2xwcdy_Z46hvV.webp)![Trust to Magic WAN - Applications](https://developers.cloudflare.com/_astro/10_trust_to_mwan_apps.DQXUeCED_Z1gOFzh.webp)![Trust to Magic WAN - Services/URL Categories](https://developers.cloudflare.com/_astro/11_trust_to_mwan_service-url.DHjD72HI_1GOl6B.webp)![Trust to Magic WAN - Action](https://developers.cloudflare.com/_astro/12_trust_to_mwan_action.DDnplEF5_Zzn72E.webp)\n\n##### Trust to Magic WAN command line",
      "language": "unknown"
    },
    {
      "code": "##### Magic WAN to Trust dashboard\n\n| Name | Option | Value |\n| - | - | - |\n| `Cloudflare_Magic_WAN_to_Trust_Allow` | Rule Type | *universal (default)* |\n| | Group Rules by Tag | *None* |\n| Source tab | Source Zone | **Cloudflare\\_L3\\_Zone** |\n| | Source Address | **VLAN0010\\_10-1-10-0--24** **VLAN0020\\_10-1-20-0--24** |\n| Destination tab | Destination Zone | **Trust\\_L3\\_Zone** |\n| | Destination Address | **VLAN0100\\_10-1-100-0--24** |\n| Actions tab | Action | *Allow* |\n| | Log Setting | **Log at Session End** |\n| | Profile type | *None* |\n| | Schedule | *None* |\n| | QoS Marking | *None* |\n\n![Magic WAN to Trust - General](https://developers.cloudflare.com/_astro/13_mwan_to_trust_general.CLIPMgLb_yamF1.webp)![Magic WAN to Trust - Source](https://developers.cloudflare.com/_astro/14_mwan_to_trust_source.GRgD0hWh_1y0ghh.webp)![Magic WAN to Trust - Destination](https://developers.cloudflare.com/_astro/15_mwan_to_trust_dest.1rnkUqIF_Hh5SA.webp)![Magic WAN to Trust - Applications](https://developers.cloudflare.com/_astro/16_mwan_to_trust_apps.BktgyY-4_Z1UXrP2.webp)![Magic WAN to Trust - Services/URL Categories](https://developers.cloudflare.com/_astro/17_mwan_to_trust_service-url.bKUMWAET_1pdt9i.webp)![Magic WAN to Trust - Action](https://developers.cloudflare.com/_astro/18_mwan_to_trust_action.FJTlsp2v_Z28V9DR.webp)\n\n##### Magic WAN to Trust command line",
      "language": "unknown"
    },
    {
      "code": "### Policy-based forwarding - production traffic\n\nWhether traffic ingresses or egresses Palo Alto Networks Next-Generation Firewall, it is important to ensure that traffic is routed symmetrically. This is accomplished through the use of policy-based forwarding.\n\nPolicy-based forwarding rules are only required for egress traffic.\n\nAny traffic destined for Magic WAN protected sites or Magic WAN protected sites with Gateway egress must be routed across the IPsec tunnels.\n\nNote\n\nSecurity rules match traffic flows based on source and destination zone. Policy-based forwarding rules are applied per interface. Therefore, two policy-based forwarding rules are required for every one security rule - one for tunnel.1 and one for tunnel.2.\n\n#### Dashboard policy-based forwarding - Magic WAN production traffic via tunnel.1\n\n| Name | Option | Value |\n| - | - | - |\n| `PBF_Magic_WAN_Sites_01` | Group Rules by Tag | *None* |\n| **Source tab** | Type | *Zone* |\n| | Zone | **Trust\\_L3\\_Zone** |\n| | Source Address | **VLAN0100\\_10-1-100-0--24** |\n| **Destination/Application/Service tab** | Destination Address | **VLAN0010\\_10-1-10-0--24** **VLAN0020\\_10-1-20-0--24** |\n| **Forwarding tab** | Action | *Forward* |\n| | Egress Interface | *tunnel.1* |\n| | Next hop | *IP Address* |\n| | | *CF\\_MWAN\\_IPsec\\_VTI\\_01\\_Remote* |\n\n![PBF: Trust to Magic WAN via tunnel.1 - General](https://developers.cloudflare.com/_astro/09_pbf_mwan_sites_tun01_general.B9Ui-2D4_Zq2mV.webp)![PBF: Trust to Magic WAN via tunnel.1 - Source](https://developers.cloudflare.com/_astro/10_pbf_mwan_sites_tun01_source.C7svyFEp_Z2nliv2.webp)![PBF: Trust to Magic WAN via tunnel.1 - Destinations](https://developers.cloudflare.com/_astro/11_pbf_mwan_sites_tun01_dest-app-service.BVIzYk7i_2idXF4.webp)![PBF: Trust to Magic WAN via tunnel.1 - Forwarding](https://developers.cloudflare.com/_astro/12_pbf_mwan_sites_tun01_forwarding.BgfRalCp_nD0x0.webp)\n\n#### Command line policy-based forwarding - Magic WAN production traffic via tunnel.1",
      "language": "unknown"
    },
    {
      "code": "#### Dashboard policy-based forwarding - Magic WAN production traffic via tunnel.2\n\n| Name | Option | Value |\n| - | - | - |\n| `PBF_Magic_WAN_sites_02` | Group Rules by Tag | *None* |\n| **Source tab** | Type | *Zone* |\n| | Zone | **Trust\\_L3\\_Zone** |\n| | Source Address | **VLAN0100\\_10-1-100-0--24** |\n| **Destination/Application/Service tab** | Destination Address | **VLAN0010\\_10-1-10-0--24** **VLAN0020\\_10-1-20-0--24** |\n| **Forwarding tab** | Action | *Forward* |\n| | Egress Interface | *tunnel.2* |\n| | Next hop | *IP Address* |\n| | | *CF\\_MWAN\\_IPsec\\_VTI\\_02\\_Remote* |\n\n![PBF: Trust to Magic WAN via tunnel.2 - General](https://developers.cloudflare.com/_astro/13_pbf_mwan_sites_tun02_general.CStSssKo_Mp5iG.webp)![PBF: Trust to Magic WAN via tunnel.2 - Source](https://developers.cloudflare.com/_astro/14_pbf_mwan_sites_tun02_source.ATjxgSnK_Z1Vr1xa.webp)![PBF: Trust to Magic WAN via tunnel.2 - Destinations](https://developers.cloudflare.com/_astro/15_pbf_mwan_sites_tun02_dest-app-service.CM_mCD4L_25ONr3.webp)![PBF: Trust to Magic WAN via tunnel.2 - Forwarding](https://developers.cloudflare.com/_astro/16_pbf_mwan_sites_tun02_forwarding.DMjVsrud_23KJuA.webp)\n\n#### Command line policy-based forwarding - tunnel.2",
      "language": "unknown"
    },
    {
      "code": "## Magic WAN with Cloudflare Zero Trust (Gateway egress)\n\nThis section covers adding in support for the use of Cloudflare Gateway. Adding Cloudflare Gateway allows you to set up policies to inspect outbound traffic to the Internet through DNS, network, HTTP and egress filtering.\n\nThis use case can be supported in one of two ways:\n\n* **Option 1**\n\n  * **Security Rule**: Extend the scope of the `Trust_to_Cloudflare_Magic_WAN_Allow` rule to allow any destination address.\n  * **Policy-Based Forwarding**: Extend the scope of `PBF_Magic_WAN_Sites_01` and `PBF_Magic_WAN_Sites_02` to allow any destination address.\n\n* **Option 2**\n\n  * **Security Rule**: Add a new rule below `Trust_to_Cloudflare_Magic_WAN_Allow` called `Trust_to_MWAN_Gateway_Egress_Allow` to allow traffic to any destination address except for the Magic WAN Protected Sites (using the Negate option).\n  * **Policy-Based Forwarding**: Add a new rule below `PBF_Magic_WAN_Sites_01` and `PBF_Magic_WAN_Sites_02` to allow any destination address except for the Magic WAN Protected Sites (using the Negate option).\n\nThe following examples are based on Option 2.\n\nNote\n\nThis example assumes the security rules and policy-based forwarding rules from the previous sections have been configured and are directly above the rules configured in this section.\n\nAlso, traffic from Trust to the Internet would typically be defined as `Trust_L3_Zone` to `Untrust_L3_Zone`. However, since egress Internet traffic will be routed through the Magic IPsec tunnels, the rule must reference `Trust_L3_Zone` to `Cloudflare_L3_Zone`.\n\n### Security Rule: Trust to Gateway Egress\n\n#### Dashboard\n\n| Name | Option | Value |\n| - | - | - |\n| `Trust_to_MWAN_Gateway_Egress_Allow` | Rule Type | *universal (default)* |\n| | Group Rules By Tag | *None* |\n| **Source tab** | Source Zone | **Trust\\_L3\\_Zone** |\n| **Destination tab** | Destination Zone | **Cloudflare\\_L3\\_Zone** |\n| | Destination Address | **VLAN0010\\_10-1-10-0--24** **VLAN0020\\_10-1-20-0--24** **Negate** |\n| **Actions tab** | Action | *Allow* |\n| | Log Setting | **Log at Session End** |\n| | Profile Type | *None* |\n| | Schedule | *None* |\n| | QoS Marking | *None* |\n\n![Trust to MWAN Egress - General](https://developers.cloudflare.com/_astro/01_trust_mwan_egress_general.Biz7B17n_Z1iTO1c.webp)![Trust to MWAN Egress - Source](https://developers.cloudflare.com/_astro/02_trust_mwan_egress_source.B7t96mux_psyKK.webp)![Trust to MWAN Egress - Destination](https://developers.cloudflare.com/_astro/03__trust_mwan_egress_destination.BrBr5PhZ_ZAfkD9.webp)![Trust to MWAN Egress - Applications](https://developers.cloudflare.com/_astro/04_trust_mwan_egress_apps.GpW02LW6_Z1BsSvi.webp)![Trust to MWAN Egress - Services/URL Categories](https://developers.cloudflare.com/_astro/05_trust_mwan_egress_service-url.CkJbZtLv_pPHzW.webp)![Trust to MWAN Egress - Action](https://developers.cloudflare.com/_astro/06_trust_mwan_egress_actions.D64ZOSoI_7pVv7.webp)\n\n#### Command line",
      "language": "unknown"
    },
    {
      "code": "### Policy-based forwarding: Trust to Gateway egress via tunnel.1\n\n#### Dashboard\n\n| Name | Option | Value |\n| - | - | - |\n| `PBF_MWAN_Egress01` | Group Rules By Tag | *None* |\n| **Source tab** | Source Zone | **Trust\\_L3\\_Zone** |\n| **Destination/Application/Service tab** | Destination Address | **VLAN0010\\_10-1-10-0--24** **VLAN0020\\_10-1-20-0--24** **Negate** |\n| **Forwarding tab** | Action | *Forward* |\n| | Egress Interface | *tunnel.1* |\n| | Next Hop | *IP Address* |\n| | | *CF\\_MWAN\\_IPsec\\_VTI\\_01\\_Remote* |\n\n![PBF: Trust to Magic WAN Egress via tunnel.1 - General](https://developers.cloudflare.com/_astro/07_pbf_trust_mwan_egress_tun01_general.DanIxwjJ_yI2si.webp)![PBF: Trust to Magic WAN via tunnel.1 - Source](https://developers.cloudflare.com/_astro/02_trust_mwan_egress_source.B7t96mux_psyKK.webp)![PBF: Trust to Magic WAN via tunnel.1 - Destinations](https://developers.cloudflare.com/_astro/09_pbf_trust_mwan_egress_tun01_dest.D3-eCYMo_ZVN6p1.webp)![PBF: Trust to Magic WAN via tunnel.1 - Forwarding](https://developers.cloudflare.com/_astro/10_pbf_trust_mwan_egress_tun01_forward.w-i02GXK_ZQhurD.webp)\n\n#### Command line",
      "language": "unknown"
    },
    {
      "code": "### Policy-based forwarding: Trust to Gateway egress via tunnel.2\n\n#### Dashboard\n\n| Name | Option | Value |\n| - | - | - |\n| `PBF_MWAN_Egress02` | Group Rules By Tag | *None* |\n| **Source tab** | Source Zone | **Trust\\_L3\\_Zone** |\n| | Source Address | **VLAN0100\\_10-1-100-0--24** |\n| **Destination/Application/Service tab** | Destination Address | **VLAN0010\\_10-1-10-0--24** **VLAN0020\\_10-1-20-0--24** **Negate** |\n| **Forwarding tab** | Action | *Forward* |\n| | Egress Interface | *tunnel.2* |\n| | Next Hop | *IP Address* |\n| | | *CF\\_MWAN\\_IPsec\\_VTI\\_02\\_Remote* |\n\n![PBF: Trust to Magic WAN Egress via tunnel.2 - General](https://developers.cloudflare.com/_astro/11_pbf_trust_mwan_egress_tun02_general.D8ffa0E__1uYVDt.webp)![PBF: Trust to Magic WAN via tunnel.2 - Source](https://developers.cloudflare.com/_astro/12_pbf_trust_mwan_egress_tun02_source.UqvzUgLo_Z1jErHU.webp)![PBF: Trust to Magic WAN via tunnel.2 - Destinations](https://developers.cloudflare.com/_astro/13_pbf_trust_mwan_egress_tun02_dest.DYJd_Nm6_2vWn7D.webp)![PBF: Trust to Magic WAN via tunnel.2 - Forwarding](https://developers.cloudflare.com/_astro/14_pbf_trust_mwan_egress_tun02_forward.CDTxDSWp_1HHKof.webp)\n\n#### Command line",
      "language": "unknown"
    },
    {
      "code": "## Troubleshooting\n\nCloudflare recommends you consult [PAN-OS 9.1 Administrators Guide - Interpret VPN Error Messages](https://docs.paloaltonetworks.com/pan-os/9-1/pan-os-admin/vpns/set-up-site-to-site-vpn/interpret-vpn-error-messages) and [PAN-OS 10.2 Administrators Guide - Interpret VPN Error Messages](https://docs.paloaltonetworks.com/pan-os/10-2/pan-os-admin/vpns/set-up-site-to-site-vpn/interpret-vpn-error-messages) for general troubleshooting.\n\n</page>\n\n<page>\n---\ntitle: pfSense  Cloudflare One docs\ndescription: This tutorial includes the steps required to configure IPsec\n  tunnels to connect a pfSense firewall to Cloudflare Magic WAN.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/pfsense/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/pfsense/index.md\n---\n\nThis tutorial includes the steps required to configure IPsec tunnels to connect a pfSense firewall to Cloudflare Magic WAN.\n\n## Software tested\n\n| Manufacturer | Firmware revision |\n| - | - |\n| pfSense | 24.03 |\n\n## Prerequisites\n\nFor this tutorial, you will need to know the following information:\n\n* Your Anycast IP addresses (given to you by Cloudflare)\n* External IP addresses\n* Internal IP address ranges\n* Inside tunnel `/31` ranges\n\n## Example scenario\n\nThe following IP addresses are used throughout this tutorial. Any legally routable IP addresses have been replaced with IPv4 Address Blocks Reserved for Documentation ([RFC 5737](https://datatracker.ietf.org/doc/html/rfc5737)) addresses within the `203.0.113.0/24` subnet.\n\n| Tunnel name | `PF_TUNNEL_01` | `PF_TUNNEL_02` |\n| - | - | - |\n| Interface address | `10.252.2.26/31` | `10.252.2.28/31` |\n| Customer endpoint | `203.0.113.254` | `203.0.113.254` |\n| Cloudflare endpoint | `<YOUR_ANYCAST_IP_ADDRESS_1>` | `<YOUR_ANYCAST_IP_ADDRESS_2>` |\n| Pfsense IPsec Phase 2 Local IP | `10.252.2.27` | `10.252.2.29` |\n| Pfsense IPsec Phase 2 Remote IP | `10.252.2.26` | `10.252.2.28` |\n| Magic WAN static routes - Prefix | `10.1.100.0/24` | `10.1.100.0/24` |\n| Magic WAN static routes - Next hop | `PF_TUNNEL_01` | `PF_TUNNEL_02` |\n\n## 1. Configure Magic WAN IPsec tunnels\n\nUse the Cloudflare dashboard or API to [configure two IPsec tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels). The settings mentioned below are used for the IPsec tunnels referenced throughout the remainder of this guide.\n\n### Add IPsec tunnels\n\n1. Follow the [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) instructions to create the required IPsec tunnels with the following options:\n\n   * **Tunnel name**: `PF_TUNNEL_01`\n   * **Interface address**: `10.252.2.26/31`\n   * **Customer endpoint**: `203.0.113.254`\n   * **Cloudflare endpoint**: Enter the Anycast IP address provided by Cloudflare.\n   * **Health check rate**: *Medium*\n   * **Health check type**: *Request*\n   * **Health check direction**: *Bidirectional*\n   * **Turn on replay protection**: Enable\n\n2. Select **Add pre-shared key later** > **Add tunnels**.\n\n3. Repeat the process to create a second IPsec tunnel with the following options:\n\n   * **Tunnel name**: `PF_TUNNEL_02`\n   * **Interface address**: `10.252.2.28/31`\n   * **Customer endpoint**: `203.0.113.254`\n   * **Cloudflare endpoint**: Enter the Anycast IP address provided by Cloudflare.\n   * **Health check rate**: *Medium*\n   * **Health check type**: *Request*\n   * **Health check direction**: *Bidirectional*\n   * **Turn on replay protection**: Enable\n\n4. Select **Add pre-shared key later** > **Add tunnels**.\n\nNote\n\nIf site-to-site traffic is a requirement for your use case, you need to enable replay protection. Refer to [Add tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) > IPsec tunnel to learn how to enable this feature.\n\n### Generate pre-shared keys\n\nWhen you create IPsec tunnels with the option **Add pre-shared key later**, the Cloudflare dashboard will show you a warning indicator.\n\n1. Select **Edit** to edit the properties of each IPsec tunnel you have created.\n2. Select **Generate a new pre-shared key** > **Update and generate pre-shared key**.\n3. Copy the pre-shared key value for each of your IPsec tunnels, and save these values somewhere safe. Then, select **Done**.\n\nNote\n\nTake note of your pre-shared keys, and keep them in a safe place to use later in pfSense.\n\n### IPsec identifier - User ID\n\nAfter creating your IPsec tunnels, the Cloudflare dashboard will list them under **Tunnels**. To retrieve your IPsec tunnel's user ID:\n\n1. Go to **Tunnels** in the Cloudflare dashboard.\n\n   [Go to **Configuration**](https://dash.cloudflare.com/?to=/:account/magic-wan/configuration)\n\n2. Select the IPsec tunnel.\n\n3. Scroll to **User ID** and copy the string. For example, `ipsec@long_string_of_letters_and_numbers`.\n\nThe User ID will be required when configuring IKE Phase 1 on the pfSense firewall.\n\n## 2. Create Magic WAN static routes\n\nCreate a [static route](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route) for each of the two IPsec tunnels configured in the previous section, with the following settings (settings not mentioned here can be left with their default values):\n\n### Tunnel 01\n\n* **Description**: `PF_TUNNEL_01`\n* **Prefix**: `10.1.100.0/24`\n* **Tunnel/Next hop**: `PF_TUNNEL_01`\n\n### Tunnel 02\n\n* **Description**: `PF_TUNNEL_02`\n* **Prefix**: `10.1.100.0/24`\n* **Tunnel/Next hop**: `PF_TUNNEL_02`\n\n## 3. Configure the pfSense firewall\n\nInstall pfSense and boot up. Then, assign and set LAN and WAN interfaces, as well as IP addresses. For example:\n\n* **LAN**: `203.0.113.254`\n* **WAN**: `<YOUR_WAN_ADDRESS>`\n\n### Configure IPsec Phase 1\n\nAdd a new IPsec tunnel [Phase 1 entry](https://docs.netgate.com/pfsense/en/latest/vpn/ipsec/configure-p1.html), with the following settings:\n\n* **General Information**\n  * **Description**: `CF1_IPsec_P1`\n\n* **IKE Endpoint Configuration**\n\n  * **Key exchange version**: *IKE\\_v2*\n  * **Internet Protocol**: *IPv4*\n  * **Interface**: *WAN*\n  * **Remote gateway**: Enter your Cloudflare Anycast IP address.\n\n* **Phase 1 Proposal (Authentication)**\n\n  * **Authentication method**: *Mutual PSK*\n  * **My identifier**: *User Fully qualified domain name* > `ipsec@long_string_of_letters_and_numbers`\\\n    (You can get this identifier from your Cloudflare IPsec tunnel configuration > **User ID**)\n  * **Peer identifier**: *Peer IP Address* (your Cloudflare Anycast IP)\n  * **Pre-Shared Key**: Enter the PSK you have on your Cloudflare IPsec tunnel.\n\n* **Phase 1 proposal (Encryption algorithm)**\n\n  * **Encryption algorithm**: *AES 256 bits*\n  * **Key length**: *256 bits*\n  * **Hash algorithm**: *SHA256*\n  * **DH key group**: *20*\n  * **Lifetime**: `86400`\n\n### Configure IPsec Phase 2\n\nAdd a new IPsec tunnel [Phase 2 entry](https://docs.netgate.com/pfsense/en/latest/vpn/ipsec/configure-p2.html), with the following settings. You need to create an entry for tunnel 1 and 2, making the appropriate changes for the IP addresses for local and remote network:\n\n* **General Information**\n\n  * **Description**: `CF1_IPsec_P2`\n  * **Mode**: *Routed (VTI)*\n\n* **Networks**\n\n  * **Local Network**: *Address* > Upper IP address in the `/31` assigned in Cloudflare tunnel. For example, `10.252.2.27` for tunnel 1 and `10.252.2.29` for tunnel 2.\n  * **Remote Network**: *Address* > Lower IP address in the `/31` for Cloudflare side. For example, `10.252.2.26` for tunnel 1, and `10.252.2.28` for tunnel 2.\n\n* **Phase 2 Proposal (SA/Key Exchange)**\n\n  * **Protocol**: *ESP*\n  * **Encryption algorithm**: *AES 256 bits*\n  * **Hash algorithm**: *SHA256*\n  * **DH key group**: *20*\n  * **Lifetime**: `28800`\n\nWhen you are finished, apply your changes. If you go to **Status** > **IPsec**, you should be able to check that both Phase 1 and Phase 2 are connected.\n\n![pfSense IPsec overview](https://developers.cloudflare.com/_astro/ipsec-overview.B7tL0kto_Nzl7V.webp)\n\n### Interface assignments\n\nIn **Interfaces** > **Assignments** > **Add**, create a new interface to assign to the first IPsec tunnel, with the following settings:\n\n* **General configuration**\n\n  * **Description**: `CF1_IPsec_1`\n  * **MSS**: `1446`\n\n* **Interface Assignments**\n\n  * **WAN**: Add your WAN interface. For example, `vnet1`.\n  * **LAN**: Add your LAN interface. For example, `vnet0`.\n  * Add your **CF\\_IPsec\\_1** that you have created above for Phase 1.\n\nSelect **Save** when you are finished.\n\n![Assign a new interface to the first IPsec tunnel](https://developers.cloudflare.com/_astro/interfaces.COkbEEZi_Z1qEfaY.webp)\n\n![Configuring interface assignments](https://developers.cloudflare.com/_astro/interface-assignments.CblqhRKO_Zsid2F.webp)\n\n### Gateway\n\nIn **System** > **Routing** > **Gateways** there should already be a gateway. For this example, it is named `CF1_IPSEC_1_VTIV4`.\n\n![There should already be a gateway configured in the interface](https://developers.cloudflare.com/_astro/gateways.BWYSJrzk_2rCe1d.webp)\n\n### Firewall Rules IPsec\n\n1. In **Firewall Rules** > **IPsec interface**, allow any type of traffic.\n\n![Allow all traffic for IPsec](https://developers.cloudflare.com/_astro/firewall-ipsec.CgXaJWLX_Z1pCizW.webp)\n\n1. Navigate to **Status** > **Gateways**. `CF1_IPSEC_1_VTIV4` should now be online.\n\n![The gateway should now be online](https://developers.cloudflare.com/_astro/status-gateways.CAqgLr_K_a1bVv.webp)\n\n### Firewall Rules LAN\n\n1. In **Firewall** > **Rules** > **LAN**, allow any type of traffic.\n2. Expand the **Advanced** section.\n3. Change the Gateway to `CF1_IPSEC_1_VTIV4`.\n\n![Change the gateway in the firewall rules for LAN traffic](https://developers.cloudflare.com/_astro/firewall-lan.DduZnf_o_1jVj2x.webp)\n\n</page>\n\n<page>\n---\ntitle: SonicWall  Cloudflare One docs\ndescription: \"This tutorial shows you how to use Magic WAN with the following\n  versions of the SonicWall appliances:\"\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/sonicwall/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/sonicwall/index.md\n---\n\nThis tutorial shows you how to use Magic WAN with the following versions of the SonicWall appliances:\n\n* **Hardware tested**:\n\n  * SonicWall NSv 470\n  * SonicWal 3700\n\n* **Software versions tested**:\n  * SonicOS 7.0.1\n\nYou can connect your SonicWall appliance through [IPsec tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/) to Magic WAN. Generic Routing Encapsulation (GRE) is not supported on SonicWall.\n\n## Topology\n\n![Topology diagram showing how to connect SonicWall appliances to Magic WAN](https://developers.cloudflare.com/_astro/topology.Qe7r1Gcs_Z2cR4HM.webp)\n\nThe following instructions show how to setup an IPsec connection on your SonicWall device. We will use the IP ranges from the above topology example to create the connections needed. Settings not explicitly mentioned can be left with their default values.\n\n## 1. Create an IPsec tunnel on your Cloudflare account\n\n1. Start by [creating your IPsec tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) on Cloudflare. Name and describe the tunnels as needed, and add the following settings:\n\n   * **Interface address**: Enter the internal tunnel IP on the Cloudflare side of the IPsec tunnel. In this example, it is `10.200.1.0/31`.\n   * **Customer endpoint**: Enter the WAN IP address of your SonicWall device. In our example, this is `198.51.100.2`.\n   * **Cloudflare endpoint**: Enter the IP address provided by Cloudflare. In our example, this is `1.2.3.4`.\n   * **Pre-shared key**: Select **Use my own pre-shared key** and paste a secure key of your own.\n\n2. Select **Add tunnels** when you are finished.\n\n3. After you create your tunnel, Cloudflare dashboard will load a list of tunnels set up for your account. Select the arrow to expand the tunnels you have just created, and check the following settings:\n\n   * **Customer endpoint**: Refers to the SonicWall WAN IP that the VPN policy is bound to (in red).\n   * **Cloudflare endpoint**: Refers to the anycast IP provided by Cloudflare (in blue).\n   * **FQDN ID**: The ID used in the VPN policy for the SonicWall's Local IKE ID. Copy this ID and save it. You will need it when configuring the tunnel on your SonicWall (in green).\n\n   ![An example of what your IPsec tunnel should look like](https://developers.cloudflare.com/_astro/step3.BQqYLGGy_Z1omATt.webp)\n\nNote\n\nThe interface address on the Cloudflare side of the tunnel is `10.200.1.0/31`. You will need to use `10.200.1.1/31` on the SonicWall side of the tunnel.\n\n## 2. Create static routes on Cloudflare dashboard\n\nStatic routes are required for any networks that will be reached via the IPsec tunnel. In our example, there are two networks: `172.31.3.0/24` and the tunnel network `10.200.1.0/31`.\n\n1. [Create your static routes](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-routes/#create-a-static-route). Name and describe them as needed, and add the following settings:\n\n   * **First tunnel**: Following our example, add `10.200.1.0/31` as the **Prefix** and `10.200.1.1` for the **Tunnel/Next hop**.\n   * **Second tunnel**: Following our example, add `172.31.3.0/24` as the **Prefix** and `10.200.1.1` for the **Tunnel/Next hop**.\n\n2. Select **Add routes** when you are finished.\n\n## 3. Add a VPN configuration in SonicWall\n\n1. Go to **Network** > **IPsec VPN** > **Rules and Settings**.\n\n2. Select **Add**.\n\n3. In **General** > **Security Policy** group, add the following settings:\n\n   * **Authentication Method**: *IKE Using Preshared Secret*.\n   * **IPsec Primary Gateway Name or Address**: Enter Cloudflare's anycast IP address for the primary gateway (in blue).\n\n4. In the **IKE Authentication** group, add the following settings:\n\n   * **Shared secret**: Paste the pre-shared key you use to create the IPsec tunnel in step 1 (in purple).\n   * **Local IKE ID**: Select *Domain name* from the dropdown menu, and paste here the **FQDN ID** you saved from step 1, after creating the IPsec tunnel (in green).\n   * **Peer IKE IDE**: Select *IPv4* Address from the dropdown menu, and enter the Cloudflare anycast IP address (in blue).\n\n![Configure a VPN policy on your SonicWall device](https://developers.cloudflare.com/_astro/3-vpn-config.D7Z_hEIs_2mY6og.webp)\n\n1. Select **Proposals**. VPN Policy is somewhat flexible. Adjust these settings to match your organization's preferred security policy. As an example, you can use the settings in the examples below.\n\n2. In the **IKE (Phase 1) Proposal** group, select the following settings:\n\n   * **Exchange**: *IKEv2 Mode*\n   * **DH Group**: *Group 20*\n   * **Encryption**: *AES-256*\n   * **Authentication**: *SHA256*\n   * **Life Time (seconds)**: `86400`\n\n3. In the **IPsec (Phase 2) Proposal** group, add the following settings:\n\n   * **Protocol**: *ESP*\n   * **Encryption**: *AESGCM16-256*\n   * **Authentication**: *None*\n   * **Enable Perfect Forward Secrecy**: Enabled\n   * **DH Group**: *Group 20*\n   * **Life Time (seconds)**: `28800`\n\n4. Select **Advanced**.\n\n5. Enable **Disable IPsec Anti-Replay**.\n\n6. In **VPN Policy bound to** select your WAN interface from the dropdown menu, to bind it to your VPN.\n\n7. Select **Save**.\n\n![Enable anti-replay on your SonicWall device](https://developers.cloudflare.com/_astro/5-anti-replay.Dth4Gt_P_ZwYCWu.webp)\n\n## 4. Add a VPN tunnel interface\n\nSonicOS requires a VPN tunnel interface to route traffic via Magic WAN. When creating the interface, use the prefix `10.200.1.1/31`. This matches with the Cloudflare side for this tunnel, which is `10.200.1.0`.\n\nNote\n\nYou will need to use a different IP pair for each tunnel/site.\n\n1. Go to **Network** > **System** > **Interfaces**.\n2. Select **Add interface** > **VPN Tunnel Interface**.\n3. For IP Address, use `10.200.1.1`.\n4. Enable **Ping**. This is required so the interface can be pinged for debugging and Magic WAN health checks.\n\n![Enable ping to that your interface can be pinged for debugging and Magic WAN health checks](https://developers.cloudflare.com/_astro/6-vpn-ping.C-1HHDpJ_Z18xDRn.webp)\n\n1. Select **Advanced**.\n2. Enable the **Enable Asymmetric Route Support** option. This is required for the Magic WAN tunnel health check.\n\n![Enable Asymmetric Route Support. It is required for Magic WAN health checks](https://developers.cloudflare.com/_astro/6-vpn-assymetric.z4MOIOv3_fuABl.webp)\n\n1. Select **OK**.\n\n## 5. Add address object(s)\n\nAddress objects are necessary for route policies. In our example, we have one other site that will be reached via Magic WAN. First, you need to create address objects for each network. Then, you need to create an address group that contains all the remote networks. This address group will be used in the next step to create the correct route policies.\n\nTo add an address object:\n\n1. Select **Object** > **Match Objects** > **Addresses**.\n2. Select **Address Objects** > **Add**.\n3. Enter the information for your address object - refer to the topology image for the examples this tutorial is using. Since the addresses are in the VPN zone, set the **Zone Assignment** for the object to *VPN*.\n4. Select **Save**. The window will stay on to facilitate multiple entries. Select **X** to close it.\n\n![Enter the appropriate settings for you object](https://developers.cloudflare.com/_astro/7-address-objects-settings.Dym3UpvD_bLprj.webp)\n\n1. Select **Address Groups** > **Add** to add a new address group.\n2. Enter a **Name** for your address group.\n3. Select the individual network objects you have created on the left menu, and add them to the group by selecting the right-facing arrow in the middle column.\n4. Select **Save**.\n\n![Copy the individual network objects and add them to your group](https://developers.cloudflare.com/_astro/7-add-objects-group.CYauQpR7_Z4W5mb.webp)\n\n## 6. Set up routing\n\nAdd a route using the address object or group just created as the destination.\n\n1. Select **Policy** > **Rules and Policies** > **Routing Rules**.\n2. Select **Add** to add your route policy.\n3. The **Next Hop** should be the VPN tunnel interface that was previously created in the interface panel.\n\n## 7. Add access rule for health checks\n\nAn additional access rule is required for Magic WAN health checks to work properly. This will enable the WAN IP to receive ICMP pings via the tunnel, and return them over the WAN.\n\n1. Select **Policy** > **Rules and Policies**.\n2. Select **Access Rules** > **Add**.\n3. Enter a descriptive name for your policy.\n4. In **Source / Destination** > **Destination > Port/Services**, select *ICMP* from the dropdown.\n5. Select **Optional Settings**.\n6. In **Others**, enable **Allow Management traffic**.\n\n## 8. Setup health checks\n\nYou have to [configure Magic WAN health checks](https://developers.cloudflare.com/magic-wan/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) correctly. Here is an example of how to set up health checks:",
      "language": "unknown"
    },
    {
      "code": "Health checks might take some time to stabilize after the configuration is changed.\n\n## 9. Verify tunnel status on Cloudflare dashboard\n\nThe Cloudflare dashboard monitors the health of all anycast tunnels on your account that route traffic from Cloudflare to your origin network. Refer to [Check tunnel health in the dashboard](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/check-tunnel-health-dashboard/) for more information.\n\n</page>\n\n<page>\n---\ntitle: Sophos Firewall  Cloudflare One docs\ndescription: \"This tutorial shows you how to use Magic WAN with the following\n  versions of the Sophos Firewall:\"\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/sophos-firewall/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/sophos-firewall/index.md\n---\n\nThis tutorial shows you how to use Magic WAN with the following versions of the Sophos Firewall:\n\n* **Sophos form factor tested:**\n\n  * Sophos Firewall XGS and XG series hardware\n  * Sophos Firewall virtual appliance on VMware\n\n* **Sophos software versions tested:**\n\n  * SFOS Version 19.0 MR2-Build 472\n  * SFOS Version 19.5.1 MR1-Build 278\n\nYou can connect through[ Generic Routing Encapsulation (GRE) or IPsec tunnels](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/) to Magic WAN.\n\n## IPsec connection\n\nThe following instructions show how to setup an IPsec connection on your Sophos Firewall device. Settings not explicitly mentioned can be left with their default values.\n\n### 1. Add an IPsec profile\n\n1. Go to **System** > **Profiles**.\n\n2. In **IPsec profiles**, select **Add**.\n\n3. In the **General settings** group, make sure you have the following settings:\n\n   * **Name**: Give your profile a descriptive name.\n   * **Key exchange**: **IKEv2**\n   * **Authentication mode**: **Main mode**\n\n4. In the **Phase 1** group, make sure you have the following settings:\n\n   * **DH group (key group)**: *20*\n   * **Encryption**: *AES256*\n   * **Authentication**: *SHA2 256*\n\n5. In the **Phase 2** group, select the following:\n\n   * **PFS group (DH group)**: *Same as phase-1*\n   * **Key life**: *28800*\n   * **Encryption**: *AES256*\n   * **Authentication**: *SHA2 256*\n\n6. Enable **Dead Peer Detection**.\n\n7. In **When peer unreachable**, select *Re-initiate*.\n\n8. Select **Save**.\n\n### 2. Create IPsec connection tunnel\n\nThe next step involves configuring a site-to-site IPsec VPN connection on your Sophos Firewall device.\n\n1. Go to **Configure** > **Site-to-site VPN**.\n\n2. In **IPsec**, select **Add**.\n\n3. In the **General settings** group, make sure you have the following settings:\n\n   * **Name**: Give your site-to-site VPN a descriptive name.\n   * **Connection type**: *Tunnel interface*\n   * **Gateway type**: *Initiate the connection*\n\n4. In the **Encryption** group, make sure you have the following settings:\n   * **Authentication type**: **Preshared key**\n\n5. In **Gateway settings**, make sure you have the following settings:\n\n   * **Gateway address**: Enter your Cloudflare anycast IP address provided by Cloudflare.\n   * **Local ID type**: Add the [IKE ID](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/reference/gre-ipsec-tunnels/#supported-ike-id-formats) provided by Cloudflare.\n\n![Configure an IPsec tunnel.](https://developers.cloudflare.com/_astro/2-ipsec-tunnel.EuRwmMGh_wIMKi.webp)\n\nAfter setting up your IPsec tunnel, it will show up on the IPsec connections list with an **Active** status.\n\n![The IPsec tunnel should show up on the IPsec connections list.](https://developers.cloudflare.com/_astro/2b-ipsec-tunnel.DcLZdCzX_2gDzJX.webp)\n\n### 3. Assign the XFRM interface address\n\nYou must use an interface address from the `/31` subnet required to [configure tunnel endpoints](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/) on Magic WAN.\n\n1. Go to **Configure** > **Network**.\n2. In **Interfaces**, select the corresponding interface to the IPsec tunnel you created in [step 2](#2-create-ipsec-connection-tunnel).\n3. Edit the interface to assign an address from the `/31` subnet required to [configure tunnel endpoints](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/). When you are finished, it should look similar to the following:\n\n![Configure a XFRM interface.](https://developers.cloudflare.com/_astro/3-xfrm-interface.Dks8X1E8_ZPYrQT.webp)\n\n### 4. Add a firewall rule\n\n1. Go to **Protect** > **Rules and policies**.\n2. In **Firewall rules**, create a firewall rule with the criteria and security policies from your company that allows traffic to flow between Sophos and Magic WAN.\n\n![Create a firewall rule with the criteria and security policies from your company](https://developers.cloudflare.com/_astro/4-firewall-rule.CfVt6IDY_Z1zkMRq.webp)\n\n### 5. Disable IPsec anti-replay\n\nYou will have to disable IPsec Anti-Replay on your Sophos Firewall. Changing the anti-replay settings restarts the IPsec service, which causes tunnel-flap for all IPsec tunnels. This will also disable IPsec anti-replay protection for all VPN connections globally. Plan these changes accordingly.\n\nBelow are instruction on how to achieve this on SFOS version 19 and SFOS version 19.5:\n\n#### SFOS 19.0 MR2-Build 472 or 19.5 MR1-Build278 or later versions:\n\n1. Sign in to the CLI.\n\n2. Enter **4** to choose **Device console**, and enter the following command:",
      "language": "unknown"
    },
    {
      "code": "![Access the CLI to disable anti-replay](https://developers.cloudflare.com/_astro/5-sfos-19.CmXNwDG8_Z2sQ13W.webp)\n\n#### Older SFOS versions\n\nContact Sophos support.\n\n## GRE connection\n\n### 1. Configure a GRE tunnel between SFOS and Cloudflare\n\nStart by configuring a GRE tunnel between SFOS and the Cloudflare anycast IP address.\n\n1. Sign in to the CLI.\n\n2. Enter **4** to choose **Device console**, and enter the following command:",
      "language": "unknown"
    },
    {
      "code": "![Access the CLI to configure a GRE tunnel](https://developers.cloudflare.com/_astro/1-gre-connection.BwxtP6sM_Z12PvdG.webp)\n\n   For more details, refer to the [Sophos Firewall knowledge base](https://support.sophos.com/support/s/article/KB-000035813?language=en_US).\n\n### 2. Add a GRE or SD-WAN route to redirect traffic through the GRE tunnel\n\nThe detailed information on how to add a GRE or SD-WAN route to redirect traffic through the GRE tunnel, is in the next section ([Traffic redirection mechanism on Sophos Firewall](#traffic-redirection-mechanism-on-sophos-firewall)).\n\n### 3. Add a firewall rule for LAN/DMZ to VPN\n\nCreate a firewall rule with the criteria and security policies from your company that allows traffic to flow between Sophos and Magic WAN. This firewall rule should include the required networks and services.\n\n1. Go to **Protect** > **Rules and policies**.\n2. In **Firewall rules**, select **IPv4** > **Add firewall rule**.\n\n![Create a firewall rule with the criteria and security policies from your company](https://developers.cloudflare.com/_astro/4-firewall-rule.CfVt6IDY_Z1zkMRq.webp)\n\n## Traffic redirection mechanism on Sophos Firewall\n\nTo redirect traffic, you can add a static or an SD-WAN route.\n\n### IPsec\n\n#### Static route\n\nGo to **Configure** > **Routing** > **Static routes** to add an XFRM interface-based route. The interface will be automatically created when you set up a tunnel interface based on IPsec (such as the Cloudflare\\_MWAN example from above).\n\n![Go to static routes to add an XFRM interface-based route](https://developers.cloudflare.com/_astro/static-route.Cv8cjbPi_blRdV.webp)\n\n#### SD-WAN route\n\n1. Go to **Configure** > **Routing** > **Gateways** to create a custom gateway on the XFRM interface. The interface will be automatically created when you set up a tunnel interface based on IPsec (such as the Cloudflare\\_MWAN example from above).\n\n![Go to Gateways to add an XFRM interface-based route](https://developers.cloudflare.com/_astro/1-sd-wan-gateway.B-zYNWQF_Z2x4Oc6.webp)\n\n1. In **Configure** > **Routing** > **SD-WAN routes**, select **Add** to add the desired networks and services in the route to redirect traffic to Cloudflare. Enter a descriptive name for your connection, and the IP addresses you set up for your IPsec tunnels in **Incoming interface** and **Source networks**. Do not forget to choose the correct **Primary gateway** option.\n\n![Go to SD-WAN to add the desired networks and services in the route.](https://developers.cloudflare.com/_astro/2-sd-wan-routes.ZK7MHrV6_ZEhQ4a.webp)\n\n### GRE\n\nAdd a GRE or SD-WAN route or both.\n\n#### GRE route\n\nAdd the route on the CLI.\n\n1. Sign in to the CLI.\n2. Enter **4** to choose **Device console**, and enter the following command to create the tunnel:",
      "language": "unknown"
    },
    {
      "code": "![Add the route on the CLI.](https://developers.cloudflare.com/_astro/gre-route-cli.eRcqLJze_1WI8vl.webp)\n\n#### SD-WAN route\n\n1. Add a custom gateway on GRE with the peer IP address (from the `/31` subnet you chose earlier) as the Gateway IP address, and disable **Health check**.\n\n![Add a custom gateway on GRE.](https://developers.cloudflare.com/_astro/sd-wan-1-gre.CApTTOXu_Z2uMYKP.webp)\n\n1. Add an SD-WAN route with the desired networks and services in the route to redirect traffic to Cloudflare.\n\n![Add an SD-WAN route.](https://developers.cloudflare.com/_astro/2-sd-wan-routes.ZK7MHrV6_ZEhQ4a.webp)\n\n## Verify tunnel status on Cloudflare dashboard\n\nThe Cloudflare dashboard monitors the health of all anycast tunnels on your account that route traffic from Cloudflare to your origin network. Refer to [Check tunnel health in the dashboard](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/common-settings/check-tunnel-health-dashboard/) for more information.\n\n### Make Cloudflare health checks work\n\n1. The ICMP probe packet from Cloudflare must be the type ICMP request, with anycast source IP. In the following example, we have used `172.64.240.252` as a target example:",
      "language": "unknown"
    },
    {
      "code": "1. Go to **Configure** > **Network** > **Interfaces** > **Add alias**. Add the IP address provided by Cloudflare for the ICMP probe traffic. This is needed to prevent Sophos firewall from dropping them as spoof packets. This is not the same IP used to create VPN. This is the special IP address for probe traffic only.\n\n![Add the IP address provided by Cloudflare to prevent the probe from being dropped by the firewall.](https://developers.cloudflare.com/_astro/2-icmp-probe-firewall.BD1XaeDb_ZpN0sB.webp)\n\n1. ICMP reply from SFOS should go back via the same tunnel on which the probe packets are received. You will need to create an additional SD-WAN policy route.\n\n![Configure an SD-WAN route so the ICMP reply goes back to Cloudflare via the same tunnel.](https://developers.cloudflare.com/_astro/3-icmp-probe-reply.CX60fYHN_Z9vF1H.webp)\n\nPacket flow will look like the following:",
      "language": "unknown"
    },
    {
      "code": "",
      "language": "unknown"
    },
    {
      "code": "## Verify tunnel status on Sophos Firewall dashboard\n\n### IPsec\n\nWhen the tunnel is working, its **Status** will be green.\n\n![If the tunnel is working, it will show up with a green status.](https://developers.cloudflare.com/_astro/2b-ipsec-tunnel.DcLZdCzX_2gDzJX.webp)\n\nThe corresponding XFRM interface will also show a **Connected** status.\n\n![The XFRM interface will also show a connected status.](https://developers.cloudflare.com/_astro/1-sd-wan-gateway.B-zYNWQF_Z2x4Oc6.webp)\n\n### GRE\n\nAccess the CLI and type `system gre tunnel show` to check the status of a GRE tunnel. When the tunnel is working, its Status will show up as **Enabled**.\n\n![The GRE tunnel will show a status of Enabled when working.](https://developers.cloudflare.com/_astro/gre-status-enabled.CkTEu5BC_ZlXB2y.webp) ![The GRE tunnel will show a status of Enabled when working.](https://developers.cloudflare.com/_astro/gre-status-enabled-b.D8-vH0Du_vfstx.webp)\n\n## Troubleshooting\n\nIf a tunnel shows a connected status at both ends, but is not established:\n\n* Check if the IPsec profile configuration is correct.\n* Make sure the corresponding tunnel interfaces are up.\n* Make sure routing configuration and route precedence are correctly set on SFOS.\n* Make sure a static back route is added on Cloudflare.\n* Firewall rules for specific zones and host or service must be added in SFOS. GRE and IPsec belong to the VPN zone.\n* Perform `tcpdump` to check if packets are going through the VPN or GRE tunnel as expected.\n* Perform a packet capture on Cloudflare to see if traffic is reaching the Cloudflare platform.\n\n</page>\n\n<page>\n---\ntitle: strongSwan  Cloudflare One docs\ndescription: This tutorial explains how to set up strongSwan along with Magic\n  WAN. You will learn how to configure strongSwan, configure an IPsec tunnel and\n  create a Policy Based Routing.\nlastUpdated: 2025-10-31T13:37:27.000Z\nchatbotDeprioritize: false\nsource_url:\n  html: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/strongswan/\n  md: https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/third-party/strongswan/index.md\n---\n\nThis tutorial explains how to set up strongSwan along with Magic WAN. You will learn how to configure strongSwan, configure an IPsec tunnel and create a Policy Based Routing.\n\n## 1. Health checks configuration\n\nStart by configuring the [bidirectional health checks](https://developers.cloudflare.com/cloudflare-one/networks/connectors/wan-tunnels/configuration/manually/how-to/configure-tunnel-endpoints/#add-tunnels) target for Magic WAN. For this particular tutorial, we are using `172.64.240.252` as the target IP address, and `type` as the request.\n\nThis can be set up [with the API](https://developers.cloudflare.com/api/resources/magic_transit/subresources/ipsec_tunnels/methods/update/). For example:",
      "language": "unknown"
    },
    {
      "code": "## 2. Configure StrongSwan\n\n1. Start by [installing StrongSwan](https://docs.strongswan.org/docs/5.9/install/install.html). For example, open the console and run:",
      "language": "unknown"
    },
    {
      "code": "1. After StrongSwan finishes installing, go to `/etc/strongswan.conf` to edit the configuration file and add the following settings:",
      "language": "unknown"
    },
    {
      "code": "## 3. Configure IPsec file\n\n1. Go to `/etc/ipsec.conf` and add the following settings:",
      "language": "unknown"
    }
  ],
  "headings": [
    {
      "level": "h3",
      "text": "5. Get help",
      "id": "5.-get-help"
    },
    {
      "level": "h2",
      "text": "1. Create an SSH key pair",
      "id": "1.-create-an-ssh-key-pair"
    },
    {
      "level": "h2",
      "text": "2. Create a VM instance in GCP",
      "id": "2.-create-a-vm-instance-in-gcp"
    },
    {
      "level": "h2",
      "text": "3. Connect the server to Cloudflare",
      "id": "3.-connect-the-server-to-cloudflare"
    },
    {
      "level": "h2",
      "text": "4. Set up the client",
      "id": "4.-set-up-the-client"
    },
    {
      "level": "h2",
      "text": "5. Route private network IPs through WARP",
      "id": "5.-route-private-network-ips-through-warp"
    },
    {
      "level": "h2",
      "text": "6. Connect as a user",
      "id": "6.-connect-as-a-user"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Before you begin",
      "id": "before-you-begin"
    },
    {
      "level": "h3",
      "text": "Determine the need for a high availability configuration",
      "id": "determine-the-need-for-a-high-availability-configuration"
    },
    {
      "level": "h3",
      "text": "Decide on DHCP vs static IP connections",
      "id": "decide-on-dhcp-vs-static-ip-connections"
    },
    {
      "level": "h2",
      "text": "Port speeds",
      "id": "port-speeds"
    },
    {
      "level": "h2",
      "text": "Set up Cloudflare dashboard",
      "id": "set-up-cloudflare-dashboard"
    },
    {
      "level": "h3",
      "text": "Register your Connector",
      "id": "register-your-connector"
    },
    {
      "level": "h3",
      "text": "Create a new profile",
      "id": "create-a-new-profile"
    },
    {
      "level": "h3",
      "text": "Create a WAN",
      "id": "create-a-wan"
    },
    {
      "level": "h3",
      "text": "Create a LAN",
      "id": "create-a-lan"
    },
    {
      "level": "h3",
      "text": "Add your Magic WAN Connector to a site",
      "id": "add-your-magic-wan-connector-to-a-site"
    },
    {
      "level": "h2",
      "text": "Set up your Magic WAN Connector",
      "id": "set-up-your-magic-wan-connector"
    },
    {
      "level": "h3",
      "text": "Device installation",
      "id": "device-installation"
    },
    {
      "level": "h2",
      "text": "Activate appliance",
      "id": "activate-appliance"
    },
    {
      "level": "h2",
      "text": "WAN with a static IP address",
      "id": "wan-with-a-static-ip-address"
    },
    {
      "level": "h2",
      "text": "Bootstrap via Serial Console",
      "id": "bootstrap-via-serial-console"
    },
    {
      "level": "h3",
      "text": "Equipment required",
      "id": "equipment-required"
    },
    {
      "level": "h3",
      "text": "1. Access the device's serial port",
      "id": "1.-access-the-device's-serial-port"
    },
    {
      "level": "h3",
      "text": "2. Install a serial terminal client",
      "id": "2.-install-a-serial-terminal-client"
    },
    {
      "level": "h3",
      "text": "3. Configure a static IP",
      "id": "3.-configure-a-static-ip"
    },
    {
      "level": "h2",
      "text": "About high availability configurations",
      "id": "about-high-availability-configurations"
    },
    {
      "level": "h3",
      "text": "Create a high availability configuration",
      "id": "create-a-high-availability-configuration"
    },
    {
      "level": "h2",
      "text": "IPsec tunnels and static routes",
      "id": "ipsec-tunnels-and-static-routes"
    },
    {
      "level": "h2",
      "text": "Next steps",
      "id": "next-steps"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Before you begin",
      "id": "before-you-begin"
    },
    {
      "level": "h3",
      "text": "Determine the need for a high availability configuration",
      "id": "determine-the-need-for-a-high-availability-configuration"
    },
    {
      "level": "h3",
      "text": "Decide on DHCP vs static IP connections",
      "id": "decide-on-dhcp-vs-static-ip-connections"
    },
    {
      "level": "h2",
      "text": "Configure a virtual machine",
      "id": "configure-a-virtual-machine"
    },
    {
      "level": "h2",
      "text": "Set up Cloudflare dashboard",
      "id": "set-up-cloudflare-dashboard"
    },
    {
      "level": "h3",
      "text": "Create a new profile",
      "id": "create-a-new-profile"
    },
    {
      "level": "h3",
      "text": "Create a WAN",
      "id": "create-a-wan"
    },
    {
      "level": "h3",
      "text": "Create a LAN",
      "id": "create-a-lan"
    },
    {
      "level": "h3",
      "text": "Add your Virtual Connector to a site",
      "id": "add-your-virtual-connector-to-a-site"
    },
    {
      "level": "h2",
      "text": "Activate appliance",
      "id": "activate-appliance"
    },
    {
      "level": "h2",
      "text": "Boot your Virtual Connector",
      "id": "boot-your-virtual-connector"
    },
    {
      "level": "h2",
      "text": "Default password to access Virtual Connector",
      "id": "default-password-to-access-virtual-connector"
    },
    {
      "level": "h2",
      "text": "WAN with a static IP address",
      "id": "wan-with-a-static-ip-address"
    },
    {
      "level": "h2",
      "text": "About high availability configurations",
      "id": "about-high-availability-configurations"
    },
    {
      "level": "h3",
      "text": "Create a high availability configuration",
      "id": "create-a-high-availability-configuration"
    },
    {
      "level": "h2",
      "text": "IPsec tunnels and static routes",
      "id": "ipsec-tunnels-and-static-routes"
    },
    {
      "level": "h2",
      "text": "Next steps",
      "id": "next-steps"
    },
    {
      "level": "h2",
      "text": "Query metrics with GraphQL",
      "id": "query-metrics-with-graphql"
    },
    {
      "level": "h3",
      "text": "Average CPU load explained",
      "id": "average-cpu-load-explained"
    },
    {
      "level": "h2",
      "text": "Security and other information",
      "id": "security-and-other-information"
    },
    {
      "level": "h2",
      "text": "ICMP traffic",
      "id": "icmp-traffic"
    },
    {
      "level": "h2",
      "text": "VLAN ID",
      "id": "vlan-id"
    },
    {
      "level": "h2",
      "text": "High availability configurations",
      "id": "high-availability-configurations"
    },
    {
      "level": "h3",
      "text": "Terminology",
      "id": "terminology"
    },
    {
      "level": "h3",
      "text": "High availability",
      "id": "high-availability"
    },
    {
      "level": "h3",
      "text": "Active/Standby Election",
      "id": "active/standby-election"
    },
    {
      "level": "h3",
      "text": "Configuration",
      "id": "configuration"
    },
    {
      "level": "h3",
      "text": "Failure detection and failover",
      "id": "failure-detection-and-failover"
    },
    {
      "level": "h2",
      "text": "WAN settings",
      "id": "wan-settings"
    },
    {
      "level": "h3",
      "text": "High-capacity use cases",
      "id": "high-capacity-use-cases"
    },
    {
      "level": "h3",
      "text": "Configure multiple tunnels in the same WAN profile",
      "id": "configure-multiple-tunnels-in-the-same-wan-profile"
    },
    {
      "level": "h3",
      "text": "WAN settings",
      "id": "wan-settings"
    },
    {
      "level": "h2",
      "text": "LAN settings",
      "id": "lan-settings"
    },
    {
      "level": "h3",
      "text": "Restrict traffic to your premises",
      "id": "restrict-traffic-to-your-premises"
    },
    {
      "level": "h2",
      "text": "Device metrics",
      "id": "device-metrics"
    },
    {
      "level": "h3",
      "text": "Performance analytics",
      "id": "performance-analytics"
    },
    {
      "level": "h3",
      "text": "Port analytics",
      "id": "port-analytics"
    },
    {
      "level": "h3",
      "text": "Event logs",
      "id": "event-logs"
    },
    {
      "level": "h3",
      "text": "DHCP leasing",
      "id": "dhcp-leasing"
    },
    {
      "level": "h2",
      "text": "Troubleshooting tips",
      "id": "troubleshooting-tips"
    },
    {
      "level": "h2",
      "text": "I have set up a site, but my Magic WAN Connector is not working",
      "id": "i-have-set-up-a-site,-but-my-magic-wan-connector-is-not-working"
    },
    {
      "level": "h2",
      "text": "I have tried to activate Magic WAN Connector, but it is still not working",
      "id": "i-have-tried-to-activate-magic-wan-connector,-but-it-is-still-not-working"
    },
    {
      "level": "h2",
      "text": "I can access Magic WAN Connector's health checks, but there is no traffic",
      "id": "i-can-access-magic-wan-connector's-health-checks,-but-there-is-no-traffic"
    },
    {
      "level": "h2",
      "text": "Devices I have behind Magic WAN Connector cannot connect to the Internet",
      "id": "devices-i-have-behind-magic-wan-connector-cannot-connect-to-the-internet"
    },
    {
      "level": "h2",
      "text": "How do I know if my device is contacting Cloudflare?",
      "id": "how-do-i-know-if-my-device-is-contacting-cloudflare?"
    },
    {
      "level": "h2",
      "text": "What do I do in the event of hardware issues with Magic WAN Connector?",
      "id": "what-do-i-do-in-the-event-of-hardware-issues-with-magic-wan-connector?"
    },
    {
      "level": "h2",
      "text": "Check tunnel health for a specific tunnel",
      "id": "check-tunnel-health-for-a-specific-tunnel"
    },
    {
      "level": "h2",
      "text": "Connectors",
      "id": "connectors"
    },
    {
      "level": "h2",
      "text": "Alert data",
      "id": "alert-data"
    },
    {
      "level": "h2",
      "text": "SLO thresholds",
      "id": "slo-thresholds"
    },
    {
      "level": "h2",
      "text": "Set up Magic Tunnel health alerts",
      "id": "set-up-magic-tunnel-health-alerts"
    },
    {
      "level": "h2",
      "text": "Test SLOs",
      "id": "test-slos"
    },
    {
      "level": "h2",
      "text": "Assign permissions",
      "id": "assign-permissions"
    },
    {
      "level": "h2",
      "text": "Add a site",
      "id": "add-a-site"
    },
    {
      "level": "h2",
      "text": "Network overview",
      "id": "network-overview"
    },
    {
      "level": "h3",
      "text": "Network map and traffic overview",
      "id": "network-map-and-traffic-overview"
    },
    {
      "level": "h3",
      "text": "Traffic overview",
      "id": "traffic-overview"
    },
    {
      "level": "h2",
      "text": "Edit a site",
      "id": "edit-a-site"
    },
    {
      "level": "h3",
      "text": "Add or remove on-ramps",
      "id": "add-or-remove-on-ramps"
    },
    {
      "level": "h3",
      "text": "Set geographic coordinates",
      "id": "set-geographic-coordinates"
    },
    {
      "level": "h3",
      "text": "Set thresholds for site health",
      "id": "set-thresholds-for-site-health"
    },
    {
      "level": "h2",
      "text": "Manual configuration",
      "id": "manual-configuration"
    },
    {
      "level": "h2",
      "text": "Configure Connector",
      "id": "configure-connector"
    },
    {
      "level": "h2",
      "text": "Limitations",
      "id": "limitations"
    },
    {
      "level": "h3",
      "text": "AWS",
      "id": "aws"
    },
    {
      "level": "h2",
      "text": "Manage local domains",
      "id": "manage-local-domains"
    },
    {
      "level": "h3",
      "text": "View domains",
      "id": "view-domains"
    },
    {
      "level": "h3",
      "text": "Add a domain",
      "id": "add-a-domain"
    },
    {
      "level": "h3",
      "text": "Route traffic to fallback server",
      "id": "route-traffic-to-fallback-server"
    },
    {
      "level": "h3",
      "text": "Delete a domain",
      "id": "delete-a-domain"
    },
    {
      "level": "h2",
      "text": "Reverse DNS lookups for internal IPs",
      "id": "reverse-dns-lookups-for-internal-ips"
    },
    {
      "level": "h2",
      "text": "Related resources",
      "id": "related-resources"
    },
    {
      "level": "h2",
      "text": "WARP traffic flow",
      "id": "warp-traffic-flow"
    },
    {
      "level": "h2",
      "text": "Windows, macOS, and Linux",
      "id": "windows,-macos,-and-linux"
    },
    {
      "level": "h3",
      "text": "DNS traffic",
      "id": "dns-traffic"
    },
    {
      "level": "h3",
      "text": "IP traffic",
      "id": "ip-traffic"
    },
    {
      "level": "h2",
      "text": "iOS, Android, and ChromeOS",
      "id": "ios,-android,-and-chromeos"
    },
    {
      "level": "h2",
      "text": "Change Split Tunnels mode",
      "id": "change-split-tunnels-mode"
    },
    {
      "level": "h2",
      "text": "Add a route",
      "id": "add-a-route"
    },
    {
      "level": "h3",
      "text": "When to use Split Tunnels",
      "id": "when-to-use-split-tunnels"
    },
    {
      "level": "h3",
      "text": "When not to use Split Tunnels",
      "id": "when-not-to-use-split-tunnels"
    },
    {
      "level": "h2",
      "text": "Routes for Split Tunnels Include mode",
      "id": "routes-for-split-tunnels-include-mode"
    },
    {
      "level": "h3",
      "text": "Cloudflare Zero Trust domains",
      "id": "cloudflare-zero-trust-domains"
    },
    {
      "level": "h3",
      "text": "Cloudflare Zero Trust IP addresses",
      "id": "cloudflare-zero-trust-ip-addresses"
    },
    {
      "level": "h2",
      "text": "Domain-based Split Tunnels",
      "id": "domain-based-split-tunnels"
    },
    {
      "level": "h3",
      "text": "Valid domains",
      "id": "valid-domains"
    },
    {
      "level": "h3",
      "text": "Platform differences",
      "id": "platform-differences"
    },
    {
      "level": "h2",
      "text": "Remove a route",
      "id": "remove-a-route"
    },
    {
      "level": "h2",
      "text": "Related resources",
      "id": "related-resources"
    },
    {
      "level": "h2",
      "text": "1. Turn on account settings",
      "id": "1.-turn-on-account-settings"
    },
    {
      "level": "h2",
      "text": "2. Configure the WARP client",
      "id": "2.-configure-the-warp-client"
    },
    {
      "level": "h2",
      "text": "3. (Optional) Verify the client certificate",
      "id": "3.-(optional)-verify-the-client-certificate"
    },
    {
      "level": "h2",
      "text": "4. Enforce the client certificate",
      "id": "4.-enforce-the-client-certificate"
    },
    {
      "level": "h2",
      "text": "Limitations",
      "id": "limitations"
    },
    {
      "level": "h2",
      "text": "Allow users to connect to captive portals",
      "id": "allow-users-to-connect-to-captive-portals"
    },
    {
      "level": "h3",
      "text": "No user interaction required",
      "id": "no-user-interaction-required"
    },
    {
      "level": "h3",
      "text": "User interaction required",
      "id": "user-interaction-required"
    },
    {
      "level": "h2",
      "text": "How captive portal detection works",
      "id": "how-captive-portal-detection-works"
    },
    {
      "level": "h2",
      "text": "Limitations",
      "id": "limitations"
    },
    {
      "level": "h2",
      "text": "Get captive portal logs Beta",
      "id": "get-captive-portal-logs-beta"
    },
    {
      "level": "h2",
      "text": "Related resources",
      "id": "related-resources"
    },
    {
      "level": "h2",
      "text": "Required for full Cloudflare Zero Trust features",
      "id": "required-for-full-cloudflare-zero-trust-features"
    },
    {
      "level": "h3",
      "text": "`organization`",
      "id": "`organization`"
    },
    {
      "level": "h2",
      "text": "Required for DNS-only policy enforcement",
      "id": "required-for-dns-only-policy-enforcement"
    },
    {
      "level": "h3",
      "text": "`gateway_unique_id`",
      "id": "`gateway_unique_id`"
    },
    {
      "level": "h2",
      "text": "Organization parameters",
      "id": "organization-parameters"
    },
    {
      "level": "h3",
      "text": "`auth_client_id`",
      "id": "`auth_client_id`"
    },
    {
      "level": "h3",
      "text": "`auth_client_secret`",
      "id": "`auth_client_secret`"
    },
    {
      "level": "h3",
      "text": "`auto_connect`",
      "id": "`auto_connect`"
    },
    {
      "level": "h3",
      "text": "`display_name`",
      "id": "`display_name`"
    },
    {
      "level": "h3",
      "text": "`enable_pmtud`",
      "id": "`enable_pmtud`"
    },
    {
      "level": "h3",
      "text": "`enable_post_quantum`",
      "id": "`enable_post_quantum`"
    },
    {
      "level": "h3",
      "text": "`onboarding`",
      "id": "`onboarding`"
    },
    {
      "level": "h3",
      "text": "`override_api_endpoint`",
      "id": "`override_api_endpoint`"
    },
    {
      "level": "h3",
      "text": "`override_doh_endpoint`",
      "id": "`override_doh_endpoint`"
    },
    {
      "level": "h3",
      "text": "`override_warp_endpoint`",
      "id": "`override_warp_endpoint`"
    },
    {
      "level": "h3",
      "text": "`service_mode`",
      "id": "`service_mode`"
    },
    {
      "level": "h3",
      "text": "`support_url`",
      "id": "`support_url`"
    },
    {
      "level": "h3",
      "text": "`switch_locked`",
      "id": "`switch_locked`"
    },
    {
      "level": "h3",
      "text": "`unique_client_id`",
      "id": "`unique_client_id`"
    },
    {
      "level": "h3",
      "text": "`warp_tunnel_protocol`",
      "id": "`warp_tunnel_protocol`"
    },
    {
      "level": "h2",
      "text": "Top-level parameters",
      "id": "top-level-parameters"
    },
    {
      "level": "h3",
      "text": "`configs`",
      "id": "`configs`"
    },
    {
      "level": "h3",
      "text": "`multi_user`",
      "id": "`multi_user`"
    },
    {
      "level": "h3",
      "text": "`pre_login`",
      "id": "`pre_login`"
    },
    {
      "level": "h2",
      "text": "Per-app VPN parameters (Android)",
      "id": "per-app-vpn-parameters-(android)"
    },
    {
      "level": "h3",
      "text": "`app_identifier`",
      "id": "`app_identifier`"
    },
    {
      "level": "h3",
      "text": "`is_browser`",
      "id": "`is_browser`"
    },
    {
      "level": "h2",
      "text": "Footnotes",
      "id": "footnotes"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Enable Path MTU Discovery",
      "id": "enable-path-mtu-discovery"
    },
    {
      "level": "h2",
      "text": "Minimum MTUs",
      "id": "minimum-mtus"
    },
    {
      "level": "h3",
      "text": "Recommended MTU",
      "id": "recommended-mtu"
    },
    {
      "level": "h3",
      "text": "Path MTU Discovery",
      "id": "path-mtu-discovery"
    },
    {
      "level": "h3",
      "text": "IPv6",
      "id": "ipv6"
    },
    {
      "level": "h3",
      "text": "WebRTC",
      "id": "webrtc"
    },
    {
      "level": "h2",
      "text": "Check your MTU",
      "id": "check-your-mtu"
    },
    {
      "level": "h2",
      "text": "Turn off onboarding screens",
      "id": "turn-off-onboarding-screens"
    },
    {
      "level": "h2",
      "text": "Turn on Instant Auth",
      "id": "turn-on-instant-auth"
    },
    {
      "level": "h2",
      "text": "Allow browser to launch WARP",
      "id": "allow-browser-to-launch-warp"
    },
    {
      "level": "h3",
      "text": "Chromium-based browsers",
      "id": "chromium-based-browsers"
    },
    {
      "level": "h2",
      "text": "MDM file format",
      "id": "mdm-file-format"
    },
    {
      "level": "h3",
      "text": "XML",
      "id": "xml"
    },
    {
      "level": "h3",
      "text": "plist",
      "id": "plist"
    },
    {
      "level": "h3",
      "text": "mobileconfig",
      "id": "mobileconfig"
    },
    {
      "level": "h2",
      "text": "Switch organizations in WARP",
      "id": "switch-organizations-in-warp"
    },
    {
      "level": "h3",
      "text": "Troubleshooting",
      "id": "troubleshooting"
    },
    {
      "level": "h2",
      "text": "Enable multi-user mode",
      "id": "enable-multi-user-mode"
    },
    {
      "level": "h2",
      "text": "WARP registration logic",
      "id": "warp-registration-logic"
    },
    {
      "level": "h3",
      "text": "Fast user switching",
      "id": "fast-user-switching"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "1. Create a service token",
      "id": "1.-create-a-service-token"
    },
    {
      "level": "h2",
      "text": "2. Create a device enrollment policy",
      "id": "2.-create-a-device-enrollment-policy"
    },
    {
      "level": "h2",
      "text": "2. (Optional) Restrict access during pre-login",
      "id": "2.-(optional)-restrict-access-during-pre-login"
    },
    {
      "level": "h2",
      "text": "3. Configure the MDM file",
      "id": "3.-configure-the-mdm-file"
    },
    {
      "level": "h2",
      "text": "Configure domains",
      "id": "configure-domains"
    },
    {
      "level": "h2",
      "text": "Configure anti-spam policies",
      "id": "configure-anti-spam-policies"
    },
    {
      "level": "h2",
      "text": "Create transport rules",
      "id": "create-transport-rules"
    },
    {
      "level": "h2",
      "text": "Configure domains",
      "id": "configure-domains"
    },
    {
      "level": "h2",
      "text": "Create quarantine policies",
      "id": "create-quarantine-policies"
    },
    {
      "level": "h2",
      "text": "Configure quarantine notifications",
      "id": "configure-quarantine-notifications"
    },
    {
      "level": "h2",
      "text": "Configure anti-spam policies",
      "id": "configure-anti-spam-policies"
    },
    {
      "level": "h2",
      "text": "Create transport rules",
      "id": "create-transport-rules"
    },
    {
      "level": "h2",
      "text": "Configure domains",
      "id": "configure-domains"
    },
    {
      "level": "h2",
      "text": "Create quarantine policies",
      "id": "create-quarantine-policies"
    },
    {
      "level": "h2",
      "text": "Configure quarantine notifications",
      "id": "configure-quarantine-notifications"
    },
    {
      "level": "h2",
      "text": "Configure anti-spam policies",
      "id": "configure-anti-spam-policies"
    },
    {
      "level": "h2",
      "text": "Create transport rules",
      "id": "create-transport-rules"
    },
    {
      "level": "h2",
      "text": "Configure domains",
      "id": "configure-domains"
    },
    {
      "level": "h2",
      "text": "Create quarantine policies",
      "id": "create-quarantine-policies"
    },
    {
      "level": "h2",
      "text": "Configure quarantine notifications",
      "id": "configure-quarantine-notifications"
    },
    {
      "level": "h2",
      "text": "Configure anti-spam policies",
      "id": "configure-anti-spam-policies"
    },
    {
      "level": "h2",
      "text": "Create transport rules",
      "id": "create-transport-rules"
    },
    {
      "level": "h2",
      "text": "Configure domains",
      "id": "configure-domains"
    },
    {
      "level": "h2",
      "text": "Create quarantine policies",
      "id": "create-quarantine-policies"
    },
    {
      "level": "h2",
      "text": "Configure quarantine notifications",
      "id": "configure-quarantine-notifications"
    },
    {
      "level": "h2",
      "text": "Configure anti-spam policies",
      "id": "configure-anti-spam-policies"
    },
    {
      "level": "h2",
      "text": "Create transport rules",
      "id": "create-transport-rules"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Enable Gmail BCC integration:",
      "id": "enable-gmail-bcc-integration:"
    },
    {
      "level": "h3",
      "text": "1. Create a Service Account in your GCP Project",
      "id": "1.-create-a-service-account-in-your-gcp-project"
    },
    {
      "level": "h3",
      "text": "2. Create a JSON Key for your Service Account",
      "id": "2.-create-a-json-key-for-your-service-account"
    },
    {
      "level": "h3",
      "text": "3. Upload JSON Key",
      "id": "3.-upload-json-key"
    },
    {
      "level": "h3",
      "text": "4. Enable Necessary Google Workspace APIs in GCP",
      "id": "4.-enable-necessary-google-workspace-apis-in-gcp"
    },
    {
      "level": "h3",
      "text": "5. Log in to Google Workspace Admin Console",
      "id": "5.-log-in-to-google-workspace-admin-console"
    },
    {
      "level": "h3",
      "text": "6. Create a Domain-Wide Delegation API Client",
      "id": "6.-create-a-domain-wide-delegation-api-client"
    },
    {
      "level": "h3",
      "text": "7. Confirm Workspace Administrator Email",
      "id": "7.-confirm-workspace-administrator-email"
    },
    {
      "level": "h3",
      "text": "8. Create integration",
      "id": "8.-create-integration"
    },
    {
      "level": "h2",
      "text": "Verify integration",
      "id": "verify-integration"
    },
    {
      "level": "h2",
      "text": "Next steps",
      "id": "next-steps"
    },
    {
      "level": "h2",
      "text": "Add additional domains",
      "id": "add-additional-domains"
    },
    {
      "level": "h2",
      "text": "Verify successful deployment",
      "id": "verify-successful-deployment"
    },
    {
      "level": "h2",
      "text": "Configure anti-spam policies",
      "id": "configure-anti-spam-policies"
    },
    {
      "level": "h2",
      "text": "Create transport rules",
      "id": "create-transport-rules"
    },
    {
      "level": "h2",
      "text": "Create quarantine policies",
      "id": "create-quarantine-policies"
    },
    {
      "level": "h2",
      "text": "Configure quarantine notifications",
      "id": "configure-quarantine-notifications"
    },
    {
      "level": "h2",
      "text": "Configure anti-spam policies",
      "id": "configure-anti-spam-policies"
    },
    {
      "level": "h2",
      "text": "Create transport rules",
      "id": "create-transport-rules"
    },
    {
      "level": "h2",
      "text": "Create quarantine policies",
      "id": "create-quarantine-policies"
    },
    {
      "level": "h2",
      "text": "Configure quarantine notifications",
      "id": "configure-quarantine-notifications"
    },
    {
      "level": "h2",
      "text": "Configure anti-spam policies",
      "id": "configure-anti-spam-policies"
    },
    {
      "level": "h2",
      "text": "Create transport rules",
      "id": "create-transport-rules"
    },
    {
      "level": "h2",
      "text": "Create quarantine policies",
      "id": "create-quarantine-policies"
    },
    {
      "level": "h2",
      "text": "Configure quarantine notifications",
      "id": "configure-quarantine-notifications"
    },
    {
      "level": "h2",
      "text": "Configure anti-spam policies",
      "id": "configure-anti-spam-policies"
    },
    {
      "level": "h2",
      "text": "Create transport rules",
      "id": "create-transport-rules"
    },
    {
      "level": "h2",
      "text": "Create quarantine policies",
      "id": "create-quarantine-policies"
    },
    {
      "level": "h2",
      "text": "Configure quarantine notifications",
      "id": "configure-quarantine-notifications"
    },
    {
      "level": "h2",
      "text": "Configure anti-spam policies",
      "id": "configure-anti-spam-policies"
    },
    {
      "level": "h2",
      "text": "Create transport rules",
      "id": "create-transport-rules"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "1. Configure `cloudflared` as a service",
      "id": "1.-configure-`cloudflared`-as-a-service"
    },
    {
      "level": "h2",
      "text": "2. Run `cloudflared` as a service",
      "id": "2.-run-`cloudflared`-as-a-service"
    },
    {
      "level": "h2",
      "text": "Next steps",
      "id": "next-steps"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "1. Configure `cloudflared` as a service",
      "id": "1.-configure-`cloudflared`-as-a-service"
    },
    {
      "level": "h2",
      "text": "2. Run `cloudflared` as a service",
      "id": "2.-run-`cloudflared`-as-a-service"
    },
    {
      "level": "h3",
      "text": "Run at login",
      "id": "run-at-login"
    },
    {
      "level": "h3",
      "text": "Run at boot",
      "id": "run-at-boot"
    },
    {
      "level": "h2",
      "text": "3. Manually start the service",
      "id": "3.-manually-start-the-service"
    },
    {
      "level": "h2",
      "text": "Next steps",
      "id": "next-steps"
    },
    {
      "level": "h2",
      "text": "Configure `cloudflared` as a service",
      "id": "configure-`cloudflared`-as-a-service"
    },
    {
      "level": "h2",
      "text": "Run `cloudflared` as a service",
      "id": "run-`cloudflared`-as-a-service"
    },
    {
      "level": "h2",
      "text": "Next steps",
      "id": "next-steps"
    },
    {
      "level": "h2",
      "text": "Port configuration",
      "id": "port-configuration"
    },
    {
      "level": "h2",
      "text": "SFP+ module compatibility",
      "id": "sfp+-module-compatibility"
    },
    {
      "level": "h2",
      "text": "Recover from unsupported SFP+ inputs",
      "id": "recover-from-unsupported-sfp+-inputs"
    },
    {
      "level": "h2",
      "text": "Overview",
      "id": "overview"
    },
    {
      "level": "h2",
      "text": "How subnet NAT works in Magic WAN",
      "id": "how-subnet-nat-works-in-magic-wan"
    },
    {
      "level": "h2",
      "text": "Addressing rules",
      "id": "addressing-rules"
    },
    {
      "level": "h2",
      "text": "Example",
      "id": "example"
    },
    {
      "level": "h2",
      "text": "Configure NAT for subnets",
      "id": "configure-nat-for-subnets"
    },
    {
      "level": "h2",
      "text": "Create routed subnets",
      "id": "create-routed-subnets"
    },
    {
      "level": "h2",
      "text": "Create a policy",
      "id": "create-a-policy"
    },
    {
      "level": "h2",
      "text": "Edit a policy",
      "id": "edit-a-policy"
    },
    {
      "level": "h2",
      "text": "Delete a policy",
      "id": "delete-a-policy"
    },
    {
      "level": "h2",
      "text": "Default password to access hardware Magic WAN Connector",
      "id": "default-password-to-access-hardware-magic-wan-connector"
    },
    {
      "level": "h2",
      "text": "Default password to access Virtual Connector",
      "id": "default-password-to-access-virtual-connector"
    },
    {
      "level": "h3",
      "text": "Access Magic WAN Connector's heartbeat",
      "id": "access-magic-wan-connector's-heartbeat"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Affected Connectors",
      "id": "affected-connectors"
    },
    {
      "level": "h2",
      "text": "Configure source IPs via API",
      "id": "configure-source-ips-via-api"
    },
    {
      "level": "h2",
      "text": "Ways to onboard traffic to Cloudflare",
      "id": "ways-to-onboard-traffic-to-cloudflare"
    },
    {
      "level": "h3",
      "text": "GRE and IPsec tunnels",
      "id": "gre-and-ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Network Interconnect (CNI)",
      "id": "network-interconnect-(cni)"
    },
    {
      "level": "h2",
      "text": "Add tunnels",
      "id": "add-tunnels"
    },
    {
      "level": "h2",
      "text": "Bidirectional vs unidirectional health checks",
      "id": "bidirectional-vs-unidirectional-health-checks"
    },
    {
      "level": "h3",
      "text": "Legacy bidirectional health checks",
      "id": "legacy-bidirectional-health-checks"
    },
    {
      "level": "h2",
      "text": "Next steps",
      "id": "next-steps"
    },
    {
      "level": "h2",
      "text": "Configure static routes",
      "id": "configure-static-routes"
    },
    {
      "level": "h3",
      "text": "Create a static route",
      "id": "create-a-static-route"
    },
    {
      "level": "h3",
      "text": "Edit a static route",
      "id": "edit-a-static-route"
    },
    {
      "level": "h3",
      "text": "Delete static route",
      "id": "delete-static-route"
    },
    {
      "level": "h2",
      "text": "Configure Automatic Return Routing (beta)",
      "id": "configure-automatic-return-routing-(beta)"
    },
    {
      "level": "h2",
      "text": "Configure BGP routes",
      "id": "configure-bgp-routes"
    },
    {
      "level": "h3",
      "text": "Choose an ASN for BGP peering",
      "id": "choose-an-asn-for-bgp-peering"
    },
    {
      "level": "h3",
      "text": "Set up BGP peering",
      "id": "set-up-bgp-peering"
    },
    {
      "level": "h2",
      "text": "Next steps",
      "id": "next-steps"
    },
    {
      "level": "h2",
      "text": "Inherited TTL value",
      "id": "inherited-ttl-value"
    },
    {
      "level": "h2",
      "text": "WARP client",
      "id": "warp-client"
    },
    {
      "level": "h2",
      "text": "Alibaba Cloud",
      "id": "alibaba-cloud"
    },
    {
      "level": "h3",
      "text": "1. Create a VPC",
      "id": "1.-create-a-vpc"
    },
    {
      "level": "h3",
      "text": "2. Create a VPN gateway",
      "id": "2.-create-a-vpn-gateway"
    },
    {
      "level": "h3",
      "text": "3. Create IPsec connections",
      "id": "3.-create-ipsec-connections"
    },
    {
      "level": "h2",
      "text": "Magic WAN",
      "id": "magic-wan"
    },
    {
      "level": "h3",
      "text": "1. IPsec tunnels",
      "id": "1.-ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "2. Static route",
      "id": "2.-static-route"
    },
    {
      "level": "h3",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Example scenario",
      "id": "example-scenario"
    },
    {
      "level": "h2",
      "text": "1. Define a common site on the Orchestrator",
      "id": "1.-define-a-common-site-on-the-orchestrator"
    },
    {
      "level": "h2",
      "text": "2. Configure overlay policies",
      "id": "2.-configure-overlay-policies"
    },
    {
      "level": "h2",
      "text": "3. Create tunnels on Cloudflare and EdgeConnect",
      "id": "3.-create-tunnels-on-cloudflare-and-edgeconnect"
    },
    {
      "level": "h2",
      "text": "4. Create static routes on Cloudflare and EdgeConnect",
      "id": "4.-create-static-routes-on-cloudflare-and-edgeconnect"
    },
    {
      "level": "h2",
      "text": "5. Validate traffic flow",
      "id": "5.-validate-traffic-flow"
    },
    {
      "level": "h2",
      "text": "6. Cloudflare policies",
      "id": "6.-cloudflare-policies"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "AWS",
      "id": "aws"
    },
    {
      "level": "h3",
      "text": "Create AWS transit gateway VPN attachment",
      "id": "create-aws-transit-gateway-vpn-attachment"
    },
    {
      "level": "h3",
      "text": "Configure the VPN connection",
      "id": "configure-the-vpn-connection"
    },
    {
      "level": "h2",
      "text": "Magic WAN",
      "id": "magic-wan"
    },
    {
      "level": "h3",
      "text": "IPsec tunnels",
      "id": "ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Static routes",
      "id": "static-routes"
    },
    {
      "level": "h2",
      "text": "Cisco IOS XE configuration example",
      "id": "cisco-ios-xe-configuration-example"
    },
    {
      "level": "h3",
      "text": "Establish IPsec behind a NAT or CGNAT with port `4500`",
      "id": "establish-ipsec-behind-a-nat-or-cgnat-with-port-`4500`"
    },
    {
      "level": "h2",
      "text": "Diagnostic output: show crypto session detail",
      "id": "diagnostic-output:-show-crypto-session-detail"
    },
    {
      "level": "h2",
      "text": "Diagnostic output: show crypto session remote `<ANYCAST 01>` detail",
      "id": "diagnostic-output:-show-crypto-session-remote-`<anycast-01>`-detail"
    },
    {
      "level": "h2",
      "text": "Diagnostic output: show crypto session remote `<ANYCAST 02>` detail",
      "id": "diagnostic-output:-show-crypto-session-remote-`<anycast-02>`-detail"
    },
    {
      "level": "h2",
      "text": "Troubleshooting",
      "id": "troubleshooting"
    },
    {
      "level": "h2",
      "text": "Testing environment",
      "id": "testing-environment"
    },
    {
      "level": "h2",
      "text": "IPsec configuration",
      "id": "ipsec-configuration"
    },
    {
      "level": "h3",
      "text": "Magic WAN configuration",
      "id": "magic-wan-configuration"
    },
    {
      "level": "h3",
      "text": "FITELnet router configuration",
      "id": "fitelnet-router-configuration"
    },
    {
      "level": "h2",
      "text": "Static route configuration",
      "id": "static-route-configuration"
    },
    {
      "level": "h3",
      "text": "Magic WAN",
      "id": "magic-wan"
    },
    {
      "level": "h3",
      "text": "FITELnet router configuration",
      "id": "fitelnet-router-configuration"
    },
    {
      "level": "h2",
      "text": "Connection test",
      "id": "connection-test"
    },
    {
      "level": "h3",
      "text": "IPsec status",
      "id": "ipsec-status"
    },
    {
      "level": "h3",
      "text": "Route Status",
      "id": "route-status"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Google Cloud Platform",
      "id": "google-cloud-platform"
    },
    {
      "level": "h3",
      "text": "Create a GCP Cloud VPN Gateway",
      "id": "create-a-gcp-cloud-vpn-gateway"
    },
    {
      "level": "h3",
      "text": "Configure the VPN connection",
      "id": "configure-the-vpn-connection"
    },
    {
      "level": "h3",
      "text": "Static Routes",
      "id": "static-routes"
    },
    {
      "level": "h2",
      "text": "Magic WAN",
      "id": "magic-wan"
    },
    {
      "level": "h3",
      "text": "IPsec tunnels",
      "id": "ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Static routes",
      "id": "static-routes"
    },
    {
      "level": "h2",
      "text": "Testing Environment",
      "id": "testing-environment"
    },
    {
      "level": "h2",
      "text": "Magic WAN configuration",
      "id": "magic-wan-configuration"
    },
    {
      "level": "h3",
      "text": "Magic IPsec Tunnels",
      "id": "magic-ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Magic static routes",
      "id": "magic-static-routes"
    },
    {
      "level": "h2",
      "text": "Fortinet FortiGate configuration",
      "id": "fortinet-fortigate-configuration"
    },
    {
      "level": "h3",
      "text": "Enable asymmetric routing",
      "id": "enable-asymmetric-routing"
    },
    {
      "level": "h3",
      "text": "Configure NAT-T (optional)",
      "id": "configure-nat-t-(optional)"
    },
    {
      "level": "h3",
      "text": "Disable anti-replay protection",
      "id": "disable-anti-replay-protection"
    },
    {
      "level": "h3",
      "text": "IPsec tunnels",
      "id": "ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Network interfaces",
      "id": "network-interfaces"
    },
    {
      "level": "h3",
      "text": "Validate communication across virtual tunnel interfaces",
      "id": "validate-communication-across-virtual-tunnel-interfaces"
    },
    {
      "level": "h3",
      "text": "Zone objects (optional)",
      "id": "zone-objects-(optional)"
    },
    {
      "level": "h3",
      "text": "Create Address Objects",
      "id": "create-address-objects"
    },
    {
      "level": "h3",
      "text": "Configure Address Group Object",
      "id": "configure-address-group-object"
    },
    {
      "level": "h3",
      "text": "Add security policy",
      "id": "add-security-policy"
    },
    {
      "level": "h3",
      "text": "Policy-based routing",
      "id": "policy-based-routing"
    },
    {
      "level": "h2",
      "text": "Monitor Cloudflare Magic IPsec tunnel health checks",
      "id": "monitor-cloudflare-magic-ipsec-tunnel-health-checks"
    },
    {
      "level": "h2",
      "text": "Troubleshooting",
      "id": "troubleshooting"
    },
    {
      "level": "h3",
      "text": "Packet Capture",
      "id": "packet-capture"
    },
    {
      "level": "h3",
      "text": "Flow Debugging",
      "id": "flow-debugging"
    },
    {
      "level": "h3",
      "text": "Disable Flow Debugging",
      "id": "disable-flow-debugging"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Cloudflare Magic WAN configuration",
      "id": "cloudflare-magic-wan-configuration"
    },
    {
      "level": "h3",
      "text": "Magic WAN topology",
      "id": "magic-wan-topology"
    },
    {
      "level": "h3",
      "text": "Magic IPsec tunnels",
      "id": "magic-ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Magic static routes",
      "id": "magic-static-routes"
    },
    {
      "level": "h2",
      "text": "Juniper SRX configuration",
      "id": "juniper-srx-configuration"
    },
    {
      "level": "h3",
      "text": "Tunnel interfaces",
      "id": "tunnel-interfaces"
    },
    {
      "level": "h3",
      "text": "Security Zone (Cloudflare) - tunnel interfaces",
      "id": "security-zone-(cloudflare)---tunnel-interfaces"
    },
    {
      "level": "h3",
      "text": "Security zone (untrust) - `host-inbound-traffic`",
      "id": "security-zone-(untrust)---`host-inbound-traffic`"
    },
    {
      "level": "h3",
      "text": "IKE - Phase 1",
      "id": "ike---phase-1"
    },
    {
      "level": "h3",
      "text": "Phase 2 - IPsec",
      "id": "phase-2---ipsec"
    },
    {
      "level": "h3",
      "text": "Policy-Based Routing",
      "id": "policy-based-routing"
    },
    {
      "level": "h3",
      "text": "Security policies",
      "id": "security-policies"
    },
    {
      "level": "h2",
      "text": "Troubleshooting",
      "id": "troubleshooting"
    },
    {
      "level": "h3",
      "text": "Validate tunnel connectivity",
      "id": "validate-tunnel-connectivity"
    },
    {
      "level": "h3",
      "text": "IKE `traceoptions`",
      "id": "ike-`traceoptions`"
    },
    {
      "level": "h2",
      "text": "## inactive: security ike traceoptions",
      "id": "##-inactive:-security-ike-traceoptions"
    },
    {
      "level": "h2",
      "text": "file ike-debug.log size 1m files 3 world-readable;",
      "id": "file-ike-debug.log-size-1m-files-3-world-readable;"
    },
    {
      "level": "h3",
      "text": "IPsec `traceoptions`",
      "id": "ipsec-`traceoptions`"
    },
    {
      "level": "h2",
      "text": "## inactive: security ipsec traceoptions",
      "id": "##-inactive:-security-ipsec-traceoptions"
    },
    {
      "level": "h2",
      "text": "file ipsec-debug.log size 1m files 3 world-readable;",
      "id": "file-ipsec-debug.log-size-1m-files-3-world-readable;"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Oracle Cloud",
      "id": "oracle-cloud"
    },
    {
      "level": "h3",
      "text": "1. Create Oracle Cloud customer-premises equipment",
      "id": "1.-create-oracle-cloud-customer-premises-equipment"
    },
    {
      "level": "h3",
      "text": "2. Create Oracle Cloud dynamic routing gateways",
      "id": "2.-create-oracle-cloud-dynamic-routing-gateways"
    },
    {
      "level": "h3",
      "text": "3. Create an IPsec connection",
      "id": "3.-create-an-ipsec-connection"
    },
    {
      "level": "h2",
      "text": "Magic WAN",
      "id": "magic-wan"
    },
    {
      "level": "h3",
      "text": "IPsec tunnels",
      "id": "ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Static routes",
      "id": "static-routes"
    },
    {
      "level": "h2",
      "text": "Software version tested",
      "id": "software-version-tested"
    },
    {
      "level": "h2",
      "text": "Use Cases",
      "id": "use-cases"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Environment",
      "id": "environment"
    },
    {
      "level": "h2",
      "text": "Cloudflare Magic WAN",
      "id": "cloudflare-magic-wan"
    },
    {
      "level": "h3",
      "text": "Magic IPsec Tunnels",
      "id": "magic-ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Magic Static Routes",
      "id": "magic-static-routes"
    },
    {
      "level": "h2",
      "text": "Palo Alto Networks Next-Generation Firewall",
      "id": "palo-alto-networks-next-generation-firewall"
    },
    {
      "level": "h3",
      "text": "Tags",
      "id": "tags"
    },
    {
      "level": "h3",
      "text": "Objects",
      "id": "objects"
    },
    {
      "level": "h3",
      "text": "Interface Mgmt - Network Profiles",
      "id": "interface-mgmt---network-profiles"
    },
    {
      "level": "h3",
      "text": "Network Interfaces",
      "id": "network-interfaces"
    },
    {
      "level": "h3",
      "text": "Tunnel interfaces",
      "id": "tunnel-interfaces"
    },
    {
      "level": "h3",
      "text": "Zones",
      "id": "zones"
    },
    {
      "level": "h3",
      "text": "Apply Changes",
      "id": "apply-changes"
    },
    {
      "level": "h3",
      "text": "IKE crypto profile Phase 1",
      "id": "ike-crypto-profile-phase-1"
    },
    {
      "level": "h3",
      "text": "IPsec crypto profile Phase 2",
      "id": "ipsec-crypto-profile-phase-2"
    },
    {
      "level": "h3",
      "text": "IKE Gateways",
      "id": "ike-gateways"
    },
    {
      "level": "h3",
      "text": "IPsec Tunnels",
      "id": "ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Apply Changes",
      "id": "apply-changes"
    },
    {
      "level": "h3",
      "text": "IPsec tunnel connectivity tests",
      "id": "ipsec-tunnel-connectivity-tests"
    },
    {
      "level": "h3",
      "text": "Virtual Router",
      "id": "virtual-router"
    },
    {
      "level": "h3",
      "text": "Magic health checks",
      "id": "magic-health-checks"
    },
    {
      "level": "h3",
      "text": "Troubleshooting tunnel health checks",
      "id": "troubleshooting-tunnel-health-checks"
    },
    {
      "level": "h3",
      "text": "Security Policies - Production Traffic",
      "id": "security-policies---production-traffic"
    },
    {
      "level": "h3",
      "text": "Policy-based forwarding - production traffic",
      "id": "policy-based-forwarding---production-traffic"
    },
    {
      "level": "h2",
      "text": "Magic WAN with Cloudflare Zero Trust (Gateway egress)",
      "id": "magic-wan-with-cloudflare-zero-trust-(gateway-egress)"
    },
    {
      "level": "h3",
      "text": "Security Rule: Trust to Gateway Egress",
      "id": "security-rule:-trust-to-gateway-egress"
    },
    {
      "level": "h3",
      "text": "Policy-based forwarding: Trust to Gateway egress via tunnel.1",
      "id": "policy-based-forwarding:-trust-to-gateway-egress-via-tunnel.1"
    },
    {
      "level": "h3",
      "text": "Policy-based forwarding: Trust to Gateway egress via tunnel.2",
      "id": "policy-based-forwarding:-trust-to-gateway-egress-via-tunnel.2"
    },
    {
      "level": "h2",
      "text": "Troubleshooting",
      "id": "troubleshooting"
    },
    {
      "level": "h2",
      "text": "Software tested",
      "id": "software-tested"
    },
    {
      "level": "h2",
      "text": "Prerequisites",
      "id": "prerequisites"
    },
    {
      "level": "h2",
      "text": "Example scenario",
      "id": "example-scenario"
    },
    {
      "level": "h2",
      "text": "1. Configure Magic WAN IPsec tunnels",
      "id": "1.-configure-magic-wan-ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Add IPsec tunnels",
      "id": "add-ipsec-tunnels"
    },
    {
      "level": "h3",
      "text": "Generate pre-shared keys",
      "id": "generate-pre-shared-keys"
    },
    {
      "level": "h3",
      "text": "IPsec identifier - User ID",
      "id": "ipsec-identifier---user-id"
    },
    {
      "level": "h2",
      "text": "2. Create Magic WAN static routes",
      "id": "2.-create-magic-wan-static-routes"
    },
    {
      "level": "h3",
      "text": "Tunnel 01",
      "id": "tunnel-01"
    },
    {
      "level": "h3",
      "text": "Tunnel 02",
      "id": "tunnel-02"
    },
    {
      "level": "h2",
      "text": "3. Configure the pfSense firewall",
      "id": "3.-configure-the-pfsense-firewall"
    },
    {
      "level": "h3",
      "text": "Configure IPsec Phase 1",
      "id": "configure-ipsec-phase-1"
    },
    {
      "level": "h3",
      "text": "Configure IPsec Phase 2",
      "id": "configure-ipsec-phase-2"
    },
    {
      "level": "h3",
      "text": "Interface assignments",
      "id": "interface-assignments"
    },
    {
      "level": "h3",
      "text": "Gateway",
      "id": "gateway"
    },
    {
      "level": "h3",
      "text": "Firewall Rules IPsec",
      "id": "firewall-rules-ipsec"
    },
    {
      "level": "h3",
      "text": "Firewall Rules LAN",
      "id": "firewall-rules-lan"
    },
    {
      "level": "h2",
      "text": "Topology",
      "id": "topology"
    },
    {
      "level": "h2",
      "text": "1. Create an IPsec tunnel on your Cloudflare account",
      "id": "1.-create-an-ipsec-tunnel-on-your-cloudflare-account"
    },
    {
      "level": "h2",
      "text": "2. Create static routes on Cloudflare dashboard",
      "id": "2.-create-static-routes-on-cloudflare-dashboard"
    },
    {
      "level": "h2",
      "text": "3. Add a VPN configuration in SonicWall",
      "id": "3.-add-a-vpn-configuration-in-sonicwall"
    },
    {
      "level": "h2",
      "text": "4. Add a VPN tunnel interface",
      "id": "4.-add-a-vpn-tunnel-interface"
    },
    {
      "level": "h2",
      "text": "5. Add address object(s)",
      "id": "5.-add-address-object(s)"
    },
    {
      "level": "h2",
      "text": "6. Set up routing",
      "id": "6.-set-up-routing"
    },
    {
      "level": "h2",
      "text": "7. Add access rule for health checks",
      "id": "7.-add-access-rule-for-health-checks"
    },
    {
      "level": "h2",
      "text": "8. Setup health checks",
      "id": "8.-setup-health-checks"
    },
    {
      "level": "h2",
      "text": "9. Verify tunnel status on Cloudflare dashboard",
      "id": "9.-verify-tunnel-status-on-cloudflare-dashboard"
    },
    {
      "level": "h2",
      "text": "IPsec connection",
      "id": "ipsec-connection"
    },
    {
      "level": "h3",
      "text": "1. Add an IPsec profile",
      "id": "1.-add-an-ipsec-profile"
    },
    {
      "level": "h3",
      "text": "2. Create IPsec connection tunnel",
      "id": "2.-create-ipsec-connection-tunnel"
    },
    {
      "level": "h3",
      "text": "3. Assign the XFRM interface address",
      "id": "3.-assign-the-xfrm-interface-address"
    },
    {
      "level": "h3",
      "text": "4. Add a firewall rule",
      "id": "4.-add-a-firewall-rule"
    },
    {
      "level": "h3",
      "text": "5. Disable IPsec anti-replay",
      "id": "5.-disable-ipsec-anti-replay"
    },
    {
      "level": "h2",
      "text": "GRE connection",
      "id": "gre-connection"
    },
    {
      "level": "h3",
      "text": "1. Configure a GRE tunnel between SFOS and Cloudflare",
      "id": "1.-configure-a-gre-tunnel-between-sfos-and-cloudflare"
    },
    {
      "level": "h3",
      "text": "2. Add a GRE or SD-WAN route to redirect traffic through the GRE tunnel",
      "id": "2.-add-a-gre-or-sd-wan-route-to-redirect-traffic-through-the-gre-tunnel"
    },
    {
      "level": "h3",
      "text": "3. Add a firewall rule for LAN/DMZ to VPN",
      "id": "3.-add-a-firewall-rule-for-lan/dmz-to-vpn"
    },
    {
      "level": "h2",
      "text": "Traffic redirection mechanism on Sophos Firewall",
      "id": "traffic-redirection-mechanism-on-sophos-firewall"
    },
    {
      "level": "h3",
      "text": "IPsec",
      "id": "ipsec"
    },
    {
      "level": "h3",
      "text": "GRE",
      "id": "gre"
    },
    {
      "level": "h2",
      "text": "Verify tunnel status on Cloudflare dashboard",
      "id": "verify-tunnel-status-on-cloudflare-dashboard"
    },
    {
      "level": "h3",
      "text": "Make Cloudflare health checks work",
      "id": "make-cloudflare-health-checks-work"
    },
    {
      "level": "h2",
      "text": "Verify tunnel status on Sophos Firewall dashboard",
      "id": "verify-tunnel-status-on-sophos-firewall-dashboard"
    },
    {
      "level": "h3",
      "text": "IPsec",
      "id": "ipsec"
    },
    {
      "level": "h3",
      "text": "GRE",
      "id": "gre"
    },
    {
      "level": "h2",
      "text": "Troubleshooting",
      "id": "troubleshooting"
    },
    {
      "level": "h2",
      "text": "1. Health checks configuration",
      "id": "1.-health-checks-configuration"
    },
    {
      "level": "h2",
      "text": "2. Configure StrongSwan",
      "id": "2.-configure-strongswan"
    },
    {
      "level": "h2",
      "text": "3. Configure IPsec file",
      "id": "3.-configure-ipsec-file"
    }
  ],
  "url": "llms-txt#forcecommand-cvs-server",
  "links": []
}